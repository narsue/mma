<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMA Gym Portal</title>
    <!-- Include Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Add Google Fonts for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <!-- Flowbite + Chart.js (Flowbite uses Chart.js under the hood) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://unpkg.com/flowbite@2.3.0/dist/flowbite.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        html, body {
            overflow-x: hidden;
        }

        .portal-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .section-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Enhanced nav styling */
        nav {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            display: inline-flex;
            min-width: max-content;
            flex-wrap: nowrap;
        }
        nav ul li {
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        nav ul li a {
            color: #f3f4f6;
            text-decoration: none;
            padding: 0.75rem 1rem;
            display: block;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.875rem;
        }
        nav ul li a:hover {
            background: rgba(99, 102, 241, 0.2);
            color: #c7d2fe;
            transform: translateY(-1px);
        }
        nav ul li a.active {
            background: rgba(99, 102, 241, 0.3);
            color: #c7d2fe;
            font-weight: 600;
        }

        /* Styles for content sections */
        .portal-section {
            display: none; /* Initially hide all content sections */
        }
        .portal-section.active {
            display: block; /* Show the active section */
        }

        /* Modal styles (retained and adapted for Tailwind context) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* Adjusted margin to be higher */
            padding: 24px; /* Increased padding */
            border: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
            width: 90%; /* Adjusted width */
            max-width: 700px; /* Increased max width for forms */
            border-radius: 8px; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Added a subtle shadow */
        }

        .modal-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             border-bottom: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
             padding-bottom: 16px; /* Increased padding */
             margin-bottom: 24px; /* Increased margin */
        }

        .modal-header h3 {
             margin: 0;
             font-size: 1.5rem; /* Tailwind text-2xl */
             font-weight: 600; /* Tailwind font-semibold */
             color: #1f2937; /* Tailwind text-gray-900 */
         }

        .close-button {
            color: #9ca3af; /* Tailwind text-gray-400 */
            font-size: 2rem; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #6b7280; /* Tailwind text-gray-500 */
            text-decoration: none;
        }

         #new-waiver-content {
             width: 100%;
             box-sizing: border-box; /* Include padding in width */
             margin-bottom: 10px;
         }

         /* Styles for waiver/accept messages */
         #create-waiver-error, #accept-waiver-message {
             margin-top: 10px;
             padding: 10px; /* Increased padding */
             border-radius: 4px;
             font-size: 0.875rem; /* Tailwind text-sm */
         }
         #create-waiver-error.error, #accept-waiver-message.error {
             color: #b91c1c; /* Tailwind text-red-700 */
             border: 1px solid #f87171; /* Tailwind border-red-400 */
             background-color: #fee2e2; /* Tailwind bg-red-100 */
         }
          #create-waiver-error.success, #accept-waiver-message.success {
             color: #065f46; /* Tailwind text-green-700 */
             border: 1px solid #34d399; /* Tailwind border-green-400 */
             background-color: #d1fae5; /* Tailwind bg-green-100 */
         }

         .form-group {
             margin-bottom: 16px; /* Increased margin */
         }

         .form-group label {
             display: block;
             margin-bottom: 8px; /* Increased margin */
             font-weight: 500; /* Tailwind font-medium */
             color: #374151; /* Tailwind text-gray-700 */
         }

         .form-group input[type="text"],
         .form-group input[type="number"],
         .form-group input[type="date"], /* Added date input */
         .form-group input[type="time"], /* Added time input */
         .form-group textarea,
         .form-group select {
             width: 100%; /* Use full width with Tailwind padding */
             padding: 8px 12px; /* Tailwind py-2 px-3 */
             border: 1px solid #d1d5db; /* Tailwind border-gray-300 */
             border-radius: 6px; /* Tailwind rounded-md */
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Tailwind shadow-sm */
             font-size: 0.875rem; /* Tailwind text-sm */
             color: #1f2937; /* Tailwind text-gray-900 */
             transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
         }
          .form-group input:focus,
          .form-group textarea:focus,
          .form-group select:focus {
              outline: none;
              border-color: #3b82f6; /* Tailwind border-blue-500 */
              box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Tailwind ring-blue-500 */
          }


         .form-group textarea {
             resize: vertical; /* Allow vertical resizing */
         }

         .checkbox-group {
             display: flex;
             align-items: center;
             margin-bottom: 16px; /* Consistent form-group margin */
         }
         .checkbox-group input[type="checkbox"] {
             margin-right: 8px; /* Tailwind mr-2 */
             width: auto; /* Don't use 100% width */
             padding: 0; /* Remove padding from checkbox */
             box-shadow: none; /* Remove shadow from checkbox */
             /* Further checkbox styling can be added with Tailwind, but it's often
                easier with a custom approach or a library for cross-browser consistency */
         }
          .checkbox-group label {
             margin-bottom: 0; /* Reset margin */
             font-weight: 400; /* Normal font weight */
             color: #374151; /* Consistent text color */
         }

         #frequency-container .frequency-entry {
             border: 1px dashed #d1d5db; /* Tailwind border-dashed border-gray-300 */
             padding: 16px; /* Increased padding */
             margin-bottom: 16px; /* Consistent margin */
             border-radius: 6px; /* Tailwind rounded-md */
             position: relative; /* Needed for absolute positioning of remove button */
         }

         .remove-frequency-button {
            position: absolute;
            top: 8px; /* Adjusted position */
            right: 8px; /* Adjusted position */
            background: #ef4444; /* Tailwind bg-red-500 */
            color: white;
            border: none;
            border-radius: 4px; /* Tailwind rounded */
            padding: 4px 8px; /* Tailwind py-1 px-2 */
            cursor: pointer;
            font-size: 0.75rem; /* Tailwind text-xs */
            font-weight: 500; /* Tailwind font-medium */
            transition: background-color 0.2s ease-in-out;
         }
          .remove-frequency-button:hover {
              background-color: #dc2626; /* Tailwind bg-red-600 */
          }


         .modal-footer {
             border-top: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
             padding-top: 16px; /* Increased padding */
             margin-top: 24px; /* Increased margin */
             text-align: right; /* Buttons to the right */
         }

         .modal-footer button {
             padding: 10px 20px; /* Tailwind py-2.5 px-5 */
             margin-left: 12px; /* Tailwind ml-3 */
             border: none;
             border-radius: 6px; /* Tailwind rounded-md */
             cursor: pointer;
             font-size: 0.875rem; /* Tailwind text-sm */
             font-weight: 500; /* Tailwind font-medium */
             transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
         }

         .modal-footer .submit-button {
             background-color: #22c55e; /* Tailwind bg-green-500 */
             color: white;
         }
          .modal-footer .submit-button:hover {
              background-color: #16a34a; /* Tailwind bg-green-600 */
          }


         .modal-footer .cancel-button {
             background-color: #facc15; /* Tailwind bg-yellow-400 */
             color: #1f2937; /* Tailwind text-gray-900 */
         }
         .modal-footer .cancel-button:hover {
             background-color: #eab308; /* Tailwind bg-yellow-500 */
         }

         #create-class-message {
             margin-top: 16px; /* Consistent margin */
             padding: 10px; /* Consistent padding */
             border-radius: 4px;
             font-size: 0.875rem; /* Tailwind text-sm */
             color: #b91c1c; /* Tailwind text-red-700 */
             border: 1px solid #f87171; /* Tailwind border-red-400 */
             background-color: #fee2e2; /* Tailwind bg-red-100 */
             display: none; /* Hidden by default */
         }
         #create-class-message.success {
             color: #065f46; /* Tailwind text-green-700 */
             border: 1px solid #34d399; /* Tailwind border-green-400 */
             background-color: #d1fae5; /* Tailwind bg-green-100 */
         }

        /* POS Section Styles -- START */
        #calendar-grid {
            position: relative;
        }

        .time-slot {
            display: flex;
            align-items: flex-start;
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .time-slot:hover {
            background-color: #f9fafb;
        }

        .time-label {
            width: 80px;
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            padding: 4px 12px;
            text-align: right;
        }

        .time-content {
            flex: 1;
            height: 100%;
            border-left: 2px solid #e5e7eb;
            margin-left: 8px;
        }

        .event {
            position: absolute;
            left: 100px;
            right: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            border: 2px solid transparent;
            z-index: 10;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .event-title {
            font-weight: 600;
            line-height: 1.2;
        }

        .event-time {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .event-description {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
            line-height: 1.3;
        }

        .event-highlight {
            animation: eventPulse 2.5s ease-in-out infinite;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.4), 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        @keyframes eventPulse {
            0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7), 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            50% {
            transform: scale(1.02);
            box-shadow: 0 0 0 8px rgba(251, 191, 36, 0.2), 0 6px 16px rgba(59, 130, 246, 0.6);
            }
            100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7), 0 4px 12px rgba(59, 130, 246, 0.4);
            }
        }

        .current-time-indicator {
            position: absolute;
            left: 88px;
            right: 16px;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            z-index: 20;
            border-radius: 2px;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        }

        .current-time-indicator::before {
            content: "";
            position: absolute;
            left: -8px;
            top: -5px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.8);
        }

        .current-time-label {
            position: absolute;
            right: -70px;
            top: -12px;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
        }

        /* Modal specific styles */
        .student-search-item {
            display: flex;
            items-center: space-x-3;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .student-search-item:hover {
            background-color: #f3f4f6;
        }

        .student-list-item {
            display: flex;
            items-center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .student-list-item:hover {
            background-color: #f9fafb;
        }

        .student-list-item.attending {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .student-grid-item {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .student-grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .student-grid-item.attending {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #e5e7eb;
        }

        .student-grid-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #e5e7eb;
            margin: 0 auto 12px;
        }
        /* POS Section Styles -- END */

        /* Stripe card section styles -- START */
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        #card-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        #card-errors {
            color: #fa755a;
            margin-top: 10px;
            font-size: 14px;
        }
        .btn {
            background: #5469d4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            background: #4f5fc7;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin-top: 20px;
        }
        .error {
            color: #dc3545;
            padding: 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin-top: 20px;
        }
        .saved-cards {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .card-info {
            flex-grow: 1;
        }
        .card-brand {
            font-weight: bold;
            text-transform: capitalize;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        /* Stripe card section styles -- END */




    </style>

</head>
<body class="bg-gradient-to-br from-gray-50 to-indigo-100 text-gray-800 min-h-screen">
    <!-- Enhanced Navigation -->
    <nav class="fixed w-full top-0 z-50">
        <div class="max-w-full px-4">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-white text-xl font-bold tracking-wide font-poppins">MMA Portal</span>
                    </div>
                </div>
                <div class="flex-1 flex justify-center">
                    <div class="flex items-center space-x-1">
                        <ul class="flex space-x-1">
                            <!-- Nav items for client-side tab switching -->
                            <li id="dashboard-nav" class="hidden"><a href="#" data-section="dashboard" class="nav-link">üìä Dashboard</a></li>
                            <li><a href="#" data-section="frontpage" class="nav-link">üè† Home</a></li>
                            <li><a href="#" data-section="classes" class="nav-link">ü•ã Classes</a></li>
                            <li><a href="#" data-section="venues" class="nav-link">üìç Venues</a></li>
                            <li><a href="#" data-section="styles" class="nav-link">üéØ Styles</a></li>
                            <li><a href="#" data-section="waivers" class="nav-link">üìã Waivers</a></li>
                            <li><a href="#" data-section="locations" class="nav-link">üó∫Ô∏è Locations</a></li>
                            <li><a href="#" data-section="pos" class="nav-link">üìÖ Today</a></li>
                            <li><a href="#" data-section="payment_plans" class="nav-link">üí≥ Plans</a></li>
                            <li><a href="#" data-section="kiosk" class="nav-link">üñ•Ô∏è Kiosk</a></li>
                            <li id="users-nav" class="nav-item hidden"><a href="#" data-section="users" class="nav-link">üë• Users</a></li>
                            <li id="settings-nav" class="nav-item hidden"><a href="#" data-section="settings" class="nav-link">üè´ School Settings</a></li>
                            <li><a href="#" data-section="account" class="nav-link">‚öôÔ∏è Account</a></li>
                            <!-- Logout is a different action -->
                            <li><a href="#" id="logoutLink" class="nav-link text-red-300 hover:text-red-200">üö™ Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="pt-20 px-4 sm:px-6 lg:px-8 pb-8">
        <div class="max-w-7xl mx-auto">
        <!-- Section: Front Page -->
        <div id="frontpageSection" class="portal-section">
            <div class="section-card bg-white rounded-3xl shadow-xl p-8 mb-8">
                <div class="text-center mb-12">
                    <div class="w-24 h-24 portal-gradient rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <h1 class="text-4xl font-bold text-gray-900 mb-4 font-poppins">Welcome to Your Portal</h1>
                    <p class="text-xl text-gray-600 mb-8">Manage your martial arts business with powerful tools and insights</p>
                </div>

                <!-- Quick Stats Grid -->
                <div id="frontpage-content" class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl p-6 text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <h3 id="total-members-stat" class="text-2xl font-bold text-gray-900 mb-1">-</h3>
                        <p class="text-gray-600 text-sm">Total Members</p>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl p-6 text-center">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 id="active-classes-stat" class="text-2xl font-bold text-gray-900 mb-1">-</h3>
                        <p class="text-gray-600 text-sm">Active Classes</p>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-pink-100 rounded-2xl p-6 text-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 id="todays-attendance-stat" class="text-2xl font-bold text-gray-900 mb-1">-</h3>
                        <p class="text-gray-600 text-sm">Today's Attendance</p>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-50 to-orange-100 rounded-2xl p-6 text-center">
                        <div class="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <h3 id="monthly-revenue-stat" class="text-2xl font-bold text-gray-900 mb-1">-</h3>
                        <p class="text-gray-600 text-sm">Monthly Revenue</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid md:grid-cols-3 gap-6">
                    <button onclick="showSection('classes')" class="section-card bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-2xl p-6 text-center hover:shadow-lg transition-all duration-300">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Create Class</h3>
                        <p class="text-blue-100 text-sm">Schedule a new class session</p>
                    </button>

                    <button onclick="showSection('pos')" class="section-card bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-2xl p-6 text-center hover:shadow-lg transition-all duration-300">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Take Attendance</h3>
                        <p class="text-green-100 text-sm">Mark today's class attendance</p>
                    </button>

                    <button onclick="showSection('account')" class="section-card bg-gradient-to-br from-purple-500 to-pink-600 text-white rounded-2xl p-6 text-center hover:shadow-lg transition-all duration-300">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">Manage Account</h3>
                        <p class="text-purple-100 text-sm">Update your profile settings</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- Section: Dashboard Page -->
        <div id="dashboardSection" class="portal-section">
            <div class="section-card bg-white rounded-3xl shadow-xl p-8 mb-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 font-poppins">Analytics Dashboard</h1>
                        <p class="text-gray-600 mt-2">Monitor your gym's performance and growth</p>
                    </div>
                    <div class="w-16 h-16 portal-gradient rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
          
            <!-- Filters -->
            <div class="mb-6 flex flex-col sm:flex-row gap-4">
                <select id="classFilter" class="w-full sm:w-1/3 border-gray-300 rounded-md shadow-sm">
                    <option value="">All Classes</option>
                    <option value="1">Class 1</option>
                    <option value="2">Class 2</option>
                </select>

                <select id="timeFilter" class="w-full sm:w-1/3 border-gray-300 rounded-md shadow-sm">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week" selected>This Week</option>
                    <option value="last_month">Last Month</option>
                    <option value="last_3_months">Last 3 Months</option>
                    <option value="last_year">Last Year</option>
                    <option value="all" selected>All Time</option>
                </select>

                <select id="countTypeFilter" class="w-full sm:w-1/3 border-gray-300 rounded-md shadow-sm">
                    <option value="AttendanceAll" selected>Attendance (All)</option>
                    <option value="AttendanceGender">Attendance (By Gender)</option>
                    <option value="Revenue">Revenue</option>
                    <option value="PendingRevenue">Pending Revenue</option>
                    <option value="Refunded">Refunded</option>
                </select>

              <button id="refreshDashboard" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                Refresh
              </button>
            </div>
          
            <!-- Charts -->
            <div class="gap-6">
              <div class="bg-white p-4 rounded shadow">
                <h3 class="text-lg font-semibold mb-2">Lesson Attendance</h3>
                <canvas id="attendanceChart" height="200"></canvas>
              </div>

            </div>
        </div>


        <!-- Section: Classes -->
        <div id="classesSection" class="portal-section">
            <div class="section-card bg-white rounded-3xl shadow-xl p-8 mb-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 font-poppins">Classes Management</h1>
                        <p class="text-gray-600 mt-2">Schedule and manage your martial arts classes</p>
                    </div>
                    <div class="flex space-x-4">
                        <button id="createClassBtn" class="hidden inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 transform hover:scale-105">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create Class
                        </button>
                    </div>
                </div>

                <!-- Filter and Sort Controls -->
                <div class="bg-gray-50 rounded-2xl p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter & Search Classes</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="class-filter-style" class="block text-sm font-medium text-gray-700">Filter by Style:</label>
                        <select id="class-filter-style" class="mt-1 block w-full pl-3 pr-10 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="class-filter-venue" class="block text-sm font-medium text-gray-700">Filter by Venue:</label>
                        <select id="class-filter-venue" class="mt-1 block w-full pl-3 pr-10 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <!-- Options will be populated by JS -->
                        </select>
                </div>
                <div>
                    <label for="class-sort-by" class="block text-sm font-medium text-gray-700">Sort By:</label>
                    <select id="class-sort-by" class="mt-1 block w-full pl-3 pr-10 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                         <option value="title" selected>Title (A-Z)</option>
                         <option value="next_run_time">Next Run Time</option>
                         <option value="price">Price (Low to High)</option>
                         <option value="capacity">Capacity</option>
                    </select>
                </div>
                 <div>
                     <label for="class-search" class="block text-sm font-medium text-gray-700">Search:</label>
                     <input type="text" id="class-search" placeholder="Search by title, description..." class="mt-1 block w-full pl-3 pr-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                 </div>
                        <div>
                            <button id="apply-filters-button" class="w-full py-2 px-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 transform hover:scale-105">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Join by Code -->
                <div class="bg-blue-50 rounded-2xl p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Join</h3>
                    <div class="flex items-center gap-4">
                        <div class="flex-grow">
                            <label for="class-code-input" class="block text-sm font-medium text-gray-700 mb-2">Join Class by Code:</label>
                            <input type="text" id="class-code-input" placeholder="Enter Class Code" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        </div>
                        <div class="flex-shrink-0">
                            <button id="join-by-code-button" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 transform hover:scale-105 mt-6">
                                Join Class
                            </button>
                        </div>
                    </div>
                    <div id="join-by-code-message" class="mt-4 text-center text-sm"></div>
                </div>

                <!-- Class listing area -->
                <div id="class-list" class="mt-6 space-y-6">
                    <!-- Class cards will be loaded here -->
                    <p class="text-gray-600 italic">Loading classes...</p>
                </div>
            </div>


        </div>
    </div>

    <!-- Add Class Modal (Remains the same) -->
    <div id="add-class-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Class</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="add-class-form">
                            <div class="form-group">
                                <label for="class-title">Title:</label>
                                <input type="text" id="class-title" required>
                            </div>
                            <div class="form-group">
                                <label for="class-description">Description:</label>
                                <textarea id="class-description" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="class-venue-id">Venue:</label>
                                <select id="class-venue-id" required>
                                     <option value="">Loading venues...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="class-style-ids">Styles:</label>
                                <select id="class-style-ids" multiple required> <!-- Added 'multiple' for selecting multiple styles -->
                                     <option value="">Loading styles...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="class-grading-ids">Grading IDs (comma-separated):</label>
                                <input type="text" id="class-grading-ids" placeholder="e.g., uuidA,uuidB">
                            </div>
                            <div class="form-group">
                                <label for="class-price">Price (optional):</label>
                                <input type="text" id="class-price" placeholder="e.g., 10.50">
                            </div>
                             <div class="form-group">
                                <label for="class-publish-mode">Publish Mode (int):</label>
                                <input type="number" id="class-publish-mode" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="class-capacity">Capacity:</label>
                                <input type="number" id="class-capacity" value="10" required>
                            </div>

                             <!-- Frequency Section -->
                            <div class="form-group">
                                <label>Frequency:</label>
                                <div id="frequency-container" class="space-y-4">
                                    <!-- Frequency entries will be added here -->
                                </div>
                                <button type="button" id="add-frequency-button" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200 mt-4">Add Frequency Slot</button>
                            </div>

                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="class-notify-booking">
                                <label for="class-notify-booking">Notify on Booking</label>
                            </div>
                             <div class="form-group">
                                <label for="class-waiver-id">Waiver ID (optional):</label>
                                <input type="text" id="class-waiver-id" placeholder="e.g., optional-waiver-uuid">
                            </div>

                            <div id="create-class-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-create-class">Create Class</button>
                    </div>
                </div>
            </div>

             <!-- Edit Class Modal (New) -->
            <div id="edit-class-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Class</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="edit-class-form">
                            <input type="hidden" id="edit-class-id"> <!-- Hidden field for class ID -->
                            <div class="form-group">
                                <label for="edit-class-title">Title:</label>
                                <input type="text" id="edit-class-title" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-class-description">Description:</label>
                                <textarea id="edit-class-description" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-class-venue-id">Venue:</label>
                                <select id="edit-class-venue-id" required>
                                     <option value="">Loading venues...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-class-style-ids">Styles:</label>
                                <select id="edit-class-style-ids" multiple required>
                                     <option value="">Loading styles...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-class-grading-ids">Grading IDs (comma-separated):</label>
                                <input type="text" id="edit-class-grading-ids" placeholder="e.g., uuidA,uuidB">
                            </div>
                            <div class="form-group">
                                <label for="edit-class-price">Price (optional):</label>
                                <input type="text" id="edit-class-price" placeholder="e.g., 10.50">
                            </div>
                             <div class="form-group">
                                <label for="edit-class-publish-mode">Publish Mode (int):</label>
                                <input type="number" id="edit-class-publish-mode" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-class-capacity">Capacity:</label>
                                <input type="number" id="edit-class-capacity">
                            </div>
                            <div class="form-group">
                                <label for="edit-class-free_lessons">Free Lessons:</label>
                                <input type="number" id="edit-class-free_lessons">
                            </div>

                             <!-- Frequency Section for Edit -->
                            <div class="form-group">
                                <label>Frequency:</label>
                                <div id="edit-frequency-container" class="space-y-4">
                                    <!-- Frequency entries will be loaded/added here -->
                                </div>
                                <button type="button" id="add-edit-frequency-button" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200 mt-4">Add Frequency Slot</button>
                            </div>

                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="edit-class-notify-booking">
                                <label for="edit-class-notify-booking">Notify on Booking</label>
                            </div>
                             <div class="form-group">
                                <label for="edit-class-waiver-id">Waiver ID (optional):</label>
                                <input type="text" id="edit-class-waiver-id" placeholder="e.g., optional-waiver-uuid">
                            </div>

                            <div id="edit-class-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-edit-class">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Venue Info Modal (New) -->
        <div id="venue-info-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Venue Information</h3>
                    <span class="close-button">&times;</span>
                </div>
                <div class="modal-body" id="venue-info-content">
                    <!-- Venue details and map will be loaded here -->
                    <p>Loading venue information...</p>
                </div>
                    <div class="modal-footer">
                    <button type="button" class="cancel-button">Close</button>
                </div>
            </div>
        </div>



        <!-- Section: Venues -->
        <div id="venuesSection" class="portal-section">
            <!-- Modern Header with Gradient Icon -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Venues Management</h2>
                            <p class="text-gray-600">Manage and organize your training locations</p>
                        </div>
                    </div>
                    <button id="add-venue-button" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-medium rounded-lg hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add Venue
                    </button>
                </div>

                <!-- Enhanced Filter and Sort Controls -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="venue-search" class="block text-sm font-medium text-gray-700 mb-1">Search Venues</label>
                            <div class="relative">
                                <input type="text" id="venue-search" placeholder="Search by name, address..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="venue-sort-by" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="venue-sort-by" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 sm:text-sm bg-white">
                                <option value="title">Name (A-Z)</option>
                                <option value="distance">Distance</option>
                                <option value="created">Recently Added</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="apply-venue-filters-button" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors duration-200">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modern Venue List Container -->
            <div id="venue-list" class="space-y-4">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading venues...</p>
                </div>
            </div>


            <!-- Add Venue Modal (Remains the same) -->
            <div id="add-venue-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Venue</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="add-venue-form">
                            <div class="form-group">
                                <label for="venue-title">Title:</label>
                                <input type="text" id="venue-title" required>
                            </div>
                            <div class="form-group">
                                <label for="venue-description">Description (optional):</label>
                                <textarea id="venue-description" rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="venue-address">Address (optional):</label>
                                <input type="text" id="venue-address">
                            </div>
                            <div class="form-group">
                                <label for="venue-suburb">Suburb (optional):</label>
                                <input type="text" id="venue-suburb">
                            </div>
                            <div class="form-group">
                                <label for="venue-state">State (optional):</label>
                                <input type="text" id="venue-state">
                            </div>
                            <div class="form-group">
                                <label for="venue-postcode">Postcode (optional):</label>
                                <input type="text" id="venue-postcode">
                            </div>
                            <div class="form-group">
                                <label for="venue-country">Country (optional):</label>
                                <input type="text" id="venue-country">
                            </div>
                            <div class="form-group">
                                <label for="venue-latitude">Latitude (optional):</label>
                                <input type="text" id="venue-latitude" placeholder="e.g., -33.8688">
                            </div>
                            <div class="form-group">
                                <label for="venue-longitude">Longitude (optional):</label>
                                <input type="text" id="venue-longitude" placeholder="e.g., 151.2093">
                            </div>
                            <div class="form-group">
                                <label for="venue-contact-phone">Contact Phone (optional):</label>
                                <input type="text" id="venue-contact-phone">
                            </div>

                            <div id="create-venue-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-create-venue">Create Venue</button>
                    </div>
                </div>
            </div>

            <!-- Edit Venue Modal (New) -->
            <div id="edit-venue-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Venue</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="edit-venue-form">
                            <input type="hidden" id="edit-venue-id"> <!-- Hidden field for venue ID -->
                            <div class="form-group">
                                <label for="edit-venue-title">Title:</label>
                                <input type="text" id="edit-venue-title" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-description">Description (optional):</label>
                                <textarea id="edit-venue-description" rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-address">Address (optional):</label>
                                <input type="text" id="edit-venue-address">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-suburb">Suburb (optional):</label>
                                <input type="text" id="edit-venue-suburb">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-state">State (optional):</label>
                                <input type="text" id="edit-venue-state">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-postcode">Postcode (optional):</label>
                                <input type="text" id="edit-venue-postcode">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-country">Country (optional):</label>
                                <input type="text" id="edit-venue-country">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-latitude">Latitude (optional):</label>
                                <input type="text" id="edit-venue-latitude" placeholder="e.g., -33.8688">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-longitude">Longitude (optional):</label>
                                <input type="text" id="edit-venue-longitude" placeholder="e.g., 151.2093">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-contact-phone">Contact Phone (optional):</label>
                                <input type="text" id="edit-venue-contact-phone">
                            </div>

                            <div id="edit-venue-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-edit-venue">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Section: Styles -->
        <div id="stylesSection" class="portal-section">
            <!-- Modern Header with Gradient Icon -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Styles Management</h2>
                            <p class="text-gray-600">Manage martial arts styles and disciplines</p>
                        </div>
                    </div>
                    <button id="add-style-button" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-orange-600 to-red-600 text-white font-medium rounded-lg hover:from-orange-700 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add Style
                    </button>
                </div>

                <!-- Enhanced Filter and Sort Controls -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="style-search" class="block text-sm font-medium text-gray-700 mb-1">Search Styles</label>
                            <div class="relative">
                                <input type="text" id="style-search" placeholder="Search by name, description..." class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 sm:text-sm">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="style-sort-by" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="style-sort-by" class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 sm:text-sm bg-white">
                                <option value="title">Name (A-Z)</option>
                                <option value="created">Recently Added</option>
                                <option value="popularity">Most Popular</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="apply-style-filters-button" class="w-full px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors duration-200">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modern Style List Container -->
            <div id="style-list" class="space-y-4">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading styles...</p>
                </div>
            </div>

            <!-- Add Style Modal (Remains the same) -->
            <div id="add-style-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Style</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="add-style-form">
                            <div class="form-group">
                                <label for="style-title">Title:</label>
                                <input type="text" id="style-title" required>
                            </div>
                            <div class="form-group">
                                <label for="style-description">Description (optional):</label>
                                <textarea id="style-description" rows="4"></textarea>
                            </div>

                            <div id="create-style-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-create-style">Create Style</button>
                    </div>
                </div>
            </div>

            <!-- Edit Style Modal (New) -->
            <div id="edit-style-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Style</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="edit-style-form">
                            <input type="hidden" id="edit-style-id"> <!-- Hidden field for style ID -->
                            <div class="form-group">
                                <label for="edit-style-title">Title:</label>
                                <input type="text" id="edit-style-title" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-style-description">Description (optional):</label>
                                <textarea id="edit-style-description" rows="4"></textarea>
                            </div>

                            <div id="edit-style-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-edit-style">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

         <!-- Section: Waivers -->
        <div id="waiversSection" class="portal-section">
            <!-- Modern Header with Gradient Icon -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-lg flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Waiver Management</h2>
                            <p class="text-gray-600">Manage liability waivers and legal documents</p>
                        </div>
                    </div>
                    <button id="create-waiver-button" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-teal-600 to-cyan-600 text-white font-medium rounded-lg hover:from-teal-700 hover:to-cyan-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg" style="display: none;">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Create New Waiver
                    </button>
                </div>
            </div>

            <!-- Modern Waiver Display Card -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-gradient-to-r from-teal-50 to-cyan-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Current Waiver</h3>
                    <p class="text-sm text-gray-600 mt-1">Review and accept the liability waiver below</p>
                </div>
                <div id="latest-waiver-display" class="p-6">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">Loading waiver...</p>
                    </div>
                </div>
            </div>

            <!-- Modern Accept Waiver Area -->
            <div id="accept-waiver-area" class="bg-white rounded-lg shadow-md p-6">
                <div id="accept-waiver-message" class="message text-center mb-4"></div>
                <div class="text-center">
                    <button id="accept-waiver-button" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-medium rounded-lg hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 shadow-md hover:shadow-lg" style="display: none;">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Accept Waiver
                    </button>
                </div>
            </div>

            <!-- Waiver Creation Modal -->
            <div id="create-waiver-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create New Waiver Version</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                         <div class="form-group">
                            <label for="new-waiver-title">Title:</label>
                            <input type="text" id="new-waiver-title" rows="1" placeholder="Enter the new waiver title here...">
                         </div>
                         <div class="form-group">
                            <label for="new-waiver-content">Content:</label>
                            <textarea id="new-waiver-content" rows="15" placeholder="Enter the new waiver content here..."></textarea>
                         </div>
                         <div id="create-waiver-error" class="message"></div>
                    </div>
                    <div class="modal-footer">
                         <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-new-waiver">Submit Waiver</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Locations -->
        <div id="locationsSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Locations</h2>
            <p class="text-gray-700 mb-6">Find gym locations and details.</p>
             <!-- You could potentially fetch and display multiple locations here -->
             <div class="map-section mb-8">
                <p class="text-xl font-semibold text-gray-800 mb-3 text-center">Leura Gym (Example)</p>
                <div class="map-container rounded-lg overflow-hidden shadow-md">
                    <!-- Replace this iframe with the actual OpenStreetMap embed code for your location -->
                     <iframe
                        loading="lazy"
                        width="100%"
                        height="450"
                        frameborder="0"
                        scrolling="no"
                        marginheight="0"
                        marginwidth="0"
                        src="https://www.openstreetmap.org/export/embed.html?bbox=149.5054,-33.3695,150.7585,-33.8664&amp;layer=mapnik&amp;marker=-33.69791913672688, 150.33542282204206"
                        style="border: 1px solid black"
                    ></iframe>
                     <br/><small><a href="https://www.openstreetmap.org/?mlat=-33.7115&amp;mlon=150.3376#map=16/-33.7115/150.3376">View Larger Map</a></small>
                </div>
                 <p class="text-sm text-gray-600 italic mt-2 text-center">Map data ¬© OpenStreetMap contributors.</p>
            </div>
        </div>


		<!-- Section: PaymentPlans -->
		<div id="payment_plansSection" class="portal-section">
			<h2 class="text-2xl font-bold text-gray-900 mb-4">Payment Plans</h2>

			<!-- User‚Äôs Active Memberships -->
			<div id="userMemberships" class="mb-8 text-center">
				<p class="text-gray-600 italic">Loading your memberships‚Ä¶</p>
			</div>

			<!-- Purchasable Plans Grid -->
			<div id="purchasablePlansGrid" class="grid grid-cols-2 gap-4 mb-12">
				<!-- Filled dynamically -->
			</div>

			<!-- Admin-only: adjust all plans -->
			<div id="adminPaymentPlansSection" style="display: none;">
				<h3 class="text-xl font-semibold text-gray-800 mb-4">
				Admin: Current Payment Plans
				</h3>
				<div
				id="adminPlansGrid"
				class="grid grid-cols-2 gap-4 mb-6 text-sm"
				></div>
			</div>
		</div>

		<!-- Admin Edit Payment Plan Modal -->
		<div id="edit-paymentplan-modal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
				<h3>Edit Payment Plan</h3>
				<span class="close-button">&times;</span>
				</div>
				<div class="modal-body">
				<form id="edit-paymentplan-form">
					<input type="hidden" id="edit-pp-id" />
					<div class="form-group">
					<label>Title:</label>
					<input
						type="text"
						id="edit-pp-title"
						class="w-full"
					/>
					</div>
					<div class="form-group">
					<label>Description:</label>
					<textarea
						id="edit-pp-desc"
						rows="2"
						class="w-full"
					></textarea>
					</div>
					<div class="form-group">
					<label>Cost:</label>
					<input
						type="number"
						step="0.01"
						id="edit-pp-cost"
						class="w-full"
					/>
					</div>
					<div class="form-group">
					<label>Duration:</label>
					<select id="edit-pp-duration" disabled class="w-full">
						<option value="1">Calendar Month</option>
						<option value="2">School Term</option>
					</select>
					</div>
					<div class="form-group">
					<label>Type:</label>
					<select id="edit-pp-type" class="w-full">
						<option value="0">Individual</option>
						<option value="1">Family</option>
					</select>
					</div>
					<div class="form-group">
					<label>Min Age:</label>
					<input type="number" id="edit-pp-min-age" class="w-full" />
					</div>
					<div class="form-group">
					<label>Max Age:</label>
					<input type="number" id="edit-pp-max-age" class="w-full" />
					</div>
					<div class="form-group checkbox-group">
					<input type="checkbox" id="edit-pp-is-working" />
					<label for="edit-pp-is-working">Applies if Working</label>
					</div>
				</form>
				<div id="edit-pp-message" class="message text-center"></div>
				</div>
				<div class="modal-footer">
				<button type="button" class="cancel-button">Cancel</button>
				<button
					type="button"
					class="submit-button"
					id="submit-edit-paymentplan"
				>
					Save Changes
				</button>
				</div>
			</div>
		</div>


        <!-- Section: Kiosk -->
        <div id="kioskSection" class="portal-section">
            <div class="section-card bg-white rounded-3xl shadow-xl p-8 mb-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 font-poppins">Kiosk Mode</h1>
                        <p class="text-gray-600 mt-2">Select a venue to start kiosk mode for student check-ins</p>
                    </div>
                    <div class="flex-shrink-0 w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Available Venues</h3>
                    <div id="kiosk-venues-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p class="text-gray-600 italic col-span-full text-center py-8">Loading venues...</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- Section: POS -->
        <div id="posSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Today's Schedule</h2>
            <div id="calendar-container" class="bg-white rounded-lg shadow-sm border">
                <div id="calendar-header" class="bg-gray-50 px-4 py-3 border-b">
                <h3 id="current-date" class="text-lg font-semibold text-gray-900"></h3>
                </div>
                <div id="calendar-body" class="p-4">
                <div id="calendar-grid" class="relative">
                    <div id="time-slots"></div>
                    <div id="events-container" class="absolute top-0 left-0 w-full"></div>
                </div>
                </div>
            </div>
        </div>

        <!-- Attendance Modal -->
        <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gray-50 px-6 py-4 border-b">
                    <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 id="modal-event-title" class="text-xl font-bold text-gray-900"></h3>
                        <p id="modal-event-description" class="text-gray-600 mt-1"></p>
                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                        <span id="modal-event-location"></span>
                        <span id="modal-event-time"></span>
                        </div>
                    </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                        √ó
                    </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6 overflow-auto max-h-[calc(90vh-120px)]">
                    <!-- Search Section -->
                    <div class="mb-6">
                    <div class="relative">
                        <input
                        type="text"
                        id="student-search"
                        placeholder="Search for a student..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                        <div class="absolute right-3 top-3 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="search-results" class="hidden mt-3 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    </div>
                    </div>

                    <!-- View Toggle -->
                    <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-900">Class Students</h4>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="list-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">
                        List
                        </button>
                        <button id="grid-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                        Grid
                        </button>
                    </div>
                    </div>

                    <!-- Students Display -->
                    <div id="students-container">
                    <div id="students-list-view" class="space-y-2">
                        <!-- List view students will be populated here -->
                    </div>
                    <div id="students-grid-view" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Grid view students will be populated here -->
                    </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-2">Loading students...</p>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Section: Users -->
        <div id="usersSection" class="portal-section">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Users</h2>
                    <p class="text-gray-700">Allocate user permissions.</p>
                </div>
                <button id="addUserBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                    Add User
                </button>
            </div>

            <!-- Filter & Sort Controls -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-2">
            <input
                type="text"
                id="userSearch"
                placeholder="Search by name or email..."
                class="w-full sm:w-1/2 px-4 py-2 border border-gray-300 rounded"
            />
            <select
                id="userSort"
                class="px-3 py-2 border border-gray-300 rounded"
            >
                <option value="">Sort By</option>
                <option value="name">Name (A-Z)</option>
                <option value="email">Email (A-Z)</option>
            </select>
            </div>
        
            <!-- User List -->
            <div id="user-list" class="mt-6 space-y-4">
            <p class="text-gray-600 italic">Loading users...</p>
            </div>
        </div>

        <!-- Class History Modal -->
        <div id="classHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                    <!-- Modal Header -->
                    <div class="bg-purple-50 px-6 py-4 border-b">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 id="history-class-title" class="text-xl font-bold text-gray-900"></h3>
                                <p class="text-gray-600 mt-1">Class Attendance History & Payment Records</p>
                            </div>
                            <button id="closeHistoryModal" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                                √ó
                            </button>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="p-6 overflow-auto max-h-[calc(90vh-120px)]">
                        <!-- Filters Section -->
                        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="history-date-from" class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                                    <input type="date" id="history-date-from" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div>
                                    <label for="history-date-to" class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                                    <input type="date" id="history-date-to" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div class="flex items-end">
                                    <button id="apply-history-filters" class="w-full bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition duration-200">
                                        Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Summary Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div id="total-sessions" class="text-2xl font-bold text-blue-600">-</div>
                                <div class="text-sm text-gray-600">Total Sessions</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div id="total-attendees" class="text-2xl font-bold text-green-600">-</div>
                                <div class="text-sm text-gray-600">Total Attendees</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <div id="total-revenue" class="text-2xl font-bold text-purple-600">-</div>
                                <div class="text-sm text-gray-600">Total Revenue</div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg text-center">
                                <div id="avg-attendance" class="text-2xl font-bold text-orange-600">-</div>
                                <div class="text-sm text-gray-600">Avg Attendance</div>
                            </div>
                        </div>

                        <!-- History Table -->
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                                <h4 class="text-lg font-medium text-gray-900">Attendance Records</h4>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Check-in Time</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Method</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- History records will be loaded here -->
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading history...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Export Options -->
                        <div class="mt-6 flex justify-between items-center">
                            <div class="text-sm text-gray-600">
                                <span id="history-total-records">0</span> records found
                            </div>
                            <div class="flex gap-2">
                                <button id="export-history-csv" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200 text-sm">
                                    Export CSV
                                </button>
                                <button id="export-history-pdf" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200 text-sm">
                                    Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div id="userEditModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white w-full max-w-3xl p-6 rounded-lg relative overflow-y-auto max-h-[90vh]">
            <button id="closeUserEditModalBtn" class="absolute top-2 right-2 text-gray-500 hover:text-black text-xl">&times;</button>
            
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Edit User</h2>
            
            <form id="editUserForm" class="space-y-6 overflow-y-auto">
                <input type="hidden" id="edit_user_id" />
        
                <!-- Same fields as Account section (copy/paste from your Account form) -->
                <div class="form-group">
                <label for="edit_email">Email:</label>
                <input type="email" id="edit_email"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_first_name">First Name:</label>
                <input type="text" id="edit_first_name" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_surname">Surname:</label>
                <input type="text" id="edit_surname" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_gender">Gender:</label>
                <select id="edit_gender"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
                </div>
        
                <div class="form-group">
                <label for="edit_phone">Phone:</label>
                <input type="tel" id="edit_phone" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_dob">Date of Birth:</label>
                <input type="date" id="edit_dob"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_address">Address:</label>
                <input type="text" id="edit_address" maxlength="512"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_suburb">Suburb:</label>
                <input type="text" id="edit_suburb" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <h4 class="text-lg font-semibold text-gray-800 mt-6 mb-3">Emergency Contact</h4>
        
                <div class="form-group">
                <label for="edit_emergency_name">Name:</label>
                <input type="text" id="edit_emergency_name" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_emergency_relationship">Relationship:</label>
                <input type="text" id="edit_emergency_relationship" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_emergency_phone">Phone:</label>
                <input type="tel" id="edit_emergency_phone" maxlength="64"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_emergency_medical">Medical Notes:</label>
                <textarea id="edit_emergency_medical" rows="3"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm"></textarea>
                </div>
        
                <h4 class="text-lg font-semibold text-gray-800 mt-6 mb-3">Uniform Details</h4>
        
                <div class="form-group">
                <label for="edit_belt_size">Belt Size:</label>
                <input type="number" id="edit_belt_size" min="0" max="100"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <div class="form-group">
                <label for="edit_uniform_size">Uniform Size:</label>
                <input type="number" id="edit_uniform_size" min="0" max="100"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
        
                <!-- Read-only fields
                <div id="editModalReadOnlyFields" class="mt-6 text-sm text-gray-600 space-y-1">
                <p><strong>User ID:</strong> <span id="edit_user_id_display"></span></p>
                <p><strong>Member #:</strong> <span id="edit_member_number_display"></span></p>
                <p><strong>Joined:</strong> <span id="edit_created_ts_display"></span></p>
                <p><strong>Contracted Until:</strong> <span id="edit_contracted_until_display"></span></p>
                <p><strong>Email Verified:</strong> <span id="edit_email_verified_display"></span></p>
                <p><strong>Waiver ID:</strong> <span id="edit_waiver_id_display"></span></p>
                <p><strong>Photo ID:</strong> <span id="edit_photo_id_display"></span></p>
                <p><strong>Stripe Payment ID:</strong> <span id="edit_stripe_payment_method_id_display"></span></p>
                </div> -->
        
                <!-- Actions -->
                <div class="flex justify-between mt-6">
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Update</button>
                <button type="button" id="inviteUserBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Invite</button>
                </div>
        
                <div id="editUserStatusMessage" class="mt-4 text-center text-gray-700"></div>
            </form>

            <!-- Admin Stripe Card Section -->
            <div id="admin-stripe-section" class="mt-10 p-6 bg-gray-50 rounded-lg border-t pt-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Payment Method</h3>
            
                <form id="stripe-card-form-admin" class="space-y-4">
                <div class="form-group">
                    <label for="stripe-cardholder-name-admin" class="block text-sm font-medium text-gray-700">Cardholder Name</label>
                    <input type="text" id="stripe-cardholder-name-admin" placeholder="John Doe" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md sm:text-sm">
                </div>
            
                <div class="form-group">
                    <label for="card-element-admin" class="block text-sm font-medium text-gray-700">Card Details</label>
                    <div id="card-element-admin" class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm bg-white"></div>
                    <div id="card-errors-admin" role="alert" class="mt-2 text-sm text-red-600"></div>
                </div>
            
                <button type="submit" id="stripe-submit-btn-admin"
                        class="w-full py-2 px-4 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    Save Payment Method
                </button>
                </form>
            
                <div id="stripe-loading-admin" class="hidden mt-4 text-center">
                <p class="text-gray-600">Processing...</p>
                </div>
            
                <div id="stripe-result-admin" class="mt-4"></div>
            
                <div class="mt-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Saved Payment Methods</h4>
                <div id="saved-cards-list-admin" class="space-y-2">
                    <p class="text-gray-600">Loading saved cards...</p>
                </div>
                <button type="button" id="refresh-cards-admin"
                        class="mt-3 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    Refresh Cards
                </button>
                </div>
            </div>

            </div>
        </div>



        <!-- Section: School Settings -->
        <div id="settingsSection" class="portal-section">
            <div class="section-card bg-white rounded-3xl shadow-xl p-8 mb-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 font-poppins">School Settings</h1>
                        <p class="text-gray-600 mt-2">Configure your school's preferences and payment settings</p>
                    </div>
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- School Settings Form -->
                <form id="schoolSettingsForm" class="space-y-8">
                    
                    <!-- General Settings -->
                    <div class="bg-gray-50 rounded-2xl p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            General Settings
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="school-name" class="block text-sm font-medium text-gray-700 mb-2">School Name</label>
                                <input type="text" id="school-name" name="school_name" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                       placeholder="Enter your school name">
                            </div>
                            
                            <div>
                                <label for="school-timezone" class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                                <select id="school-timezone" name="timezone" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                                    <option value="">Select Timezone</option>
                                    <!-- Australia/Oceania -->
                                    <optgroup label="Australia/Oceania">
                                        <option value="Australia/Sydney">Australia/Sydney (AEST/AEDT)</option>
                                        <option value="Australia/Melbourne">Australia/Melbourne (AEST/AEDT)</option>
                                        <option value="Australia/Brisbane">Australia/Brisbane (AEST)</option>
                                        <option value="Australia/Adelaide">Australia/Adelaide (ACST/ACDT)</option>
                                        <option value="Australia/Perth">Australia/Perth (AWST)</option>
                                        <option value="Australia/Darwin">Australia/Darwin (ACST)</option>
                                        <option value="Australia/Hobart">Australia/Hobart (AEST/AEDT)</option>
                                        <option value="Pacific/Auckland">New Zealand (NZST/NZDT)</option>
                                    </optgroup>
                                    <!-- Americas -->
                                    <optgroup label="Americas">
                                        <option value="America/New_York">US Eastern (EST/EDT)</option>
                                        <option value="America/Chicago">US Central (CST/CDT)</option>
                                        <option value="America/Denver">US Mountain (MST/MDT)</option>
                                        <option value="America/Los_Angeles">US Pacific (PST/PDT)</option>
                                        <option value="America/Toronto">Canada Eastern (EST/EDT)</option>
                                        <option value="America/Vancouver">Canada Pacific (PST/PDT)</option>
                                    </optgroup>
                                    <!-- Europe -->
                                    <optgroup label="Europe">
                                        <option value="Europe/London">UK (GMT/BST)</option>
                                        <option value="Europe/Paris">Central Europe (CET/CEST)</option>
                                        <option value="Europe/Berlin">Germany (CET/CEST)</option>
                                        <option value="Europe/Madrid">Spain (CET/CEST)</option>
                                        <option value="Europe/Rome">Italy (CET/CEST)</option>
                                    </optgroup>
                                    <!-- Asia -->
                                    <optgroup label="Asia">
                                        <option value="Asia/Tokyo">Japan (JST)</option>
                                        <option value="Asia/Shanghai">China (CST)</option>
                                        <option value="Asia/Seoul">South Korea (KST)</option>
                                        <option value="Asia/Singapore">Singapore (SGT)</option>
                                        <option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
                                        <option value="Asia/Bangkok">Thailand (ICT)</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Stripe Payment Settings -->
                    <div class="bg-gray-50 rounded-2xl p-6">
                        <h3 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Stripe Payment Configuration
                        </h3>
                        
                        <div class="space-y-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="text-sm text-blue-800">
                                        <p class="font-medium">Stripe Configuration</p>
                                        <p>Configure your Stripe keys to enable payment processing. You can find these keys in your Stripe Dashboard.</p>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="stripe-publishable-key" class="block text-sm font-medium text-gray-700 mb-2">
                                    Stripe Publishable Key
                                    <span class="text-gray-500 text-xs">(starts with pk_live_)</span>
                                </label>
                                <input type="text" id="stripe-publishable-key" name="stripe_publishable_key"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-200"
                                       placeholder="pk_live_...">
                            </div>
                            
                            <div>
                                <label for="stripe-secret-key" class="block text-sm font-medium text-gray-700 mb-2">
                                    Stripe Secret Key
                                    <span class="text-gray-500 text-xs">(starts with sk_live_)</span>
                                </label>
                                <input type="password" id="stripe-secret-key" name="stripe_secret_key"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-200"
                                       placeholder="sk_live_...">
                            </div>
                            
                            <div>
                                <label for="stripe-webhook-secret" class="block text-sm font-medium text-gray-700 mb-2">
                                    Stripe Webhook Endpoint Secret
                                    <span class="text-gray-500 text-xs">(starts with whsec_)</span>
                                </label>
                                <input type="password" id="stripe-webhook-secret" name="stripe_webhook_secret"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition duration-200"
                                       placeholder="whsec_...">
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="resetSettingsBtn"
                                class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 transition duration-200">
                            Reset Changes
                        </button>
                        <button type="button" id="saveSettingsBtn"
                                class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-lg hover:from-blue-700 hover:to-indigo-700 focus:ring-2 focus:ring-blue-500 transition duration-200 transform hover:scale-105">
                            üíæ Save Settings
                        </button>
                    </div>

                    <!-- Status Message -->
                    <div id="settingsStatusMessage" class="hidden mt-4 p-4 rounded-lg"></div>
                </form>
            </div>
        </div>

        <!-- Section: Account -->
        <div id="accountSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Account Settings</h2>

            <!-- Profile Update Form -->
            <form id="profileUpdateForm" class="space-y-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Profile</h3>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required readonly disabled
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="first_name">First Name:</label>
                    <input type="text" id="first_name" name="first_name" required maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="surname">Surname:</label>
                    <input type="text" id="surname" name="surname" required maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone" maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="dob">Date of Birth:</label>
                    <input type="date" id="dob" name="dob"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" maxlength="512"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="suburb">Suburb:</label>
                    <input type="text" id="suburb" name="suburb" maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Emergency Contact</h4>
                 <div class="form-group">
                    <label for="emergency_name">Name:</label>
                    <input type="text" id="emergency_name" name="emergency_name" maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="emergency_relationship">Relationship:</label>
                    <input type="text"id="emergency_relationship" name="emergency_relationship" maxlength="64"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="emergency_phone">Phone:</label>
             <input type="tel" id="emergency_phone" name="emergency_phone" maxlength="64"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="emergency_medical">Medical Notes:</label>
             <textarea id="emergency_medical" name="emergency_medical" rows="4"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
         </div>
          <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Uniform Details</h4>
          <div class="form-group">
             <label for="belt_size">Belt Size:</label>
             <input type="number" id="belt_size" name="belt_size" min="0" max="100"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="uniform_size">Uniform Size:</label>
             <input type="number" id="uniform_size" name="uniform_size" min="0" max="100"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>

         <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Update Profile</button>
          <div id="profileStatusMessage" class="mt-4 text-center text-gray-700"></div>
     </form>

     <hr class="my-8 border-gray-300"> <!-- Separator -->

    <!-- Stripe card section -->
    <div class="mt-8 p-6 bg-gray-50 rounded-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Payment Method</h3>
        
        <form id="stripe-card-form" class="space-y-4">
            <div class="form-group">
                <label for="stripe-cardholder-name" class="block text-sm font-medium text-gray-700">Cardholder Name</label>
                <input type="text" id="stripe-cardholder-name" placeholder="John Doe" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <div class="form-group">
                <label for="card-element" class="block text-sm font-medium text-gray-700">Card Details</label>
                <div id="card-element" class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm bg-white">
                    <!-- Stripe Elements will create form elements here -->
                </div>
                <div id="card-errors" role="alert" class="mt-2 text-sm text-red-600"></div>
            </div>
            
            <button type="submit" id="stripe-submit-btn" 
                    class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Save Payment Method
            </button>
        </form>
        
        <div id="stripe-loading" class="hidden mt-4 text-center">
            <p class="text-gray-600">Processing...</p>
        </div>
        
        <div id="stripe-result" class="mt-4"></div>
        
        <div class="mt-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">Saved Payment Methods</h4>
            <div id="saved-cards-list" class="space-y-2">
                <p class="text-gray-600">Loading saved cards...</p>
            </div>
            <button type="button" id="refresh-cards" 
                    class="mt-3 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Refresh Cards
            </button>
        </div>
    </div>

    <hr class="my-8 border-gray-300"> <!-- Separator -->

     <!-- Change Password Form -->
     <form id="passwordChangeForm" class="space-y-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Change Password</h3>
          <div class="form-group">
             <label for="currentPassword">Current Password:</label>
             <input type="password" id="currentPassword" name="current_password" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="newPassword">New Password:</label>
             <input type="password" id="newPassword" name="new_password" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
              <label for="confirmNewPassword">Confirm New Password:</label>
              <input type="password" id="confirmNewPassword" name="confirm_new_password" required
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>

          <button type="submit" class="w-full py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Change Password</button>
          <div id="passwordStatusMessage" class="mt-4 text-center text-gray-700"></div>
     </form>

    </div> 
    <!-- Account section -- END -->

 <!-- Add more sections as needed -->
</div>

<footer class="mt-auto text-center py-4 text-gray-600 text-sm">
 <p>&copy; 2025 MMA Gym Management</p>
</footer>



    <script>

        const Permissions = {
            HyperAdmin: 0,
            SuperAdmin: 1,
            CreateSuperAdmin: 2,
            RemoveSuperAdmin: 3,
            CreateClass: 4,
            ModifyClass: 5,
            RemoveClass: 6,
            InstructClass: 7,
            ViewClass: 8,
            CreateClub: 9,
            ViewClub: 10,
            ModifyClub: 11,
            RemoveClub: 12,
            CreateWaiver: 13,
            AddStudent: 14,
            RemoveStudent: 15,
            ViewStudent: 16,
            ModifyStudent: 17,
            SendEmail: 18,
            CreateInstructor: 19,
            ModifyInstructor: 20,
            RemoveInstructor: 21,
            ViewInstructor: 22,
            CreateGrading: 23,
            ModifyGrading: 24,
            RemoveGrading: 25,
            ViewGrading: 26,
            RefundPayment: 27,
            DiscountStudent: 28,
            CreateDiscount: 29,
            ModifyDiscount: 30,
            RemoveDiscount: 31,
            Banned: 32,
            // Add any new permissions here, continuing the sequence
        };


        const StatWindow = {
            1: "HOUR",
            2: "DAY",
            3: "WEEK",
            4: "MONTH",
            5: "YEAR",
            6: "ALL",
        };

        const StatGender = {
            1: "Male",
            2: "Female",
            3: "Unknown",
        };

        const StatPayType = {
            1: "FreeLesson",
            2: "AllPlan",
            3: "FamilyPlan",
            4: "IndividualPlan",
            5: "Instructor",
            6: "NoCharge",
        };

        const StatCountType = {
            1: "AttendanceAll",
            2: "AttendanceGender",
            3: "AttendanceAge",
            4: "AttendancePay",
            5: "Revenue",
            6: "PendingRevenue",
            7: "Refunded",
        };

        const StatIdType = {
            1: "SCHOOL",
            2: "CLASS",
            3: "VENUE",
            4: "CLUB",
        };

        let attendanceChart;
        // Dashboard -- start
        const attendanceChartCtx = document.getElementById('attendanceChart').getContext('2d');

        // Map timeFilter to StatWindow enum value
        const timeFilterToWindow = {
            today: 1,         // HOUR
            yesterday: 1,     // HOUR (or handle differently if needed)
            week: 2,          // WEEK
            last_month: 4,    // MONTH
            last_3_months: 4, // MONTH (or handle differently)
            last_year: 5,     // YEAR
            all: 6,           // ALL
        };


        function formatLabel(ts, window) {
            const date = new Date(ts); // ts is in milliseconds
            switch (window) {
                case 1: // HOUR
                return date.toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                    hour: "2-digit",
                });
                case 2: // DAY
                return date.toLocaleDateString();
                case 3: // WEEK
                // Show week start date
                return "Week of " + date.toLocaleDateString();
                case 4: // MONTH
                return date.toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                });
                case 5: // YEAR
                return date.getFullYear().toString();
                case 6: // ALL
                return "All Time";
                default:
                return date.toLocaleString();
            }
        }



        var accounts = [];
        let userPermissions = []; // This should be set when the user logs in or is fetched from the server
        var my_user_id = null;
        var my_school_id = null;

        var cached_data = {};

        function add_cached_value(key_type, key, value) {
            key = key_type.toString() + "_" + key.toString(); // Ensure the key is a string
            value.cache_ts = Date.now();
            // console.log("Adding to cache:", key, value);
            cached_data[key] = value;
        }

        function get_cached_value(key_type, key) {
            key = key_type.toString() + "_" + key.toString(); // Ensure the key is a string

            if (cached_data[key] === undefined) {
                return null;
            }
            if (Date.now() - cached_data[key].cache_ts > 1000 * 60 * 5) { // 5 minutes
                delete cached_data[key];
                return null;
            }
            return cached_data[key];
        }


        /**
         * Checks if a user has a specific permission.
         * @param {number[]} userPermissionIntegers - An array of integers representing the user's permissions received from the backend.
         * @param {number} requiredPermission - The integer value of the permission you want to check for (e.g., Permissions.CreateWaiver).
         * @returns {boolean} - True if the user has the required permission, false otherwise.
         */
        function hasPermission(userPermissionIntegers, requiredPermissions) {
            if (!Array.isArray(requiredPermissions)) {
                console.error("requiredPermissions is not an array.");
                return false;
            }
            for (const requiredPermission of requiredPermissions) {

                // Ensure userPermissionIntegers is a valid array
                if (!Array.isArray(userPermissionIntegers)) {
                    console.error("userPermissionIntegers is not an array.");
                    return false;
                }
                if (requiredPermission === undefined) {
                    console.error("requiredPermission is undefined.");
                    return false;
                }
                if (typeof requiredPermission !== 'number') {
                    console.error("requiredPermission is not a number.");
                    return false;
                }
                if (userPermissionIntegers.length === 0) {
                    console.warn("userPermissionIntegers is empty.");
                    return false;
                }
                if (userPermissionIntegers.includes(Permissions.Banned)) {
                    console.warn("User is banned.");
                    return false;
                }
                if (userPermissionIntegers.includes(Permissions.HyperAdmin)) {
                    return true; // HyperAdmin has all permissions
                }
                if (userPermissionIntegers.includes(Permissions.SuperAdmin) && requiredPermission !== Permissions.CreateSuperAdmin && requiredPermission !== Permissions.RemoveSuperAdmin) {
                    return true; // SuperAdmin has all permissions
                }
                // Check if the required permission integer exists in the user's permissions array
                if (userPermissionIntegers.includes(requiredPermission)) {
                    return true; // User has the required permission
                }
            }
            return false; // Default to false if no permissions matched
        }




        // Helper function to display messages
        function displayMessage(element, message, isSuccess) {
            element.textContent = message;
            element.style.color = isSuccess ? 'green' : 'red';
        }

         // Basic email format validation (simple check)
         function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Basic phone number validation (allows numbers, +, -, spaces, parens)
         function isValidPhoneNumber(phone) {
            const phoneRegex = /^[\d\s\-\(\)\+]+$/;
            return phoneRegex.test(phone);
        }

        // Basic name validation (allows letters, spaces, hyphens) - adjust regex for international names if needed
         function isValidName(name) {
             const nameRegex = /^[a-zA-Z\s-]+$/;
             return nameRegex.test(name);
         }

        // Get elements related to accepting the waiver
        const acceptWaiverButton = document.getElementById('accept-waiver-button');
        const acceptWaiverMessageDiv = document.getElementById('accept-waiver-message');

        // Function to fetch and display the latest waiver
        async function fetchLatestWaiver() {
            const waiverDisplay = document.getElementById('latest-waiver-display');
            waiverDisplay.innerHTML = '<p>Loading waiver...</p>'; // Show loading state
            acceptWaiverButton.style.display = 'none'; // Hide button while loading
            acceptWaiverMessageDiv.textContent = ''; // Clear previous messages
            acceptWaiverMessageDiv.className = '';


            try {
                const response = await fetch('/api/waiver/get_latest_waiver', {
                    method: 'GET',
                });

                if (response.ok) { // Status 200-299
                    const waiverData = await response.json();
                    // Store the waiver ID just in case you need it later, though not displayed
                    waiverDisplay.dataset.waiverId = waiverData.waiver_id;
                    waiverDisplay.innerHTML = `
                        <p><strong>Latest Waiver Version:</strong></p>
                        <div style="border: 1px dashed #ccc; padding: 10px; max-height: 300px; overflow-y: auto;">
                            <pre>${waiverData.waiver}</pre> <!-- Use pre for preformatted text -->
                        </div>
                    `;

                    // Show the accept button if a waiver was found
                    acceptWaiverButton.style.display = 'block';
                } else if (response.status === 404) {
                     // No active waiver found
                     waiverDisplay.innerHTML = '<p>No current waiver has been published yet.</p>';
                     acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
                }
                 else if (response.status === 401 || response.status === 403) {
                     // Authentication/Authorization error
                      waiverDisplay.innerHTML = '<p style="color: red;">Error: You are not authorized to view waiver information.</p>';
                      console.error("Authorization error fetching waiver:", response.status);
                      acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
                 }
                 else {
                    // Other server errors (5xx) or client errors (4xx)
                    const errorText = await response.text();
                    waiverDisplay.innerHTML = `<p style="color: red;">Error loading waiver: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                    console.error("Error fetching waiver:", response.status, errorText);
                    acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
                }
            } catch (error) {
                // Network errors etc.
                waiverDisplay.innerHTML = `<p style="color: red;">Network error loading waiver.</p>`;
                console.error("Fetch error for waiver:", error);
                acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
            }
        }


        // --- Accept Waiver Logic ---

        // Event listener for the Accept button
        acceptWaiverButton.addEventListener('click', async () => {
            const waiverId = document.getElementById('latest-waiver-display').dataset.waiverId;

             if (!waiverId) {
                 acceptWaiverMessageDiv.textContent = 'Error: Could not determine waiver ID to accept.';
                 acceptWaiverMessageDiv.className = 'error';
                 console.error("Waiver ID data attribute missing.");
                 return;
             }

             // Optional: Disable button and show loading state
             acceptWaiverButton.disabled = true;
             acceptWaiverMessageDiv.textContent = 'Submitting acceptance...';
             acceptWaiverMessageDiv.className = ''; // Clear previous classes


            try {
                 const response = await fetch('/api/user/accept_waiver', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                        //  'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify({ waiver_id: waiverId })
                 });

                 const responseData = await response.json(); // Assuming response is JSON


                 if (response.ok && responseData.success) { // Check both HTTP status and custom success flag

                     acceptWaiverMessageDiv.textContent = 'Waiver accepted successfully!';
                     acceptWaiverMessageDiv.className = 'success';
                     acceptWaiverButton.style.display = 'none'; // Hide the button on success
                     // Optional: You might want to update the user's local state here
                     // or refetch the user profile to show the waiver_id is now set.
                 } else if (responseData && responseData.error_message) {
                     // Server returned a specific error message in the JSON body
                     acceptWaiverMessageDiv.textContent = `Acceptance failed: ${responseData.error_message}`;
                     acceptWaiverMessageDiv.className = 'error';
                     console.error("Server error accepting waiver:", response.status, responseData.error_message);
                 }
                  else if (response.status === 401 || response.status === 403) {
                     // Authentication/Authorization error
                      acceptWaiverMessageDiv.textContent = 'Error: You are not authorized to accept waivers.';
                      acceptWaiverMessageDiv.className = 'error';
                      console.error("Authorization error accepting waiver:", response.status);
                 }
                  else if (response.status === 409) { // Conflict (e.g., outdated waiver)
                       acceptWaiverMessageDiv.textContent = responseData.error_message || 'Waiver version is outdated. Please refresh.';
                       acceptWaiverMessageDiv.className = 'error';
                       console.warn("Conflict accepting waiver:", response.status, responseData.error_message);
                        // Consider prompting user to refresh or automatically refreshing the waiver display
                        fetchLatestWaiver();
                  }
                 else {
                     // Other errors
                      const errorText = await response.text();
                      acceptWaiverMessageDiv.textContent = `Error accepting waiver: ${response.status} - ${errorText.substring(0, 100)}...`;
                      acceptWaiverMessageDiv.className = 'error';
                      console.error("Error accepting waiver:", response.status, errorText);
                 }

            } catch (error) {
                 // Network errors etc.
                 acceptWaiverMessageDiv.textContent = 'Network error submitting waiver acceptance.';
                 acceptWaiverMessageDiv.className = 'error';
                 console.error("Fetch error for waiver acceptance:", error);
            } finally {
                 // Re-enable button regardless of success/failure, unless hidden
                 if (acceptWaiverButton.style.display !== 'none') {
                     acceptWaiverButton.disabled = false;
                 }
            }
        });


    

        // Get modal elements
        const createWaiverModal = document.getElementById('create-waiver-modal');
        const createWaiverButton = document.getElementById('create-waiver-button');
        const closeButton = createWaiverModal.querySelector('.close-button');
        const submitWaiverButton = document.getElementById('submit-new-waiver');
        const newWaiverContentTitle = document.getElementById('new-waiver-title');
        const newWaiverContentArea = document.getElementById('new-waiver-content');
        const createWaiverErrorDiv = document.getElementById('create-waiver-error');


        // Open the modal
        createWaiverButton.onclick = function() {
            createWaiverModal.style.display = 'block';
             createWaiverErrorDiv.textContent = ''; // Clear previous errors
             newWaiverContentArea.value = ''; // Clear previous content
             newWaiverContentTitle.value = ''; // Clear previous title
        }

        // Close the modal using the close button
        closeButton.onclick = function() {
            createWaiverModal.style.display = 'none';
        }

        // Close the modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == createWaiverModal) {
                createWaiverModal.style.display = 'none';
            }
        }

        // Submit the new waiver
        submitWaiverButton.onclick = async function() {
            const waiverContent = newWaiverContentArea.value.trim(); // Trim whitespace
            const waiverTitle = newWaiverContentTitle.value.trim(); // Trim whitespace

            if (!waiverContent) {
                createWaiverErrorDiv.textContent = 'Waiver content cannot be empty.';
                return;
            }

            if (!waiverTitle) {
                createWaiverErrorDiv.textContent = 'Waiver title cannot be empty.';
                return;
            }

             createWaiverErrorDiv.textContent = 'Submitting...'; // Show submitting state

             try {
                 const response = await fetch('/api/waiver/create', { // *** You'll need to implement this backend endpoint ***
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                        //  'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify({ content: waiverContent, title: waiverTitle }) 
                 });

                 const responseData = await response.json(); // Assuming the response is JSON

                 if (response.ok) { // Status 200-299
                     console.log("Waiver created successfully:", responseData);
                     createWaiverModal.style.display = 'none'; // Hide modal on success
                     newWaiverContentArea.value = ''; // Clear the text area
                     fetchLatestWaiver(); // Refresh the displayed waiver
                 } else if (responseData && responseData.error_message) {
                      // Server returned a specific error message in the JSON body
                      createWaiverErrorDiv.textContent = `Error: ${responseData.error_message}`;
                      console.error("Server error creating waiver:", response.status, responseData.error_message);
                 }
                  else if (response.status === 401 || response.status === 403) {
                     // Authentication/Authorization error
                      createWaiverErrorDiv.textContent = 'Error: You are not authorized to create waivers.';
                      console.error("Authorization error creating waiver:", response.status);
                 }
                 else {
                     // Other errors
                      const errorText = await response.text(); // Try to get any response text
                      createWaiverErrorDiv.textContent = `Error creating waiver: ${response.status} - ${errorText.substring(0, 100)}...`;
                      console.error("Error creating waiver:", response.status, errorText);
                 }

             } catch (error) {
                 // Network errors etc.
                 createWaiverErrorDiv.textContent = 'Network error submitting waiver.';
                 console.error("Fetch error for waiver creation:", error);
             }
        }


        // --- Section Switching Logic (Remains the same) ---
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.portal-section');
            const navLinks = document.querySelectorAll('nav ul li a[data-section]');

            // Get form elements and message divs
            const profileUpdateForm = document.getElementById('profileUpdateForm');
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            const profileStatusMessageDiv = document.getElementById('profileStatusMessage');
            const passwordStatusMessageDiv = document.getElementById('passwordStatusMessage');


            console.log('showSection called with:', sectionId);
            sections.forEach(section => {
                if (section.id === sectionId + 'Section') {
                    console.log('Showing section:', section.id);
                    section.classList.add('active');
                    section.style.display = 'block'; // Or 'flex'
                    
                    // Debug section dimensions after showing
                    setTimeout(() => {
                        const rect = section.getBoundingClientRect();
                        console.log(`${section.id} dimensions after show:`, rect.width, 'x', rect.height);
                        console.log(`${section.id} computed display:`, getComputedStyle(section).display);
                        console.log(`${section.id} parent:`, section.parentElement?.tagName, section.parentElement?.className);
                    }, 100);
                } else {
                    section.classList.remove('active');
                    section.style.display = 'none';
                }
            });

            navLinks.forEach(link => {
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
            history.pushState(null, '', `#${sectionId}`);

            
            if (sectionId === 'frontpage') {
                loadFrontpageStats();
            }
            if (sectionId === 'users') {
                initUsersSection();
            }
            if (sectionId === 'dashboard') {
                initDashboardSection();
            }
            if (sectionId === 'payment_plans') {
                initPaymentPlansSection();
            }
            if (sectionId === 'classes') {
                console.log('Switching to classes section, calling fetchAndDisplayClasses');
                fetchAndDisplayClasses(); // Fetch and display classes when this section is shown
            }
            if (sectionId === 'venues') {
                fetchAndDisplayVenues(); // Fetch and display venues when this section is shown
            }
            if (sectionId === 'kiosk') {
                fetchAndDisplayKioskVenues(); // Fetch and display venues for kiosk mode
            }
            if (sectionId === 'styles') {
                fetchAndDisplayStyles();
            }
            if (sectionId === 'pos') {
                fetchAndDisplayPOS();
            }
                // --- Load profile data when Account section is shown ---
                if (sectionId === 'account') {
                init_stripe();
                loadUserProfile();
                } else {
                    // Optional: Clear forms when leaving the section
                    profileUpdateForm.reset();
                    passwordChangeForm.reset();
                    profileStatusMessageDiv.textContent = '';
                    passwordStatusMessageDiv.textContent = '';
                }

                if (sectionId === 'waivers') {
                    fetchLatestWaiver(); // Load the latest waiver when this section is shown
                }
                
                if (sectionId === 'settings') {
                    loadSchoolSettings(); // Load school settings when this section is shown
                }
        }



        async function loadDashboardData() {
            // const classId = document.getElementById('classFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const countType = document.getElementById('countTypeFilter').value;
            const windowValue = timeFilterToWindow[timeFilter] || 6; // default to ALL
            // console.log("Loading dashboard data for classId:", classId, "timeFilter:", timeFilter, "countType:", countType);
            try {
                const res = await fetch(`/api/school/get_dashboard_data`);
                const { data } = await res.json();

                const classIds = Array.from(
                    new Set(
                        data
                        .filter(d => d.id_type === 2)
                        .map(d => d.id)
                    )
                );


                const classFilter = document.getElementById('classFilter');

                // Save the current selection (if any)
                const currentValue = classFilter.value;

                // Clear existing options
                classFilter.innerHTML = '';

                // Add "All Classes" option
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = 'All Classes';
                classFilter.appendChild(allOption);

                // Add options for each class ID
                for (const classId of classIds) {
                    const option = document.createElement('option');
                    option.value = classId;
                    var class_info = get_cached_value("class", classId);
                    if (class_info === null) {
                        await fetchAndDisplayClasses();
                    }
                    var class_info = get_cached_value("class", classId);
                    if (class_info === null) {
                        option.textContent = `Class ${classId}`;
                    } else {
                        option.textContent = `${class_info.title}`;
                    }
                    classFilter.appendChild(option);
                }

                // Restore previous selection if possible
                if (classIds.includes(currentValue)) {
                    classFilter.value = currentValue;
                }



                // Prepare datasets based on countType
                let attendanceDatasets = [];
                let revenueDatasets = [];
                // Filter data by selected window
                const windowData = data.filter(d => d.window === windowValue);

                var labels = [];

                if (countType === "AttendanceAll") {
                    labels = windowData.map(d => formatLabel(d.ts, d.window));

                    attendanceDatasets = [
                        {
                        label: "All",
                        data: windowData.map((d) => d.count),
                        borderColor: "#2563eb",
                        backgroundColor: "#2563eb20",
                        tension: 0.3,
                        },
                    ];
                } else if (countType === "AttendanceGender") {
                    if (windowValue === 6) {
                            // For ALL TIME, show a histogram (bar chart) of total counts per gender
                            const menTotal = windowData
                                    .filter(d => d.count_type === 2 && d.v1 === 1)
                                    .reduce((sum, d) => sum + d.count, 0);
                                const womenTotal = windowData
                                    .filter(d => d.count_type === 2 && d.v1 === 2)
                                    .reduce((sum, d) => sum + d.count, 0);
                                const unknownTotal = windowData
                                    .filter(d => d.count_type === 2 && d.v1 === 3)
                                    .reduce((sum, d) => sum + d.count, 0);

                                labels = ["Men", "Women", "Unknown"];
                                attendanceDatasets = [
                                {
                                    label: "Attendance by Gender (All Time)",
                                    data: [menTotal, womenTotal, unknownTotal],
                                    backgroundColor: ["#4b5563", "#10b981", "#f59e0b"],
                                },
                            ];
                        } else {
                            // Show last 7 days, even if no data
                            function getLastNDaysTimestamps(n) {
                                const days = [];
                                const now = new Date();
                                now.setHours(0, 0, 0, 0);
                                for (let i = n - 1; i >= 0; i--) {
                                const d = new Date(now);
                                d.setDate(now.getDate() - i);
                                days.push(d.getTime());
                                }
                                return days;
                            }

                            function buildGenderDayMap(genderValue) {
                                const map = {};
                                windowData
                                .filter(d => d.count_type === 2 && d.v1 === genderValue)
                                .forEach(d => {
                                    const dayTs = new Date(d.ts);
                                    dayTs.setHours(0, 0, 0, 0);
                                    map[dayTs.getTime()] = d.count;
                                });
                                return map;
                            }

                            const last7Days = getLastNDaysTimestamps(7);

                            const menMap = buildGenderDayMap(1);
                            const womenMap = buildGenderDayMap(2);
                            const unknownMap = buildGenderDayMap(3);

                            const menData = last7Days.map(ts => menMap[ts] || 0);
                            const womenData = last7Days.map(ts => womenMap[ts] || 0);
                            const unknownData = last7Days.map(ts => unknownMap[ts] || 0);

                            labels = last7Days.map(ts => {
                                const d = new Date(ts);
                                return d.toLocaleDateString();
                            });

                            attendanceDatasets = [
                                {
                                label: "Men",
                                data: menData,
                                borderColor: "#4b5563",
                                backgroundColor: "#4b556320",
                                tension: 0.3,
                                },
                                {
                                label: "Women",
                                data: womenData,
                                borderColor: "#10b981",
                                backgroundColor: "#10b98120",
                                tension: 0.3,
                                },
                                {
                                label: "Unknown",
                                data: unknownData,
                                borderColor: "#f59e0b",
                                backgroundColor: "#f59e0b20",
                                tension: 0.3,
                                },
                            ];
                        }
                } else if (countType === "Revenue") {
                    attendanceDatasets = [
                        {
                        label: "Casual Revenue ($)",
                        data: data.map((d) => d.casual_earned),
                        backgroundColor: "#3b82f6",
                        },
                        {
                        label: "Plan Revenue ($)",
                        data: data.map((d) => d.plan_earned),
                        backgroundColor: "#10b981",
                        },
                    ];
                    } else if (countType === "PendingRevenue") {
                    attendanceDatasets = [
                        {
                        label: "Pending Revenue ($)",
                        data: data.map((d) => d.pending_revenue),
                        backgroundColor: "#f59e0b",
                        },
                    ];
                    } else if (countType === "Refunded") {
                    attendanceDatasets = [
                        {
                        label: "Refunded ($)",
                        data: data.map((d) => d.refunded),
                        backgroundColor: "#ef4444",
                        },
                    ];
                }

                // Attendance Chart
                if (attendanceChart) attendanceChart.destroy();
                attendanceChart = new Chart(attendanceChartCtx, {
                    type: "line",
                    data: {
                        labels,
                        datasets: attendanceDatasets,
                    },
                    options: {
                        responsive: true,
                        plugins: {
                        legend: { position: "top" },
                        title: {
                            display: true,
                            text:
                            countType === "AttendanceAll"
                                ? "Lesson Attendance Over Time"
                                : countType === "AttendanceGender"
                                ? "Lesson Attendance by Gender"
                                : "",
                        },
                        },
                    },
                });


            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }



        async function loadFrontpageStats() {
            // Load dashboard statistics for the frontpage
            try {
                const response = await fetch('/api/school/get_dashboard_data');
                if (response.ok) {
                    const result = await response.json();
                    const data = result.data || [];
                    
                    // Calculate stats from the dashboard data
                    const stats = calculateDashboardStats(data);
                    console.log("Frontpage stats calculated:", stats);
                    
                    // Update the UI elements
                    document.getElementById('total-members-stat').textContent = stats.totalMembers.toLocaleString();
                    document.getElementById('active-classes-stat').textContent = stats.activeClasses.toLocaleString();
                    document.getElementById('todays-attendance-stat').textContent = stats.todaysAttendance.toLocaleString();
                    document.getElementById('monthly-revenue-stat').textContent = '$' + stats.monthlyRevenue.toLocaleString();
                    
                } else {
                    console.error('Failed to load dashboard stats:', response.status);
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        function formatDateInTZ(ts, tz) {
            const d = new Date(ts);
            const f = new Intl.DateTimeFormat("en-CA", {
                timeZone: tz,
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
            });
            // en-CA locale gives us YYYY-MM-DD output
            return f.format(d);
        }


        function calculateDashboardStats(data) {
            // Calculate statistics from the dashboard data
            let totalMembers = 0;
            let activeClasses = 0;
            let todaysAttendance = 0;
            let monthlyRevenue = 0;
            
            // Get today's date for filtering
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            if (data && data.length > 0) {
                // Get unique class IDs for active classes count (attendance records)
                // const classIds = new Set(data.filter(d => d.count_type === 1).map(d => d.id));
                // activeClasses = classIds.size;
                
                // Calculate stats from dashboard data
                data.forEach(d => {
                    // const recordDate = formatDateInTZ(d.ts, 'Australia/Sydney');

                    const recordDateStr = formatDateInTZ(d.ts, 'Australia/Sydney'); // "2025-09-30"
                    const [recordYear, recordMonth, recordDay] = recordDateStr.split("-");

                    // const recordMonth = recordDate.getMonth();
                    // const recordYear = recordDate.getFullYear();
                    
                    // Total Active Classes (count_type = 9, window = 6 for ALL)
                    if (d.count_type === 9 && d.window === 6) {
                        activeClasses = d.count;
                    }

                    // Total Members (count_type = 8, window = 6 for ALL)
                    if (d.count_type === 8 && d.window === 6) {
                        totalMembers = d.count;
                    }
                    
                    // Get the stats for today only (window == 2), id_type = 1 for SCHOOL, count_type = 1 for AttendanceAll
                    if (d.count_type === 1 && d.window === 2 && d.id_type === 1 && recordDateStr === todayStr) {
                        todaysAttendance += d.count || 0;
                    }
                    
                    // Monthly revenue (count_type = 5 for Revenue, window = 4 for MONTH)
                    if (d.count_type === 5 && d.window === 4 && recordMonth === currentMonth && recordYear === currentYear) {
                        monthlyRevenue += d.count || 0;
                    }
                });
            }
            
            return {
                totalMembers: totalMembers,
                activeClasses: activeClasses,
                todaysAttendance: todaysAttendance,
                monthlyRevenue: monthlyRevenue
            };
        }

        function initDashboardSection() {

        }


        // --- Load User Profile Data ---
        async function loadUserProfile() {
            // Get form elements and message divs
            const profileUpdateForm = document.getElementById('profileUpdateForm');
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            const profileStatusMessageDiv = document.getElementById('profileStatusMessage');
            const passwordStatusMessageDiv = document.getElementById('passwordStatusMessage');

            // Get profile input fields by ID
            const profileFields = {
                email: document.getElementById('email'),
                first_name: document.getElementById('first_name'),
                surname: document.getElementById('surname'),
                gender: document.getElementById('gender'), // This is now a select
                phone: document.getElementById('phone'),
                dob: document.getElementById('dob'), // This is now type="date"
                address: document.getElementById('address'),
                suburb: document.getElementById('suburb'),
                emergency_name: document.getElementById('emergency_name'),
                emergency_relationship: document.getElementById('emergency_relationship'),
                emergency_phone: document.getElementById('emergency_phone'),
                emergency_medical: document.getElementById('emergency_medical'), // Textarea
                belt_size: document.getElementById('belt_size'), // This is now type="number"
                uniform_size: document.getElementById('uniform_size'), // This is now type="number"

            };


            displayMessage(profileStatusMessageDiv, 'Loading profile...', false);
            try {
                    const response = await fetch('/api/user/profile_data', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                // Check if response is OK (status 2xx)
                if (!response.ok) {
                    // If not OK, it might be 401 Unauthorized if session expired
                    if (response.status === 401) {
                        console.warn('Session expired while loading profile.');
                        alert('Your session has expired. Please log in again.');
                        window.location.href = '/#login'; // Redirect to login
                        return; // Stop further processing
                    }
                        // Handle other non-OK statuses
                    const errorResult = await response.json(); // Try to parse JSON error
                    console.error('Failed to load profile (HTTP error):', response.status, errorResult);
                    displayMessage(profileStatusMessageDiv, errorResult.error_message || `HTTP error ${response.status}`, false);
                    return; // Stop further processing
                }


                const result = await response.json();

                if (result.success && result.user_profile) {
                    const profile = result.user_profile;

                    // Populate form fields
                    profileFields.email.value = profile.email; // Email (read-only)
                    profileFields.first_name.value = profile.first_name || '';
                    profileFields.surname.value = profile.surname || '';
                    profileFields.gender.value = profile.gender || ''; // Set select value
                    profileFields.phone.value = profile.phone || '';
                    profileFields.dob.value = profile.dob
                        ? profile.dob.replace(/\//g, '-')
                        : '';
                    profileFields.address.value = profile.address || '';
                    profileFields.suburb.value = profile.suburb || '';
                    profileFields.emergency_name.value = profile.emergency_name || '';
                    profileFields.emergency_relationship.value = profile.emergency_relationship || '';
                    profileFields.emergency_phone.value = profile.emergency_phone || '';
                    profileFields.emergency_medical.value = profile.emergency_medical || ''; // Textarea
                        // Handle number inputs - ensure they are numbers or empty strings
                    profileFields.belt_size.value = profile.belt_size !== null && profile.belt_size !== undefined ? profile.belt_size : '';
                    profileFields.uniform_size.value = profile.uniform_size !== null && profile.uniform_size !== undefined ? profile.uniform_size : '';


                    displayMessage(profileStatusMessageDiv, 'Profile loaded.', true);
                } else {
                        console.error('Failed to load profile:', result.error_message);
                        displayMessage(profileStatusMessageDiv, result.error_message || 'Failed to load profile.', false);
                }

            } catch (error) {
                console.error('Fetch error loading profile:', error);
                displayMessage(profileStatusMessageDiv, 'Failed to connect to the server to load profile.', false);
            }
        }

        // --- School Settings Functions ---
        async function loadSchoolSettings() {
            const schoolNameInput = document.getElementById('school-name');
            const schoolTimezoneSelect = document.getElementById('school-timezone');
            const stripePublishableKey = document.getElementById('stripe-publishable-key');
            const stripeSecretKey = document.getElementById('stripe-secret-key');
            const stripeWebhookSecret = document.getElementById('stripe-webhook-secret');
            const settingsStatusMessage = document.getElementById('settingsStatusMessage');

            try {
                settingsStatusMessage.textContent = 'Loading settings...';
                settingsStatusMessage.className = 'text-blue-600 mt-4 p-4 rounded-lg';
                settingsStatusMessage.classList.remove('hidden');

                const response = await fetch('/api/school/get_settings', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.settings) {
                        const settings = result.settings;
                        
                        schoolNameInput.value = settings.school_name || '';
                        schoolTimezoneSelect.value = settings.timezone || 'Australia/Sydney';
                        stripePublishableKey.value = settings.stripe_publishable_key || '';
                        stripeSecretKey.value = settings.stripe_secret_key ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
                        stripeWebhookSecret.value = settings.stripe_webhook_secret ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';

                        settingsStatusMessage.textContent = 'Settings loaded successfully';
                        settingsStatusMessage.className = 'text-green-600 mt-4 p-4 rounded-lg';
                        settingsStatusMessage.classList.remove('hidden');
                    } else {
                        settingsStatusMessage.textContent = result.error_message || 'Failed to load settings';
                        settingsStatusMessage.className = 'text-red-600 mt-4 p-4 rounded-lg';
                        settingsStatusMessage.classList.remove('hidden');
                    }
                } else {
                    settingsStatusMessage.textContent = `Error: ${response.status}`;
                    settingsStatusMessage.className = 'text-red-600';
                }
            } catch (error) {
                console.error('Error loading school settings:', error);
                settingsStatusMessage.textContent = 'Network error loading settings';
                settingsStatusMessage.className = 'text-red-600';
            }
        }

        async function saveSchoolSettings() {
            const schoolNameInput = document.getElementById('school-name');
            const schoolTimezoneSelect = document.getElementById('school-timezone');
            const stripePublishableKey = document.getElementById('stripe-publishable-key');
            const stripeSecretKey = document.getElementById('stripe-secret-key');
            const stripeWebhookSecret = document.getElementById('stripe-webhook-secret');
            const settingsStatusMessage = document.getElementById('settingsStatusMessage');

            try {
                settingsStatusMessage.textContent = 'Saving settings...';
                settingsStatusMessage.className = 'text-blue-600 mt-4 p-4 rounded-lg';
                settingsStatusMessage.classList.remove('hidden');

                const settingsData = {
                    school_name: schoolNameInput.value.trim(),
                    timezone: schoolTimezoneSelect.value,
                    stripe_publishable_key: stripePublishableKey.value.trim(),
                };

                if (stripeSecretKey.value.trim() && stripeSecretKey.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                    settingsData.stripe_secret_key = stripeSecretKey.value.trim();
                }

                if (stripeWebhookSecret.value.trim() && stripeWebhookSecret.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                    settingsData.stripe_webhook_secret = stripeWebhookSecret.value.trim();
                }

                const response = await fetch('/api/school/update_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    settingsStatusMessage.textContent = 'Settings saved successfully!';
                    settingsStatusMessage.className = 'text-green-600 mt-4 p-4 rounded-lg';
                    settingsStatusMessage.classList.remove('hidden');
                    
                    if (stripeSecretKey.value.trim() && stripeSecretKey.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                        stripeSecretKey.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    }
                    if (stripeWebhookSecret.value.trim() && stripeWebhookSecret.value !== '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                        stripeWebhookSecret.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    }
                } else {
                    settingsStatusMessage.textContent = result.error_message || 'Failed to save settings';
                    settingsStatusMessage.className = 'text-red-600';
                }
            } catch (error) {
                console.error('Error saving school settings:', error);
                settingsStatusMessage.textContent = 'Network error saving settings';
                settingsStatusMessage.className = 'text-red-600';
            }
        }

        function resetSchoolSettings() {
            loadSchoolSettings();
        }


        // Function to fetch and display the list of venues as cards
        async function fetchAndDisplayVenues() {
            // --- Venue Section Logic ---
            const addVenueButton = document.getElementById('add-venue-button');
            const addVenueModal = document.getElementById('add-venue-modal');
            const addVenueForm = document.getElementById('add-venue-form');
            const submitCreateVenueButton = document.getElementById('submit-create-venue');
            const createVenueMessageDiv = document.getElementById('create-venue-message');
            const venueListDiv = document.getElementById('venue-list'); // Assuming this exists in your HTML

            // Filter and Sort Elements for Venues
            const venueSearchInput = document.getElementById('venue-search');
            const venueSortBySelect = document.getElementById('venue-sort-by');
            const applyVenueFiltersButton = document.getElementById('apply-venue-filters-button');

            // Edit Venue Modal Elements
            const editVenueModal = document.getElementById('edit-venue-modal');
            const editVenueForm = document.getElementById('edit-venue-form');
            const submitEditVenueButton = document.getElementById('submit-edit-venue');
            const editVenueIdInput = document.getElementById('edit-venue-id');
            const editVenueTitleInput = document.getElementById('edit-venue-title');
            const editVenueDescriptionInput = document.getElementById('edit-venue-description');
            const editVenueAddressInput = document.getElementById('edit-venue-address');
            const editVenueSuburbInput = document.getElementById('edit-venue-suburb');
            const editVenueStateInput = document.getElementById('edit-venue-state');
            const editVenuePostcodeInput = document.getElementById('edit-venue-postcode');
            const editVenueCountryInput = document.getElementById('edit-venue-country');
            const editVenueLatitudeInput = document.getElementById('edit-venue-latitude');
            const editVenueLongitudeInput = document.getElementById('edit-venue-longitude');
            const editVenueContactPhoneInput = document.getElementById('edit-venue-contact-phone');
            const editVenueMessageDiv = document.getElementById('edit-venue-message');



            venueListDiv.innerHTML = '<p class="text-gray-600 italic">Loading venues...</p>';

            // Get filter and sort parameters for venues
            const searchTerm = venueSearchInput.value.trim();
            const sortBy = venueSortBySelect.value;

            // Construct query parameters
            const queryParams = new URLSearchParams();
            if (searchTerm) queryParams.append('search', searchTerm);
            if (sortBy) queryParams.append('sort_by', sortBy);

            const url = `/api/venue/get_list${queryParams.toString() ? '?' + queryParams.toString() : ''}`;

            try {
                const response = await fetch(url, { method: 'GET' });

                if (response.ok) {
                    const result = await response.json(); // Assuming backend returns { success: true, venues: [...] }

                    if (result.success && result.venues) {
                    const venues = result.venues;
                        if (venues.length > 0) {
                            let html = '';
                            venues.forEach(venue => {
                                var edit_btn = "";
                                if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin])){
                                edit_btn = `<button class="edit-venue-button py-2 px-4 bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition duration-200 text-sm" data-venue-id="${venue.venue_id}">Edit</button>`;
                                }

                                add_cached_value("venue", venue.venue_id, venue); // Cache the venue data
                                html += `
                                    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${venue.title}</h3>
                                        <p class="text-gray-700 mb-4">${venue.description || 'No description'}</p>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                                            <div>
                                                <p><strong class="font-medium">Address:</strong> ${venue.address || 'N/A'}, ${venue.suburb || ''}, ${venue.state || ''} ${venue.postcode || ''}, ${venue.country || ''}</p>
                                                <p><strong class="font-medium">Contact Phone:</strong> ${venue.contact_phone || 'N/A'}</p>
                                            </div>
                                            <div>
                                                ${venue.latitude && venue.longitude ?
                                                    `<p><strong class="font-medium">Location:</strong> ${parseFloat(venue.latitude).toFixed(4)}, ${parseFloat(venue.longitude).toFixed(4)}</p>`
                                                    : '<p><strong class="font-medium">Location:</strong> N/A</p>'}
                                                <p><strong class="font-medium">Distance:</strong> ${venue.distance || 'N/A'}</p> <!-- Assuming backend provides distance -->
                                            </div>
                                        </div>

                                        <div class="flex flex-wrap gap-3">
                                            <!-- Add buttons like View Details (opens venue info modal) or Edit -->
                                            <button class="view-venue-button py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 text-sm" data-venue-id="${venue.venue_id}">View Details</button>
                                            ${edit_btn}
                                            <!-- Add Delete button if needed -->
                                        </div>
                                    </div>
                                `;
                            });
                            venueListDiv.innerHTML = html;

                        // Attach event listeners after rendering
                        attachVenueButtonListeners(); // Attach listeners to Edit button
                        attachViewVenueButtonListeners(); // Attach listeners to View Details button

                        } else {
                            venueListDiv.innerHTML = '<p class="text-gray-600 italic">No venues found matching your criteria.</p>';
                        }
                    } else {
                        // Handle cases where response is OK but success is false (backend level error)
                        venueListDiv.innerHTML = `<p class="text-red-600">Error loading venues: ${result.error_message || 'Unknown error'}</p>`;
                        console.error('Backend success: false for venues:', result.error_message);
                    }

                } else if (response.status === 401 || response.status === 403) {
                    venueListDiv.innerHTML = '<p class="text-red-600">Error: You are not authorized to view venues.</p>';
                    console.error("Authorization error fetching venues:", response.status);
                }
                else {
                    // Handle other HTTP errors
                    const errorText = await response.text();
                    venueListDiv.innerHTML = `<p class="text-red-600">Error loading venues: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                    console.error("Error fetching venues:", response.status, errorText);
                }
            } catch (error) {
                // Handle network errors
                venueListDiv.innerHTML = `<p class="text-red-600">Network error loading venues.</p>`;
                console.error("Fetch error for venue list:", error);
            }
        }

        // Function to attach event listeners to dynamically created venue buttons
        function attachVenueButtonListeners() {
            // --- Venue Section Logic ---
            const venueListDiv = document.getElementById('venue-list'); // Assuming this exists in your HTML

            // Edit Button Listener
            venueListDiv.querySelectorAll('.edit-venue-button').forEach(button => {
                button.addEventListener('click', async () => {
                    const venueId = button.getAttribute('data-venue-id');
                    console.log('Attempting to edit venue:', venueId);
                    // Fetch venue data and open edit modal
                    fetchVenueForEdit(venueId);
                });
            });
            // Add Delete button listener here if needed
        }

        // Function to attach event listeners to View Details buttons
        function attachViewVenueButtonListeners() {
            // --- Venue Section Logic ---
            const venueListDiv = document.getElementById('venue-list'); // Assuming this exists in your HTML

            venueListDiv.querySelectorAll('.view-venue-button').forEach(button => {
                button.addEventListener('click', async () => {
                    const venueId = button.getAttribute('data-venue-id');
                    console.log('Attempting to view venue details for:', venueId);
                    fetchAndDisplayVenueInfo(venueId); // Reuse the venue info modal logic
                });
            });
        }


        // Function to fetch venue data for editing and populate the modal
        async function fetchVenueForEdit(venueId) {
            // --- Venue Section Logic ---
            const addVenueButton = document.getElementById('add-venue-button');
            const addVenueModal = document.getElementById('add-venue-modal');
            const addVenueForm = document.getElementById('add-venue-form');
            const submitCreateVenueButton = document.getElementById('submit-create-venue');
            const createVenueMessageDiv = document.getElementById('create-venue-message');
            const venueListDiv = document.getElementById('venue-list'); // Assuming this exists in your HTML

            // Filter and Sort Elements for Venues
            const venueSearchInput = document.getElementById('venue-search');
            const venueSortBySelect = document.getElementById('venue-sort-by');
            const applyVenueFiltersButton = document.getElementById('apply-venue-filters-button');

            // Edit Venue Modal Elements
            const editVenueModal = document.getElementById('edit-venue-modal');
            const editVenueForm = document.getElementById('edit-venue-form');
            const submitEditVenueButton = document.getElementById('submit-edit-venue');
            const editVenueIdInput = document.getElementById('edit-venue-id');
            const editVenueTitleInput = document.getElementById('edit-venue-title');
            const editVenueDescriptionInput = document.getElementById('edit-venue-description');
            const editVenueAddressInput = document.getElementById('edit-venue-address');
            const editVenueSuburbInput = document.getElementById('edit-venue-suburb');
            const editVenueStateInput = document.getElementById('edit-venue-state');
            const editVenuePostcodeInput = document.getElementById('edit-venue-postcode');
            const editVenueCountryInput = document.getElementById('edit-venue-country');
            const editVenueLatitudeInput = document.getElementById('edit-venue-latitude');
            const editVenueLongitudeInput = document.getElementById('edit-venue-longitude');
            const editVenueContactPhoneInput = document.getElementById('edit-venue-contact-phone');
            const editVenueMessageDiv = document.getElementById('edit-venue-message');



            editVenueMessageDiv.textContent = '';
            editVenueMessageDiv.className = 'message text-center';
            editVenueMessageDiv.style.display = 'none';

            try {
                // Use POST request body for venue ID
                const response = await fetch('/api/venue/get', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ venue_id: venueId })
                });

                if (response.ok) {
                    const result = await response.json(); // Assuming backend returns { success: true, venue: {...} } OR just the venue data

                    if (!result.success) {
                        console.error('Backend success: false fetching venue for editing:', result.error_message || 'Invalid data received');
                        alert('Error fetching venue for editing: ' + (result.error_message || 'Invalid data received'));
                        return;
                    }
                const venue = result.venue; // Adjust based on actual API response structure

                    if (venue && venue.venue_id) {
                        // Populate the edit modal form
                        editVenueIdInput.value = venue.venue_id;
                        editVenueTitleInput.value = venue.title || '';
                        editVenueDescriptionInput.value = venue.description || '';
                        editVenueAddressInput.value = venue.address || '';
                        editVenueSuburbInput.value = venue.suburb || '';
                        editVenueStateInput.value = venue.state || '';
                        editVenuePostcodeInput.value = venue.postcode || '';
                        editVenueCountryInput.value = venue.country || '';
                        editVenueLatitudeInput.value = venue.latitude !== null ? parseFloat(venue.latitude) : '';
                        editVenueLongitudeInput.value = venue.longitude !== null ? parseFloat(venue.longitude) : '';
                        editVenueContactPhoneInput.value = venue.contact_phone || '';

                        // Show the edit modal
                        editVenueModal.style.display = 'block';
                        add_cached_value("venue", venue.venue_id, venue); // Cache the venue data

                    } else {
                        alert('Error fetching venue for editing: ' + (result.error_message || 'Invalid data received'));
                        console.error('Backend success: false fetching venue for editing:', result.error_message || 'Invalid data received');
                    }

                } else if (response.status === 404) {
                    alert('Venue not found.');
                    console.warn('Venue not found for editing:', venueId);
                }
                else if (response.status === 401 || response.status === 403) {
                    alert('You are not authorized to edit this venue.');
                    console.error("Authorization error fetching venue for editing:", response.status);
                }
                else {
                    const errorText = await response.text();
                    alert(`Error fetching venue for editing: ${response.status}`);
                    console.error("Error fetching venue for editing:", response.status, errorText);
                }
            } catch (error) {
                console.error('Fetch error fetching venue for editing:', error);
                alert('Network error fetching venue for editing.');
            }
        }

        // Function to fetch and display venues for kiosk mode
        async function fetchAndDisplayKioskVenues() {
            const kioskVenuesListDiv = document.getElementById('kiosk-venues-list');
            if (!kioskVenuesListDiv) {
                console.error('Kiosk venues list div not found!');
                return;
            }
            
            kioskVenuesListDiv.innerHTML = '<p class="text-gray-600 italic col-span-full text-center py-8">Loading venues...</p>';
            
            try {
                const response = await fetch('/api/venue/get_list', { method: 'GET' });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && Array.isArray(result.venues)) {
                        if (result.venues.length > 0) {
                            let html = '';
                            
                            result.venues.forEach(venue => {
                                html += `
                                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 p-6 border border-gray-100 hover:border-indigo-200">
                                        <div class="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 class="text-xl font-bold text-gray-900 mb-2">${venue.title || 'Unnamed Venue'}</h3>
                                                <p class="text-gray-600 text-sm">${venue.description || 'No description'}</p>
                                            </div>
                                        </div>
                                        <div class="space-y-2 mb-4">
                                            <p class="text-sm text-gray-600"><strong>Address:</strong> ${venue.address || 'N/A'}</p>
                                            <p class="text-sm text-gray-600"><strong>Phone:</strong> ${venue.contact_phone || 'N/A'}</p>
                                        </div>
                                        <button 
                                            class="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-300 transform hover:scale-105 start-kiosk-btn"
                                            data-venue-id="${venue.venue_id}"
                                            data-venue-name="${venue.title}"
                                        >
                                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            Start Kiosk
                                        </button>
                                    </div>
                                `;
                            });
                            
                            kioskVenuesListDiv.innerHTML = html;
                            
                            // Add event listeners to Start Kiosk buttons
                            attachKioskButtonListeners();
                        } else {
                            kioskVenuesListDiv.innerHTML = '<p class="text-gray-600 italic col-span-full text-center py-8">No venues found.</p>';
                        }
                    } else {
                        kioskVenuesListDiv.innerHTML = `<p class="text-red-600 col-span-full text-center py-8">Error: ${result.error_message || 'Failed to load venues'}</p>`;
                    }
                } else {
                    kioskVenuesListDiv.innerHTML = '<p class="text-red-600 col-span-full text-center py-8">Failed to load venues.</p>';
                }
            } catch (error) {
                console.error('Error fetching venues for kiosk:', error);
                kioskVenuesListDiv.innerHTML = '<p class="text-red-600 col-span-full text-center py-8">Network error loading venues.</p>';
            }
        }
        
        // Function to attach event listeners to kiosk buttons
        function attachKioskButtonListeners() {
            const kioskButtons = document.querySelectorAll('.start-kiosk-btn');
            kioskButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const venueId = this.getAttribute('data-venue-id');
                    const venueName = this.getAttribute('data-venue-name');
                    startKioskMode(venueId, venueName);
                });
            });
        }
        
        // Function to start kiosk mode for a specific venue
        function startKioskMode(venueId, venueName) {
            // Redirect to kiosk mode in the same window
            const kioskUrl = `/kiosk?venue_id=${venueId}&venue_name=${encodeURIComponent(venueName)}`;
            window.location.href = kioskUrl;
        }


        async function fetchAndDisplayPOS() {
            await fetchAndDisplayClasses();
        }



        // Function to fetch and display the list of styles as cards
        async function fetchAndDisplayStyles() {
            // --- Styles Section Logic ---
            const addStyleButton = document.getElementById('add-style-button');
            const addStyleModal = document.getElementById('add-style-modal');
            const addStyleForm = document.getElementById('add-style-form');
            const submitCreateStyleButton = document.getElementById('submit-create-style');
            const createStyleMessageDiv = document.getElementById('create-style-message');
            const styleListDiv = document.getElementById('style-list');

            // Filter and Sort Elements for Styles
            const styleSearchInput = document.getElementById('style-search'); // Add this
            const styleSortBySelect = document.getElementById('style-sort-by'); // Add this
            const applyStyleFiltersButton = document.getElementById('apply-style-filters-button'); // Add this

            // Edit Style Modal Elements
            const editStyleModal = document.getElementById('edit-style-modal'); // Add this
            const editStyleForm = document.getElementById('edit-style-form'); // Add this
            const submitEditStyleButton = document.getElementById('submit-edit-style'); // Add this
            const editStyleIdInput = document.getElementById('edit-style-id'); // Add this
            const editStyleTitleInput = document.getElementById('edit-style-title'); // Add this
            const editStyleDescriptionInput = document.getElementById('edit-style-description'); // Add this
            const editStyleMessageDiv = document.getElementById('edit-style-message'); // Add this


            styleListDiv.innerHTML = '<p class="text-gray-600 italic">Loading styles...</p>';

            // Get filter and sort parameters for styles
            const searchTerm = styleSearchInput.value.trim();
            const sortBy = styleSortBySelect.value;

            // Construct query parameters
            const queryParams = new URLSearchParams();
            if (searchTerm) queryParams.append('search', searchTerm);
            if (sortBy) queryParams.append('sort_by', sortBy);

            const url = `/api/style/get_list${queryParams.toString() ? '?' + queryParams.toString() : ''}`;

            try {
                const response = await fetch(url, { method: 'GET' });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success && result.styles) {
                        const styles = result.styles;
                        if (styles.length > 0) {
                            let html = '';
                            styles.forEach(style => {

                            let edit_btn = "";
                            if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin])) {
                                edit_btn=  `
                                        <div class="flex flex-wrap gap-3 mt-4">
                                            <button class="edit-style-button py-2 px-4 bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition duration-200 text-sm" data-style-id="${style.style_id}">Edit</button>
                                            <!-- Add Delete button if needed -->
                                        </div>
                                `;
                            }

                            //has Permissions
                                html += `
                                    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${style.title}</h3>
                                        <p class="text-gray-700">${style.description || 'No description'}</p>
                                        ${edit_btn}
                                    </div>
                                `;
                            });
                            styleListDiv.innerHTML = html;

                            attachStyleButtonListeners(); // Attach listeners to Edit button

                        } else {
                            styleListDiv.innerHTML = '<p class="text-gray-600 italic">No styles found matching your criteria.</p>';
                        }
                    } else {
                        displayMessage(styleListDiv, `Error loading styles: ${result.error_message || 'Unknown error'}`, 'error');
                        console.error('Backend success: false for styles:', result.error_message);
                    }
                } else if (response.status === 401 || response.status === 403) {
                    displayMessage(styleListDiv, 'Error: You are not authorized to view styles.', 'error');
                    console.error("Authorization error fetching styles:", response.status);
                }
                else {
                    const errorText = await response.text();
                    displayMessage(styleListDiv, `Error loading styles: ${response.status} - ${errorText.substring(0, 100) + '...'}`, 'error');
                    console.error("Error fetching styles:", response.status, errorText);
                }
            } catch (error) {
                console.error('Error fetching styles:', error);
                displayMessage(styleListDiv, 'Network error loading styles.', 'error');
            }
        }

            // Function to attach event listeners to dynamically created style buttons
        function attachStyleButtonListeners() {
            const styleListDiv = document.getElementById('style-list');

            // Edit Button Listener
            styleListDiv.querySelectorAll('.edit-style-button').forEach(button => {
                button.addEventListener('click', async () => {
                    const styleId = button.getAttribute('data-style-id');
                    console.log('Attempting to edit style:', styleId);
                    // Fetch style data and open edit modal
                    fetchStyleForEdit(styleId);
                });
            });
            // Add Delete button listener here if needed
        }


        // Function to fetch style data for editing and populate the modal
        async function fetchStyleForEdit(styleId) {
            // Edit Style Modal Elements
            const editStyleModal = document.getElementById('edit-style-modal'); // Add this
            const editStyleForm = document.getElementById('edit-style-form'); // Add this
            const submitEditStyleButton = document.getElementById('submit-edit-style'); // Add this
            const editStyleIdInput = document.getElementById('edit-style-id'); // Add this
            const editStyleTitleInput = document.getElementById('edit-style-title'); // Add this
            const editStyleDescriptionInput = document.getElementById('edit-style-description'); // Add this
            const editStyleMessageDiv = document.getElementById('edit-style-message'); // Add this

            editStyleMessageDiv.textContent = '';
            editStyleMessageDiv.className = 'message text-center';
            editStyleMessageDiv.style.display = 'none';

            try {
                console.log('Fetching style for editing:', styleId);


                const requestBody = {
                    style_id: styleId, // Include the style ID for update
                };

                // Assuming you have a GET /api/style/{id} endpoint
                const response = await fetch(`/api/style/get`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

            //  const response = await fetch(`/api/style/${styleId}`, { method: 'GET' });
                const result = await response.json(); // Assuming backend returns { success: true, style: {...} }

                if (response.ok && result.success && result.style) {
                    const style = result.style;
                    // Populate the edit modal form
                    editStyleIdInput.value = style.style_id;
                    editStyleTitleInput.value = style.title || '';
                    editStyleDescriptionInput.value = style.description || '';

                    // Show the edit modal
                    editStyleModal.style.display = 'block';

                } else if (response.ok && result.error_message) {
                    alert('Error fetching style for editing: ' + (result.error_message || 'Unknown error'));
                    console.error('Backend success: false fetching style for editing:', result.error_message);
                } else if (response.status === 404) {
                    alert('Style not found.');
                    console.warn('Style not found for editing:', styleId);
                }
                else if (response.status === 401 || response.status === 403) {
                    alert('You are not authorized to edit this style.');
                    console.error("Authorization error fetching style for editing:", response.status);
                }
                else {
                    const errorText = await response.text();
                    alert(`Error fetching style for editing: ${response.status}`);
                    console.error("Error fetching style for editing:", response.status, errorText);
                }
            } catch (error) {
                console.error('Fetch error fetching style for editing:', error);
                alert('Network error fetching style for editing.');
            }
        }


        function initUsersSection() {
            const userList = document.getElementById("user-list");
            const userSearch = document.getElementById("userSearch");
            const userSort = document.getElementById("userSort");

            let allUsers = [];

            // Render users to the UI
            function renderUsers(users) {
                if (users.length === 0) {
                    userList.innerHTML = '<p class="text-gray-600 italic">No users found.</p>';
                    return;
                }

                userList.innerHTML = '';
                users.forEach(user => {
                    const userDiv = document.createElement("div");
                    userDiv.className = "bg-white shadow p-4 rounded flex items-center justify-between";

                    userDiv.innerHTML = `
                        <div class="flex items-center gap-4">
                            <img src="${user.img || '/default-avatar.png'}" alt="avatar" class="w-10 h-10 rounded-full object-cover bg-gray-200" />
                            <div>
                                <p class="text-gray-900 font-medium">${user.first_name} ${user.surname}</p>
                                <p class="text-gray-600 text-sm">${user.email}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm ${user.email_verified ? 'text-green-600' : 'text-red-500'}">
                                ${user.email_verified ? 'Verified' : 'Unverified'}
                            </span>
                            <button class="editUserBtn text-sm bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded" data-user-id="${user.user_id}">
                                Edit
                            </button>
                        </div>
                    `;
                    const editBtn = userDiv.querySelector('.editUserBtn');
                    editBtn.addEventListener('click', () => openEditUserModal(user.user_id));
                    userList.appendChild(userDiv);
                });
            }

            // Filter and sort users
            function updateDisplayedUsers() {
                const searchTerm = userSearch.value.toLowerCase().trim();
                const sortBy = userSort.value;

                let filtered = allUsers.filter(user =>
                    `${user.first_name} ${user.surname}`.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm)
                );

                if (sortBy === "name") {
                    filtered.sort((a, b) => {
                        const nameA = `${a.first_name} ${a.surname}`.toLowerCase();
                        const nameB = `${b.first_name} ${b.surname}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    });
                } else if (sortBy === "email") {
                    filtered.sort((a, b) => a.email.toLowerCase().localeCompare(b.email.toLowerCase()));
                }

                renderUsers(filtered);
            }

            // Fetch users from the backend
            fetch("/api/school/get_users", {
                method: "POST"
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && Array.isArray(data.users)) {
                    allUsers = data.users;
                    updateDisplayedUsers();
                } else {
                    userList.innerHTML = '<p class="text-red-600">Failed to load users.</p>';
                }
            })
            .catch(err => {
                console.error("Error loading users:", err);
                userList.innerHTML = '<p class="text-red-600">Error loading users.</p>';
            });

            // Event listeners for sorting and filtering
            userSearch.addEventListener("input", updateDisplayedUsers);
            userSort.addEventListener("change", updateDisplayedUsers);
        }


        function openNewUserModal() {
                        
            // Fill form fields
            document.getElementById('edit_user_id').value = '00000000-0000-0000-0000-000000000000';
            document.getElementById('edit_email').value = '';
            document.getElementById('edit_first_name').value = '';
            document.getElementById('edit_surname').value = '';
            document.getElementById('edit_gender').value = '';
            document.getElementById('edit_phone').value = '';
            document.getElementById('edit_dob').value = '';
            document.getElementById('edit_address').value = '';
            document.getElementById('edit_suburb').value = '';
            document.getElementById('edit_emergency_name').value = '';
            document.getElementById('edit_emergency_relationship').value = '';
            document.getElementById('edit_emergency_phone').value = '';
            document.getElementById('edit_emergency_medical').value = '';
            document.getElementById('edit_belt_size').value = '';
            document.getElementById('edit_uniform_size').value = '';

            userEditModal.classList.remove('hidden');
            document.getElementById("admin-stripe-section").classList.add('hidden');
            document.getElementById("inviteUserBtn").classList.add('hidden');
            
            
            // initStripeForAdmin(u.user_id, u.email, `${u.first_name || ''} ${u.surname || ''}`.trim());
        }

        function openEditUserModal(userId) {
            deinitStripeForAdmin(); // Deinitialize any existing Stripe setup
            
            fetch('/api/user/get', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({'user_id': userId})
            })
                .then(res => res.json())
                .then(data => {
                if (data.success && data.user_profile) {
                    const u = data.user_profile;

                    
                    // Fill form fields
                    document.getElementById('edit_user_id').value = u.user_id;
                    document.getElementById('edit_email').value = u.email || '';
                    document.getElementById('edit_first_name').value = u.first_name || '';
                    document.getElementById('edit_surname').value = u.surname || '';
                    document.getElementById('edit_gender').value = u.gender || '';
                    document.getElementById('edit_phone').value = u.phone || '';
                    document.getElementById('edit_dob').value = u.dob ? u.dob.replace(/\//g, '-'): '';
                    document.getElementById('edit_address').value = u.address || '';
                    document.getElementById('edit_suburb').value = u.suburb || '';
                    document.getElementById('edit_emergency_name').value = u.emergency_name || '';
                    document.getElementById('edit_emergency_relationship').value = u.emergency_relationship || '';
                    document.getElementById('edit_emergency_phone').value = u.emergency_phone || '';
                    document.getElementById('edit_emergency_medical').value = u.emergency_medical || '';
                    document.getElementById('edit_belt_size').value = u.belt_size || '';
                    document.getElementById('edit_uniform_size').value = u.uniform_size || '';

                    userEditModal.classList.remove('hidden');
                    document.getElementById("inviteUserBtn").classList.remove('hidden');

                    initStripeForAdmin(u.user_id, u.email, `${u.first_name || ''} ${u.surname || ''}`.trim());
                } else {
                    alert('User not found.');
                }
            });
        }

        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            async function loadPermissionsData() {
                try {
                    const res = await fetch("/api/user/get_permissions", {
                        method: "POST"
                    });
                    var data = await res.json();
                    var tmp_permissions = [];
                    // For the moment we'll simplify the permission model to just look at permissions.
                    // Ignoring class / club specific information
                    for (i in data.permissions) {
                        tmp_permissions.push(data.permissions[i].permission);
                    }
                    userPermissions = tmp_permissions;
                    accounts = data.accounts;
                    my_user_id = data.user_id;
                    my_school_id = data.school_id;

                    console.log("User permissions:", userPermissions);
                    console.log("Checking permissions for SuperAdmin/HyperAdmin:", hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin]));
                    
                    if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin]))
                    {
                        console.log("User has admin permissions - showing admin buttons");
                        document.getElementById("dashboard-nav").classList.remove("hidden");
                        document.getElementById("users-nav").classList.remove("hidden");
                        document.getElementById("add-venue-button").classList.remove("hidden");
                        const createClassBtn = document.getElementById("createClassBtn");
                        createClassBtn.classList.remove("hidden");
                        createClassBtn.style.display = "inline-flex"; // Explicitly set display
                        console.log("Create class button should now be visible");
                        console.log("Button element:", createClassBtn);
                        console.log("Button computed display:", window.getComputedStyle(createClassBtn).display);
                        console.log("Button computed visibility:", window.getComputedStyle(createClassBtn).visibility);
                        console.log("Button computed opacity:", window.getComputedStyle(createClassBtn).opacity);
                        console.log("Button classes:", createClassBtn.classList.toString());
                    }
                    else{
                        console.log("User does NOT have admin permissions - hiding admin buttons");
                        document.getElementById("dashboard-nav").classList.add("hidden");
                        document.getElementById("users-nav").classList.add("hidden");
                        document.getElementById("add-venue-button").classList.add("hidden");
                        document.getElementById("createClassBtn").classList.add("hidden");
                    }

                    if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin, Permissions.CreateWaiver])) {
                        document.getElementById('create-waiver-button').style.display = 'block'; // Show button if user has permission
                    } else {
                        document.getElementById('create-waiver-button').style.display = 'none'; // Hide button if no permission
                    }

                    if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin])) {
                        document.getElementById('add-style-button').style.display = 'block'; // Show button if user has permission
                        document.getElementById("settings-nav").classList.remove("hidden"); // Show settings nav
                    } else {
                        document.getElementById('add-style-button').style.display = 'none'; // Hide button if no permission
                        document.getElementById("settings-nav").classList.add("hidden"); // Hide settings nav
                    }

                } catch (error) {
                    console.error('Error loading permission data:', error);
                }
            }
            loadPermissionsData();

            // userPermissions










            document.getElementById("refreshDashboard").addEventListener("click", loadDashboardData);
            document.getElementById("classFilter").addEventListener("change", loadDashboardData);
            document.getElementById("timeFilter").addEventListener("change", loadDashboardData);
            document.getElementById("countTypeFilter").addEventListener("change", loadDashboardData);
            loadDashboardData(); // Initial load

            // Dashboard -- end






            const sections = document.querySelectorAll('.portal-section');
            const navLinks = document.querySelectorAll('nav ul li a[data-section]');
            const logoutLink = document.getElementById('logoutLink');

            // Get form elements and message divs
            const profileUpdateForm = document.getElementById('profileUpdateForm');
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            const profileStatusMessageDiv = document.getElementById('profileStatusMessage');
            const passwordStatusMessageDiv = document.getElementById('passwordStatusMessage');

            // Get profile input fields by ID
            const profileFields = {
                email: document.getElementById('email'),
                first_name: document.getElementById('first_name'),
                surname: document.getElementById('surname'),
                gender: document.getElementById('gender'), // This is now a select
                phone: document.getElementById('phone'),
                dob: document.getElementById('dob'), // This is now type="date"
                address: document.getElementById('address'),
                suburb: document.getElementById('suburb'),
                emergency_name: document.getElementById('emergency_name'),
                emergency_relationship: document.getElementById('emergency_relationship'),
                emergency_phone: document.getElementById('emergency_phone'),
                emergency_medical: document.getElementById('emergency_medical'), // Textarea
                belt_size: document.getElementById('belt_size'), // This is now type="number"
                uniform_size: document.getElementById('uniform_size'), // This is now type="number"

            };

            // Get password change fields
            const currentPasswordField = document.getElementById('currentPassword');
            const newPasswordField = document.getElementById('newPassword');
            const confirmNewPasswordField = document.getElementById('confirmNewPassword');


            

            document.getElementById('addUserBtn').addEventListener('click', () => {
                openNewUserModal(); // Pass `null` to trigger blank form
            });



            



            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const sectionId = link.getAttribute('data-section');
                    showSection(sectionId);
                });
            });


            

            // Add event listeners for school settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSchoolSettings);
            document.getElementById('resetSettingsBtn').addEventListener('click', resetSchoolSettings);
            
            // Prevent form submission
            document.getElementById('schoolSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSchoolSettings();
            });

            // Edit users modal section -- START //

            const userEditModal = document.getElementById('userEditModal');
            const closeModalBtn = document.getElementById('closeUserEditModalBtn');
            const inviteUserBtn = document.getElementById('inviteUserBtn');
            const editUserForm = document.getElementById('editUserForm');
            const editUserStatusMessage = document.getElementById('editUserStatusMessage');

            

            closeModalBtn.addEventListener('click', () => {
                userEditModal.classList.add('hidden');
                editUserForm.reset();
                editUserStatusMessage.textContent = '';
            });

            editUserForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const payload = {
                    user_id: document.getElementById('edit_user_id').value,
                    first_name: document.getElementById('edit_first_name').value,
                    surname: document.getElementById('edit_surname').value,
                    gender: document.getElementById('edit_gender').value,
                    phone: document.getElementById('edit_phone').value,
                    dob: document.getElementById('edit_dob').value
                        ? (() => {
                            const date = new Date(document.getElementById('edit_dob').value);
                            const yyyy = date.getFullYear();
                            const mm = String(date.getMonth() + 1).padStart(2, '0');
                            const dd = String(date.getDate()).padStart(2, '0');
                            return `${yyyy}/${mm}/${dd}`;
                        })()
                        : null,
                    address: document.getElementById('edit_address').value,
                    suburb: document.getElementById('edit_suburb').value,
                    emergency_name: document.getElementById('edit_emergency_name').value,
                    emergency_relationship: document.getElementById('edit_emergency_relationship').value,
                    emergency_phone: document.getElementById('edit_emergency_phone').value,
                    emergency_medical: document.getElementById('edit_emergency_medical').value,
                    belt_size: document.getElementById('edit_belt_size').value,
                    uniform_size: document.getElementById('edit_uniform_size').value,
                    email: document.getElementById('edit_email').value
                };

                fetch('/api/user/update_profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(res => res.json())
                .then(data => {
                    editUserStatusMessage.textContent = data.success ? 'User updated successfully.' : (data.error_message || 'Failed to update.');
                    if (data.success) {
                        setTimeout(() => {
                            userEditModal.classList.add('hidden');
                            editUserForm.reset();
                            editUserStatusMessage.textContent = '';
                            initUsersSection(); // reload user list
                        }, 1500);
                    }
                });
            });

            inviteUserBtn.addEventListener('click', () => {
                const userId = document.getElementById('edit_user_id').value;
                const email = document.getElementById('edit_email').value;

                fetch('/api/user/invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, email: email })
                })
                .then(res => res.json())
                .then(data => {
                editUserStatusMessage.textContent = data.success ? 'Invite sent successfully!' : (data.error_message || 'Failed to invite.');
                });
            });

            // EDIT USERS MODAL SECTION -- END //


            // --- Handle Profile Update Submission ---
            profileUpdateForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                displayMessage(profileStatusMessageDiv, 'Saving profile...', false);
                profileStatusMessageDiv.style.color = 'gray';

                // --- Client-side Validation ---
                if (profileFields.first_name.value.length === 0 || profileFields.surname.value.length === 0) {
                     displayMessage(profileStatusMessageDiv, 'First name and Surname are required.', false);
                     return;
                }
                 // Check max lengths (already handled by HTML maxlength, but double-checking here for consistency)
                 if (profileFields.first_name.value.length > 64 || profileFields.surname.value.length > 64 || profileFields.gender.value.length > 64 ||
                     profileFields.phone.value.length > 64 || profileFields.suburb.value.length > 64 || profileFields.emergency_name.value.length > 64 ||
                     profileFields.emergency_relationship.value.length > 64 || profileFields.emergency_phone.value.length > 64 || profileFields.belt_size.value.length > 64 ||
                     profileFields.uniform_size.value.length > 64)
                 {
                      displayMessage(profileStatusMessageDiv, 'Maximum length for most fields is 64 characters.', false);
                      return;
                 }
                 if (profileFields.address.value.length > 512) {
                     displayMessage(profileStatusMessageDiv, 'Maximum length for Address is 512 characters.', false);
                     return;
                 }
                // Basic format validation
                 if (profileFields.phone.value && !isValidPhoneNumber(profileFields.phone.value)) {
                     displayMessage(profileStatusMessageDiv, 'Please enter a valid phone number format.', false);
                     return;
                 }
                // Add more format validation for names, etc. if desired, but be cautious with international characters.

                 // Validate number inputs (type="number" helps, but value might be empty or invalid)
                 var beltSizeValue = profileFields.belt_size.value;
                 if (beltSizeValue !== '') { // Only validate if not empty
                    const numBeltSize = parseInt(beltSizeValue, 10);
                     if (isNaN(numBeltSize) || numBeltSize < 0 || numBeltSize > 100 || beltSizeValue.includes('.')) { // Also check for decimals
                         displayMessage(profileStatusMessageDiv, 'Belt Size must be an integer between 0 and 100.', false);
                         return;
                    }
                    beltSizeValue = beltSizeValue.toString(); // Convert to string for consistency
                 }
                 const uniformSizeValue = profileFields.uniform_size.value;
                 if (uniformSizeValue !== '') { // Only validate if not empty
                     const numUniformSize = parseInt(uniformSizeValue, 10);
                     if (isNaN(numUniformSize) || numUniformSize < 0 || numUniformSize > 100 || uniformSizeValue.includes('.')) { // Also check for decimals
                         displayMessage(profileStatusMessageDiv, 'Uniform Size must be an integer between 0 and 100.', false);
                         return;
                     }
                 }
                // End Client-side Validation ---


                // Collect data from the form fields matching UpdateUserProfileRequest
                const updateData = {
                     user_id: my_user_id, // Assuming my_user_id is defined globally
                     first_name: profileFields.first_name.value,
                     surname: profileFields.surname.value,
                     gender: profileFields.gender.value || null,
                     phone: profileFields.phone.value || null,
                     dob: profileFields.dob.value
                        ? (() => {
                            const date = new Date(profileFields.dob.value);
                            const yyyy = date.getFullYear();
                            const mm = String(date.getMonth() + 1).padStart(2, '0');
                            const dd = String(date.getDate()).padStart(2, '0');
                            return `${yyyy}/${mm}/${dd}`;
                        })()
                        : null,
                     address: profileFields.address.value || null,
                     suburb: profileFields.suburb.value || null,
                     emergency_name: profileFields.emergency_name.value || null,
                     emergency_relationship: profileFields.emergency_relationship.value || null,
                     emergency_phone: profileFields.emergency_phone.value || null,
                     emergency_medical: profileFields.emergency_medical.value || null, // Send "" if empty, convert to null if needed backend
                     belt_size: profileFields.belt_size.value || null, // Send number string or null if empty
                     uniform_size: profileFields.uniform_size.value || null, // Send number string or null if empty
                };
                 // Convert number strings to numbers if they are not empty strings or null
                //  if (updateData.belt_size !== null) updateData.belt_size = parseInt(updateData.belt_size, 10);
                //  if (updateData.uniform_size !== null) updateData.uniform_size = parseInt(updateData.uniform_size, 10);


                try {
                     const response = await fetch('/api/user/update_profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    // Check if response is OK
                     if (!response.ok) {
                         if (response.status === 401) {
                            console.warn('Session expired while updating profile.');
                            alert('Your session has expired. Please log in again.');
                            window.location.href = '/#login';
                            return;
                        }
                         const errorResult = await response.json();
                         console.error('Profile update failed (HTTP error):', response.status, errorResult);
                         displayMessage(profileStatusMessageDiv, errorResult.error_message || `HTTP error ${response.status}`, false);
                         return;
                     }

                    const result = await response.json();

                    if (result.success) {
                        console.log('Profile updated successfully.');
                        displayMessage(profileStatusMessageDiv, 'Profile updated successfully!', true);
                    } else {
                         console.error('Profile update failed:', result.error_message);
                         displayMessage(profileStatusMessageDiv, result.error_message || 'Failed to update profile.', false);
                    }

                } catch (error) {
                    console.error('Fetch error updating profile:', error);
                    displayMessage(profileStatusMessageDiv, 'Failed to connect to the server to update profile.', false);
                }
            });

            // --- Handle Password Change Submission ---
             passwordChangeForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                displayMessage(passwordStatusMessageDiv, 'Changing password...', false);
                passwordStatusMessageDiv.style.color = 'gray';

                const currentPassword = currentPasswordField.value;
                const newPassword = newPasswordField.value;
                const confirmNewPassword = confirmNewPasswordField.value;

                 // --- Client-side Validation ---
                 if (!currentPassword || !newPassword || !confirmNewPassword) {
                      displayMessage(passwordStatusMessageDiv, 'All password fields are required.', false);
                      return;
                 }
                 if (newPassword !== confirmNewPassword) {
                     displayMessage(passwordStatusMessageDiv, 'New Password and Confirm New Password must match.', false);
                     // Clear both new password fields
                     newPasswordField.value = '';
                     confirmNewPasswordField.value = '';
                     return;
                 }
                 if (currentPassword === newPassword) {
                     displayMessage(passwordStatusMessageDiv, 'New password cannot be the same as the current password.', false);
                     // Clear new password fields
                     newPasswordField.value = '';
                     confirmNewPasswordField.value = '';
                     return;
                 }
                 // Add more validation (e.g., minimum password length, complexity)
                 if (newPassword.length < 8) { // Example minimum length
                      displayMessage(passwordStatusMessageDiv, 'New password must be at least 8 characters long.', false);
                      // Clear new password fields
                       newPasswordField.value = '';
                       confirmNewPasswordField.value = '';
                      return;
                 }
                 // End Client-side Validation ---


                const passwordData = {
                    current_password: currentPassword,
                    new_password: newPassword
                };

                try {
                    const response = await fetch('/api/user/change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(passwordData)
                    });

                    // Check if response is OK
                     if (!response.ok) {
                         if (response.status === 401) {
                            // This could be session expired OR incorrect current password (if backend sends 401 for both)
                            const errorResult = await response.json(); // Try to parse JSON error
                             console.error('Password change failed (HTTP 401):', errorResult);
                             // Check if the error message indicates incorrect password (based on your backend)
                             if (errorResult.error_message && errorResult.error_message.includes('Incorrect current password')) {
                                  displayMessage(passwordStatusMessageDiv, 'Incorrect current password.', false);
                             } else {
                                  // Assume session expired or other auth issue
                                  console.warn('Session expired during password change or other authentication issue.');
                                  alert('Your session has expired or there was an authentication issue. Please log in again.');
                                  window.location.href = '/#login';
                             }
                            currentPasswordField.value = ''; // Always clear current password on 401
                             newPasswordField.value = '';
                             confirmNewPasswordField.value = '';
                             return;
                         }
                         // Handle other non-OK statuses
                         const errorResult = await response.json(); // Try to parse JSON error
                         console.error('Password change failed (HTTP error):', response.status, errorResult);
                         displayMessage(passwordStatusMessageDiv, errorResult.error_message || `HTTP error ${response.status}`, false);
                         // Optionally clear password fields on other failures
                         currentPasswordField.value = '';
                         newPasswordField.value = '';
                         confirmNewPasswordField.value = '';
                         return;
                     }


                    const result = await response.json();

                    if (result.success) {
                        console.log('Password changed successfully.');
                        displayMessage(passwordStatusMessageDiv, 'Password changed successfully!', true);
                        // Clear password fields on success
                        currentPasswordField.value = '';
                        newPasswordField.value = '';
                        confirmNewPasswordField.value = '';
                    } else {
                        console.error('Password change failed:', result.error_message);
                         displayMessage(passwordStatusMessageDiv, result.error_message || 'Failed to change password.', false);
                         // Optionally clear current password field on failure for security
                         currentPasswordField.value = '';
                    }

                } catch (error) {
                     console.error('Fetch error changing password:', error);
                     displayMessage(passwordStatusMessageDiv, 'Failed to connect to the server to change password.', false);
                }
            });

            // --- Handle Logout Link Click (Existing Logic) ---
            logoutLink.addEventListener('click', async (event) => {
                event.preventDefault();

                try {
                    const response = await fetch('/api/user/logout', { method: 'POST' });

                    // Check if response is OK
                    if (!response.ok) {
                         // Even logout might return non-OK (e.g., if session was already invalid)
                         console.warn('Logout response not OK:', response.status);
                         // We can still proceed to login page in most cases
                    }

                    console.log('Logout attempt finished, redirecting...');
                    window.location.href = '/#login'; // Always redirect to login after logout attempt

                } catch (error) {
                    console.error('Fetch error during logout:', error);
                     alert('Failed to connect to the server for logout. Attempting redirect.');
                     window.location.href = '/#login'; // Redirect even on fetch error
                }
            });




            // handleClassSection();


            // --- Venue Section Logic ---
            const addVenueButton = document.getElementById('add-venue-button');
            const addVenueModal = document.getElementById('add-venue-modal');
            const addVenueForm = document.getElementById('add-venue-form');
            const submitCreateVenueButton = document.getElementById('submit-create-venue');
            const createVenueMessageDiv = document.getElementById('create-venue-message');
            const venueListDiv = document.getElementById('venue-list'); // Assuming this exists in your HTML

            // Filter and Sort Elements for Venues
            const venueSearchInput = document.getElementById('venue-search');
            const venueSortBySelect = document.getElementById('venue-sort-by');
            const applyVenueFiltersButton = document.getElementById('apply-venue-filters-button');

            // Edit Venue Modal Elements
            const editVenueModal = document.getElementById('edit-venue-modal');
            const editVenueForm = document.getElementById('edit-venue-form');
            const submitEditVenueButton = document.getElementById('submit-edit-venue');
            const editVenueIdInput = document.getElementById('edit-venue-id');
            const editVenueTitleInput = document.getElementById('edit-venue-title');
            const editVenueDescriptionInput = document.getElementById('edit-venue-description');
            const editVenueAddressInput = document.getElementById('edit-venue-address');
            const editVenueSuburbInput = document.getElementById('edit-venue-suburb');
            const editVenueStateInput = document.getElementById('edit-venue-state');
            const editVenuePostcodeInput = document.getElementById('edit-venue-postcode');
            const editVenueCountryInput = document.getElementById('edit-venue-country');
            const editVenueLatitudeInput = document.getElementById('edit-venue-latitude');
            const editVenueLongitudeInput = document.getElementById('edit-venue-longitude');
            const editVenueContactPhoneInput = document.getElementById('edit-venue-contact-phone');
            const editVenueMessageDiv = document.getElementById('edit-venue-message');


            // Open Add Venue Modal
            addVenueButton.addEventListener('click', () => {
                addVenueModal.style.display = 'block';
                createVenueMessageDiv.textContent = '';
                createVenueMessageDiv.className = 'message text-center';
                createVenueMessageDiv.style.display = 'none';
                addVenueForm.reset();
            });


            // Close the Add Venue modal using close buttons (X and Cancel)
            // addVenueModalCloseButtons.forEach(button => {
            //     button.onclick = function() {
            //         addVenueModal.style.display = 'none';
            //     }
            // });

            // Close modals when clicking outside of them (Updated to handle multiple modals)
            // This function should already exist and handle multiple modals,
            // just ensure 'addVenueModal' is included in its checks.
            // window.onclick = function(event) { ... }


            // Submit Create Venue Form
            submitCreateVenueButton.addEventListener('click', async () => {
                 createVenueMessageDiv.style.display = 'none';
                 createVenueMessageDiv.textContent = '';
                 createVenueMessageDiv.className = 'message text-center';
                 submitCreateVenueButton.disabled = true;

                 const title = document.getElementById('venue-title').value.trim();
                 const description = document.getElementById('venue-description').value.trim();
                 const address = document.getElementById('venue-address').value.trim();
                 const suburb = document.getElementById('venue-suburb').value.trim();
                 const state = document.getElementById('venue-state').value.trim();
                 const postcode = document.getElementById('venue-postcode').value.trim();
                 const country = document.getElementById('venue-country').value.trim();
                 const latitudeString = document.getElementById('venue-latitude').value.trim();
                 const longitudeString = document.getElementById('venue-longitude').value.trim();
                 const contactPhone = document.getElementById('venue-contact-phone').value.trim();

                 if (!title) {
                     displayMessage(createVenueMessageDiv, 'Title is required.', 'error');
                     submitCreateVenueButton.disabled = false;
                     return;
                 }

                 const formattedDescription = description === '' ? null : description;
                 const formattedAddress = address === '' ? null : address;
                 const formattedSuburb = suburb === '' ? null : suburb;
                 const formattedState = state === '' ? null : state;
                 const formattedPostcode = postcode === '' ? null : postcode;
                 const formattedCountry = country === '' ? null : country;
                 const formattedContactPhone = contactPhone === '' ? null : contactPhone;

                 const latitude = latitudeString === '' ? null : latitudeString;
                 const longitude = longitudeString === '' ? null : longitudeString;

                 if (latitude !== null && isNaN(parseFloat(latitude))) {
                     displayMessage(createVenueMessageDiv, 'Invalid Latitude format. Must be a number.', 'error');
                     submitCreateVenueButton.disabled = false;
                     return;
                 }
                 if (longitude !== null && isNaN(parseFloat(longitude))) {
                     displayMessage(createVenueMessageDiv, 'Invalid Longitude format. Must be a number.', 'error');
                     submitCreateVenueButton.disabled = false;
                     return;
                 }


                 const requestBody = {
                     title: title,
                     description: formattedDescription,
                     address: formattedAddress,
                     suburb: formattedSuburb,
                     state: formattedState,
                     postcode: formattedPostcode,
                     country: formattedCountry,
                     latitude: latitude ? parseFloat(latitude) : null,
                     longitude: longitude ? parseFloat(longitude) : null,
                     contact_phone: formattedContactPhone,
                 };

                 console.log("Sending venue creation request:", requestBody);

                 try {
                     const response = await fetch('/api/venue/create', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Venue created successfully:", responseData);
                         displayMessage(createVenueMessageDiv, responseData.message || `Venue created successfully! ID: ${responseData.venue_id}`, 'success');

                         setTimeout(() => {
                             closeModal(addVenueModal);
                             fetchAndDisplayVenues(); // Refresh the venue list
                         }, 2000);


                     } else if (responseData && responseData.error_message) {
                         displayMessage(createVenueMessageDiv, `Creation failed: ${responseData.error_message}`, 'error');
                         console.error("Server error creating venue:", response.status, responseData.error_message);
                     }
                     else if (response.status === 400) {
                         const errorText = await response.text();
                          displayMessage(createVenueMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                         console.error("Bad request creating venue:", response.status, errorText);

                     }
                     else if (response.status === 401 || response.status === 403) {
                         displayMessage(createVenueMessageDiv, 'Error: You are not authorized to create venues.', 'error');
                         console.error("Authorization error creating venue:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                          displayMessage(createVenueMessageDiv, `Error creating venue: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error creating venue:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(createVenueMessageDiv, 'Network error submitting venue creation.', 'error');
                     console.error("Fetch error for venue creation:", error);
                 } finally {
                     submitCreateVenueButton.disabled = false;
                 }
            });


            


            // Submit Edit Venue Form
            submitEditVenueButton.addEventListener('click', async () => {
                 editVenueMessageDiv.style.display = 'none';
                 editVenueMessageDiv.textContent = '';
                 editVenueMessageDiv.className = 'message text-center';
                 submitEditVenueButton.disabled = true;

                const venueId = editVenueIdInput.value;
                const title = editVenueTitleInput.value.trim();
                const description = editVenueDescriptionInput.value.trim();
                const address = editVenueAddressInput.value.trim();
                const suburb = editVenueSuburbInput.value.trim();
                const state = editVenueStateInput.value.trim();
                const postcode = editVenuePostcodeInput.value.trim();
                const country = editVenueCountryInput.value.trim();
                const latitudeString = editVenueLatitudeInput.value.trim();
                const longitudeString = editVenueLongitudeInput.value.trim();
                const contactPhone = editVenueContactPhoneInput.value.trim();

                 if (!title) {
                     displayMessage(editVenueMessageDiv, 'Title is required.', 'error');
                     submitEditVenueButton.disabled = false;
                     return;
                 }

                 const formattedDescription = description === '' ? null : description;
                 const formattedAddress = address === '' ? null : address;
                 const formattedSuburb = suburb === '' ? null : suburb;
                 const formattedState = state === '' ? null : state;
                 const formattedPostcode = postcode === '' ? null : postcode;
                 const formattedCountry = country === '' ? null : country;
                 const formattedContactPhone = contactPhone === '' ? null : contactPhone;

                 const latitude = latitudeString === '' ? null : latitudeString;
                 const longitude = longitudeString === '' ? null : longitudeString;

                 if (latitude !== null && isNaN(parseFloat(latitude))) {
                     displayMessage(editVenueMessageDiv, 'Invalid Latitude format. Must be a number.', 'error');
                     submitEditVenueButton.disabled = false;
                     return;
                 }
                 if (longitude !== null && isNaN(parseFloat(longitude))) {
                     displayMessage(editVenueMessageDiv, 'Invalid Longitude format. Must be a number.', 'error');
                     submitEditVenueButton.disabled = false;
                     return;
                 }


                 const requestBody = {
                     venue_id: venueId, // Include the venue ID for update
                     title: title,
                     description: formattedDescription,
                     address: formattedAddress,
                     suburb: formattedSuburb,
                     state: formattedState,
                     postcode: formattedPostcode,
                     country: formattedCountry,
                     latitude: latitude ? parseFloat(latitude) : null,
                     longitude: longitude ? parseFloat(longitude) : null,
                     contact_phone: formattedContactPhone,
                 };

                console.log("Sending venue update request:", requestBody);

                 try {
                     const response = await fetch(`/api/venue/update`, { // Adjust endpoint
                         method: 'PUT', // Or 'PATCH'
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Venue updated successfully:", responseData);
                         displayMessage(editVenueMessageDiv, responseData.message || 'Venue updated successfully!', 'success');

                         setTimeout(() => {
                             closeModal(editVenueModal);
                             fetchAndDisplayVenues(); // Refresh the venue list
                         }, 2000);
                     } else if (responseData && responseData.error_message) {
                         displayMessage(editVenueMessageDiv, `Update failed: ${responseData.error_message}`, 'error');
                         console.error("Server error updating venue:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                          const errorText = await response.text();
                          displayMessage(editVenueMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                          console.error("Bad request updating venue:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                          displayMessage(editVenueMessageDiv, 'Error: You are not authorized to update venues.', 'error');
                           console.error("Authorization error updating venue:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(editVenueMessageDiv, `Error updating venue: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error updating venue:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(editVenueMessageDiv, 'Network error submitting venue update.', 'error');
                     console.error("Fetch error for venue update:", error);
                 } finally {
                     submitEditVenueButton.disabled = false;
                 }
            });


            // Attach event listener for applying venue filters
            applyVenueFiltersButton.addEventListener('click', () => {
                fetchAndDisplayVenues(); // Refetch venues with current filters
            });

            // --- Styles Management JavaScript ---

            // --- Styles Section Logic ---
            const addStyleButton = document.getElementById('add-style-button');
             const addStyleModal = document.getElementById('add-style-modal');
             const addStyleForm = document.getElementById('add-style-form');
             const submitCreateStyleButton = document.getElementById('submit-create-style');
             const createStyleMessageDiv = document.getElementById('create-style-message');
             const styleListDiv = document.getElementById('style-list');

             // Filter and Sort Elements for Styles
             const styleSearchInput = document.getElementById('style-search'); // Add this
             const styleSortBySelect = document.getElementById('style-sort-by'); // Add this
             const applyStyleFiltersButton = document.getElementById('apply-style-filters-button'); // Add this

             // Edit Style Modal Elements
             const editStyleModal = document.getElementById('edit-style-modal'); // Add this
             const editStyleForm = document.getElementById('edit-style-form'); // Add this
             const submitEditStyleButton = document.getElementById('submit-edit-style'); // Add this
             const editStyleIdInput = document.getElementById('edit-style-id'); // Add this
             const editStyleTitleInput = document.getElementById('edit-style-title'); // Add this
             const editStyleDescriptionInput = document.getElementById('edit-style-description'); // Add this
             const editStyleMessageDiv = document.getElementById('edit-style-message'); // Add this


             // Open Add Style Modal
             addStyleButton.addEventListener('click', () => {
                  addStyleModal.style.display = 'block';
                  createStyleMessageDiv.textContent = '';
                  createStyleMessageDiv.className = 'message text-center';
                  createStyleMessageDiv.style.display = 'none';
                  addStyleForm.reset();
             });


            // Submit Create Style Form
            submitCreateStyleButton.addEventListener('click', async () => {
                 createStyleMessageDiv.style.display = 'none';
                 createStyleMessageDiv.textContent = '';
                 createStyleMessageDiv.className = 'message text-center';
                 submitCreateStyleButton.disabled = true;

                 const title = document.getElementById('style-title').value.trim();
                 const description = document.getElementById('style-description').value.trim();

                  if (!title) {
                     displayMessage(createStyleMessageDiv, 'Title is required.', 'error');
                     submitCreateStyleButton.disabled = false;
                     return;
                 }

                  const styleData = {
                     title: title,
                     description: description || null,
                 };

                 console.log("Sending Style Data:", styleData);

                  try {
                     const response = await fetch('/api/style/create', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(styleData)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Style created successfully:", responseData);
                         displayMessage(createStyleMessageDiv, responseData.message || 'Style created successfully!', 'success');

                         setTimeout(() => {
                             closeModal(addStyleModal);
                             fetchAndDisplayStyles();
                            //  fetchStylesForSelect(classStyleSelect);
                            //  fetchStylesForSelect(editClassStyleSelect);
                         }, 2000);

                     } else if (responseData && responseData.error_message) {
                         displayMessage(createStyleMessageDiv, `Creation failed: ${responseData.error_message}`, 'error');
                         console.error("Server error creating style:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                           const errorText = await response.text();
                           displayMessage(createStyleMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                           console.error("Bad request creating style:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                           displayMessage(createStyleMessageDiv, 'Error: You are not authorized to create styles.', 'error');
                            console.error("Authorization error creating style:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(createStyleMessageDiv, `Error creating style: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error creating style:", response.status, errorText);
                     }

                  } catch (error) {
                      console.error('Error creating style:', error);
                     displayMessage(createStyleMessageDiv, 'Failed to connect to the server.', 'error');
                  } finally {
                      submitCreateStyleButton.disabled = false;
                  }
             });


            


            // Submit Edit Style Form
            submitEditStyleButton.addEventListener('click', async () => {
                 editStyleMessageDiv.style.display = 'none';
                 editStyleMessageDiv.textContent = '';
                 editStyleMessageDiv.className = 'message text-center';
                 submitEditStyleButton.disabled = true;

                const styleId = editStyleIdInput.value;
                const title = editStyleTitleInput.value.trim();
                const description = editStyleDescriptionInput.value.trim();

                 if (!title) {
                     displayMessage(editStyleMessageDiv, 'Title is required.', 'error');
                     submitEditStyleButton.disabled = false;
                     return;
                 }

                 const formattedDescription = description === '' ? null : description;

                 const requestBody = {
                     style_id: styleId, // Include the style ID for update
                     title: title,
                     description: formattedDescription,
                 };

                console.log("Sending style update request:", requestBody);

                 try {
                     // Assuming you have a PUT /api/style/update/{id} endpoint
                     const response = await fetch(`/api/style/update`, {
                         method: 'PUT',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Style updated successfully:", responseData);
                         displayMessage(editStyleMessageDiv, responseData.message || 'Style updated successfully!', 'success');

                         setTimeout(() => {
                             closeModal(editStyleModal);
                             fetchAndDisplayStyles();
                              // Also refresh style selects in other modals if open
                             fetchStylesForSelect(classStyleSelect);
                             fetchStylesForSelect(editClassStyleSelect);
                         }, 2000);
                     } else if (responseData && responseData.error_message) {
                         displayMessage(editStyleMessageDiv, `Update failed: ${responseData.error_message}`, 'error');
                         console.error("Server error updating style:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                          const errorText = await response.text();
                          displayMessage(editStyleMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                          console.error("Bad request updating style:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                          displayMessage(editStyleMessageDiv, 'Error: You are not authorized to update styles.', 'error');
                           console.error("Authorization error updating style:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(editStyleMessageDiv, `Error updating style: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error updating style:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(editStyleMessageDiv, 'Network error submitting style update.', 'error');
                     console.error("Fetch error for style update:", error);
                 } finally {
                     submitEditStyleButton.disabled = false;
                 }
            });

             // Attach event listener for applying style filters
             applyStyleFiltersButton.addEventListener('click', () => {
                 fetchAndDisplayStyles();
             });



            // Handle initial section display
            setTimeout(() => {
                const currentHash = window.location.hash;
                const initialSection = currentHash ? currentHash.substring(1) : 'frontpage';
                const currentNavLinks = document.querySelectorAll('nav ul li a[data-section]');
                const validSections = Array.from(currentNavLinks).map(link => link.getAttribute('data-section'));
                
                console.log('Current URL:', window.location.href);
                console.log('Current hash:', currentHash);
                console.log('Initial section:', initialSection);
                console.log('Valid sections:', validSections);
                
                if (validSections.includes(initialSection)) {
                    console.log('Showing initial section:', initialSection);
                    showSection(initialSection);
                } else {
                    console.log('Section not valid, showing default frontpage section');
                    showSection('frontpage');
                }
            }, 100);
        });

        // Backup initialization on window load in case DOMContentLoaded doesn't work properly
        window.addEventListener('load', () => {
            // Fix classesSection DOM structure if it's incorrectly placed
            const classesSection = document.getElementById('classesSection');
            if (classesSection && classesSection.parentElement.id === 'dashboardSection') {
                console.log('FIXING: Moving classesSection out of dashboardSection on page load');
                const mainContainer = document.querySelector('.max-w-7xl');
                if (mainContainer) {
                    mainContainer.appendChild(classesSection);
                    console.log('Moved classesSection to main container on page load');
                    
                    // Apply normal styling
                    classesSection.style.cssText = `
                        position: relative !important;
                        background: transparent !important;
                        border: none !important;
                        width: auto !important;
                        height: auto !important;
                        z-index: auto !important;
                        opacity: 1 !important;
                    `;
                }
            }
            
            // Check if any section is already visible
            const visibleSection = document.querySelector('.portal-section.active, .portal-section[style*="block"]');
            console.log('Window load - visible section:', visibleSection?.id);
            console.log('Window load - current hash:', window.location.hash);
            
            if (!visibleSection) {
                console.log('No section visible on window load, checking hash again');
                const currentHash = window.location.hash;
                const hashSection = currentHash ? currentHash.substring(1) : 'frontpage';
                
                if (hashSection && hashSection !== 'frontpage') {
                    console.log('Attempting to show hash section:', hashSection);
                    const targetSection = document.getElementById(hashSection + 'Section');
                    if (targetSection) {
                        targetSection.classList.add('active');
                        targetSection.style.display = 'block';
                        console.log('Forced display of section:', hashSection);
                        return;
                    }
                }
                
                console.log('Falling back to frontpage');
                const frontpageSection = document.getElementById('frontpageSection');
                if (frontpageSection) {
                    frontpageSection.classList.add('active');
                    frontpageSection.style.display = 'block';
                }
            }
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', () => {
            const currentSection = window.location.hash ? window.location.hash.substring(1) : 'frontpage';
            const currentNavLinks = document.querySelectorAll('nav ul li a[data-section]');
            const validSections = Array.from(currentNavLinks).map(link => link.getAttribute('data-section'));
            
            if (validSections.includes(currentSection)) {
                showSection(currentSection);
            } else {
                showSection('frontpage');
            }
        });

        // Function to handle the class section display logic
        // function handleClassSection() {
   
            // --- Portal Navigation Logic (Keep your existing navigation logic here) ---
            // ... (Your showPortalSection, navLinks event listeners, popstate, initial section logic) ...

             // --- Global Modal Closing (Keep your existing global modal closing logic here) ---
             // ... (Your closeModal function, closeButtons event listeners, window click listener) ...

            // Add references to the new modals here so closeModal can find them
            const editClassModal = document.getElementById('edit-class-modal');
            const venueInfoModal = document.getElementById('venue-info-modal');


            // --- Classes Section Logic ---
            const classListDiv = document.getElementById('class-list');
            let cachedClassesData = null; // Cache for classes data to avoid repeated API calls
            const addClassButton = document.getElementById('createClassBtn');
            const addClassModal = document.getElementById('add-class-modal');
            const addClassForm = document.getElementById('add-class-form');
            const submitCreateClassButton = document.getElementById('submit-create-class');
            const classMessageDiv = document.getElementById('create-class-message');
            const frequencyContainer = document.getElementById('frequency-container');
            const addFrequencyButton = document.getElementById('add-frequency-button');
            const classVenueSelect = document.getElementById('class-venue-id');
            const classStyleSelect = document.getElementById('class-style-ids');

            // Filter and Sort Elements (using let so they can be reassigned after DOM reconstruction)
            let classFilterStyle = document.getElementById('class-filter-style');
            let classFilterVenue = document.getElementById('class-filter-venue');
            let classSortBy = document.getElementById('class-sort-by');
            let classSearchInput = document.getElementById('class-search');
            let applyFiltersButton = document.getElementById('apply-filters-button');

            // Join by Code Elements
            const classCodeInput = document.getElementById('class-code-input');
            const joinByCodeButton = document.getElementById('join-by-code-button');
            const joinByCodeMessageDiv = document.getElementById('join-by-code-message');

             // Edit Class Modal Elements
             const editClassForm = document.getElementById('edit-class-form');
             const submitEditClassButton = document.getElementById('submit-edit-class');
             const editClassIdInput = document.getElementById('edit-class-id');
             const editClassTitleInput = document.getElementById('edit-class-title');
             const editClassDescriptionInput = document.getElementById('edit-class-description');
             const editClassVenueSelect = document.getElementById('edit-class-venue-id');
             const editClassStyleSelect = document.getElementById('edit-class-style-ids');
             const editClassGradingIdsInput = document.getElementById('edit-class-grading-ids');
             const editClassPriceInput = document.getElementById('edit-class-price');
             const editClassPublishModeInput = document.getElementById('edit-class-publish-mode');
             const editClassCapacityInput = document.getElementById('edit-class-capacity');
             const editFrequencyContainer = document.getElementById('edit-frequency-container');
             const addEditFrequencyButton = document.getElementById('add-edit-frequency-button');
             const editClassNotifyBookingCheckbox = document.getElementById('edit-class-notify-booking');
             const editClassWaiverIdInput = document.getElementById('edit-class-waiver-id');
             const editClassMessageDiv = document.getElementById('edit-class-message');
             const editClassFreeLessonsInput = document.getElementById('edit-class-free_lessons');
             

            // Venue Info Modal Elements
            const venueInfoContentDiv = document.getElementById('venue-info-content');
            const closeButtons = document.querySelectorAll('.modal .close-button'); // Select all close buttons for modals  .cancel-button

            // Close Modals (Reusable function)
            function closeModal(modalElement) {
                 modalElement.style.display = 'none';
                 // Clear specific form and message
                 if (modalElement.id === 'add-class-modal') {
                     addClassForm.reset();
                     frequencyContainer.innerHTML = ''; // Clear frequency entries
                     classMessageDiv.textContent = '';
                     classMessageDiv.style.display = 'none';
                 } else if (modalElement.id === 'add-venue-modal') {
                     addVenueForm.reset();
                     createVenueMessageDiv.textContent = '';
                     createVenueMessageDiv.style.display = 'none';
                 } else if (modalElement.id === 'add-style-modal') {
                     addStyleForm.reset();
                     createStyleMessageDiv.textContent = '';
                     createStyleMessageDiv.style.display = 'none';
                 } else if (modalElement.id === 'create-waiver-modal') {
                     createWaiverModal.style.display = 'none'; // Specific closing logic for waiver modal
                     newWaiverTitleInput.value = '';
                     newWaiverContentInput.value = '';
                     createWaiverErrorDiv.textContent = '';
                     createWaiverErrorDiv.className = 'message'; // Reset classes
                 }
                 // Add more modals here
             }


             // Attach close listeners to all close buttons
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Find the parent modal and close it
                    const modal = button.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                });
            });

            const cancelButtons = document.querySelectorAll('.modal .cancel-button'); // Select all close buttons for modals  .cancel-button
            // Attach close listeners to all close buttons
            cancelButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Find the parent modal and close it
                    const modal = button.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                });
            });


             // --- Helper Functions ---

             // Template for a single frequency entry (using a function to generate HTML with Tailwind classes)
             function createFrequencyEntryHTML(frequency = {}, isEdit = false) {
                // Generate a unique ID for the HTML inputs even if frequency has an ID
                const htmlId = Date.now() + Math.random().toString(36).substr(2, 9);
                const prefix = isEdit ? 'edit-freq' : 'freq';

                const frequencyId = frequency.class_frequency_id || ''; // Get the class_frequency_id if it exists
                const frequencyValue = frequency.frequency || '';
                const startDateValue = frequency.start_date || '';
                const endDateValue = frequency.end_date || '';
                const startTimeValue = frequency.start_time || '';
                const endTimeValue = frequency.end_time || '';

                return `
                    <div class="frequency-entry relative border border-dashed border-gray-300 p-4 rounded-md mb-4" data-id="${htmlId}" data-frequency-id="${frequencyId}">
                        <button type="button" class="remove-frequency-button absolute top-2 right-2 bg-red-500 text-white rounded px-2 py-1 text-xs font-medium hover:bg-red-600">Remove</button>
                        ${isEdit && frequencyId ? `<input type="hidden" name="${prefix}-${htmlId}-id" value="${frequencyId}">` : ''} <!-- Hidden input for frequency ID -->
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-frequency" class="block text-sm font-medium text-gray-700 mb-1">Frequency:</label>
                            <select id="${prefix}-${htmlId}-frequency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="">Select frequency...</option>
                                ${getFrequencyOptions().map(option => 
                                    `<option value="${option.id}" ${frequencyValue == option.id ? 'selected' : ''}>${option.label}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date:</label>
                            <input type="date" id="${prefix}-${htmlId}-start-date" value="${startDateValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date:</label>
                            <input type="date" id="${prefix}-${htmlId}-end-date" value="${endDateValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time:</label>
                            <input type="time" id="${prefix}-${htmlId}-start-time" value="${startTimeValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time:</label>
                            <input type="time" id="${prefix}-${htmlId}-end-time" value="${endTimeValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                `;
            }

             // Function to get user ID (Implement based on how you store it after login)
             function getUserIdFromCookieOrStorage() {
                 // Example: Reading from a cookie named 'user_id'
                 const name = 'user_id=';
                 const decodedCookie = decodeURIComponent(document.cookie);
                 const ca = decodedCookie.split(';');
                 for(let i = 0; i <ca.length; i++) {
                     let c = ca[i];
                     while (c.charAt(0) === ' ') {
                         c = c.substring(1);
                     }
                     if (c.indexOf(name) === 0) {
                         return c.substring(name.length, c.length);
                     }
                 }
                 return null; // Return null if not found
             }


            // Function to check if a frequency should run today
            function shouldFrequencyRunToday(frequency, startDate, endDate) {
                let today = new Date(); // local
                today.setHours(0, 0, 0, 0);
                // let today = new Date(today + today.getTimezoneOffset() * 60000); // Normalize to UTC date
                // const todayDateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format // UTC
                // const todayDate = new Date(todayDateStr); // Normalize to date only // UTC
                
                let startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0); // Normalize to date only
                
                // Check if today is within the date bounds
                if (today < startDateObj) {
                    return false;
                }
                
                if (endDate) {
                    const endDateObj = new Date(endDate);
                    if (today > endDateObj) {
                        return false;
                    }
                }
                
                const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                
                switch (frequency) {
                    case 1: // Every Monday
                        return dayOfWeek === 1;
                    case 2: // Every Tuesday
                        return dayOfWeek === 2;
                    case 3: // Every Wednesday
                        return dayOfWeek === 3;
                    case 4: // Every Thursday
                        return dayOfWeek === 4;
                    case 5: // Every Friday
                        return dayOfWeek === 5;
                    case 6: // Every Saturday
                        return dayOfWeek === 6;
                    case 7: // Every Sunday
                        return dayOfWeek === 0;
                    case 8: // Every Weekday
                        return dayOfWeek >= 1 && dayOfWeek <= 5;
                    case 9: // Every Weekend
                        return dayOfWeek === 0 || dayOfWeek === 6;
                    case 10: // Every Day
                        return true;
                    case 11: // Public Holidays
                        // Would need holiday calendar integration
                        return false;
                    case 12: // One off
                    case 16: // One off
                        // For one-off, check if today matches the start date exactly
                        return today.toDateString() === startDateObj.toDateString();
                    case 13: // Every week (same as every day within bounds)
                        return true;
                    case 14: // Every fortnight
                        const daysDiff = Math.floor((today - startDateObj) / (1000 * 60 * 60 * 24));
                        const weeksDiff = Math.floor(daysDiff / 7);
                        return weeksDiff >= 0 && weeksDiff % 2 === 0;
                    case 15: // Every month
                        return today.getDate() === startDateObj.getDate();
                    default:
                        console.warn(`Unknown frequency code: ${frequency}`);
                        return false;
                }
            }

            // Function to calculate the next run time for a frequency
            function getNextRunTime(frequency, startDate, endDate, startTime) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0);
                
                // Check if we're past the end date
                if (endDate) {
                    const endDateObj = new Date(endDate);
                    if (today > endDateObj) {
                        return null; // No more runs
                    }
                }
                
                // Start checking from today
                let checkDate = new Date(Math.max(today.getTime(), startDateObj.getTime()));
                
                // Look ahead up to 365 days to find next occurrence
                for (let i = 0; i < 365; i++) {
                    const dayOfWeek = checkDate.getDay();
                    let shouldRun = false;
                    
                    switch (frequency) {
                        case 1: // Every Monday
                            shouldRun = dayOfWeek === 1;
                            break;
                        case 2: // Every Tuesday
                            shouldRun = dayOfWeek === 2;
                            break;
                        case 3: // Every Wednesday
                            shouldRun = dayOfWeek === 3;
                            break;
                        case 4: // Every Thursday
                            shouldRun = dayOfWeek === 4;
                            break;
                        case 5: // Every Friday
                            shouldRun = dayOfWeek === 5;
                            break;
                        case 6: // Every Saturday
                            shouldRun = dayOfWeek === 6;
                            break;
                        case 7: // Every Sunday
                            shouldRun = dayOfWeek === 0;
                            break;
                        case 8: // Every Weekday
                            shouldRun = dayOfWeek >= 1 && dayOfWeek <= 5;
                            break;
                        case 9: // Every Weekend
                            shouldRun = dayOfWeek === 0 || dayOfWeek === 6;
                            break;
                        case 10: // Every Day
                            shouldRun = true;
                            break;
                        case 12: // One off
                        case 16: // One off
                            shouldRun = checkDate.toDateString() === startDateObj.toDateString();
                            break;
                        case 13: // Every week (same as every day within bounds)
                            shouldRun = true;
                            break;
                        case 14: // Every fortnight
                            const daysDiff = Math.floor((checkDate - startDateObj) / (1000 * 60 * 60 * 24));
                            const weeksDiff = Math.floor(daysDiff / 7);
                            shouldRun = weeksDiff >= 0 && weeksDiff % 2 === 0;
                            break;
                        case 15: // Every month
                            shouldRun = checkDate.getDate() === startDateObj.getDate();
                            break;
                        default:
                            return null;
                    }
                    
                    if (shouldRun) {
                        // Create the full datetime for this occurrence
                        const nextRun = new Date(checkDate);
                        const [hours, minutes, seconds] = startTime.split(':');
                        nextRun.setHours(parseInt(hours), parseInt(minutes), parseInt(seconds || 0));
                        
                        // If it's today, make sure the time hasn't passed yet
                        if (checkDate.toDateString() === today.toDateString()) {
                            const now = new Date();
                            if (nextRun <= now) {
                                // Time has passed today, continue to next day
                                checkDate.setDate(checkDate.getDate() + 1);
                                continue;
                            }
                        }
                        
                        return nextRun;
                    }
                    
                    checkDate.setDate(checkDate.getDate() + 1);
                }
                
                return null; // No occurrence found in the next 365 days
            }

            // Function to update join button states based on current attendance
            async function updateJoinButtonStates(targetDiv = classListDiv) {
                const joinButtons = targetDiv.querySelectorAll('.join-class-button');
                const currentUserId = my_user_id;
                
                if (!currentUserId) return;
                
                for (const button of joinButtons) {
                    const classId = button.getAttribute('data-class-id');
                    const nextRunTimeStamp = button.getAttribute('data-next-run');
                    
                    if (!nextRunTimeStamp) continue;
                    
                    try {
                        const timeSegment = parseInt(nextRunTimeStamp);
                        const studentsResponse = await fetch('/api/class/get_students', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                class_id: classId,
                                class_start_ts: timeSegment
                            })
                        });
                        
                        if (studentsResponse.ok) {
                            const studentsData = await studentsResponse.json();
                            const students = studentsData.students || [];
                            const currentUserAttendance = students.find(student => student.user_id === currentUserId);
                            const isCurrentlyAttending = currentUserAttendance && currentUserAttendance.attended;
                            
                            if (isCurrentlyAttending) {
                                button.textContent = 'Leave Class';
                                button.className = 'join-class-button py-2 px-4 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 text-sm';
                            } else {
                                button.textContent = 'Join Class';
                                button.className = 'join-class-button py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 text-sm';
                            }
                        }
                    } catch (error) {
                        console.error('Error checking attendance for button state:', error);
                    }
                }
            }

            // --- API Fetch Functions ---

            // Helper function to get frequency label from ID
            function getFrequencyLabel(frequencyId) {
                const frequencyMap = {
                    1: 'Every Monday',
                    2: 'Every Tuesday', 
                    3: 'Every Wednesday',
                    4: 'Every Thursday',
                    5: 'Every Friday',
                    6: 'Every Saturday',
                    7: 'Every Sunday',
                    8: 'Every Weekday',
                    9: 'Every Weekend',
                    10: 'Every Day',
                    11: 'Public Holidays',
                    12: 'One Off',
                    13: 'Every Week',
                    16: 'One Off (Alt)'
                };
                return frequencyMap[frequencyId] || `Frequency ${frequencyId}`;
            }

            // Helper function to get all frequency options
            function getFrequencyOptions() {
                return [
                    { id: 1, label: 'Every Monday' },
                    { id: 2, label: 'Every Tuesday' },
                    { id: 3, label: 'Every Wednesday' },
                    { id: 4, label: 'Every Thursday' },
                    { id: 5, label: 'Every Friday' },
                    { id: 6, label: 'Every Saturday' },
                    { id: 7, label: 'Every Sunday' },
                    { id: 8, label: 'Every Weekday (Mon-Fri)' },
                    { id: 9, label: 'Every Weekend (Sat-Sun)' },
                    { id: 10, label: 'Every Day' },
                    { id: 11, label: 'Public Holidays' },
                    { id: 12, label: 'One Off Event' },
                    { id: 13, label: 'Every Week' },
                    { id: 16, label: 'One Off (Alternative)' }
                ];
            }

            // Function to apply client-side filtering, searching, and sorting to classes
            function applyClassFilters(classes) {
                // Get filter and sort parameters
                console.log('Applying filters. Elements:', {
                    styleFilter: classFilterStyle,
                    venueFilter: classFilterVenue,
                    sortBy: classSortBy,
                    searchInput: classSearchInput
                });
                
                const styleFilterValue = classFilterStyle ? classFilterStyle.value : '';
                const venueFilterValue = classFilterVenue ? classFilterVenue.value : '';
                const sortBy = classSortBy ? classSortBy.value : '';
                const searchTerm = classSearchInput ? classSearchInput.value.trim().toLowerCase() : '';
                
                console.log('Filter values:', {
                    style: styleFilterValue,
                    venue: venueFilterValue,
                    sort: sortBy,
                    search: searchTerm
                });
                
                let filtered = [...classes];
                
                // Apply style filter (single-selection)
                // Only filter if a specific style is selected (not "all")
                if (styleFilterValue && styleFilterValue !== 'all') {
                    filtered = filtered.filter(cls => {
                        if (!cls.styles || !Array.isArray(cls.styles)) return false;
                        return cls.styles.some(style => {
                            const styleId = typeof style === 'object' ? style.style_id : style;
                            return styleId === styleFilterValue;
                        });
                    });
                }
                
                // Apply venue filter (single-selection) 
                // Only filter if a specific venue is selected (not "all")
                if (venueFilterValue && venueFilterValue !== 'all') {
                    filtered = filtered.filter(cls => cls.venue_id === venueFilterValue);
                }
                
                // Apply search filter
                if (searchTerm) {
                    filtered = filtered.filter(cls => {
                        const title = (cls.title || '').toLowerCase();
                        const description = (cls.description || '').toLowerCase();
                        return title.includes(searchTerm) || description.includes(searchTerm);
                    });
                }
                
                // Apply sorting
                if (sortBy) {
                    filtered.sort((a, b) => {
                        switch (sortBy) {
                            case 'title':
                                return (a.title || '').localeCompare(b.title || '');
                            case 'price':
                                const priceA = parseFloat(a.price) || 0;
                                const priceB = parseFloat(b.price) || 0;
                                return priceA - priceB;
                            case 'capacity':
                                return (a.capacity || 0) - (b.capacity || 0);
                            case 'next_run_time':
                                // Calculate next run times for both classes and compare
                                let nextRunA = null;
                                let nextRunB = null;
                                
                                // Calculate next run time for class A
                                if (a.frequencies && a.frequencies.length > 0) {
                                    const freq = a.frequencies[0]; // Use first frequency
                                    nextRunA = getNextRunTime(freq.frequency, freq.start_date, freq.end_date, freq.start_time);
                                }
                                
                                // Calculate next run time for class B
                                if (b.frequencies && b.frequencies.length > 0) {
                                    const freq = b.frequencies[0]; // Use first frequency
                                    nextRunB = getNextRunTime(freq.frequency, freq.start_date, freq.end_date, freq.start_time);
                                }
                                
                                // Handle null cases (classes with no upcoming runs go to the end)
                                if (nextRunA === null && nextRunB === null) return 0;
                                if (nextRunA === null) return 1; // A goes after B
                                if (nextRunB === null) return -1; // A goes before B
                                
                                // Both have next run times, sort by earliest first
                                return nextRunA.getTime() - nextRunB.getTime();
                            default:
                                return 0;
                        }
                    });
                }
                
                console.log(`Filtering result: ${classes.length} -> ${filtered.length} classes`);
                return filtered;
            }

            // Function to fetch venues for multi-select filter dropdown
            async function fetchVenuesForFilter(selectElement, preserveSelections = false) {
                console.log("Fetching venues for filter:", selectElement.id);
                
                // Save current selections if preserving
                let currentSelections = [];
                if (preserveSelections && selectElement.options) {
                    currentSelections = Array.from(selectElement.selectedOptions).map(option => option.value);
                }
                
                selectElement.innerHTML = '<option value="" disabled>Loading venues...</option>';
                selectElement.disabled = true;
                
                try {
                    const response = await fetch('/api/venue/get_list', { method: 'GET' });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && result.venues) {
                            const venues = result.venues;
                            selectElement.disabled = false;
                            
                            if (venues.length > 0) {
                                let optionsHtml = '';
                                
                                // Add "All Venues" option
                                optionsHtml += `<option value="all">All Venues</option>`;
                                
                                // Add individual venue options
                                venues.forEach(venue => {
                                    optionsHtml += `<option value="${venue.venue_id}">${venue.title}</option>`;
                                    add_cached_value("venue", venue.venue_id, venue);
                                });
                                selectElement.innerHTML = optionsHtml;
                            } else {
                                selectElement.innerHTML = '<option value="" disabled>No venues found</option>';
                            }
                        } else {
                            selectElement.innerHTML = `<option value="" disabled>Error: ${result.error_message || 'Unknown error'}</option>`;
                            console.error('Backend success: false for venues:', result.error_message);
                        }
                    } else {
                        selectElement.innerHTML = '<option value="" disabled>Failed to load venues</option>';
                        console.error('Failed to fetch venues:', response.status);
                    }
                } catch (error) {
                    selectElement.innerHTML = '<option value="" disabled>Network error</option>';
                    console.error('Error fetching venues:', error);
                }
            }

            // Function to fetch styles for multi-select filter dropdown
            async function fetchStylesForFilter(selectElement, preserveSelections = false) {
                console.log("Fetching styles for filter:", selectElement.id);
                
                // Save current selections if preserving
                let currentSelections = [];
                if (preserveSelections && selectElement.options) {
                    currentSelections = Array.from(selectElement.selectedOptions).map(option => option.value);
                }
                
                selectElement.innerHTML = '<option value="" disabled>Loading styles...</option>';
                selectElement.disabled = true;
                
                try {
                    const response = await fetch('/api/style/get_list', { method: 'GET' });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.success && Array.isArray(result.styles)) {
                            selectElement.disabled = false;
                            
                            if (result.styles.length > 0) {
                                let optionsHtml = '';
                                
                                // Add "All Styles" option
                                optionsHtml += `<option value="all">All Styles</option>`;
                                
                                // Add individual style options
                                result.styles.forEach(style => {
                                    optionsHtml += `<option value="${style.style_id}">${style.title}</option>`;
                                    add_cached_value("style", style.style_id, style);
                                });
                                selectElement.innerHTML = optionsHtml;
                            } else {
                                selectElement.innerHTML = '<option value="" disabled>No styles found</option>';
                            }
                        } else {
                            selectElement.innerHTML = `<option value="" disabled>Error: ${result.error_message || 'Unknown error'}</option>`;
                            console.error('Backend success: false for styles:', result.error_message);
                        }
                    } else {
                        selectElement.innerHTML = '<option value="" disabled>Failed to load styles</option>';
                        console.error('Failed to fetch styles:', response.status);
                    }
                } catch (error) {
                    selectElement.innerHTML = '<option value="" disabled>Network error</option>';
                    console.error('Error fetching styles:', error);
                }
            }

            // Function to fetch and display classes as cards
             async function fetchAndDisplayClasses() {
                if (!classListDiv) {
                    console.error('classListDiv is null! Element with id="class-list" not found!');
                    return;
                }
                
                classListDiv.innerHTML = '<p class="text-gray-600 italic">Loading classes...</p>';

                const url = `/api/class/get_list`;

                try {
                     const response = await fetch(url, {
                         method: 'GET',
                         headers: {
                            'Content-Type': 'application/json'
                         }
                     });

                     if (response.ok) {
                        const allClasses = await response.json();
                        console.log('Classes received:', allClasses);
                        
                        // Cache the data for filtering
                        cachedClassesData = allClasses;
                        
                        // Apply client-side filtering
                        const filteredClasses = applyClassFilters(allClasses);
                        console.log('Classes after filtering:', filteredClasses.length);
                        
                        if (filteredClasses.length > 0) {
                            let html = '';

                            filteredClasses.forEach((cls, index) => {
                                console.log(`Processing class ${index}:`, cls);
                                add_cached_value('class', cls.class_id, cls); // Cache the class data for later use

                                // Determine eligibility status
                                let eligibilityStatus = cls.eligibility || 'Not specified';
                                let eligibilityColor = 'text-gray-600';
                                if (eligibilityStatus.toLowerCase().includes('eligible')) {
                                    eligibilityColor = 'text-green-600';
                                } else if (eligibilityStatus.toLowerCase().includes('ineligible')) {
                                    eligibilityColor = 'text-red-600';
                                }

                                 // Format price
                                const formattedPrice = cls.price !== undefined && cls.price !== null ? `$${parseFloat(cls.price).toFixed(2)}` : 'Free';
                                let venue_name = '';
                                let venue_data = get_cached_value('venue', cls.venue_id);

                                if (venue_data != null) {
                                    venue_name = venue_data.title;
                                } else {
                                    venue_name = 'N/A'; 
                                }
                                
                                // Calculate next run time for this class
                                let nextRunTime = null;
                                let nextRunTimeStr = 'Not scheduled';
                                
                                if (cls.frequency && cls.frequency.length > 0) {
                                    let earliestNextRun = null;
                                    
                                    cls.frequency.forEach(class_frequency => {
                                        const nextRun = getNextRunTime(
                                            class_frequency.frequency,
                                            class_frequency.start_date,
                                            class_frequency.end_date,
                                            class_frequency.start_time
                                        );
                                        
                                        if (nextRun && (!earliestNextRun || nextRun < earliestNextRun)) {
                                            earliestNextRun = nextRun;
                                        }
                                    });
                                    
                                    if (earliestNextRun) {
                                        nextRunTime = earliestNextRun;
                                        nextRunTimeStr = earliestNextRun.toLocaleString();
                                    }
                                }
                                
                                // Check if class runs today and generate join button accordingly
                                let joinButtonHtml = '';
                                let classRunsToday = false;
                                
                                if (cls.frequency && cls.frequency.length > 0) {
                                    cls.frequency.forEach(class_frequency => {
                                        if (shouldFrequencyRunToday(
                                            class_frequency.frequency,
                                            class_frequency.start_date,
                                            class_frequency.end_date
                                        )) {
                                            classRunsToday = true;
                                        }
                                    });
                                }
                                
                                if (classRunsToday) {
                                    // Note: Initial button state is "Join Class" - the actual state will be updated after page load
                                    // when the event listener checks current attendance status
                                    joinButtonHtml = `<button class="join-class-button py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 text-sm" data-class-id="${cls.class_id}" data-next-run="${nextRunTime ? nextRunTime.getTime() : ''}">Join Class</button>`;
                                }
                                
                                // Updated calendar event addition code
                                const today = new Date();
                                const todayStr = today.toLocaleDateString(); //.split('T')[0]; // Get today's date in YYYY-MM-DD format
                                const year = todayStr.split('/')[2];
                                const month = todayStr.split('/')[1].padStart(2, '0'); // Ensure two digits
                                const day = todayStr.split('/')[0].padStart(2, '0'); // Ensure two digits
                                var all_event_ids = [];
                                cls.frequency.forEach(class_frequency => {
                                    // Check if this frequency should run today
                                    if (shouldFrequencyRunToday(
                                        class_frequency.frequency, 
                                        class_frequency.start_date, 
                                        class_frequency.end_date
                                    )) {
                                        // let starta = new Date(`${todayStr}T${class_frequency.start_time}`); // Adjust for timezone offset
                                        // let startb = today.getTimezoneOffset() * 1000; // Adjust for timezone offset
                                        
                                        let start = new Date( new Date(`${year}-${month}-${day}T${class_frequency.start_time}`)); // Adjust for timezone offset
                                        let end = new Date( new Date(`${year}-${month}-${day}T${class_frequency.end_time}`)); // Adjust for timezone offset
                                        // start.setMinutes(start.getMinutes() - start.getTimezoneOffset()); // Adjust for timezone offset
                                        // end.setMinutes(end.getMinutes() - end.getTimezoneOffset()); // Adjust for timezone offset
                                        console.log("Frequency start time:", class_frequency, cls);
                                        // Add the calendar event only if it should run today
                                        calendar.addEvent(
                                            start,
                                            end,
                                            cls.title,
                                            cls.description,
                                            venue_name,
                                            cls.class_id,
                                            class_frequency.class_frequency_id
                                        );
                                        all_event_ids.push(class_frequency.class_frequency_id);
                                    }
                                });

                                calendar.removeNonPresentClassIdEvents(cls.class_id, all_event_ids);
                                var editbtn = ``;
                                if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin])) {
                                    editbtn = `<button class="edit-class-button py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 text-sm" data-class-id="${cls.class_id}">Edit</button>`;
                                }


                                 html += `
                                     <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                                         <h3 class="text-xl font-semibold text-gray-900 mb-2">${cls.title}</h3>
                                         <p class="text-gray-700 mb-4">${cls.description}</p>

                                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                                             <div>
                                                 <p><strong class="font-medium">Venue:</strong> <span class="venue-name cursor-pointer text-blue-600 hover:underline" data-venue-id="${cls.venue_id}">${venue_data.title || 'N/A'}</span></p>
                                                  <p><strong class="font-medium">Address:</strong> ${venue_data.address || 'N/A'}</p>
                                                  ${venue_data.latitude && venue_data.longitude ?
                                                     `<p>
                                                         <strong class="font-medium">Map:</strong>
                                                         <a href="https://www.openstreetmap.org/?mlat=${venue_data.latitude}&mlon=${venue_data.longitude}#map=15/${venue_data.latitude}/${venue_data.longitude}" target="_blank" class="text-blue-600 hover:underline">View on Map</a>
                                                      </p>`
                                                     : ''}
                                             </div>
                                             <div>
                                                 <p><strong class="font-medium">Instructor:</strong> ${cls.instructor_name || 'N/A'}</p>
                                                 <p><strong class="font-medium">Styles:</strong> ${cls.style_names && cls.style_names.length > 0 ? cls.style_names.join(', ') : 'N/A'}</p>
                                                  <p><strong class="font-medium">Eligibility:</strong> <span class="${eligibilityColor}">${eligibilityStatus}</span></p>
                                                  <p><strong class="font-medium">Distance:</strong> ${cls.distance || 'N/A'}</p>
                                             </div>
                                         </div>

                                         <div class="text-sm text-gray-600 mb-4">
                                              <p><strong class="font-medium">Next Run Time:</strong> ${nextRunTimeStr}</p>
                                              <p><strong class="font-medium">Capacity:</strong> ${cls.capacity !== undefined ? cls.capacity : 'N/A'}</p>
                                              <p><strong class="font-medium">Price:</strong> ${formattedPrice}</p>
                                         </div>


                                         <div class="flex flex-wrap gap-3">
                                              ${joinButtonHtml}
                                             <!-- <button class="checkin-class-button py-2 px-4 bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition duration-200 text-sm" data-class-id="${cls.class_id}">Check-in</button> -->
                                             <button class="history-class-button py-2 px-4 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition duration-200 text-sm" data-class-id="${cls.class_id}" data-class-title="${cls.title}">üìä History</button>
                                             ${editbtn}
                                             <!-- Add Delete button if needed -->
                                         </div>
                                     </div>
                                 `;
                             });
                             console.log('Generated HTML length:', html.length);
                             console.log('Setting classListDiv innerHTML');
                             classListDiv.innerHTML = html;
                             console.log('classListDiv innerHTML set');
                             
                             // Debug visibility
                             const classesSection = document.getElementById('classesSection');
                             console.log('classesSection display style:', classesSection.style.display);
                             console.log('classesSection computed display:', getComputedStyle(classesSection).display);
                             console.log('classesSection classList:', classesSection.classList.toString());
                             console.log('First 500 chars of generated HTML:', html.substring(0, 500));
                             console.log('classListDiv after setting innerHTML:', classListDiv.innerHTML.substring(0, 200));
                             
                             
                             
                             // Debug the section dimensions and position
                             const rect = classesSection.getBoundingClientRect();
                             console.log('classesSection position:', rect);
                             console.log('classesSection width:', rect.width, 'height:', rect.height);
                             console.log('classesSection computed styles:', {
                                 display: getComputedStyle(classesSection).display,
                                 visibility: getComputedStyle(classesSection).visibility,
                                 opacity: getComputedStyle(classesSection).opacity,
                                 overflow: getComputedStyle(classesSection).overflow,
                                 position: getComputedStyle(classesSection).position,
                                 zIndex: getComputedStyle(classesSection).zIndex
                             });
                             
                             // Restore the original classes HTML structure
                             classesSection.innerHTML = `
                                 <div class="section-card bg-white rounded-3xl shadow-xl p-8 mb-8">
                                     <div class="flex items-center justify-between mb-8">
                                         <div>
                                             <h1 class="text-3xl font-bold text-gray-900 font-poppins">Classes Management</h1>
                                             <p class="text-gray-600 mt-2">Schedule and manage your martial arts classes</p>
                                         </div>
                                         <div class="flex space-x-4">
                                             <button id="createClassBtn" class="hidden inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300 transform hover:scale-105">
                                                 <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                 </svg>
                                                 Create Class
                                             </button>
                                         </div>
                                     </div>
                                     
                                     <!-- Filter and Sort Controls -->
                                     <div class="bg-gray-50 rounded-2xl p-6 mb-8">
                                         <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter & Search Classes</h3>
                                         <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                                             <div>
                                                 <label for="class-filter-style" class="block text-sm font-medium text-gray-700">Filter by Style:</label>
                                                 <select id="class-filter-style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                                     <option value="">All Styles</option>
                                                 </select>
                                             </div>
                                             <div>
                                                 <label for="class-filter-venue" class="block text-sm font-medium text-gray-700">Filter by Venue:</label>
                                                 <select id="class-filter-venue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                                     <option value="">All Venues</option>
                                                 </select>
                                             </div>
                                             <div>
                                                 <label for="class-sort-by" class="block text-sm font-medium text-gray-700">Sort By:</label>
                                                 <select id="class-sort-by" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                                     <option value="title" selected>Title (A-Z)</option>
                                                     <option value="next_run_time">Next Run Time</option>
                                                     <option value="price">Price (Low to High)</option>
                                                     <option value="capacity">Capacity</option>
                                                 </select>
                                             </div>
                                             <div>
                                                 <label for="class-search" class="block text-sm font-medium text-gray-700">Search:</label>
                                                 <input type="text" id="class-search" placeholder="Search by title, description..." class="mt-1 block w-full pl-3 pr-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                             </div>
                                             <div>
                                                 <button id="apply-filters-button" class="w-full py-2 px-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 transform hover:scale-105">
                                                     Apply Filters
                                                 </button>
                                             </div>
                                         </div>
                                     </div>

                                     <!-- Join by Code -->
                                     <div class="bg-blue-50 rounded-2xl p-6 mb-8">
                                         <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Join</h3>
                                         <div class="flex items-center gap-4">
                                             <div class="flex-grow">
                                                 <label for="class-code-input" class="block text-sm font-medium text-gray-700 mb-2">Join Class by Code:</label>
                                                 <input type="text" id="class-code-input" placeholder="Enter Class Code" class="w-full px-4 py-2 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                             </div>
                                             <div class="flex-shrink-0">
                                                 <button id="join-by-code-button" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 transform hover:scale-105 mt-6">
                                                     Join Class
                                                 </button>
                                             </div>
                                         </div>
                                         <div id="join-by-code-message" class="mt-4 text-center text-sm"></div>
                                     </div>

                                     <!-- Class listing area -->
                                     <div id="class-list" class="mt-6 space-y-6">
                                         <!-- Classes will be loaded here -->
                                     </div>
                                 </div>
                             `;
                             console.log('Restored original classes structure with proper HTML');
                             
                             // Now populate the class-list div with the generated class cards
                             const newClassListDiv = classesSection.querySelector('#class-list');
                             if (newClassListDiv && html) {
                                 newClassListDiv.innerHTML = html;
                                 console.log('Populated class-list with generated HTML');
                             }
                             
                             // Check for duplicate IDs or CSS overrides
                             const allClassesSections = document.querySelectorAll('#classesSection');
                             console.log('Number of elements with ID classesSection:', allClassesSections.length);
                             
                             const allClassLists = document.querySelectorAll('#class-list');
                             console.log('Number of elements with ID class-list:', allClassLists.length);
                             
                             // Check parent containers
                             console.log('classesSection parent:', classesSection.parentElement);
                             console.log('classesSection parent display:', getComputedStyle(classesSection.parentElement).display);
                             
                             // Apply clean normal styling, preserving display state
                             const currentCleanDisplay = classesSection.style.display;
                             classesSection.style.cssText = `
                                 display: ${currentCleanDisplay || (classesSection.classList.contains('active') ? 'block' : 'none')};
                                 position: relative !important;
                                 background: transparent !important;
                                 border: none !important;
                                 width: auto !important;
                                 height: auto !important;
                                 z-index: auto !important;
                                 opacity: 1 !important;
                              `;
                             console.log('Applied clean styling');
                             
                             // EMERGENCY FIX: Move classes section out of dashboard section
                             const mainContainer = document.querySelector('.max-w-7xl');
                             if (classesSection.parentElement.id === 'dashboardSection') {
                                 console.log('FIXING: Moving classesSection out of dashboardSection');
                                 
                                 // Preserve current display state before moving
                                 const currentDisplay = classesSection.style.display;
                                 
                                 mainContainer.appendChild(classesSection);
                                 console.log('Moved classesSection to main container');
                                 
                                 // Apply normal styling after moving, preserving display state
                                 classesSection.style.cssText = `
                                     display: ${currentDisplay || (classesSection.classList.contains('active') ? 'block' : 'none')};
                                     position: relative !important;
                                     background: transparent !important;
                                     border: none !important;
                                     width: auto !important;
                                     height: auto !important;
                                     z-index: auto !important;
                                     opacity: 1 !important;
                                  `;
                                 console.log('Applied normal styling after move, display:', classesSection.style.display);
                             }
                             
                             // Reconnect form elements since we replaced the innerHTML
                             const newClassFilterStyle = document.getElementById('class-filter-style');
                             const newClassFilterVenue = document.getElementById('class-filter-venue');
                             const newClassSortBy = document.getElementById('class-sort-by');
                             const newClassSearchInput = document.getElementById('class-search');
                             const newApplyFiltersButton = document.getElementById('apply-filters-button');
                             const newJoinByCodeButton = document.getElementById('join-by-code-button');
                             
                             console.log('Reconnecting form elements:', {
                                 classFilterStyle: newClassFilterStyle,
                                 classFilterVenue: newClassFilterVenue,
                                 classSortBy: newClassSortBy,
                                 classSearchInput: newClassSearchInput,
                                 applyFiltersButton: newApplyFiltersButton,
                                 joinByCodeButton: newJoinByCodeButton
                             });

                             // Update classListDiv reference to the new element
                             const updatedClassListDiv = document.getElementById('class-list');
                             console.log('Updated classListDiv reference:', updatedClassListDiv);
                             
                             // Attach event listeners after rendering (use updated reference)
                             attachClassButtonListeners(updatedClassListDiv);
                             attachVenueNameListeners(updatedClassListDiv);
                             
                             // Update join button states based on current attendance
                             updateJoinButtonStates(updatedClassListDiv);
                             
                             // Preserve current filter values before populating new dropdowns
                             const currentVenueValue = classFilterVenue ? classFilterVenue.value : 'all';
                             const currentStyleValue = classFilterStyle ? classFilterStyle.value : 'all';
                             const currentSortValue = classSortBy ? classSortBy.value : 'title';
                             const currentSearchValue = classSearchInput ? classSearchInput.value : '';
                             
                             // Populate the new filter dropdowns
                             if (newClassFilterVenue) {
                                 await fetchVenuesForFilter(newClassFilterVenue);
                                 newClassFilterVenue.value = currentVenueValue;
                             }
                             if (newClassFilterStyle) {
                                 await fetchStylesForFilter(newClassFilterStyle);
                                 newClassFilterStyle.value = currentStyleValue;
                             }
                             
                             // Update global references to use the new elements
                             if (newClassFilterStyle) classFilterStyle = newClassFilterStyle;
                             if (newClassFilterVenue) classFilterVenue = newClassFilterVenue;
                             if (newClassSortBy) {
                                 classSortBy = newClassSortBy;
                                 classSortBy.value = currentSortValue;
                             }
                             if (newClassSearchInput) {
                                 classSearchInput = newClassSearchInput;
                                 classSearchInput.value = currentSearchValue;
                             }
                             if (newApplyFiltersButton) applyFiltersButton = newApplyFiltersButton;
                             
                             // Re-attach event listeners to new filter elements
                             if (newApplyFiltersButton) {
                                 newApplyFiltersButton.addEventListener('click', () => {
                                     fetchAndDisplayClasses();
                                 });
                             }
                             
                             if (newClassFilterStyle) {
                                 newClassFilterStyle.addEventListener('change', () => {
                                     fetchAndDisplayClasses();
                                 });
                             }
                             
                             if (newClassFilterVenue) {
                                 newClassFilterVenue.addEventListener('change', () => {
                                     fetchAndDisplayClasses();
                                 });
                             }
                             
                             if (newClassSortBy) {
                                 newClassSortBy.addEventListener('change', () => {
                                     fetchAndDisplayClasses();
                                 });
                             }
                             
                             if (newClassSearchInput) {
                                 let newSearchTimeout;
                                 newClassSearchInput.addEventListener('input', () => {
                                     clearTimeout(newSearchTimeout);
                                     newSearchTimeout = setTimeout(() => {
                                         fetchAndDisplayClasses();
                                     }, 300);
                                 });
                             }
                             
                             // Attach click event listener to create class button (visibility already handled globally)
                             const createBtn = document.getElementById('createClassBtn');
                             console.log('Create Class Button:', createBtn);
                             if (createBtn) {
                                 // Remove any existing event listeners to prevent duplicates
                                 createBtn.replaceWith(createBtn.cloneNode(true));
                                 const newCreateBtn = document.getElementById('createClassBtn');
                                 if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin])) {
                                     newCreateBtn.style.display = 'inline-flex';
                                 } else {
                                     newCreateBtn.style.display = 'none';
                                 }
                                 
                                 // Attach click event listener to open modal
                                 newCreateBtn.addEventListener('click', async () => {
                                     const addClassModal = document.getElementById('add-class-modal');
                                     const classMessageDiv = document.getElementById('create-class-message');
                                     const addClassForm = document.getElementById('add-class-form');
                                     const frequencyContainer = document.getElementById('frequency-container');
                                     
                                     if (addClassModal) {
                                         addClassModal.style.display = 'block';
                                         if (classMessageDiv) {
                                             classMessageDiv.textContent = '';
                                             classMessageDiv.className = 'message text-center';
                                             classMessageDiv.style.display = 'none';
                                         }
                                         if (addClassForm) addClassForm.reset();
                                         if (frequencyContainer) frequencyContainer.innerHTML = '';
                                         
                                         // Populate venues and styles dropdowns
                                         const classVenueSelect = document.getElementById('class-venue-id');
                                         const classStyleSelect = document.getElementById('class-style-ids');
                                         
                                         if (classVenueSelect) {
                                             await fetchVenuesForSelect(classVenueSelect);
                                         }
                                         if (classStyleSelect) {
                                             await fetchStylesForSelect(classStyleSelect);
                                         }
                                         
                                         console.log('Opened create class modal with populated dropdowns');
                                     } else {
                                         console.error('add-class-modal not found');
                                     }
                                 });
                             }

                        } else {
                            console.log('No classes found, showing no classes message');
                            classListDiv.innerHTML = '<p class="text-gray-600 italic">No classes found matching your criteria.</p>';
                        }
                     } else if (response.status === 401 || response.status === 403) {
                          classListDiv.innerHTML = '<p class="text-red-600">Error: You are not authorized to view classes.</p>';
                         console.error("Authorization error fetching classes:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                         classListDiv.innerHTML = `<p class="text-red-600">Error loading classes: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                         console.error("Error fetching classes:", response.status, errorText);
                     }
                 } catch (error) {
                     classListDiv.innerHTML = `<p class="text-red-600">Network error loading classes.</p>`;
                     console.error("Fetch error for class list:", error);
                 }
             }
             


            // Function to attach event listeners to dynamically created class buttons
            function attachClassButtonListeners(targetDiv = classListDiv) {
                console.log('attachClassButtonListeners called with:', targetDiv);
                 // Join Button Listener - Toggle attendance for today's class
                 targetDiv.querySelectorAll('.join-class-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const classId = button.getAttribute('data-class-id');
                         const nextRunTimeStamp = button.getAttribute('data-next-run');
                         
                         if (!nextRunTimeStamp) {
                             alert('No class time data found');
                             return;
                         }
                         
                         const nextRunTime = new Date(parseInt(nextRunTimeStamp));
                         const currentUserId = my_user_id;
                         
                         if (!currentUserId) {
                             alert('User not logged in');
                             return;
                         }
                         
                         console.log('Toggling attendance for class:', classId, 'at time:', nextRunTime.toLocaleString());
                         
                         try {
                             // First check current attendance status
                             const timeSegment = nextRunTime.getTime();
                             const studentsResponse = await fetch('/api/class/get_students', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json',
                                 },
                                 body: JSON.stringify({
                                     class_id: classId,
                                     class_start_ts: timeSegment
                                 })
                             });
                             
                             if (!studentsResponse.ok) {
                                 alert('Failed to check attendance status');
                                 return;
                             }
                             
                             const studentsData = await studentsResponse.json();
                             const students = studentsData.students || [];
                             
                             // Check if current user is already attending
                             const currentUserAttendance = students.find(student => student.user_id === currentUserId);
                             const isCurrentlyAttending = currentUserAttendance && currentUserAttendance.attended;
                             
                             // Toggle attendance - if attending, remove; if not attending, add
                             const newAttendanceStatus = !isCurrentlyAttending;
                             
                             const attendanceResponse = await fetch('/api/class/set_student_attendance', {
                                 method: 'POST',
                                 headers: {
                                     'Content-Type': 'application/json',
                                 },
                                 body: JSON.stringify({
                                     user_ids: [currentUserId],
                                     present: [newAttendanceStatus],
                                     class_id: classId,
                                     class_start_ts: timeSegment
                                 })
                             });
                             
                             if (attendanceResponse.ok) {
                                 const result = await attendanceResponse.json();
                                 if (result.success) {
                                     if (newAttendanceStatus) {
                                         button.textContent = 'Leave Class';
                                         button.className = 'join-class-button py-2 px-4 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 text-sm';
                                     } else {
                                         button.textContent = 'Join Class';
                                         button.className = 'join-class-button py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 text-sm';
                                     }
                                 } else {
                                     alert('Failed to update attendance: ' + (result.error_message || 'Unknown error'));
                                 }
                             } else {
                                 const errorData = await attendanceResponse.json();
                                 alert('Failed to update attendance: ' + (errorData.error_message || 'Server error'));
                             }
                         } catch (error) {
                              console.error('Error toggling attendance:', error);
                              alert('Network error updating attendance.');
                         }
                     });
                 });

                 // Check-in Button Listener
                 targetDiv.querySelectorAll('.checkin-class-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const classId = button.getAttribute('data-class-id');
                          console.log('Attempting to check-in for class:', classId);
                         // Implement API call to check in here (likely requires user ID)
                         try {
                              // You'll need to get the current user's ID to send with the check-in request
                              // This often comes from a cookie or local storage after login
                              const userId = getUserIdFromCookieOrStorage(); // Implement this function

                               if (!userId) {
                                    alert("Could not determine user ID for check-in.");
                                    return;
                               }

                             const response = await fetch(`/api/class/checkin`, {
                                  method: 'POST',
                                   headers: {
                                        'Content-Type': 'application/json',
                                        // Include authorization token if required
                                   },
                                   body: JSON.stringify({ user_id: userId, class_id: classId }) // Send user ID with the request
                               }); // Adjust endpoint as needed

                             const result = await response.json();
                              if (result.success) {
                                   alert('Successfully checked into class!'); // Or show a more integrated message
                                   // Optionally, update the class card to show check-in status
                              } else {
                                   alert('Failed to check in: ' + (result.error_message || 'Unknown error'));
                              }
                         } catch (error) {
                              console.error('Fetch error checking in:', error);
                              alert('Network error checking in.');
                         }
                     });
                 });

                 // Edit Button Listener
                 const editButtons = targetDiv.querySelectorAll('.edit-class-button');
                 console.log('Found edit buttons:', editButtons.length);
                 editButtons.forEach((button, index) => {
                     console.log(`Edit button ${index}:`, button);
                     button.addEventListener('click', async () => {
                         const classId = button.getAttribute('data-class-id');
                         console.log('Edit button clicked! Class ID:', classId);
                         // Fetch class data and open edit modal
                         fetchClassForEdit(classId);
                     });
                 });

                // History Button Listener
                targetDiv.querySelectorAll('.history-class-button').forEach(button => {
                    button.addEventListener('click', async () => {
                        const classId = button.getAttribute('data-class-id');
                        const classTitle = button.getAttribute('data-class-title');
                        console.log('History button clicked! Class ID:', classId);
                        openClassHistoryModal(classId, classTitle);
                    });
                });
            }

            // Function to attach event listeners to venue names for showing venue info
            function attachVenueNameListeners(targetDiv = classListDiv) {
                 targetDiv.querySelectorAll('.venue-name').forEach(span => {
                     span.addEventListener('click', async () => {
                         const venueId = span.getAttribute('data-venue-id');
                         console.log('Attempting to fetch venue info for:', venueId);
                          fetchAndDisplayVenueInfo(venueId);
                     });
                 });
            }

            // Function to fetch venues for select dropdowns
            async function fetchVenuesForSelect(selectElement, selectedVenueId = null) {
                 console.log("Fetching venues for select element:", selectElement.id);
                 selectElement.innerHTML = '<option value="">Loading venues...</option>';
                 selectElement.disabled = true;
                 try {
                     const response = await fetch('/api/venue/get_list', { method: 'GET' });

                     if (response.ok) {
                         // Assuming backend returns { success: true, venues: [...] } on success
                         const result = await response.json();

                         if (result.success && result.venues) {
                            const venues = result.venues;
                            let optionsHtml = '<option value="">Select Venue</option>';
                            selectElement.disabled = false;
                            if (venues.length > 0) {
                                venues.forEach(venue => {
                                    const selected = selectedVenueId === venue.venue_id ? 'selected' : '';
                                    optionsHtml += `<option value="${venue.venue_id}" ${selected}>${venue.title}</option>`;
                                    add_cached_value("venue", venue.venue_id, venue); // Cache the venue ID and title

                                });
                                selectElement.innerHTML = optionsHtml;
                            } else {
                                selectElement.innerHTML = '<option value="">No venues found</option>';
                            }
                        } else {
                        // Handle cases where response is OK but success is false (backend level error)
                        selectElement.innerHTML = `<option value="">Error: ${result.error_message || 'Unknown error'}</option>`;
                            console.error('Backend success: false for venues:', result.error_message);
                        }

                     } else if (response.status === 401 || response.status === 403) {
                          selectElement.innerHTML = '<option value="">Error: Not authorized</option>';
                          console.error("Authorization error fetching venues:", response.status);
                     }
                     else {
                          // Handle other HTTP errors
                          const errorText = await response.text();
                           selectElement.innerHTML = `<option value="">Error: ${response.status} - ${errorText.substring(0, 50)}...</option>`;
                          console.error("Error fetching venues:", response.status, errorText);
                     }
                 } catch (error) {
                     // Handle network errors
                     console.error('Network error fetching venues:', error);
                     selectElement.innerHTML = '<option value="">Network Error</option>';
                 }
            }

            // Function to fetch styles for select dropdowns
            async function fetchStylesForSelect(selectEl, selectedStyleIds = []) {
                // Disable while we load
                selectEl.disabled = true;
                selectEl.innerHTML = ''; // clear any old options

                // Build a Set of the selected IDs, all as strings
                const selectedSet = new Set(
                    selectedStyleIds
                    .map(item => (typeof item === 'object' ? item.style_id : item))
                    .map(String)
                );

                // (Re-)add a placeholder option if this is not a multi-select
                if (!selectEl.multiple) {
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select Style';
                    selectEl.appendChild(placeholder);
                }

                // Add a ‚Äúloading‚Ä¶‚Äù option while we fetch
                const loadingOpt = document.createElement('option');
                loadingOpt.value = '';
                loadingOpt.textContent = 'Loading styles‚Ä¶';
                selectEl.appendChild(loadingOpt);

                try {
                    const res = await fetch('/api/style/get_list');
                    if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                    }
                    const payload = await res.json();
                    if (!payload.success || !Array.isArray(payload.styles)) {
                    throw new Error(
                        payload.error_message || 'Malformed styles payload'
                    );
                    }

                    // Clear the loading/placeholder
                    selectEl.innerHTML = '';
                    if (!selectEl.multiple) {
                    // re-add placeholder
                    const placeholder2 = document.createElement('option');
                    placeholder2.value = '';
                    placeholder2.textContent = 'Select Style';
                    selectEl.appendChild(placeholder2);
                    }

                    if (payload.styles.length === 0) {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No styles found';
                    selectEl.appendChild(opt);
                    } else {
                    payload.styles.forEach(style => {
                        const opt = document.createElement('option');
                        opt.value = String(style.style_id);
                        opt.textContent = style.title;
                        if (selectedSet.has(String(style.style_id))) {
                        opt.selected = true;
                        }
                        selectEl.appendChild(opt);

                        // your existing cache helper
                        add_cached_value('style', style.style_id, style);
                    });
                    }
                } catch (err) {
                    console.error('Error loading styles:', err);
                    selectEl.innerHTML = '';
                    const errOpt = document.createElement('option');
                    errOpt.value = '';
                    errOpt.textContent = 'Error loading styles';
                    selectEl.appendChild(errOpt);
                } finally {
                    selectEl.disabled = false;
                }
            }


             // --- Event Listeners ---

            // Open Add Class Modal
            addClassButton.addEventListener('click', () => {
                addClassModal.style.display = 'block';
                classMessageDiv.textContent = ''; // Clear previous messages
                classMessageDiv.className = 'message text-center'; // Reset classes
                classMessageDiv.style.display = 'none'; // Hide message div
                addClassForm.reset(); // Clear the form fields
                frequencyContainer.innerHTML = ''; // Clear previous frequency entries
                // Add an initial frequency entry when opening the modal
                frequencyContainer.innerHTML += createFrequencyEntryHTML();

                // Fetch venues and styles when modal opens
                fetchVenuesForSelect(classVenueSelect);
                fetchStylesForSelect(classStyleSelect);
            });


            // Add a frequency entry to the form
            function addFrequencyEntry(isEdit = false) {
                 const container = isEdit ? editFrequencyContainer : frequencyContainer;
                const entryHtml = createFrequencyEntryHTML({}, isEdit); // Pass isEdit to template
                container.insertAdjacentHTML('beforeend', entryHtml);

                // Add event listener to the new remove button using delegation
                // This is now handled by the delegated listener on the container itself
            }


            // Event listener for the "Add Frequency Slot" button
            addFrequencyButton.addEventListener('click', () => addFrequencyEntry(false));
            addEditFrequencyButton.addEventListener('click', () => addFrequencyEntry(true));


            // Handle Remove Frequency Button Click (using event delegation on containers)
             frequencyContainer.addEventListener('click', (event) => {
                 if (event.target.classList.contains('remove-frequency-button')) {
                     event.target.closest('.frequency-entry').remove();
                 }
             });

             editFrequencyContainer.addEventListener('click', (event) => {
                 if (event.target.classList.contains('remove-frequency-button')) {
                     event.target.closest('.frequency-entry').remove();
                 }
             });


            // Submit Create Class Form
            submitCreateClassButton.addEventListener('click', async () => {
                classMessageDiv.style.display = 'none';
                classMessageDiv.textContent = '';
                classMessageDiv.className = 'message text-center';
                submitCreateClassButton.disabled = true;

                // --- 1. Gather data from the form ---
                const title = document.getElementById('class-title').value.trim();
                const description = document.getElementById('class-description').value.trim();
                const venueIdString = document.getElementById('class-venue-id').value.trim();
                const styleIdsSelect = document.getElementById('class-style-ids');
                const style_ids = Array.from(styleIdsSelect.selectedOptions).map(option => option.value.trim()).filter(id => id.length > 0); // Get selected options
                const gradingIdsString = document.getElementById('class-grading-ids').value.trim();
                const priceString = document.getElementById('class-price').value.trim();
                const publishMode = parseInt(document.getElementById('class-publish-mode').value, 10);
                const capacity = parseInt(document.getElementById('class-capacity').value, 10);
                const notifyBooking = document.getElementById('class-notify-booking').checked;
                const waiverIdString = document.getElementById('class-waiver-id').value.trim();


                // --- 2. Validate and Format Complex Fields ---

                 if (!title || !description || !venueIdString || style_ids.length === 0 || isNaN(publishMode) || isNaN(capacity)) {
                     displayMessage(classMessageDiv, 'Please fill in all required fields (Title, Description, Venue, Styles, Publish Mode, Capacity).', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }
                // Basic format validation for UUIDs (optional, backend should validate definitively)
                if (venueIdString && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(venueIdString)) {
                    displayMessage(classMessageDiv, 'Invalid Venue ID format.', 'error');
                    submitCreateClassButton.disabled = false;
                    return;
                }
                if (style_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                     displayMessage(classMessageDiv, 'One or more Style IDs have an invalid UUID format.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }

                const grading_ids = gradingIdsString.split(',').map(id => id.trim()).filter(id => id.length > 0);
                 if (grading_ids.length > 0 && grading_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                     displayMessage(classMessageDiv, 'One or more Grading IDs have an invalid UUID format.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }

                const price = priceString === '' ? null : priceString;
                if (price !== null && isNaN(parseFloat(price))) {
                     displayMessage(classMessageDiv, 'Invalid Price format. Must be a number.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }

                const waiver_id = waiverIdString === '' ? null : waiverIdString;
                 if (waiver_id !== null && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(waiverIdString)) {
                     displayMessage(classMessageDiv, 'Invalid Waiver ID format. Expected UUID.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }


                const frequencyEntries = frequencyContainer.querySelectorAll('.frequency-entry');
                const frequencies = [];
                for (const entry of frequencyEntries) {
                    const id = entry.dataset.id;

                    const freqNum = parseInt(entry.querySelector('[id$="-frequency"]').value, 10);
                    const startDate = entry.querySelector('[id$="-start-date"]').value;
                    const endDate = entry.querySelector('[id$="-end-date"]').value;
                    const startTime = entry.querySelector('[id$="-start-time"]').value;
                    const endTime = entry.querySelector('[id$="-end-time"]').value;


                     if (isNaN(freqNum) || freqNum <= 0) {
                         displayMessage(classMessageDiv, `Invalid frequency number for entry ID ${id}. Must be a positive integer.`, 'error');
                         submitCreateClassButton.disabled = false; return;
                     }
                     if (!startDate || !/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
                         displayMessage(classMessageDiv, `Invalid start date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                         submitCreateClassButton.disabled = false; return;
                     }
                     if (!endDate || !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) {
                         displayMessage(classMessageDiv, `Invalid end date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                            submitCreateClassButton.disabled = false; return;
                     }

                    const startTimeFormatted = startTime.includes(':') && startTime.split(':').length <= 2 ? startTime + ':00' : startTime;
                    const endTimeFormatted = endTime.includes(':') && endTime.split(':').length <= 2 ? endTime + ':00' : endTime;

                     if (!startTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(startTimeFormatted)) {
                         displayMessage(classMessageDiv, `Invalid start time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                            submitCreateClassButton.disabled = false; return;
                     }
                     if (!endTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(endTimeFormatted)) {
                         displayMessage(classMessageDiv, `Invalid end time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                            submitCreateClassButton.disabled = false; return;
                     }

                     frequencies.push({
                         frequency: freqNum,
                         start_date: startDate,
                         end_date: endDate,
                         start_time: startTimeFormatted,
                         end_time: endTimeFormatted
                     });
                 }

                 if (frequencies.length === 0) {
                    displayMessage(classMessageDiv, 'At least one frequency slot is required.', 'error');
                    submitCreateClassButton.disabled = false;
                    return;
                }


                // --- 3. Construct the JSON request body ---
                const requestBody = {
                    title: title,
                    description: description,
                    venue_id: venueIdString,
                    style_ids: style_ids,
                    grading_ids: grading_ids,
                    price: price ? parseFloat(price) : null, // Convert price to number if not null
                    publish_mode: publishMode,
                    capacity: capacity,
                    frequency: frequencies, // Use the corrected 'frequencies' variable name
                    notify_booking: notifyBooking,
                    waiver_id: waiver_id,
                };

                console.log("Sending class creation request:", requestBody);

                // --- 4. Send the POST request to the backend ---
                try {
                    const response = await fetch('/api/class/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const responseData = await response.json();

                    if (response.ok && responseData.success) {
                        console.log("Class created successfully:", responseData);
                        displayMessage(classMessageDiv, responseData.message || `Class created successfully! ID: ${responseData.class_id}`, 'success');

                        setTimeout(() => {
                            closeModal(addClassModal);
                            fetchAndDisplayClasses(); // Refresh the class list
                        }, 2000); // Hide after 2 seconds


                    } else if (responseData && responseData.error_message) {
                        displayMessage(classMessageDiv, `Creation failed: ${responseData.error_message}`, 'error');
                        console.error("Server error creating class:", response.status, responseData.error_message);
                    }
                    else if (response.status === 400) {
                        const errorText = await response.text();
                        displayMessage(classMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                        console.error("Bad request creating class:", response.status, errorText);

                    }
                    else if (response.status === 401 || response.status === 403) {
                        displayMessage(classMessageDiv, 'Error: You are not authorized to create classes.', 'error');
                        console.error("Authorization error creating class:", response.status);
                    }
                    else {
                        const errorText = await response.text();
                         displayMessage(classMessageDiv, `Error creating class: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                        console.error("Error creating class:", response.status, errorText);
                    }

                } catch (error) {
                    displayMessage(classMessageDiv, 'Network error submitting class creation.', 'error');
                    console.error("Fetch error for class creation:", error);
                } finally {
                    submitCreateClassButton.disabled = false;
                }
            });


             // Submit Edit Class Form
            submitEditClassButton.addEventListener('click', async () => {
                 editClassMessageDiv.style.display = 'none';
                 editClassMessageDiv.textContent = '';
                 editClassMessageDiv.className = 'message text-center';
                 submitEditClassButton.disabled = true;

                const classId = editClassIdInput.value;
                const title = editClassTitleInput.value.trim();
                const description = editClassDescriptionInput.value.trim();
                const venue_id = editClassVenueSelect.value.trim();
                const style_ids_select = editClassStyleSelect;
                const style_ids = Array.from(style_ids_select.selectedOptions).map(option => option.value.trim()).filter(id => id.length > 0);
                const grading_ids_string = editClassGradingIdsInput.value.trim();
                const priceString = editClassPriceInput.value.trim();
                const publish_mode = parseInt(editClassPublishModeInput.value, 10);
                const capacity = parseInt(editClassCapacityInput.value, 10);
                const free_lessons = parseInt(editClassFreeLessonsInput.value.trim());
                const notify_booking = editClassNotifyBookingCheckbox.checked;
                const waiver_id_string = editClassWaiverIdInput.value.trim();


                // --- 2. Validate and Format Complex Fields (Similar to create) ---
                console.log("Validating edit class data:", { title, description, venue_id, style_ids, publish_mode, capacity });

                if (!title || !description || !venue_id || style_ids.length === 0 || isNaN(publish_mode) || isNaN(capacity)) {
                    var missing_fields = [];
                    if (!title) missing_fields.push('Title');
                    if (!description) missing_fields.push('Description');
                    if (!venue_id) missing_fields.push('Venue');
                    if (style_ids.length === 0) missing_fields.push('Styles');
                    if (isNaN(publish_mode)) missing_fields.push('Publish Mode');
                    if (isNaN(capacity)) missing_fields.push('Capacity');
                    displayMessage(editClassMessageDiv, `Please fill in all required fields: ${missing_fields.join(', ')}.`, 'error');
                    submitEditClassButton.disabled = false;
                    return;
                }
                // Basic format validation for UUIDs
                 if (venue_id && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(venue_id)) {
                    displayMessage(editClassMessageDiv, 'Invalid Venue ID format.', 'error');
                    submitEditClassButton.disabled = false;
                    return;
                 }
                 if (style_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                      displayMessage(editClassMessageDiv, 'One or more Style IDs have an invalid UUID format.', 'error');
                      submitEditClassButton.disabled = false;
                      return;
                  }


                const grading_ids = grading_ids_string.split(',').map(id => id.trim()).filter(id => id.length > 0);
                if (grading_ids.length > 0 && grading_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                    displayMessage(editClassMessageDiv, 'One or more Grading IDs have an invalid UUID format.', 'error');
                    submitEditClassButton.disabled = false;
                    return;
                }

                const price = priceString === '' ? null : priceString;
                 if (price !== null && isNaN(parseFloat(price))) {
                     displayMessage(editClassMessageDiv, 'Invalid Price format. Must be a number.', 'error');
                     submitEditClassButton.disabled = false;
                     return;
                 }

                const waiver_id = waiver_id_string === '' ? null : waiver_id_string;
                 if (waiver_id !== null && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(waiver_id_string)) {
                     displayMessage(editClassMessageDiv, 'Invalid Waiver ID format. Expected UUID.', 'error');
                     submitEditClassButton.disabled = false;
                     return;
                 }


                const frequencyEntries = editFrequencyContainer.querySelectorAll('.frequency-entry');
                const frequencies = [];
                var id = 1;
                for (const entry of frequencyEntries) {
                    const class_frequency_id = entry.dataset.frequencyId || null;

                    const freqNum = parseInt(entry.querySelector('[id$="-frequency"]').value, 10);
                    // const class_frequency_id = entry.querySelector('[id$="-class_frequency_id"]').value;
                    const startDate = entry.querySelector('[id$="-start-date"]').value;
                    const endDate = entry.querySelector('[id$="-end-date"]').value;
                    const startTime = entry.querySelector('[id$="-start-time"]').value;
                    const endTime = entry.querySelector('[id$="-end-time"]').value;
                    // console.log("Class Frequency ID:", class_frequency_id);

                    // Basic frequency validation
                    if (isNaN(freqNum) || freqNum <= 0) {
                        displayMessage(editClassMessageDiv, `Invalid frequency number for entry ID ${id}. Must be a positive integer.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }
                    if (!startDate || !/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
                        displayMessage(editClassMessageDiv, `Invalid start date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }
                    if (!endDate || !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) {
                        displayMessage(editClassMessageDiv, `Invalid end date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }

                    const startTimeFormatted = startTime.includes(':') && startTime.split(':').length <= 2 ? startTime + ':00' : startTime;
                    const endTimeFormatted = endTime.includes(':') && endTime.split(':').length <= 2 ? endTime + ':00' : endTime;

                    if (!startTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(startTimeFormatted)) {
                        displayMessage(editClassMessageDiv, `Invalid start time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }
                    if (!endTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(endTimeFormatted)) {
                        displayMessage(editClassMessageDiv, `Invalid end time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }

                    frequencies.push({
                        class_frequency_id: class_frequency_id, // Include ID for update
                        frequency: freqNum,
                        start_date: startDate,
                        end_date: endDate,
                        start_time: startTimeFormatted,
                        end_time: endTimeFormatted
                    });

                    id++;
                 }

                 if (frequencies.length === 0) {
                    displayMessage(editClassMessageDiv, 'At least one frequency slot is required.', 'error');
                    submitEditClassButton.disabled = false;
                    return;
                }


                // --- 3. Construct the JSON request body ---
                const requestBody = {
                    class_id: classId,
                    title: title,
                    description: description,
                    venue_id: venue_id,
                    style_ids: style_ids,
                    grading_ids: grading_ids,
                    price: price ? price : null,
                    publish_mode: publish_mode,
                    capacity: capacity,
                    frequency: frequencies, // Use the corrected 'frequencies' variable name
                    notify_booking: notify_booking,
                    waiver_id: waiver_id,
                    free_lessons: free_lessons // Convert to number if not null
                };

                // console.log("Sending class update request:", requestBody);

                // --- 4. Send the PUT/PATCH request to the backend ---
                 try {
                     const response = await fetch(`/api/class/update`, { // Adjust endpoint
                         method: 'PUT', // Or 'PATCH' depending on your API design
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Class updated successfully:", responseData);
                         displayMessage(editClassMessageDiv, responseData.message || 'Class updated successfully!', 'success');

                         setTimeout(() => {
                             closeModal(editClassModal);
                             fetchAndDisplayClasses(); // Refresh the class list
                         }, 2000); // Hide after 2 seconds


                     } else if (responseData && responseData.error_message) {
                         displayMessage(editClassMessageDiv, `Update failed: ${responseData.error_message}`, 'error');
                         console.error("Server error updating class:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                          const errorText = await response.text();
                          displayMessage(editClassMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                          console.error("Bad request updating class:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                          displayMessage(editClassMessageDiv, 'Error: You are not authorized to update classes.', 'error');
                           console.error("Authorization error updating class:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(editClassMessageDiv, `Error updating class: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error updating class:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(editClassMessageDiv, 'Network error submitting class update.', 'error');
                     console.error("Fetch error for class update:", error);
                 } finally {
                     submitEditClassButton.disabled = false;
                 }
            });


             // Function to fetch class data for editing and populate the modal
            async function fetchClassForEdit(classId) {
                 editClassMessageDiv.textContent = '';
                 editClassMessageDiv.className = 'message text-center';
                 editClassMessageDiv.style.display = 'none';

                 try {
                    const response = await fetch('/api/class/get', { // Adjust endpoint
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ class_id: classId })
                    });

                    //  const response = await fetch(`/api/class/${classId}`); // Adjust endpoint to get a single class by ID
                     const result = await response.json(); // Assuming backend returns { success: true, class: {...} }

                     if (result.success && result.class) {
                         const cls = result.class;
                         // Populate the edit modal form
                         editClassIdInput.value = cls.class_id;
                         editClassTitleInput.value = cls.title || '';
                         editClassDescriptionInput.value = cls.description || '';

                         // Populate venue and style selects - need to fetch available venues/styles first
                         await fetchVenuesForSelect(editClassVenueSelect, cls.venue_id);
                         await fetchStylesForSelect(editClassStyleSelect, cls.styles); // Pass array of selected style IDs

                         editClassGradingIdsInput.value = cls.grading_ids ? cls.grading_ids.join(', ') : '';
                         editClassPriceInput.value = cls.price !== undefined && cls.price !== null ? parseFloat(cls.price) : '';
                         editClassPublishModeInput.value = cls.publish_mode !== undefined ? cls.publish_mode : 0;
                         editClassCapacityInput.value = cls.capacity !== undefined ? cls.capacity : null;
                         editClassFreeLessonsInput.value = cls.free_lessons !== undefined ? cls.free_lessons : 0;

                         // Populate frequencies for edit
                         editFrequencyContainer.innerHTML = ''; // Clear existing frequencies
                        //  console.log("Frequencies for edit:", cls);
                         if (cls.frequency && cls.frequency.length > 0) {
                             cls.frequency.forEach(freq => {
                                 editFrequencyContainer.innerHTML += createFrequencyEntryHTML(freq, true); // Pass true for edit mode
                             });
                         } else {
                             // Add an initial empty frequency slot if none exist
                              editFrequencyContainer.innerHTML += createFrequencyEntryHTML({}, true);
                         }


                         editClassNotifyBookingCheckbox.checked = cls.notify_booking || false;
                         editClassWaiverIdInput.value = cls.waiver_id || '';

                         // Show the edit modal
                         editClassModal.style.display = 'block';

                     } else {
                         alert('Error fetching class for editing: ' + (result.error_message || 'Unknown error'));
                         console.error('Error fetching class for editing:', result);
                     }
                 } catch (error) {
                     console.error('Fetch error fetching class for editing:', error);
                     alert('Network error fetching class for editing.');
                 }
            }


             // Function to fetch and display venue info in the modal
            async function fetchAndDisplayVenueInfo(venueId) {
                venueInfoContentDiv.innerHTML = '<p class="text-gray-600 italic">Loading venue information...</p>';
                venueInfoModal.style.display = 'block';

                var venue = get_cached_value("venue", venueId);
                if (venue == null)
                {
                    try {
                        const response = await fetch('/api/venue/get', { // Adjust endpoint
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ venue_id: venueId })
                        });

                        const result = await response.json(); // Assuming backend returns { success: true, venue: {...} }

                        if (result.success && result.venue) {
                            add_cached_value("venue", result.venue.venue_id, result.venue); // Cache the venue ID and title
                        } else {
                            venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${result.error_message || 'Unknown error'}</p>`;
                        }
                    } catch (error) {
                        console.error('Error fetching venue info:', error);
                        venueInfoContentDiv.innerHTML = `<p class="text-red-600">Failed to connect to the server to load venue info.</p>`;
                    }
                }

                venue = get_cached_value("venue", venueId);
                if (venue == null)
                {
                    return;
                }

                venueInfoContentDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">${venue.title}</h3>
                    <p class="text-gray-700 mb-2"><strong class="font-medium">Description:</strong> ${venue.description || 'N/A'}</p>
                    <p class="text-gray-700 mb-2"><strong class="font-medium">Address:</strong> ${venue.address || 'N/A'}, ${venue.suburb || ''}, ${venue.state || ''} ${venue.postcode || ''}, ${venue.country || ''}</p>
                    <p class="text-gray-700 mb-4"><strong class="font-medium">Contact Phone:</strong> ${venue.contact_phone || 'N/A'}</p>

                    ${venue.latitude && venue.longitude ?
                        `<div class="map-container rounded-lg overflow-hidden shadow-md mt-4">
                            <iframe
                                loading="lazy"
                                width="100%"
                                height="300"
                                frameborder="0"
                                scrolling="no"
                                marginheight="0"
                                marginwidth="0"
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(venue.longitude) - 0.005},${parseFloat(venue.latitude) - 0.005},${parseFloat(venue.longitude) + 0.005},${parseFloat(venue.latitude) + 0.005}&amp;layer=mapnik&amp;marker=${venue.latitude},${venue.longitude}"
                                style="border: 1px solid black"
                            ></iframe>
                            <br/><small><a href="https://www.openstreetmap.org/?mlat=${venue.latitude}&amp;mlon=${venue.longitude}#map=15/${venue.latitude}/${venue.longitude}" target="_blank" class="text-blue-600 hover:underline">View Larger Map</a></small>
                        </div>
                        <p class="text-sm text-gray-600 italic mt-2 text-center">Map data ¬© OpenStreetMap contributors.</p>
                        `
                        : '<p class="text-gray-600 italic">Map location not available.</p>'}

                `;
            }


            // Helper function to display messages with Tailwind classes
            function displayMessage(element, message, type) {
                 element.textContent = message;
                 element.className = `mt-4 text-center text-sm`; // Reset classes first
                 if (type === 'success') {
                     element.classList.add('text-green-600');
                 } else if (type === 'error') {
                     element.classList.add('text-red-600');
                 } else {
                      element.classList.add('text-gray-700'); // Default color
                 }
                 element.style.display = 'block'; // Ensure it's visible
            }

            // --- Class History Modal Functions ---

            // Function to open the class history modal
            async function openClassHistoryModal(classId, classTitle) {
                const modal = document.getElementById('classHistoryModal');
                const titleElement = document.getElementById('history-class-title');
                const tableBody = document.getElementById('history-table-body');
                
                // Set modal title
                titleElement.textContent = classTitle || 'Class History';
                
                // Store classId in modal dataset for filter functionality
                modal.dataset.classId = classId;
                
                // Show modal
                modal.classList.remove('hidden');
                
                // Set default date range (last 30 days)
                const today = new Date();
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                document.getElementById('history-date-to').value = today.toISOString().split('T')[0];
                document.getElementById('history-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
                
                // Load history data
                await loadClassHistory(classId);
            }

            // Function to load class history data
            async function loadClassHistory(classId) {
                const tableBody = document.getElementById('history-table-body');
                const fromDate = document.getElementById('history-date-from').value;
                const toDate = document.getElementById('history-date-to').value;
                
                // Show loading state
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading history...</td></tr>';
                
                try {
                    const response = await fetch('/api/class/get_history', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            class_id: classId,
                            from_date: fromDate,
                            to_date: toDate
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayHistoryData(data.history || [], data.stats || {});
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Failed to load history data</td></tr>';
                    }
                } catch (error) {
                    console.error('Error loading class history:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading history data</td></tr>';
                }
            }

            // Function to display history data in the table
            function displayHistoryData(historyRecords, stats) {
                const tableBody = document.getElementById('history-table-body');
                
                // Update summary stats
                document.getElementById('total-sessions').textContent = stats.total_sessions || 0;
                document.getElementById('total-attendees').textContent = stats.total_attendees || 0;
                document.getElementById('total-revenue').textContent = '$' + (stats.total_revenue || 0).toLocaleString();
                document.getElementById('avg-attendance').textContent = stats.avg_attendance || 0;
                document.getElementById('history-total-records').textContent = historyRecords.length;

                if (historyRecords.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No attendance records found for this period</td></tr>';
                    return;
                }

                // Generate table rows
                const rows = historyRecords.map(record => {
                    const date = new Date(record.class_start_ts).toLocaleDateString();
                    const checkInTime = new Date(record.checkin_ts).toLocaleTimeString();
                    const paymentMethod = getPaymentMethodDisplay(record.payment_info);
                    const amountPaid = record.amount_paid ? '$' + record.amount_paid.toFixed(2) : '-';
                    const status = getPaymentStatusDisplay(record.payment_status);

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${record.student_name}</div>
                                <div class="text-sm text-gray-500">${record.student_email || ''}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkInTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${paymentMethod}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${amountPaid}</td>
                            <td class="px-6 py-4 whitespace-nowrap">${status}</td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rows;
            }

            // Helper function to format payment method display
            function getPaymentMethodDisplay(paymentInfo) {
                if (!paymentInfo) return 'Free/Pass';
                if (paymentInfo.type_name === 'card') {
                    return `Card (**** ${paymentInfo.last4})`;
                }
                if (paymentInfo.type_name === 'pass') {
                    return 'Membership Pass';
                }
                return paymentInfo.type_name || 'Unknown';
            }

            // Helper function to format payment status display
            function getPaymentStatusDisplay(status) {
                const statusMap = {
                    1: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Paid</span>',
                    0: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>',
                    '-1': '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Failed</span>',
                    2: '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Free</span>'
                };
                return statusMap[status] || '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>';
            }

            // Add event listeners for history modal
            document.getElementById('closeHistoryModal').addEventListener('click', () => {
                document.getElementById('classHistoryModal').classList.add('hidden');
            });

            document.getElementById('apply-history-filters').addEventListener('click', async () => {
                const classId = document.getElementById('classHistoryModal').dataset.classId;
                if (classId) {
                    await loadClassHistory(classId);
                }
            });

            // Close modal on backdrop click
            document.getElementById('classHistoryModal').addEventListener('click', (e) => {
                if (e.target.id === 'classHistoryModal') {
                    document.getElementById('classHistoryModal').classList.add('hidden');
                }
            });

            // Export functionality (placeholder)
            document.getElementById('export-history-csv').addEventListener('click', () => {
                alert('CSV export functionality would be implemented here');
            });

            document.getElementById('export-history-pdf').addEventListener('click', () => {
                alert('PDF export functionality would be implemented here');
            });

            // --- Initial Load / Event Attachments ---

            // Fetch filters (venues and styles) when the DOM is ready
            fetchVenuesForFilter(classFilterVenue);
            fetchStylesForFilter(classFilterStyle);

            // Attach event listener for applying filters
             applyFiltersButton.addEventListener('click', () => {
                 fetchAndDisplayClasses();
             });
             
             // Add automatic filtering on filter changes
             classFilterStyle.addEventListener('change', () => {
                 fetchAndDisplayClasses();
             });
             
             classFilterVenue.addEventListener('change', () => {
                 fetchAndDisplayClasses();
             });
             
             classSortBy.addEventListener('change', () => {
                 fetchAndDisplayClasses();
             });
             
             // Add real-time search filtering with debounce
             let searchTimeout;
             classSearchInput.addEventListener('input', () => {
                 clearTimeout(searchTimeout);
                 searchTimeout = setTimeout(() => {
                     fetchAndDisplayClasses();
                 }, 300);
             });

             // Handle Join by Code button click
            joinByCodeButton.addEventListener('click', async () => {
                const classCode = classCodeInput.value.trim();
                joinByCodeMessageDiv.textContent = ''; // Clear previous message
                joinByCodeMessageDiv.className = 'mt-2 text-center text-gray-700 text-sm';


                if (!classCode) {
                     displayMessage(joinByCodeMessageDiv, 'Please enter a class code.', 'error');
                     return;
                }

                 console.log('Attempting to join class with code:', classCode);

                 try {
                     const response = await fetch('/api/class/join_by_code', { // Adjust endpoint
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ code: classCode })
                     });

                     const result = await response.json();

                     if (result.success) {
                         displayMessage(joinByCodeMessageDiv, result.message || 'Successfully joined class!', 'success');
                          classCodeInput.value = ''; // Clear input

                         // Optionally, refresh the class list to reflect the change
                         fetchAndDisplayClasses();

                     } else {
                         displayMessage(joinByCodeMessageDiv, result.error_message || 'Error joining class by code.', 'error');
                     }

                 } catch (error) {
                     console.error('Fetch error joining class by code:', error);
                      displayMessage(joinByCodeMessageDiv, 'Failed to connect to the server.', 'error');
                 }
            });




        // }


        // Function to fetch and display venue info in the modal
        async function fetchAndDisplayVenueInfo(venueId) {
            venueInfoContentDiv.innerHTML = '<p class="text-gray-600 italic">Loading venue information...</p>';
            venueInfoModal.style.display = 'block';

            try {
                    // Use POST request body for venue ID
                    const response = await fetch('/api/venue/get', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ venue_id: venueId })
                    });

                    if (response.ok) {
                        const result = await response.json(); // Assuming backend returns { success: true, venue: {...} } OR just the venue data
                        if (!result.success) {
                            venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${result.error_message || 'Unknown error'}</p>`;
                            return;
                        }
                        // Check for 'success' field if your API uses it, or assume data is the venue if 200 OK
                        const venue = result.venue; // Adjust based on actual API response structure


                        if (venue && venue.venue_id) { // Basic check if we got venue data
                            add_cached_value("venue", venue.venue_id, venue); // Cache the venue ID and title
                            venueInfoContentDiv.innerHTML = `
                                <h3 class="text-xl font-semibold text-gray-800 mb-3">${venue.title}</h3>
                                <p class="text-gray-700 mb-2"><strong class="font-medium">Description:</strong> ${venue.description || 'N/A'}</p>
                                <p class="text-gray-700 mb-2"><strong class="font-medium">Address:</strong> ${venue.address || 'N/A'}, ${venue.suburb || ''}, ${venue.state || ''} ${venue.postcode || ''}, ${venue.country || ''}</p>
                                <p class="text-gray-700 mb-4"><strong class="font-medium">Contact Phone:</strong> ${venue.contact_phone || 'N/A'}</p>

                                ${venue.latitude && venue.longitude ?
                                    `<div class="map-container rounded-lg overflow-hidden shadow-md mt-4">
                                        <iframe
                                            width="100%"
                                            height="300"
                                            frameborder="0"
                                            scrolling="no"
                                            marginheight="0"
                                            marginwidth="0"
                                            src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(venue.longitude) - 0.005},${parseFloat(venue.latitude) - 0.005},${parseFloat(venue.longitude) + 0.005},${parseFloat(venue.latitude) + 0.005}&amp;layer=mapnik&amp;marker=${venue.latitude},${venue.longitude}"
                                            style="border: 1px solid black"
                                        ></iframe>
                                        <br/><small><a href="https://www.openstreetmap.org/?mlat=${venue.latitude}&amp;mlon=${venue.longitude}#map=15/${venue.latitude}/${venue.longitude}" target="_blank" class="text-blue-600 hover:underline">View Larger Map</a></small>
                                    </div>
                                    <p class="text-sm text-gray-600 italic mt-2 text-center">Map data ¬© OpenStreetMap contributors.</p>
                                    `
                                    : '<p class="text-gray-600 italic">Map location not available.</p>'}

                            `;
                        } else {
                            venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${result.error_message || 'Invalid data received'}</p>`;
                        }

                    } else if (response.status === 404) {
                        venueInfoContentDiv.innerHTML = `<p class="text-red-600">Venue not found.</p>`;
                        console.warn('Venue not found:', venueId);
                    }
                    else if (response.status === 401 || response.status === 403) {
                        venueInfoContentDiv.innerHTML = '<p class="text-red-600">Error: You are not authorized to view venue details.</p>';
                        console.error("Authorization error fetching venue:", response.status);
                    }
                    else {
                        const errorText = await response.text();
                        venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                        console.error("Error fetching venue:", response.status, errorText);
                    }
            } catch (error) {
                    console.error('Error fetching venue info:', error);
                    venueInfoContentDiv.innerHTML = `<p class="text-red-600">Failed to connect to the server to load venue info.</p>`;
            }
        }




        // Function to initiate session refresh
        async function refreshSession() {
            console.log('Attempting to refresh session...');
            try {
                const response = await fetch('/api/user/refresh_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // No body needed, authentication is handled by the session cookie
                });

                // Check if the response is OK (200-299)
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        if (result.new_session_token && result.new_expires_ts) {
                            console.log('Session successfully refreshed.');
                            // Cookies are already set by the server using Set-Cookie headers
                            // You might want to store the new expiry timestamp client-side
                            // if you are doing client-side expiry checks, but it's not strictly
                            // necessary if you rely on server validation and the refresh window.
                            // Example: localStorage.setItem('sessionExpiry', result.new_expires_ts);

                        } else {
                             console.log('Session refresh request successful, but no refresh was needed.');
                        }
                    } else {
                        // Server returned success: false (backend logic prevented refresh)
                        console.warn('Session refresh failed:', result.error_message || 'Unknown error');
                        // Handle specific errors if needed (e.g., user is now unauthorized)
                    }
                } else if (response.status === 401) {
                    // User is no longer authenticated (session cookie invalid or expired)
                    console.warn('Session refresh failed: User Unauthorized. Redirecting to login.');
                    window.location.href = '/login'; // Redirect to login page
                }
                 else {
                    // Handle other HTTP errors
                    console.error('Session refresh failed with HTTP status:', response.status);
                }
            } catch (error) {
                console.error('Network error during session refresh:', error);
                // Handle network errors (e.g., server down). User might need to log in again later.
            }
        }

        const sessionRefreshInterval = setInterval(refreshSession, 30 * 60 * 1000);

        // Calendar and events management

        class DailyCalendar {
            constructor() {
                this.events = [];
                this.highlightInterval = null;
                this.currentEvent = null;
                this.currentStudents = [];
                this.currentViewMode = 'list'; // 'list' or 'grid'
                this.SLOT_HEIGHT = 60;
                this.START_HOUR = 0;
                this.END_HOUR = 23;
                this.init();
            }

            init() {
                this.renderCalendar();
                this.startHighlightUpdater();
                this.setupModalEventListeners();
            }

            setupModalEventListeners() {
            // Close modal
            document.getElementById('closeModal').addEventListener('click', () => {
                this.closeModal();
            });

            // Close modal on backdrop click
            document.getElementById('attendanceModal').addEventListener('click', (e) => {
                if (e.target.id === 'attendanceModal') {
                this.closeModal();
                }
            });

            // Search functionality
            const searchInput = document.getElementById('student-search');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.searchStudents(e.target.value);
                }, 300);
            });

            // View toggle buttons
            document.getElementById('list-view-btn').addEventListener('click', () => {
                this.switchView('list');
            });

            document.getElementById('grid-view-btn').addEventListener('click', () => {
                this.switchView('grid');
            });
            }

            renderCalendar() {
                const today = new Date();
                const dateStr = today.toLocaleDateString("en-US", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
                document.getElementById("current-date").textContent = dateStr;

                const timeSlotsContainer = document.getElementById("time-slots");
                timeSlotsContainer.innerHTML = "";

                for (let hour = this.START_HOUR; hour <= this.END_HOUR; hour++) {
                    const timeSlot = document.createElement("div");
                    timeSlot.className = "time-slot";
                    timeSlot.dataset.hour = hour;

                    const timeLabel = document.createElement("div");
                    timeLabel.className = "time-label";
                    timeLabel.textContent = this.formatTime(hour);

                    const timeContent = document.createElement("div");
                    timeContent.className = "time-content";

                    timeSlot.appendChild(timeLabel);
                    timeSlot.appendChild(timeContent);
                    timeSlotsContainer.appendChild(timeSlot);
                }

                this.updateCurrentTimeIndicator();
            }

            formatTime(hour) {
                const period = hour >= 12 ? "PM" : "AM";
                const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
                return `${displayHour}:00 ${period}`;
            }

            addEvent(startTime, endTime, title, description = "", location = "", classId = null, eventId = null) {
                if (!eventId)
                {
                    throw new Error("Event ID is required to add an event.");
                }

            
                const event = {
                    id: eventId,
                    startTime: new Date(startTime),
                    endTime: new Date(endTime),
                    title,
                    description,
                    location,
                    classId,
                };
                // Check if event with event id already exists - if so override it
                const existingIndex = this.events.findIndex(e => e.id === eventId);
                if (existingIndex !== -1) {
                    this.events[existingIndex] = event; // Update existing event
                } else {
                    this.events.push(event); // Add new event
                }
                this.renderEvents();
                return event.id;
            }

            removeNonPresentClassIdEvents(classId, eventIds) {
                // If an event has the same class id as the parameter and the event id is not in the provided list, remove it
                this.events = this.events.filter((event) => {
                    return !(event.classId === classId && !eventIds.includes(event.id));
                });
                this.renderEvents();
            }

            removeEvent(eventId) {
                this.events = this.events.filter((event) => event.id !== eventId);
                this.renderEvents();
            }

            calculateEventPosition(startTime, endTime) {
                const startHour = startTime.getHours();
                const startMinutes = startTime.getMinutes();

                const hoursFromStart = startHour - this.START_HOUR;
                const minutesOffset = startMinutes / 60;
                const topPosition = (hoursFromStart + minutesOffset) * this.SLOT_HEIGHT;

                const durationMs = endTime.getTime() - startTime.getTime();
                const durationHours = durationMs / (1000 * 60 * 60);
                const height = Math.max(durationHours * this.SLOT_HEIGHT, 24);

                return { top: topPosition, height };
            }

                renderEvents() {
                    const eventsContainer = document.getElementById("events-container");
                    eventsContainer.innerHTML = "";

                    const sortedEvents = [...this.events].sort((a, b) => a.startTime - b.startTime);

                    sortedEvents.forEach((event) => {
                        if (
                        event.startTime.getHours() >= this.START_HOUR &&
                        event.startTime.getHours() <= this.END_HOUR
                        ) {
                        this.renderEvent(event);
                        }
                    });

                    this.updateHighlights();
                }

                renderEvent(event) {
                    const position = this.calculateEventPosition(event.startTime, event.endTime);

                    const eventElement = document.createElement("div");
                    eventElement.className = "event";
                    eventElement.id = `event-${event.id}`;
                    eventElement.style.top = `${position.top}px`;
                    eventElement.style.height = `${position.height}px`;

                    // Add click handler for modal
                    eventElement.addEventListener('click', () => {
                        this.openModal(event);
                    });

                    const startTimeStr = event.startTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    });
                    const endTimeStr = event.endTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    });

                    eventElement.innerHTML = `
                        <div class="event-title">${event.title}</div>
                        <div class="event-time">${startTimeStr} - ${endTimeStr}</div>
                        ${event.description ? `<div class="event-description">${event.description}</div>` : ""}
                        ${event.location ? `<div class="event-description">üìç ${event.location}</div>` : ""}
                    `;

                    const eventsContainer = document.getElementById("events-container");
                    eventsContainer.appendChild(eventElement);
                }

                // Modal functionality
                async openModal(event) {
                    this.currentEvent = event;
                    
                    // Populate modal header
                    document.getElementById('modal-event-title').textContent = event.title;
                    document.getElementById('modal-event-description').textContent = event.description || '';
                    document.getElementById('modal-event-location').textContent = event.location ? `üìç ${event.location}` : '';
                    
                    const timeStr = `${event.startTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    })} - ${event.endTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    })}`;
                    document.getElementById('modal-event-time').textContent = `üïí ${timeStr}`;

                    // Show modal
                    document.getElementById('attendanceModal').classList.remove('hidden');
                    
                    // Load current students
                    await this.loadCurrentStudents();
                }

            closeModal() {
                document.getElementById('attendanceModal').classList.add('hidden');
                document.getElementById('student-search').value = '';
                document.getElementById('search-results').classList.add('hidden');
                this.currentEvent = null;
                this.currentStudents = [];
            }

            async loadCurrentStudents() {
                try {
                    document.getElementById('loading-indicator').classList.remove('hidden');
                    console.log('Loading students for class:', this.currentEvent.classId);
                    const timeSegment = this.getTimeSegment(this.currentEvent.startTime);
                    const response = await fetch('/api/class/get_students', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_id: this.currentEvent.classId,
                            class_start_ts: timeSegment
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentStudents = data.students || [];
                        this.renderStudents();
                    } else {
                        console.error('Failed to load students');
                        this.currentStudents = [];
                        this.renderStudents();
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                    this.currentStudents = [];
                    this.renderStudents();
                } finally {
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            }

            async searchStudents(query) {
                if (!query.trim()) {
                    document.getElementById('search-results').classList.add('hidden');
                    return;
                }

                const timeSegment = this.getTimeSegment(this.currentEvent.startTime);
                try {
                    document.getElementById('loading-indicator').classList.remove('hidden');
                    const response = await fetch('/api/class/get_students', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_id: this.currentEvent.classId,
                            class_start_ts: timeSegment,
                            q: query.trim()
                        })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const students = data.students || [];
                        this.renderSearchResults(students);
                    } else {
                        console.error('Failed to search students');
                        this.renderSearchResults([]);
                    }

                } catch (error) {
                    console.error('Error showing loading indicator:', error);
                }
                document.getElementById('loading-indicator').classList.add('hidden');
            }

            renderSearchResults(students) {
                const resultsContainer = document.getElementById('search-results');
                
                if (students.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-4 text-gray-500 text-center">No students found</div>';
                } else {
                    resultsContainer.innerHTML = students.map(student => `
                    <div class="student-search-item" data-student-id="${student.user_id}">
                        <img src="${student.photo_url || '/default-avatar.png'}" alt="${student.first_name}" class="student-avatar">
                        <div>
                        <div class="font-medium text-gray-900">${student.first_name} ${student.last_name}</div>
                        <div class="text-sm text-gray-500">ID: ${student.user_id}</div>
                        </div>
                    </div>
                    `).join('');

                    // Add click handlers
                    resultsContainer.querySelectorAll('.student-search-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.dataset.studentId;
                        const attended = this.currentStudents.find(s => s.user_id === studentId).attended;
                        this.toggleStudentAttendance(studentId, !attended);
                    });
                    });
                }

                resultsContainer.classList.remove('hidden');
            }

            switchView(mode) {
                this.currentViewMode = mode;
                
                // Update button states
                if (mode === 'list') {
                    document.getElementById('list-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
                    document.getElementById('grid-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                    document.getElementById('students-list-view').classList.remove('hidden');
                    document.getElementById('students-grid-view').classList.add('hidden');
                } else {
                    document.getElementById('grid-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
                    document.getElementById('list-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                    document.getElementById('students-list-view').classList.add('hidden');
                    document.getElementById('students-grid-view').classList.remove('hidden');
                }
            }

            renderStudents() {
                this.renderStudentsList();
                this.renderStudentsGrid();
            }

            renderStudentsList() {
                const container = document.getElementById('students-list-view');
                
                if (this.currentStudents.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No students in this class</div>';
                    return;
                }

                container.innerHTML = this.currentStudents.map(student => `
                    <div class="student-list-item ${student.attended ? 'attended' : ''}" data-student-id="${student.user_id}">
                    <div class="flex items-center space-x-3">
                        <img src="${student.photo_url || '/default-avatar.png'}" alt="${student.first_name}" class="student-avatar">
                        <div>
                        <div class="font-medium text-gray-900">${student.first_name} ${student.surname}</div>
                        </div>
                    </div>
                    <div class="text-sm font-medium ${student.attended ? 'text-blue-600' : 'text-gray-400'}">
                        ${student.attended ? '‚úì Present' : 'Absent'}
                    </div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.student-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.dataset.studentId;
                        const attended = this.currentStudents.find(s => s.user_id === studentId).attended;
                        this.toggleStudentAttendance(studentId, !attended);
                    });
                });
            }

            renderStudentsGrid() {
                const container = document.getElementById('students-grid-view');
                
                if (this.currentStudents.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No students in this class</div>';
                    return;
                }

                container.innerHTML = this.currentStudents.map(student => `
                    <div class="student-grid-item ${student.attended ? 'attended' : ''}" data-student-id="${student.user_id}">
                    <img src="${student.photo_url || '/default-avatar.png'}" alt="${student.first_name}" class="student-grid-avatar">
                    <div class="font-medium text-gray-900">${student.first_name}</div>
                    <div class="font-medium text-gray-900">${student.last_name}</div>
                    <div class="text-sm font-medium mt-2 ${student.attended ? 'text-blue-600' : 'text-gray-400'}">
                        ${student.attended ? '‚úì Present' : 'Absent'}
                    </div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.student-grid-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.dataset.studentId;
                        const attended = this.currentStudents.find(s => s.user_id === studentId).attended;
                        this.toggleStudentAttendance(studentId, !attended);
                    });
                });
            }

            async toggleStudentAttendance(studentId, attended) {
                try {
                    const timeSegment = this.getTimeSegment(this.currentEvent.startTime);
                    
                    const response = await fetch('/api/class/set_student_attendance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_ids: [studentId],
                            present: [attended],
                            class_id: this.currentEvent.classId,
                            class_start_ts: timeSegment
                        })
                    });

                    if (response.ok) {
                        console.log(`Attendance for student ${studentId} toggled to ${attended ? 'present' : 'absent'}`);
                        // Reload students to get updated attendance
                        await this.loadCurrentStudents();
                        // Hide search results
                        document.getElementById('search-results').classList.add('hidden');
                        document.getElementById('student-search').value = '';
                    } else {
                        // Show error message - show a popup
                        const errorData = await response.json();
                        const errorMessage = errorData.error_message || 'Failed to toggle attendance';
                        // Show error in a modal error box
                        const errorModal = document.createElement('div');
                        errorModal.style.position = 'fixed';
                        errorModal.style.top = '0';
                        errorModal.style.left = '0';
                        errorModal.style.width = '100vw';
                        errorModal.style.height = '100vh';
                        errorModal.style.background = 'rgba(0,0,0,0.4)';
                        errorModal.style.zIndex = '9999';
                        errorModal.innerHTML = `
                            <div style="
                                background: white;
                                max-width: 400px;
                                margin: 10vh auto;
                                padding: 24px 32px;
                                border-radius: 8px;
                                box-shadow: 0 4px 24px rgba(0,0,0,0.2);
                                text-align: center;
                                position: relative;
                            ">
                                <div style="color: #dc2626; font-size: 1.2rem; font-weight: bold; margin-bottom: 12px;">
                                    Error
                                </div>
                                <div style="color: #991b1b; margin-bottom: 20px;">
                                    ${errorMessage}
                                </div>
                                <button id="close-error-modal" style="
                                    background: #ef4444;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    padding: 8px 20px;
                                    font-size: 1rem;
                                    cursor: pointer;
                                ">Close</button>
                            </div>
                        `;
                        document.body.appendChild(errorModal);
                        document.getElementById('close-error-modal').onclick = () => {
                            document.body.removeChild(errorModal);
                        };

                        console.error('Failed to toggle attendance');
                    }
                } catch (error) {
                    console.error('Error toggling attendance:', error);
                }
            }

            getTimeSegment(date) {
                // return the date timestamp
                return Math.floor(date.getTime()); // Convert to seconds since epoch

                // Convert date to time segment format
                // return date.toLocaleTimeString("en-US", {
                //     hour: "2-digit",
                //     minute: "2-digit",
                //     hour12: false
                // });
            }

            // Keep existing methods for time indicator and highlighting...
            updateCurrentTimeIndicator() {
                const existingIndicator = document.getElementById("current-time-indicator");
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();

                if (currentHour >= this.START_HOUR && currentHour <= this.END_HOUR) {
                    const indicator = document.createElement("div");
                    indicator.className = "current-time-indicator";
                    indicator.id = "current-time-indicator";

                    const timeLabel = document.createElement("div");
                    timeLabel.className = "current-time-label";
                    timeLabel.textContent = now.toLocaleTimeString("en-US", {
                    hour: "numeric",
                    minute: "2-digit",
                    hour12: true,
                    });
                    indicator.appendChild(timeLabel);

                    const hoursFromStart = currentHour - this.START_HOUR;
                    const minutesOffset = currentMinutes / 60;
                    const topPosition = (hoursFromStart + minutesOffset) * this.SLOT_HEIGHT;

                    indicator.style.top = `${topPosition}px`;

                    const eventsContainer = document.getElementById("events-container");
                    eventsContainer.appendChild(indicator);
                }
            }

            updateHighlights() {
                document.querySelectorAll(".event-highlight").forEach((el) => {
                    el.classList.remove("event-highlight");
                });

                const now = new Date();
                let currentEvent = null;
                let nextEvent = null;

                this.events.forEach((event) => {
                    if (now >= event.startTime && now <= event.endTime) {
                    currentEvent = event;
                    }
                });

                if (!currentEvent) {
                    const thirtyMinutesFromNow = new Date(now.getTime() + 30 * 60 * 1000);

                    this.events.forEach((event) => {
                    if (event.startTime > now && event.startTime <= thirtyMinutesFromNow) {
                        if (!nextEvent || event.startTime < nextEvent.startTime) {
                        nextEvent = event;
                        }
                    }
                    });
                }

                const eventToHighlight = currentEvent || nextEvent;
                if (eventToHighlight) {
                    const eventElement = document.getElementById(`event-${eventToHighlight.id}`);
                    if (eventElement) {
                    eventElement.classList.add("event-highlight");
                    }
                }
            }

            startHighlightUpdater() {
                this.highlightInterval = setInterval(() => {
                    this.updateHighlights();
                    this.updateCurrentTimeIndicator();
                }, 30000);
            }

            destroy() {
                if (this.highlightInterval) {
                    clearInterval(this.highlightInterval);
                }
            }
        }

        // Initialize calendar
        const calendar = new DailyCalendar();

        // Stripe - START
        
        // Initialize Stripe
        var stripe = null;
        function init_stripe()
        {
            if (stripe == null) {
                stripe = Stripe('pk_test_51RW5mIP9izC6CZUZ9SqPTU177jhpSRM7NLdGRTjhUmAqILMy5YYP7vbuMxVGEh4XUj9spa9MdbeoAeAxqX5bNVBc00iDtJHDgv'); // Replace with your public key
            
                const elements = stripe.elements();

                // Create card element
                const cardElement = elements.create('card', {
                    hidePostalCode: true,
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                });

                cardElement.mount('#card-element');

                // Handle real-time validation errors from the card Element
                cardElement.on('change', ({error}) => {
                    const displayError = document.getElementById('card-errors');
                    if (error) {
                        displayError.textContent = error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });

                // Get form elements
                stripeForm = document.getElementById('stripe-card-form');
                stripeSubmitBtn = document.getElementById('stripe-submit-btn');
                stripeLoading = document.getElementById('stripe-loading');
                stripeResult = document.getElementById('stripe-result');
                stripeEmail = document.getElementById('email');
                stripeCardholderName = document.getElementById('stripe-cardholder-name');
            
                syncStripeFormData();
                loadSavedCards();

                // Handle Stripe form submission
                stripeForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    event.stopPropagation(); // Prevent bubbling to other forms

                    stripeSubmitBtn.disabled = true;
                    stripeLoading.classList.remove('hidden');
                    stripeResult.innerHTML = '';

                    const cardholderName = stripeCardholderName.value;
                    const email = stripeEmail.value;

                    if (!cardholderName.trim()) {
                        showStripeMessage('Please enter the cardholder name.', 'error');
                        stripeSubmitBtn.disabled = false;
                        stripeLoading.classList.add('hidden');
                        return;
                    }

                    if (!email.trim()) {
                        showStripeMessage('Email is required.', 'error');
                        stripeSubmitBtn.disabled = false;
                        stripeLoading.classList.add('hidden');
                        return;
                    }

                    try {
                        // Create setup intent on your backend
                        const setupIntentResponse = await fetch('/api/user/create_setup_intent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                customer_email: email,
                                cardholder_name: cardholderName,
                                user_id: my_user_id
                            }),
                        });

                        if (!setupIntentResponse.ok) {
                            throw new Error(`HTTP ${setupIntentResponse.status}: Failed to create setup intent`);
                        }

                        const { client_secret, customer_id } = await setupIntentResponse.json();

                        // Confirm setup intent with card
                        const {error, setupIntent} = await stripe.confirmCardSetup(
                            client_secret,
                            {
                                payment_method: {
                                    card: cardElement,
                                    billing_details: {
                                        name: cardholderName,
                                        email: email,
                                    },
                                }
                            }
                        );

                        if (error) {
                            throw new Error(error.message);
                        }

                        // Success
                        showStripeMessage('Success! Your payment method has been saved securely.', 'success');

                        // Clear form
                        stripeCardholderName.value = '';
                        cardElement.clear();

                        // Refresh saved cards list
                        loadSavedCards();
                        

                    } catch (error) {
                        console.error('Stripe error:', error);
                        showStripeMessage(`Error: ${error.message}`, 'error');
                    } finally {
                        stripeSubmitBtn.disabled = false;
                        stripeLoading.classList.add('hidden');
                    }
                });

            }
        }

        var elements = null;

        // Create card element
        var cardElement = null;

        // Get form elements
        var stripeForm = null;
        var stripeSubmitBtn = null;
        var stripeLoading = null;
        var stripeResult = null;
        var stripeEmail = null;
        var stripeCardholderName = null;

        // Pre-populate cardholder name from profile form
        function syncNameFromProfile() {
            const firstName = document.getElementById('first_name');
            const surname = document.getElementById('surname');
            if (firstName && surname && firstName.value && surname.value) {
                stripeCardholderName.value = `${firstName.value} ${surname.value}`;
            }
        }

        // Sync data when account section is shown
        function syncStripeFormData() {
            // syncEmailFromProfile();
            syncNameFromProfile();
        }

        // Listen for profile updates to sync the Stripe form
        const profileForm = document.getElementById('profileUpdateForm');
        if (profileForm) {
            profileForm.addEventListener('submit', function() {
                // Sync after a short delay to allow profile update to complete
                setTimeout(syncStripeFormData, 1000);
            });
        }

        // Helper function to show messages
        function showStripeMessage(message, type) {
            const className = type === 'success' 
                ? 'p-4 bg-green-100 border border-green-400 text-green-700 rounded-md'
                : 'p-4 bg-red-100 border border-red-400 text-red-700 rounded-md';
            
            stripeResult.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Clear message after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    stripeResult.innerHTML = '';
                }, 5000);
            }
        }

        // Load saved cards
        async function loadSavedCards() {
            const savedCardsList = document.getElementById('saved-cards-list');
            // console.log('loadSavedCards Loading saved cards for user:', my_user_id);
            try {
                const response = await fetch('/api/user/get_stripe_saved_payment_methods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to load payment methods`);
                }

                const { payment_methods } = await response.json();

                if (payment_methods && payment_methods.length > 0) {
                    savedCardsList.innerHTML = payment_methods.map(pm => `
                        <div class="flex justify-between items-center p-3 border border-gray-200 rounded-md bg-white" data-pm-id="${pm.id}">
                            <div>
                                <div class="font-medium capitalize">${pm.card.brand} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${pm.card.last4}</div>
                                <div class="text-sm text-gray-500">Expires ${pm.card.exp_month}/${pm.card.exp_year}</div>
                            </div>
                            <button class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700" 
                                    onclick="deletePaymentMethod('${pm.id}')">
                                Delete
                            </button>
                        </div>
                    `).join('');
                } else {
                    savedCardsList.innerHTML = '<p class="text-gray-500">No saved payment methods found.</p>';
                }
            } catch (error) {
                console.error('Error loading saved cards:', error);
                savedCardsList.innerHTML = `<p class="text-red-600">Error loading saved cards: ${error.message}</p>`;
            }
        }

        // Delete payment method (global function)
        window.deletePaymentMethod = async function(paymentMethodId) {
            if (!confirm('Are you sure you want to delete this payment method?')) {
                return;
            }

            try {
                const response = await fetch('/api/user/delete_payment_method', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: my_user_id,
                        payment_method_id: paymentMethodId
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to delete payment method`);
                }

                // Remove from UI
                const cardItem = document.querySelector(`[data-pm-id="${paymentMethodId}"]`);
                if (cardItem) {
                    cardItem.remove();
                }
                
                showStripeMessage('Payment method deleted successfully.', 'success');
                
            } catch (error) {
                console.error('Error deleting payment method:', error);
                showStripeMessage(`Error: ${error.message}`, 'error');
            }
        };

        // Refresh cards button
        document.getElementById('refresh-cards').addEventListener('click', loadSavedCards);

        // Stripe - end



		// Payment plans -- Section -- START //

		// --- Payment Plans Module ---

		async function initPaymentPlansSection() {
            await Promise.all([
                renderUserMemberships(),
                renderPurchasablePlans()
            ]);
            if (hasPermission(userPermissions, [Permissions.SuperAdmin, Permissions.HyperAdmin]))
            {
                document.getElementById('adminPaymentPlansSection').style.display =
                'block';
                await renderAdminPaymentPlans();
            }
		}

		async function renderUserMemberships() {
		const container = document.getElementById('userMemberships');
		container.innerHTML = '<p>Loading your memberships‚Ä¶</p>';
		try {
			const res = await fetch('/api/user/get_payment_plans', {
			    method: 'POST'
			});
			const { payment_plans } = await res.json(); // assume { memberships: [...] }
            let memberships = payment_plans;
			if (!memberships || memberships.length === 0) {
                container.innerHTML =
                    '<p class="text-gray-600 italic">No active memberships.</p>';
                return;
			}
			container.innerHTML = '';
			memberships.forEach((m) => {
                var exp = new Date(m.expiration_ts).toLocaleString();
                exp = exp.replace(", 12:00:00 am", "");
                const card = document.createElement('div');
                card.className =
                    'inline-block bg-white p-4 m-2 rounded shadow text-left';
                card.innerHTML = `
                    <h4 class="font-semibold">${m.title}</h4>
                    <p>${m.subscribed ? 'Renews: ' +exp : 'Expires : ' + exp }</p>
                    <p>
                    Auto-renew:
                    ${m.subscribed ? 'Yes' : 'No'}
                    </p>
                    <button
                    class="mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm cancel-pp"
                    data-user_payment_plan_id="${m.user_payment_plan_id}"
                    data-subscribed="${m.subscribed}"
                    >
                    ${m.subscribed ? 'Unsubscribe' : 'Subscribe'}
                    </button>
                `;
                container.appendChild(card);
			});
			container
			.querySelectorAll('.cancel-pp')
			.forEach((btn) =>
				btn.addEventListener('click', async () => {
                    const subscribed = btn.dataset.subscribed === 'true';
                    await fetch('/api/user/change_subscribe_user_payment_plan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_payment_plan_id: btn.dataset.user_payment_plan_id, subscribe: !subscribed })
                        });

                    await renderUserMemberships();
				})
			);
		} catch (e) {
			console.error(e);
			container.innerHTML =
			'<p class="text-red-600">Error loading memberships.</p>';
		}
		}

		async function renderPurchasablePlans() {
		const grid = document.getElementById('purchasablePlansGrid');
		grid.innerHTML = '<p>Loading plans‚Ä¶</p>';
		try {
			const res = await fetch(
                '/api/user/get_purchasable_payment_plans',
                { method: 'POST' }
			);
			const { payment_plans } = await res.json(); // { payment_plans: [...] }
			if (!payment_plans.length) {
                grid.innerHTML =
                    '<p class="col-span-2 text-gray-600 italic">No plans available.</p>';
                return;
			}
			// bucket by duration√ótype
			grid.innerHTML = '';
			payment_plans.forEach((p) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded shadow flex flex-col justify-between';
                if (!p) {
                    card.classList.add('bg-gray-200');
                    card.innerHTML = '<p class="italic">Not offered.</p>';
                } else {
                    card.innerHTML = `
                        <h4 class="font-semibold">${p.title}</h4>
                        <p class="text-sm mb-2">${p.description}</p>
                        <p>Cost: $${parseFloat(p.cost).toFixed(2)}</p>
                        <p>Duration: ${
                        p.duration_id === 1 ? 'Calendar Month' : 'School Term'
                        }</p>
                        <p>Type: ${p.grouping_id === 0 ? 'Individual' : 'Family'}</p>`;
                    if (p.purchasable) {
                        const btn = document.createElement('button');
                        btn.textContent = 'Subscribe';
                        btn.className =
                        'mt-3 px-3 py-1 bg-green-500 text-white rounded text-sm';
                        btn.addEventListener('click', async () => {
                        await fetch('/api/user/subscribe_payment_plan', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ payment_plan_id: p.payment_plan_id, base_payment_plan_id: p.base_payment_plan_id })
                        });
                        await renderUserMemberships();
                        });
                        card.appendChild(btn);
                    }
                }
                grid.appendChild(card);
			});
		} catch (e) {
			console.error(e);
			grid.innerHTML =
			'<p class="col-span-2 text-red-600">Error loading plans.</p>';
		}
		}

		// async function renderAdminPaymentPlans() {
		// const grid = document.getElementById('adminPlansGrid');
		// grid.innerHTML = '<p>Loading admin plans‚Ä¶</p>';
		// try {
		// 	const res = await fetch('/api/school/current_payment_plans', {
		// 	method: 'POST'
		// 	});
		// 	const { payment_plans } = await res.json();
		// 	// bucket by duration√ótype√óage√óworking
		// 	const byCell = {};
		// 	payment_plans.forEach((p) => {
		// 	// determine rowKey
		// 	let row;
		// 	if (p.type_id === 1) row = 'family';
		// 	else if (p.is_working) row = 'ind_adult';
		// 	else if (p.max_age <= 18) row = 'ind_child';
		// 	else row = 'ind_nonworking';
		// 	byCell[`${p.duration_id}_${row}`] = p;
		// 	});
		// 	grid.innerHTML = '';
		// 	const rows = [
		// 	['ind_adult', 'Individual Adult'],
		// 	['ind_child', 'Individual Child'],
		// 	['ind_nonworking', 'Individual Adult Non-working'],
		// 	['family', 'Family']
		// 	];
		// 	rows.forEach(([rowKey, label]) => {
		// 	[1, 2].forEach((dur) => {
		// 		const p = byCell[`${dur}_${rowKey}`];
		// 		const card = document.createElement('div');
		// 		card.className =
		// 		'p-4 rounded shadow flex flex-col justify-between';
		// 		if (!p) {
		// 		card.classList.add('bg-gray-200');
		// 		card.innerHTML = `<p class="italic">${label} / ${
		// 			dur === 1 ? 'Month' : 'Term'
		// 		} not set.</p>`;
		// 		} else {
		// 		card.classList.add('bg-white');
		// 		card.innerHTML = `
		// 			<h4 class="font-semibold">${label}</h4>
		// 			<p>Cost: $${parseFloat(p.cost).toFixed(2)}</p>
		// 			<p>Age: ${p.min_age}‚Äì${p.max_age}</p>
		// 			<p>Working: ${p.is_working ? 'Yes' : 'No'}</p>
		// 		`;
		// 		}
		// 		const btn = document.createElement('button');
		// 		btn.textContent = p ? 'Update' : 'Add';

				// --- Payment Plans Module ---
		// async function initPaymentPlansSection() {
		// await Promise.all([
		// 	renderUserMemberships(),
		// 	renderPurchasablePlans()
		// ]);

		// if (IS_ADMIN === 1) {
		// 	document.getElementById('adminPaymentPlansSection').style.display =
		// 	'block';
		// 	await renderAdminPaymentPlans();
		// }
		// }

		// async function renderUserMemberships() {
		// const container = document.getElementById('userMemberships');
		// container.innerHTML = '<p>Loading your memberships‚Ä¶</p>';
		// try {
		// 	const res = await fetch('/api/user/get_memberships', {
		// 	method: 'POST'
		// 	});
		// 	const { memberships } = await res.json(); // assume { memberships: [...] }
		// 	if (!memberships || memberships.length === 0) {
		// 	container.innerHTML =
		// 		'<p class="text-gray-600 italic">No active memberships.</p>';
		// 	return;
		// 	}
		// 	container.innerHTML = '';
		// 	memberships.forEach((m) => {
		// 	const exp = new Date(m.expires_at).toLocaleString();
		// 	const card = document.createElement('div');
		// 	card.className =
		// 		'inline-block bg-white p-4 m-2 rounded shadow text-left';
		// 	card.innerHTML = `
		// 		<h4 class="font-semibold">${m.title}</h4>
		// 		<p>Expires: ${exp}</p>
		// 		<p>
		// 		Auto-renew:
		// 		${m.auto_renew ? 'Yes' : 'No'}
		// 		</p>
		// 		<button
		// 		class="mt-2 px-3 py-1 bg-red-500 text-white rounded text-sm cancel-pp"
		// 		data-plan-id="${m.payment_plan_id}"
		// 		>
		// 		Cancel
		// 		</button>
		// 	`;
		// 	container.appendChild(card);
		// 	});
		// 	container
		// 	.querySelectorAll('.cancel-pp')
		// 	.forEach((btn) =>
		// 		btn.addEventListener('click', async () => {
		// 		await fetch('/api/user/cancel_payment_plan', { method: 'POST' });
		// 		await renderUserMemberships();
		// 		})
		// 	);
		// } catch (e) {
		// 	console.error(e);
		// 	container.innerHTML =
		// 	'<p class="text-red-600">Error loading memberships.</p>';
		// }
		// }

		// async function renderPurchasablePlans() {
		// const grid = document.getElementById('purchasablePlansGrid');
		// grid.innerHTML = '<p>Loading plans‚Ä¶</p>';
		// try {
		// 	const res = await fetch(
		// 	'/api/user/get_purchasable_payment_plans',
		// 	{ method: 'POST' }
		// 	);
		// 	const { payment_plans } = await res.json(); // { payment_plans: [...] }
		// 	if (!payment_plans.length) {
		// 	grid.innerHTML =
		// 		'<p class="col-span-2 text-gray-600 italic">No plans available.</p>';
		// 	return;
		// 	}
		// 	// bucket by duration√ótype
		// 	const byCell = {};
		// 	payment_plans.forEach((p) => {
		// 	byCell[`${p.duration_id}_${p.type_id}`] = p;
		// 	});
		// 	grid.innerHTML = '';
		// 	// durations: 1‚Üícol1, 2‚Üícol2; types: 0 row1, 1 row2
		// 	[0, 1].forEach((type) => {
		// 	[1, 2].forEach((dur) => {
		// 		const p = byCell[`${dur}_${type}`];
		// 		const card = document.createElement('div');
		// 		card.className =
		// 		'bg-white p-4 rounded shadow flex flex-col justify-between';
		// 		if (!p) {
		// 		card.classList.add('bg-gray-200');
		// 		card.innerHTML = '<p class="italic">Not offered.</p>';
		// 		} else {
		// 		card.innerHTML = `
		// 			<h4 class="font-semibold">${p.title}</h4>
		// 			<p class="text-sm mb-2">${p.description}</p>
		// 			<p>Cost: $${parseFloat(p.cost).toFixed(2)}</p>
		// 			<p>Duration: ${
		// 			dur === 1 ? 'Calendar Month' : 'School Term'
		// 			}</p>
		// 			<p>Type: ${type === 0 ? 'Individual' : 'Family'}</p>
		// 		`;
		// 		if (p.purchasable) {
		// 			const btn = document.createElement('button');
		// 			btn.textContent = 'Subscribe';
		// 			btn.className =
		// 			'mt-3 px-3 py-1 bg-green-500 text-white rounded text-sm';
		// 			btn.addEventListener('click', async () => {
		// 			await fetch('/api/user/subscribe_payment_plan', {
		// 				method: 'POST',
		// 				headers: { 'Content-Type': 'application/json' },
		// 				body: JSON.stringify({ payment_plan_id: p.payment_plan_id })
		// 			});
		// 			await renderUserMemberships();
		// 			});
		// 			card.appendChild(btn);
		// 		}
		// 		}
		// 		grid.appendChild(card);
		// 	});
		// 	});
		// } catch (e) {
		// 	console.error(e);
		// 	grid.innerHTML =
		// 	'<p class="col-span-2 text-red-600">Error loading plans.</p>';
		// }
		// }

		async function renderAdminPaymentPlans() {
		const grid = document.getElementById('adminPlansGrid');
		grid.innerHTML = '<p>Loading admin plans‚Ä¶</p>';
		try {
			const res = await fetch('/api/school/current_payment_plans', {
			method: 'POST'
			});
			const { payment_plans } = await res.json();
			// bucket by duration√ótype√óage√óworking
			const byCell = {};
			payment_plans.forEach((p) => {
			// determine rowKey
			let row;
			if (p.type_id === 1) row = 'family';
			else if (p.is_working) row = 'ind_adult';
			else if (p.max_age <= 18) row = 'ind_child';
			else row = 'ind_nonworking';
			byCell[`${p.duration_id}_${row}`] = p;
			});
			grid.innerHTML = '';
			const rows = [
			['ind_adult', 'Individual Adult'],
			['ind_child', 'Individual Child'],
			['ind_nonworking', 'Individual Adult Non-working'],
			['family', 'Family']
			];
			rows.forEach(([rowKey, label]) => {
			[1, 2].forEach((dur) => {
				const p = byCell[`${dur}_${rowKey}`];
				const card = document.createElement('div');
				card.className =
				'p-4 rounded shadow flex flex-col justify-between';
				if (!p) {
				card.classList.add('bg-gray-200');
				card.innerHTML = `<p class="italic">${label} / ${
					dur === 1 ? 'Month' : 'Term'
				} not set.</p>`;
				} else {
				card.classList.add('bg-white');
				card.innerHTML = `
					<h4 class="font-semibold">${label}</h4>
					<p>Cost: $${parseFloat(p.cost).toFixed(2)}</p>
					<p>Age: ${p.min_age}‚Äì${p.max_age}</p>
					<p>Working: ${p.is_working ? 'Yes' : 'No'}</p>
				`;
				}
				const btn = document.createElement('button');
				btn.textContent = p ? 'Update' : 'Add';
				btn.className =
				'mt-2 px-2 py-1 bg-blue-500 text-white rounded text-sm';
				btn.addEventListener('click', () =>
				openEditPPModal(p || { duration_id: dur, type_id: rowKey })
				);
				card.appendChild(btn);
				grid.appendChild(card);
			});
			});
		} catch (e) {
			console.error(e);
			grid.innerHTML =
			'<p class="col-span-2 text-red-600">Error loading admin plans.</p>';
		}
		}

		function openEditPPModal(pp) {
            const modal = document.getElementById('edit-paymentplan-modal');
            document.getElementById('edit-pp-id').value =
                pp.payment_plan_id || '';
            document.getElementById('edit-pp-title').value = pp.title || '';
            document.getElementById('edit-pp-desc').value = pp.description || '';
            document.getElementById('edit-pp-cost').value = pp.cost || '';
            document.getElementById('edit-pp-duration').value =
                pp.duration_id || '';
            document.getElementById('edit-pp-type').value = pp.type_id || '';
            document.getElementById('edit-pp-min-age').value = pp.min_age || '';
            document.getElementById('edit-pp-max-age').value = pp.max_age || '';
            document.getElementById('edit-pp-is-working').checked =
                pp.is_working || false;
            modal.style.display = 'block';
		}

		document
		.getElementById('submit-edit-paymentplan')
		.addEventListener('click', async () => {
			const body = {
                title: document.getElementById('edit-pp-title').value,
                description: document.getElementById('edit-pp-desc').value,
                payment_plan_id: document.getElementById('edit-pp-id').value,
                duration_id: parseInt(document.getElementById('edit-pp-duration').value, 10),
                grouping_id: parseInt(document.getElementById('edit-pp-type').value, 10),
                cost: parseFloat(
                    document.getElementById('edit-pp-cost').value
                ),
                min_age: parseInt(
                    document.getElementById('edit-pp-min-age').value,
                    10
                ),
                max_age: parseInt(
                    document.getElementById('edit-pp-max-age').value,
                    10
                ),
                is_working: document.getElementById('edit-pp-is-working').checked
			};
			try {
			await fetch('/api/school/update_payment_plan', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(body)
			});
			document.getElementById('edit-paymentplan-modal').style.display =
				'none';
			await renderAdminPaymentPlans();
			} catch (e) {
			console.error(e);
			document.getElementById('edit-pp-message').textContent =
				'Error updating plan';
			}
		});
        
//         );rd.appendChild(btn);
//         grid.appendChild(card);
//       });
//     });
//   } catch (e) {
//     console.error(e);
//     grid.innerHTML =
//       '<p class="col-span-2 text-red-600">Error loading admin plans.</p>';
//   }
// }

function openEditPPModal(pp) {
  const modal = document.getElementById('edit-paymentplan-modal');
  document.getElementById('edit-pp-id').value =
    pp.payment_plan_id || '';
  document.getElementById('edit-pp-title').value = pp.title || '';
  document.getElementById('edit-pp-desc').value = pp.description || '';
  document.getElementById('edit-pp-cost').value = pp.cost || '';
  document.getElementById('edit-pp-duration').value =
    pp.duration_id || '';
  document.getElementById('edit-pp-type').value = pp.type_id || '';
  document.getElementById('edit-pp-min-age').value = pp.min_age || '';
  document.getElementById('edit-pp-max-age').value = pp.max_age || '';
  document.getElementById('edit-pp-is-working').checked =
    pp.is_working || false;
  modal.style.display = 'block';
}

document
  .getElementById('submit-edit-paymentplan')
  .addEventListener('click', async () => {
    const body = {
      payment_plan_id: document.getElementById('edit-pp-id').value,
      cost: parseFloat(
        document.getElementById('edit-pp-cost').value
      ),
      min_age: parseInt(
        document.getElementById('edit-pp-min-age').value,
        10
      ),
      max_age: parseInt(
        document.getElementById('edit-pp-max-age').value,
        10
      ),
      is_working: document.getElementById('edit-pp-is-working').checked
    };
    try {
      await fetch('/api/school/update_payment_plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      document.getElementById('edit-paymentplan-modal').style.display =
        'none';
      await renderAdminPaymentPlans();
    } catch (e) {
      console.error(e);
      document.getElementById('edit-pp-message').textContent =
        'Error updating plan';
    }
  });
		
		//Payment Plans -- Section -- END //



    // Stripe Admin - edit users - START //
    // Initialize Stripe for admin modal
    var stripeAdmin = null;
    var cardElementAdmin = null;
  
    function deinitStripeForAdmin() {
        if (stripeAdmin) {
            stripeAdmin = null;
            cardElementAdmin = null;
            // document.getElementById('stripe-card-form-admin').cloneNode(true);

            const oldButton = document.getElementById('stripe-card-form-admin');
            const newButton = oldButton.cloneNode(true); // true = copy child nodes
            oldButton.parentNode.replaceChild(newButton, oldButton);


            document.getElementById('stripe-result-admin').innerHTML = '';
            document.getElementById('card-element-admin').innerHTML = '';
            document.getElementById('stripe-submit-btn-admin').disabled = false;
            document.getElementById('stripe-loading-admin').classList.add('hidden');
            document.getElementById('stripe-cardholder-name-admin').value = '';
            document.getElementById('card-errors-admin').textContent = '';
        }
    }

    function initStripeForAdmin(userId, email, cardholderName) {
        if (stripeAdmin) return; // Don't re-initialize

        stripeAdmin = Stripe('pk_test_51RW5mIP9izC6CZUZ9SqPTU177jhpSRM7NLdGRTjhUmAqILMy5YYP7vbuMxVGEh4XUj9spa9MdbeoAeAxqX5bNVBc00iDtJHDgv');
        const elements = stripeAdmin.elements();

        cardElementAdmin = elements.create('card', { hidePostalCode: true });
        cardElementAdmin.mount('#card-element-admin');

        cardElementAdmin.on('change', ({ error }) => {
            document.getElementById('card-errors-admin').textContent = error ? error.message : '';
        });

        const stripeFormAdmin = document.getElementById('stripe-card-form-admin');
        const stripeSubmitBtnAdmin = document.getElementById('stripe-submit-btn-admin');
        const stripeLoadingAdmin = document.getElementById('stripe-loading-admin');
        const stripeResultAdmin = document.getElementById('stripe-result-admin');
        const stripeCardholderNameAdmin = document.getElementById('stripe-cardholder-name-admin');

        stripeCardholderNameAdmin.value = cardholderName;

        stripeFormAdmin.addEventListener('submit', async (event) => {
            event.preventDefault();
            stripeSubmitBtnAdmin.disabled = true;
            stripeLoadingAdmin.classList.remove('hidden');
            stripeResultAdmin.innerHTML = '';

            try {
            // const name = stripeCardholderNameAdmin.value.trim();
            // if (!name) throw new Error('Cardholder name is required');


            const cardholderName = stripeCardholderNameAdmin.value;

            if (!cardholderName.trim()) {
                showStripeMessage('Please enter the cardholder name.', 'error');
                stripeSubmitBtn.disabled = false;
                stripeLoading.classList.add('hidden');
                return;
            }

            if (!email.trim()) {
                showStripeMessage('Email is required.', 'error');
                stripeSubmitBtn.disabled = false;
                stripeLoading.classList.add('hidden');
                return;
            }

            console.log('Creating setup intent for user:', userId, 'with email:', email, 'and cardholder name:', cardholderName);
            const res = await fetch('/api/user/create_setup_intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, 
                    customer_email: email, 
                    cardholder_name: cardholderName 
                })
            });

            if (!res.ok) throw new Error('Failed to create setup intent');
            const { client_secret } = await res.json();

            const { error } = await stripeAdmin.confirmCardSetup(client_secret, {
                payment_method: {
                card: cardElementAdmin,
                billing_details: { name, email }
                }
            });

            if (error) throw error;

                showStripeAdminMessage('Payment method saved successfully.', 'success');
                cardElementAdmin.clear();
                stripeCardholderNameAdmin.value = '';
                loadSavedCardsForAdmin(userId);
            } catch (err) {
                console.error(err);
                showStripeAdminMessage(err.message, 'error');
            } finally {
                stripeSubmitBtnAdmin.disabled = false;
                stripeLoadingAdmin.classList.add('hidden');
            }
        });

        const oldButton = document.getElementById('refresh-cards-admin');
        const newButton = oldButton.cloneNode(true); // true = copy child nodes
        oldButton.parentNode.replaceChild(newButton, oldButton);

        document.getElementById('refresh-cards-admin').addEventListener('click', () => {
            loadSavedCardsForAdmin(userId);
        });

        // Initial load
        // console.log("ad");
        loadSavedCardsForAdmin(userId);
    }

    function showStripeAdminMessage(message, type) {
    const result = document.getElementById('stripe-result-admin');
    const className = type === 'success'
        ? 'p-4 bg-green-100 border border-green-400 text-green-700 rounded-md'
        : 'p-4 bg-red-100 border border-red-400 text-red-700 rounded-md';

    result.innerHTML = `<div class="${className}">${message}</div>`;
    if (type === 'success') {
        setTimeout(() => result.innerHTML = '', 5000);
    }
    }

    async function loadSavedCardsForAdmin(userId) {
        const list = document.getElementById('saved-cards-list-admin');
        // console.log('loadSavedCardsForAdmin Loading saved cards for user:', userId);

        try {
            const res = await fetch('/api/user/get_stripe_saved_payment_methods', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId
                }),
            });

            if (!res.ok) throw new Error('Could not load payment methods');
            const { payment_methods } = await res.json();

            if (!payment_methods || payment_methods.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No saved cards found.</p>';
            } else {
                list.innerHTML = payment_methods.map(pm => `
                    <div class="flex justify-between items-center p-3 border border-gray-200 rounded-md bg-white" data-pm-id="${pm.id}">
                    <div>
                        <div class="font-medium capitalize">${pm.card.brand} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${pm.card.last4}</div>
                        <div class="text-sm text-gray-500">Expires ${pm.card.exp_month}/${pm.card.exp_year}</div>
                    </div>
                    <button class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                            onclick="deletePaymentMethodForAdmin('${pm.id}', '${userId}')">
                        Delete
                    </button>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error(err);
            list.innerHTML = `<p class="text-red-600">Error: ${err.message}</p>`;
        }
    }

    window.deletePaymentMethodForAdmin = async function(paymentMethodId, userId) {
        if (!confirm('Are you sure you want to delete this payment method?')) return;

        try {
            const res = await fetch('/api/user/delete_payment_method', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, payment_method_id: paymentMethodId })
            });

            if (!res.ok) throw new Error('Failed to delete card');
            document.querySelector(`[data-pm-id="${paymentMethodId}"]`)?.remove();
            showStripeAdminMessage('Payment method deleted.', 'success');
        } catch (err) {
            console.error(err);
            showStripeAdminMessage(err.message, 'error');
        }
    };
    // Stripe Admin - edit users - END //


    </script>
</body>
</html>
