<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMA Gym Portal</title>
    <!-- Include Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* Basic nav styling to demonstrate */
        nav ul {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #1f2937; /* Tailwind: bg-gray-800 */
        }
        nav ul li {
            margin-right: 1rem; /* Tailwind: mr-4 */
        }
        nav ul li a {
            color: #f3f4f6; /* Tailwind: text-gray-100 */
            text-decoration: none;
            padding: 1rem; /* Tailwind: p-4 */
            display: block;
        }
        nav ul li a:hover {
            background-color: #374151; /* Tailwind: bg-gray-700 */
        }

        /* Styles for content sections */
        .portal-section {
            display: none; /* Initially hide all content sections */
        }
        .portal-section.active {
            display: block; /* Show the active section */
        }

        /* Modal styles (retained and adapted for Tailwind context) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; /* Adjusted margin to be higher */
            padding: 24px; /* Increased padding */
            border: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
            width: 90%; /* Adjusted width */
            max-width: 700px; /* Increased max width for forms */
            border-radius: 8px; /* More rounded corners */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Added a subtle shadow */
        }

        .modal-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             border-bottom: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
             padding-bottom: 16px; /* Increased padding */
             margin-bottom: 24px; /* Increased margin */
        }

        .modal-header h3 {
             margin: 0;
             font-size: 1.5rem; /* Tailwind text-2xl */
             font-weight: 600; /* Tailwind font-semibold */
             color: #1f2937; /* Tailwind text-gray-900 */
         }

        .close-button {
            color: #9ca3af; /* Tailwind text-gray-400 */
            font-size: 2rem; /* Larger close button */
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #6b7280; /* Tailwind text-gray-500 */
            text-decoration: none;
        }

         #new-waiver-content {
             width: 100%;
             box-sizing: border-box; /* Include padding in width */
             margin-bottom: 10px;
         }

         /* Styles for waiver/accept messages */
         #create-waiver-error, #accept-waiver-message {
             margin-top: 10px;
             padding: 10px; /* Increased padding */
             border-radius: 4px;
             font-size: 0.875rem; /* Tailwind text-sm */
         }
         #create-waiver-error.error, #accept-waiver-message.error {
             color: #b91c1c; /* Tailwind text-red-700 */
             border: 1px solid #f87171; /* Tailwind border-red-400 */
             background-color: #fee2e2; /* Tailwind bg-red-100 */
         }
          #create-waiver-error.success, #accept-waiver-message.success {
             color: #065f46; /* Tailwind text-green-700 */
             border: 1px solid #34d399; /* Tailwind border-green-400 */
             background-color: #d1fae5; /* Tailwind bg-green-100 */
         }

         .form-group {
             margin-bottom: 16px; /* Increased margin */
         }

         .form-group label {
             display: block;
             margin-bottom: 8px; /* Increased margin */
             font-weight: 500; /* Tailwind font-medium */
             color: #374151; /* Tailwind text-gray-700 */
         }

         .form-group input[type="text"],
         .form-group input[type="number"],
         .form-group input[type="date"], /* Added date input */
         .form-group input[type="time"], /* Added time input */
         .form-group textarea,
         .form-group select {
             width: 100%; /* Use full width with Tailwind padding */
             padding: 8px 12px; /* Tailwind py-2 px-3 */
             border: 1px solid #d1d5db; /* Tailwind border-gray-300 */
             border-radius: 6px; /* Tailwind rounded-md */
             box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Tailwind shadow-sm */
             font-size: 0.875rem; /* Tailwind text-sm */
             color: #1f2937; /* Tailwind text-gray-900 */
             transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
         }
          .form-group input:focus,
          .form-group textarea:focus,
          .form-group select:focus {
              outline: none;
              border-color: #3b82f6; /* Tailwind border-blue-500 */
              box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* Tailwind ring-blue-500 */
          }


         .form-group textarea {
             resize: vertical; /* Allow vertical resizing */
         }

         .checkbox-group {
             display: flex;
             align-items: center;
             margin-bottom: 16px; /* Consistent form-group margin */
         }
         .checkbox-group input[type="checkbox"] {
             margin-right: 8px; /* Tailwind mr-2 */
             width: auto; /* Don't use 100% width */
             padding: 0; /* Remove padding from checkbox */
             box-shadow: none; /* Remove shadow from checkbox */
             /* Further checkbox styling can be added with Tailwind, but it's often
                easier with a custom approach or a library for cross-browser consistency */
         }
          .checkbox-group label {
             margin-bottom: 0; /* Reset margin */
             font-weight: 400; /* Normal font weight */
             color: #374151; /* Consistent text color */
         }

         #frequency-container .frequency-entry {
             border: 1px dashed #d1d5db; /* Tailwind border-dashed border-gray-300 */
             padding: 16px; /* Increased padding */
             margin-bottom: 16px; /* Consistent margin */
             border-radius: 6px; /* Tailwind rounded-md */
             position: relative; /* Needed for absolute positioning of remove button */
         }

         .remove-frequency-button {
            position: absolute;
            top: 8px; /* Adjusted position */
            right: 8px; /* Adjusted position */
            background: #ef4444; /* Tailwind bg-red-500 */
            color: white;
            border: none;
            border-radius: 4px; /* Tailwind rounded */
            padding: 4px 8px; /* Tailwind py-1 px-2 */
            cursor: pointer;
            font-size: 0.75rem; /* Tailwind text-xs */
            font-weight: 500; /* Tailwind font-medium */
            transition: background-color 0.2s ease-in-out;
         }
          .remove-frequency-button:hover {
              background-color: #dc2626; /* Tailwind bg-red-600 */
          }


         .modal-footer {
             border-top: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
             padding-top: 16px; /* Increased padding */
             margin-top: 24px; /* Increased margin */
             text-align: right; /* Buttons to the right */
         }

         .modal-footer button {
             padding: 10px 20px; /* Tailwind py-2.5 px-5 */
             margin-left: 12px; /* Tailwind ml-3 */
             border: none;
             border-radius: 6px; /* Tailwind rounded-md */
             cursor: pointer;
             font-size: 0.875rem; /* Tailwind text-sm */
             font-weight: 500; /* Tailwind font-medium */
             transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out;
         }

         .modal-footer .submit-button {
             background-color: #22c55e; /* Tailwind bg-green-500 */
             color: white;
         }
          .modal-footer .submit-button:hover {
              background-color: #16a34a; /* Tailwind bg-green-600 */
          }


         .modal-footer .cancel-button {
             background-color: #facc15; /* Tailwind bg-yellow-400 */
             color: #1f2937; /* Tailwind text-gray-900 */
         }
         .modal-footer .cancel-button:hover {
             background-color: #eab308; /* Tailwind bg-yellow-500 */
         }

         #create-class-message {
             margin-top: 16px; /* Consistent margin */
             padding: 10px; /* Consistent padding */
             border-radius: 4px;
             font-size: 0.875rem; /* Tailwind text-sm */
             color: #b91c1c; /* Tailwind text-red-700 */
             border: 1px solid #f87171; /* Tailwind border-red-400 */
             background-color: #fee2e2; /* Tailwind bg-red-100 */
             display: none; /* Hidden by default */
         }
         #create-class-message.success {
             color: #065f46; /* Tailwind text-green-700 */
             border: 1px solid #34d399; /* Tailwind border-green-400 */
             background-color: #d1fae5; /* Tailwind bg-green-100 */
         }

        /* POS Section Styles -- START */
        #calendar-grid {
            position: relative;
        }

        .time-slot {
            display: flex;
            align-items: flex-start;
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .time-slot:hover {
            background-color: #f9fafb;
        }

        .time-label {
            width: 80px;
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
            padding: 4px 12px;
            text-align: right;
        }

        .time-content {
            flex: 1;
            height: 100%;
            border-left: 2px solid #e5e7eb;
            margin-left: 8px;
        }

        .event {
            position: absolute;
            left: 100px;
            right: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            border: 2px solid transparent;
            z-index: 10;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .event:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .event-title {
            font-weight: 600;
            line-height: 1.2;
        }

        .event-time {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .event-description {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
            line-height: 1.3;
        }

        .event-highlight {
            animation: eventPulse 2.5s ease-in-out infinite;
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.4), 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        @keyframes eventPulse {
            0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7), 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            50% {
            transform: scale(1.02);
            box-shadow: 0 0 0 8px rgba(251, 191, 36, 0.2), 0 6px 16px rgba(59, 130, 246, 0.6);
            }
            100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7), 0 4px 12px rgba(59, 130, 246, 0.4);
            }
        }

        .current-time-indicator {
            position: absolute;
            left: 88px;
            right: 16px;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            z-index: 20;
            border-radius: 2px;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);
        }

        .current-time-indicator::before {
            content: "";
            position: absolute;
            left: -8px;
            top: -5px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(239, 68, 68, 0.8);
        }

        .current-time-label {
            position: absolute;
            right: -70px;
            top: -12px;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.4);
        }

        /* Modal specific styles */
        .student-search-item {
            display: flex;
            items-center: space-x-3;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .student-search-item:hover {
            background-color: #f3f4f6;
        }

        .student-list-item {
            display: flex;
            items-center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .student-list-item:hover {
            background-color: #f9fafb;
        }

        .student-list-item.attending {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .student-grid-item {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .student-grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .student-grid-item.attending {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }

        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #e5e7eb;
        }

        .student-grid-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #e5e7eb;
            margin: 0 auto 12px;
        }
        /* POS Section Styles -- END */

        /* Stripe card section styles -- START */
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="email"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        #card-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        #card-errors {
            color: #fa755a;
            margin-top: 10px;
            font-size: 14px;
        }
        .btn {
            background: #5469d4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover {
            background: #4f5fc7;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .success {
            color: #28a745;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin-top: 20px;
        }
        .error {
            color: #dc3545;
            padding: 15px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin-top: 20px;
        }
        .saved-cards {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .card-info {
            flex-grow: 1;
        }
        .card-brand {
            font-weight: bold;
            text-transform: capitalize;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        /* Stripe card section styles -- END */




    </style>

</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">
    <nav>
        <ul>
            <!-- Nav items for client-side tab switching -->
            <li><a href="#" data-section="frontpage" class="nav-link">Front Page</a></li>
            <li><a href="#" data-section="classes" class="nav-link">Classes</a></li>
            <li><a href="#" data-section="venues" class="nav-link">Venues</a></li>
            <li><a href="#" data-section="styles" class="nav-link">Styles</a></li>
            <li><a href="#" data-section="waivers" class="nav-link">Waivers</a></li>
            <li><a href="#" data-section="locations" class="nav-link">Locations</a></li>
            <li><a href="#" data-section="pos" class="nav-link">POS</a></li>
            <li id="users-nav" class="nav-item" style="display: none;"><a href="#" data-section="users" class="nav-link">Users</a></li>
            <li><a href="#" data-section="account" class="nav-link">Account</a></li>
            <!-- Logout is a different action -->
            <li><a href="#" id="logoutLink" class="nav-link">Log out</a></li>
        </ul>
    </nav>

    <div class="container mx-auto mt-8 p-6 bg-white rounded-lg shadow-md flex-grow mb-8 max-w-7xl"> <!-- Increased max-w -->
        <!-- Section: Front Page -->
        <div id="frontpageSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome to the Portal!</h2>
            <p class="text-gray-700 mb-6">This is your main dashboard area. Select an option from the navigation above.</p>
            <!-- Add summary data, recent activity, etc. here -->
             <div id="dashboard-content">
                  <!-- Dynamic dashboard content will go here -->
                  <p>Loading dashboard content...</p>
             </div>
        </div>

        <!-- Section: Classes -->
        <div id="classesSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Classes Management</h2>
            <p class="text-gray-700 mb-6">View and manage upcoming classes.</p>

            <!-- Filter and Sort Controls -->
            <div class="flex flex-wrap gap-4 mb-6 items-center">
                <div>
                    <label for="class-filter-style" class="block text-sm font-medium text-gray-700">Filter by Style:</label>
                    <select id="class-filter-style" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                         <option value="">All Styles</option>
                         <!-- Options will be populated by JS -->
                    </select>
                </div>
                 <div>
                    <label for="class-filter-venue" class="block text-sm font-medium text-gray-700">Filter by Venue:</label>
                    <select id="class-filter-venue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                         <option value="">All Venues</option>
                         <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="class-sort-by" class="block text-sm font-medium text-gray-700">Sort By:</label>
                    <select id="class-sort-by" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                         <option value="next_run_time">Next Run Time</option>
                         <option value="title">Title (A-Z)</option>
                         <!-- Add other sorting options -->
                    </select>
                </div>
                 <div>
                     <label for="class-search" class="block text-sm font-medium text-gray-700">Search:</label>
                     <input type="text" id="class-search" placeholder="Search by title, description..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                 </div>
                <button id="apply-filters-button" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200">Apply Filters</button>
            </div>

             <!-- Join by Code -->
             <div class="mb-6 flex items-center gap-4">
                 <label for="class-code-input" class="block text-sm font-medium text-gray-700">Join Class by Code:</label>
                 <input type="text" id="class-code-input" placeholder="Enter Class Code" class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm flex-grow max-w-xs">
                 <button id="join-by-code-button" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200">Join</button>
             </div>
             <div id="join-by-code-message" class="mt-2 text-center text-gray-700 text-sm"></div>


             <button id="add-class-button" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 mb-6">Add New Class</button>


            <!-- Class listing area -->
            <div id="class-list" class="mt-6 space-y-6">
                 <!-- Class cards will be loaded here -->
                 <p class="text-gray-600 italic">Loading classes...</p>
            </div>


             <!-- Add Class Modal (Remains the same) -->
            <div id="add-class-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Class</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="add-class-form">
                            <div class="form-group">
                                <label for="class-title">Title:</label>
                                <input type="text" id="class-title" required>
                            </div>
                            <div class="form-group">
                                <label for="class-description">Description:</label>
                                <textarea id="class-description" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="class-venue-id">Venue:</label>
                                <select id="class-venue-id" required>
                                     <option value="">Loading venues...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="class-style-ids">Styles:</label>
                                <select id="class-style-ids" multiple required> <!-- Added 'multiple' for selecting multiple styles -->
                                     <option value="">Loading styles...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="class-grading-ids">Grading IDs (comma-separated):</label>
                                <input type="text" id="class-grading-ids" placeholder="e.g., uuidA,uuidB">
                            </div>
                            <div class="form-group">
                                <label for="class-price">Price (optional):</label>
                                <input type="text" id="class-price" placeholder="e.g., 10.50">
                            </div>
                             <div class="form-group">
                                <label for="class-publish-mode">Publish Mode (int):</label>
                                <input type="number" id="class-publish-mode" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="class-capacity">Capacity:</label>
                                <input type="number" id="class-capacity" value="10" required>
                            </div>

                             <!-- Frequency Section -->
                            <div class="form-group">
                                <label>Frequency:</label>
                                <div id="frequency-container" class="space-y-4">
                                    <!-- Frequency entries will be added here -->
                                </div>
                                <button type="button" id="add-frequency-button" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200 mt-4">Add Frequency Slot</button>
                            </div>

                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="class-notify-booking">
                                <label for="class-notify-booking">Notify on Booking</label>
                            </div>
                             <div class="form-group">
                                <label for="class-waiver-id">Waiver ID (optional):</label>
                                <input type="text" id="class-waiver-id" placeholder="e.g., optional-waiver-uuid">
                            </div>

                            <div id="create-class-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-create-class">Create Class</button>
                    </div>
                </div>
            </div>

             <!-- Edit Class Modal (New) -->
            <div id="edit-class-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Class</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="edit-class-form">
                            <input type="hidden" id="edit-class-id"> <!-- Hidden field for class ID -->
                            <div class="form-group">
                                <label for="edit-class-title">Title:</label>
                                <input type="text" id="edit-class-title" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-class-description">Description:</label>
                                <textarea id="edit-class-description" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-class-venue-id">Venue:</label>
                                <select id="edit-class-venue-id" required>
                                     <option value="">Loading venues...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-class-style-ids">Styles:</label>
                                <select id="edit-class-style-ids" multiple required>
                                     <option value="">Loading styles...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="edit-class-grading-ids">Grading IDs (comma-separated):</label>
                                <input type="text" id="edit-class-grading-ids" placeholder="e.g., uuidA,uuidB">
                            </div>
                            <div class="form-group">
                                <label for="edit-class-price">Price (optional):</label>
                                <input type="text" id="edit-class-price" placeholder="e.g., 10.50">
                            </div>
                             <div class="form-group">
                                <label for="edit-class-publish-mode">Publish Mode (int):</label>
                                <input type="number" id="edit-class-publish-mode" value="0" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-class-capacity">Capacity:</label>
                                <input type="number" id="edit-class-capacity">
                            </div>
                            <div class="form-group">
                                <label for="edit-class-free_lessons">Free Lessons:</label>
                                <input type="number" id="edit-class-free_lessons">
                            </div>

                             <!-- Frequency Section for Edit -->
                            <div class="form-group">
                                <label>Frequency:</label>
                                <div id="edit-frequency-container" class="space-y-4">
                                    <!-- Frequency entries will be loaded/added here -->
                                </div>
                                <button type="button" id="add-edit-frequency-button" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-200 mt-4">Add Frequency Slot</button>
                            </div>

                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="edit-class-notify-booking">
                                <label for="edit-class-notify-booking">Notify on Booking</label>
                            </div>
                             <div class="form-group">
                                <label for="edit-class-waiver-id">Waiver ID (optional):</label>
                                <input type="text" id="edit-class-waiver-id" placeholder="e.g., optional-waiver-uuid">
                            </div>

                            <div id="edit-class-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-edit-class">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Venue Info Modal (New) -->
        <div id="venue-info-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Venue Information</h3>
                    <span class="close-button">&times;</span>
                </div>
                <div class="modal-body" id="venue-info-content">
                    <!-- Venue details and map will be loaded here -->
                    <p>Loading venue information...</p>
                </div>
                    <div class="modal-footer">
                    <button type="button" class="cancel-button">Close</button>
                </div>
            </div>
        </div>



        <!-- Section: Venues -->
        <div id="venuesSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Venues Management</h2>
            <p class="text-gray-700 mb-6">Information about different available venues.</p>

            <!-- Filter and Sort Controls for Venues -->
            <div class="flex flex-wrap gap-4 mb-6 items-center">
                <div>
                    <label for="venue-search" class="block text-sm font-medium text-gray-700">Search:</label>
                    <input type="text" id="venue-search" placeholder="Search by name, address..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="venue-sort-by" class="block text-sm font-medium text-gray-700">Sort By:</label>
                    <select id="venue-sort-by" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="title">Name (A-Z)</option>
                        <option value="distance">Distance</option> <!-- Requires location data in backend -->
                        <!-- Add other sorting options -->
                    </select>
                </div>
                <button id="apply-venue-filters-button" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200">Apply Filters</button>
            </div>


            <button id="add-venue-button" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 mb-6">Add New Venue</button>

            <!-- Placeholder for displaying the list of venues -->
            <div id="venue-list" class="mt-6 space-y-6">
                <p class="text-gray-600 italic">Loading venues...</p>
                <!-- Venue data will be loaded here by JavaScript -->
            </div>


            <!-- Add Venue Modal (Remains the same) -->
            <div id="add-venue-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Venue</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="add-venue-form">
                            <div class="form-group">
                                <label for="venue-title">Title:</label>
                                <input type="text" id="venue-title" required>
                            </div>
                            <div class="form-group">
                                <label for="venue-description">Description (optional):</label>
                                <textarea id="venue-description" rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="venue-address">Address (optional):</label>
                                <input type="text" id="venue-address">
                            </div>
                            <div class="form-group">
                                <label for="venue-suburb">Suburb (optional):</label>
                                <input type="text" id="venue-suburb">
                            </div>
                            <div class="form-group">
                                <label for="venue-state">State (optional):</label>
                                <input type="text" id="venue-state">
                            </div>
                            <div class="form-group">
                                <label for="venue-postcode">Postcode (optional):</label>
                                <input type="text" id="venue-postcode">
                            </div>
                            <div class="form-group">
                                <label for="venue-country">Country (optional):</label>
                                <input type="text" id="venue-country">
                            </div>
                            <div class="form-group">
                                <label for="venue-latitude">Latitude (optional):</label>
                                <input type="text" id="venue-latitude" placeholder="e.g., -33.8688">
                            </div>
                            <div class="form-group">
                                <label for="venue-longitude">Longitude (optional):</label>
                                <input type="text" id="venue-longitude" placeholder="e.g., 151.2093">
                            </div>
                            <div class="form-group">
                                <label for="venue-contact-phone">Contact Phone (optional):</label>
                                <input type="text" id="venue-contact-phone">
                            </div>

                            <div id="create-venue-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-create-venue">Create Venue</button>
                    </div>
                </div>
            </div>

            <!-- Edit Venue Modal (New) -->
            <div id="edit-venue-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Venue</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="edit-venue-form">
                            <input type="hidden" id="edit-venue-id"> <!-- Hidden field for venue ID -->
                            <div class="form-group">
                                <label for="edit-venue-title">Title:</label>
                                <input type="text" id="edit-venue-title" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-description">Description (optional):</label>
                                <textarea id="edit-venue-description" rows="4"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-address">Address (optional):</label>
                                <input type="text" id="edit-venue-address">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-suburb">Suburb (optional):</label>
                                <input type="text" id="edit-venue-suburb">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-state">State (optional):</label>
                                <input type="text" id="edit-venue-state">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-postcode">Postcode (optional):</label>
                                <input type="text" id="edit-venue-postcode">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-country">Country (optional):</label>
                                <input type="text" id="edit-venue-country">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-latitude">Latitude (optional):</label>
                                <input type="text" id="edit-venue-latitude" placeholder="e.g., -33.8688">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-longitude">Longitude (optional):</label>
                                <input type="text" id="edit-venue-longitude" placeholder="e.g., 151.2093">
                            </div>
                            <div class="form-group">
                                <label for="edit-venue-contact-phone">Contact Phone (optional):</label>
                                <input type="text" id="edit-venue-contact-phone">
                            </div>

                            <div id="edit-venue-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-edit-venue">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Section: Styles -->
        <div id="stylesSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Styles Management</h2>
            <p class="text-gray-700 mb-6">Information about different styles.</p>

            <!-- Filter and Sort Controls for Styles -->
            <div class="flex flex-wrap gap-4 mb-6 items-center">
                <div>
                    <label for="style-search" class="block text-sm font-medium text-gray-700">Search:</label>
                    <input type="text" id="style-search" placeholder="Search by name, description..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="style-sort-by" class="block text-sm font-medium text-gray-700">Sort By:</label>
                    <select id="style-sort-by" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <option value="title">Name (A-Z)</option>
                        <!-- Add other sorting options if needed -->
                    </select>
                </div>
                <button id="apply-style-filters-button" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200">Apply Filters</button>
            </div>


            <button id="add-style-button" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 mb-6">Add New Style</button>

            <!-- Placeholder for displaying the list of styles -->
            <div id="style-list" class="mt-6 space-y-6">
                <p class="text-gray-600 italic">Loading styles...</p>
                <!-- Style data will be loaded here by JavaScript -->
            </div>

            <!-- Add Style Modal (Remains the same) -->
            <div id="add-style-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add New Style</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="add-style-form">
                            <div class="form-group">
                                <label for="style-title">Title:</label>
                                <input type="text" id="style-title" required>
                            </div>
                            <div class="form-group">
                                <label for="style-description">Description (optional):</label>
                                <textarea id="style-description" rows="4"></textarea>
                            </div>

                            <div id="create-style-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-create-style">Create Style</button>
                    </div>
                </div>
            </div>

            <!-- Edit Style Modal (New) -->
            <div id="edit-style-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Style</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="edit-style-form">
                            <input type="hidden" id="edit-style-id"> <!-- Hidden field for style ID -->
                            <div class="form-group">
                                <label for="edit-style-title">Title:</label>
                                <input type="text" id="edit-style-title" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-style-description">Description (optional):</label>
                                <textarea id="edit-style-description" rows="4"></textarea>
                            </div>

                            <div id="edit-style-message" class="message text-center"></div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-edit-style">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

         <!-- Section: Waivers -->
        <div id="waiversSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Waiver Management</h2>

            <div id="latest-waiver-display" class="mt-6 p-4 border border-gray-300 rounded-md bg-gray-50">
                <!-- Latest waiver content will be loaded here by JavaScript -->
                <p class="text-gray-600 italic">Loading waiver...</p>
            </div>

            <div id="accept-waiver-area" class="mt-4">
                <!-- Accept button and messages will appear here -->
                <div id="accept-waiver-message" class="message text-center"></div>
                <button id="accept-waiver-button" class="py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 mt-4" style="display: none;">Accept Waiver</button>
            </div>


            <button id="create-waiver-button" class="py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 mt-6" style="display: none;">Create New Waiver</button>

            <!-- Waiver Creation Modal -->
            <div id="create-waiver-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create New Waiver Version</h3>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                         <div class="form-group">
                            <label for="new-waiver-title">Title:</label>
                            <input type="text" id="new-waiver-title" rows="1" placeholder="Enter the new waiver title here...">
                         </div>
                         <div class="form-group">
                            <label for="new-waiver-content">Content:</label>
                            <textarea id="new-waiver-content" rows="15" placeholder="Enter the new waiver content here..."></textarea>
                         </div>
                         <div id="create-waiver-error" class="message"></div>
                    </div>
                    <div class="modal-footer">
                         <button type="button" class="cancel-button">Cancel</button>
                        <button type="button" class="submit-button" id="submit-new-waiver">Submit Waiver</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Locations -->
        <div id="locationsSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Locations</h2>
            <p class="text-gray-700 mb-6">Find gym locations and details.</p>
             <!-- You could potentially fetch and display multiple locations here -->
             <div class="map-section mb-8">
                <p class="text-xl font-semibold text-gray-800 mb-3 text-center">Leura Gym (Example)</p>
                <div class="map-container rounded-lg overflow-hidden shadow-md">
                    <!-- Replace this iframe with the actual OpenStreetMap embed code for your location -->
                     <iframe
                        loading="lazy"
                        width="100%"
                        height="450"
                        frameborder="0"
                        scrolling="no"
                        marginheight="0"
                        marginwidth="0"
                        src="https://www.openstreetmap.org/export/embed.html?bbox=149.5054,-33.3695,150.7585,-33.8664&amp;layer=mapnik&amp;marker=-33.69791913672688, 150.33542282204206"
                        style="border: 1px solid black"
                    ></iframe>
                     <br/><small><a href="https://www.openstreetmap.org/?mlat=-33.7115&amp;mlon=150.3376#map=16/-33.7115/150.3376">View Larger Map</a></small>
                </div>
                 <p class="text-sm text-gray-600 italic mt-2 text-center">Map data  OpenStreetMap contributors.</p>
            </div>
        </div>


        <!-- Section: POS -->
        <div id="posSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Today's Schedule</h2>
            <div id="calendar-container" class="bg-white rounded-lg shadow-sm border">
                <div id="calendar-header" class="bg-gray-50 px-4 py-3 border-b">
                <h3 id="current-date" class="text-lg font-semibold text-gray-900"></h3>
                </div>
                <div id="calendar-body" class="p-4">
                <div id="calendar-grid" class="relative">
                    <div id="time-slots"></div>
                    <div id="events-container" class="absolute top-0 left-0 w-full"></div>
                </div>
                </div>
            </div>
        </div>

        <!-- Attendance Modal -->
        <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gray-50 px-6 py-4 border-b">
                    <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 id="modal-event-title" class="text-xl font-bold text-gray-900"></h3>
                        <p id="modal-event-description" class="text-gray-600 mt-1"></p>
                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                        <span id="modal-event-location"></span>
                        <span id="modal-event-time"></span>
                        </div>
                    </div>
                    <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-2xl">
                        
                    </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6 overflow-auto max-h-[calc(90vh-120px)]">
                    <!-- Search Section -->
                    <div class="mb-6">
                    <div class="relative">
                        <input
                        type="text"
                        id="student-search"
                        placeholder="Search for a student..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                        <div class="absolute right-3 top-3 text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="search-results" class="hidden mt-3 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                    </div>
                    </div>

                    <!-- View Toggle -->
                    <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-900">Class Students</h4>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="list-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">
                        List
                        </button>
                        <button id="grid-view-btn" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                        Grid
                        </button>
                    </div>
                    </div>

                    <!-- Students Display -->
                    <div id="students-container">
                    <div id="students-list-view" class="space-y-2">
                        <!-- List view students will be populated here -->
                    </div>
                    <div id="students-grid-view" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Grid view students will be populated here -->
                    </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <p class="mt-2">Loading students...</p>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Section: Users -->
        <div id="usersSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Users</h2>
            <p class="text-gray-700 mb-6">Allocate user permissions.</p>
            <!-- User listing/management interface goes here -->
             <div id="user-list" class="mt-6 space-y-4">
                  <p class="text-gray-600 italic">Loading users...</p>
             </div>
        </div>

        <!-- Section: Account -->
        <div id="accountSection" class="portal-section">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Account Settings</h2>

            <!-- Profile Update Form -->
            <form id="profileUpdateForm" class="space-y-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Profile</h3>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required readonly disabled
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="first_name">First Name:</label>
                    <input type="text" id="first_name" name="first_name" required maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="surname">Surname:</label>
                    <input type="text" id="surname" name="surname" required maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone" maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="dob">Date of Birth:</label>
                    <input type="date" id="dob" name="dob"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address" maxlength="512"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="suburb">Suburb:</label>
                    <input type="text" id="suburb" name="suburb" maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Emergency Contact</h4>
                 <div class="form-group">
                    <label for="emergency_name">Name:</label>
                    <input type="text" id="emergency_name" name="emergency_name" maxlength="64"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                 <div class="form-group">
                    <label for="emergency_relationship">Relationship:</label>
                    <input type="text"id="emergency_relationship" name="emergency_relationship" maxlength="64"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="emergency_phone">Phone:</label>
             <input type="tel" id="emergency_phone" name="emergency_phone" maxlength="64"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="emergency_medical">Medical Notes:</label>
             <textarea id="emergency_medical" name="emergency_medical" rows="4"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
         </div>
          <h4 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Uniform Details</h4>
          <div class="form-group">
             <label for="belt_size">Belt Size:</label>
             <input type="number" id="belt_size" name="belt_size" min="0" max="100"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="uniform_size">Uniform Size:</label>
             <input type="number" id="uniform_size" name="uniform_size" min="0" max="100"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>

        <div id="readOnlyFields" class="mt-6 space-y-2 text-gray-700 text-sm">
            <p><strong>User ID:</strong> <span id="user_id_display"></span></p>
            <p><strong>Member Number:</strong> <span id="member_number_display"></span></p>
            <p><strong>Joined:</strong> <span id="created_ts_display"></span></p>
            <p><strong>Contracted Until:</strong> <span id="contracted_until_display"></span></p>
            <p><strong>Email Verified:</strong> <span id="email_verified_display"></span></p>
            <p><strong>Waiver ID:</strong> <span id="waiver_id_display"></span></p>
            <p><strong>Photo ID:</strong> <span id="photo_id_display"></span></p>
            <p><strong>Stripe Payment Method ID:</strong> <span id="stripe_payment_method_id_display"></span></p>
        </div>


         <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Update Profile</button>
          <div id="profileStatusMessage" class="mt-4 text-center text-gray-700"></div>
     </form>

     <hr class="my-8 border-gray-300"> <!-- Separator -->

    <!-- Stripe card section -->
    <div class="mt-8 p-6 bg-gray-50 rounded-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Payment Method</h3>
        
        <form id="stripe-card-form" class="space-y-4">
            <div class="form-group">
                <label for="stripe-cardholder-name" class="block text-sm font-medium text-gray-700">Cardholder Name</label>
                <input type="text" id="stripe-cardholder-name" placeholder="John Doe" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            </div>
            
            <div class="form-group">
                <label for="card-element" class="block text-sm font-medium text-gray-700">Card Details</label>
                <div id="card-element" class="mt-1 p-3 border border-gray-300 rounded-md shadow-sm bg-white">
                    <!-- Stripe Elements will create form elements here -->
                </div>
                <div id="card-errors" role="alert" class="mt-2 text-sm text-red-600"></div>
            </div>
            
            <button type="submit" id="stripe-submit-btn" 
                    class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Save Payment Method
            </button>
        </form>
        
        <div id="stripe-loading" class="hidden mt-4 text-center">
            <p class="text-gray-600">Processing...</p>
        </div>
        
        <div id="stripe-result" class="mt-4"></div>
        
        <div class="mt-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">Saved Payment Methods</h4>
            <div id="saved-cards-list" class="space-y-2">
                <p class="text-gray-600">Loading saved cards...</p>
            </div>
            <button type="button" id="refresh-cards" 
                    class="mt-3 py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Refresh Cards
            </button>
        </div>
    </div>

    <hr class="my-8 border-gray-300"> <!-- Separator -->

     <!-- Change Password Form -->
     <form id="passwordChangeForm" class="space-y-6">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Change Password</h3>
          <div class="form-group">
             <label for="currentPassword">Current Password:</label>
             <input type="password" id="currentPassword" name="current_password" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
             <label for="newPassword">New Password:</label>
             <input type="password" id="newPassword" name="new_password" required
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
         </div>
          <div class="form-group">
              <label for="confirmNewPassword">Confirm New Password:</label>
              <input type="password" id="confirmNewPassword" name="confirm_new_password" required
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
          </div>

          <button type="submit" class="w-full py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Change Password</button>
          <div id="passwordStatusMessage" class="mt-4 text-center text-gray-700"></div>
     </form>

    </div> 
    <!-- Account section -- END -->

 <!-- Add more sections as needed -->
</div>

<footer class="mt-auto text-center py-4 text-gray-600 text-sm">
 <p>&copy; 2025 MMA Gym Management</p>
</footer>



    <script>

        const Permissions = {
            HyperAdmin: 0,
            SuperAdmin: 1,
            CreateSuperAdmin: 2,
            RemoveSuperAdmin: 3,
            CreateClass: 4,
            ModifyClass: 5,
            RemoveClass: 6,
            InstructClass: 7,
            ViewClass: 8,
            CreateClub: 9,
            ViewClub: 10,
            ModifyClub: 11,
            RemoveClub: 12,
            CreateWaiver: 13,
            AddStudent: 14,
            RemoveStudent: 15,
            ViewStudent: 16,
            ModifyStudent: 17,
            SendEmail: 18,
            CreateInstructor: 19,
            ModifyInstructor: 20,
            RemoveInstructor: 21,
            ViewInstructor: 22,
            CreateGrading: 23,
            ModifyGrading: 24,
            RemoveGrading: 25,
            ViewGrading: 26,
            RefundPayment: 27,
            DiscountStudent: 28,
            CreateDiscount: 29,
            ModifyDiscount: 30,
            RemoveDiscount: 31,
            Banned: 32,
            // Add any new permissions here, continuing the sequence
        };

        var cached_data = {};

        function add_cached_value(key_type, key, value) {
            key = key_type.toString() + "_" + key.toString(); // Ensure the key is a string
            value.cache_ts = Date.now();
            // console.log("Adding to cache:", key, value);
            cached_data[key] = value;
        }

        function get_cached_value(key_type, key) {
            key = key_type.toString() + "_" + key.toString(); // Ensure the key is a string

            if (cached_data[key] === undefined) {
                return null;
            }
            if (Date.now() - cached_data[key].cache_ts > 1000 * 60 * 5) { // 5 minutes
                delete cached_data[key];
                return null;
            }
            return cached_data[key];
        }


        /**
         * Checks if a user has a specific permission.
         * @param {number[]} userPermissionIntegers - An array of integers representing the user's permissions received from the backend.
         * @param {number} requiredPermission - The integer value of the permission you want to check for (e.g., Permissions.CreateWaiver).
         * @returns {boolean} - True if the user has the required permission, false otherwise.
         */
        function hasPermission(userPermissionIntegers, requiredPermissions) {
            if (!Array.isArray(requiredPermissions)) {
                console.error("requiredPermissions is not an array.");
                return false;
            }
            for (const requiredPermission of requiredPermissions) {

                // Ensure userPermissionIntegers is a valid array
                if (!Array.isArray(userPermissionIntegers)) {
                    console.error("userPermissionIntegers is not an array.");
                    return false;
                }
                if (requiredPermission === undefined) {
                    console.error("requiredPermission is undefined.");
                    return false;
                }
                if (typeof requiredPermission !== 'number') {
                    console.error("requiredPermission is not a number.");
                    return false;
                }
                if (userPermissionIntegers.length === 0) {
                    console.warn("userPermissionIntegers is empty.");
                    return false;
                }
                if (userPermissionIntegers.includes(Permissions.Banned)) {
                    console.warn("User is banned.");
                    return false;
                }
                if (userPermissionIntegers.includes(Permissions.HyperAdmin)) {
                    return true; // HyperAdmin has all permissions
                }
                if (userPermissionIntegers.includes(Permissions.SuperAdmin) && requiredPermission !== Permissions.CreateSuperAdmin && requiredPermission !== Permissions.RemoveSuperAdmin) {
                    return true; // SuperAdmin has all permissions
                }
                // Check if the required permission integer exists in the user's permissions array
                if (userPermissionIntegers.includes(requiredPermission)) {
                    return true; // User has the required permission
                }
            }
            return false; // Default to false if no permissions matched
        }




        // Helper function to display messages
        function displayMessage(element, message, isSuccess) {
            element.textContent = message;
            element.style.color = isSuccess ? 'green' : 'red';
        }

         // Basic email format validation (simple check)
         function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Basic phone number validation (allows numbers, +, -, spaces, parens)
         function isValidPhoneNumber(phone) {
            const phoneRegex = /^[\d\s\-\(\)\+]+$/;
            return phoneRegex.test(phone);
        }

        // Basic name validation (allows letters, spaces, hyphens) - adjust regex for international names if needed
         function isValidName(name) {
             const nameRegex = /^[a-zA-Z\s-]+$/;
             return nameRegex.test(name);
         }

        // Get elements related to accepting the waiver
        const acceptWaiverButton = document.getElementById('accept-waiver-button');
        const acceptWaiverMessageDiv = document.getElementById('accept-waiver-message');

        // Function to fetch and display the latest waiver
        async function fetchLatestWaiver() {
            const waiverDisplay = document.getElementById('latest-waiver-display');
            waiverDisplay.innerHTML = '<p>Loading waiver...</p>'; // Show loading state
            acceptWaiverButton.style.display = 'none'; // Hide button while loading
            acceptWaiverMessageDiv.textContent = ''; // Clear previous messages
            acceptWaiverMessageDiv.className = '';


            try {
                const response = await fetch('/api/waiver/get_latest_waiver', {
                    method: 'GET',
                });

                if (response.ok) { // Status 200-299
                    const waiverData = await response.json();
                    // Store the waiver ID just in case you need it later, though not displayed
                    waiverDisplay.dataset.waiverId = waiverData.waiver_id;
                    waiverDisplay.innerHTML = `
                        <p><strong>Latest Waiver Version:</strong></p>
                        <div style="border: 1px dashed #ccc; padding: 10px; max-height: 300px; overflow-y: auto;">
                            <pre>${waiverData.waiver}</pre> <!-- Use pre for preformatted text -->
                        </div>
                    `;

                    // Show the accept button if a waiver was found
                    acceptWaiverButton.style.display = 'block';
                } else if (response.status === 404) {
                     // No active waiver found
                     waiverDisplay.innerHTML = '<p>No current waiver has been published yet.</p>';
                     acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
                }
                 else if (response.status === 401 || response.status === 403) {
                     // Authentication/Authorization error
                      waiverDisplay.innerHTML = '<p style="color: red;">Error: You are not authorized to view waiver information.</p>';
                      console.error("Authorization error fetching waiver:", response.status);
                      acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
                 }
                 else {
                    // Other server errors (5xx) or client errors (4xx)
                    const errorText = await response.text();
                    waiverDisplay.innerHTML = `<p style="color: red;">Error loading waiver: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                    console.error("Error fetching waiver:", response.status, errorText);
                    acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
                }
            } catch (error) {
                // Network errors etc.
                waiverDisplay.innerHTML = `<p style="color: red;">Network error loading waiver.</p>`;
                console.error("Fetch error for waiver:", error);
                acceptWaiverButton.style.display = 'none'; // Ensure button is hidden
            }
        }


        // --- Accept Waiver Logic ---

        // Event listener for the Accept button
        acceptWaiverButton.addEventListener('click', async () => {
            const waiverId = document.getElementById('latest-waiver-display').dataset.waiverId;

             if (!waiverId) {
                 acceptWaiverMessageDiv.textContent = 'Error: Could not determine waiver ID to accept.';
                 acceptWaiverMessageDiv.className = 'error';
                 console.error("Waiver ID data attribute missing.");
                 return;
             }

             // Optional: Disable button and show loading state
             acceptWaiverButton.disabled = true;
             acceptWaiverMessageDiv.textContent = 'Submitting acceptance...';
             acceptWaiverMessageDiv.className = ''; // Clear previous classes


            try {
                 const response = await fetch('/api/user/accept_waiver', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                        //  'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify({ waiver_id: waiverId })
                 });

                 const responseData = await response.json(); // Assuming response is JSON


                 if (response.ok && responseData.success) { // Check both HTTP status and custom success flag

                     acceptWaiverMessageDiv.textContent = 'Waiver accepted successfully!';
                     acceptWaiverMessageDiv.className = 'success';
                     acceptWaiverButton.style.display = 'none'; // Hide the button on success
                     // Optional: You might want to update the user's local state here
                     // or refetch the user profile to show the waiver_id is now set.
                 } else if (responseData && responseData.error_message) {
                     // Server returned a specific error message in the JSON body
                     acceptWaiverMessageDiv.textContent = `Acceptance failed: ${responseData.error_message}`;
                     acceptWaiverMessageDiv.className = 'error';
                     console.error("Server error accepting waiver:", response.status, responseData.error_message);
                 }
                  else if (response.status === 401 || response.status === 403) {
                     // Authentication/Authorization error
                      acceptWaiverMessageDiv.textContent = 'Error: You are not authorized to accept waivers.';
                      acceptWaiverMessageDiv.className = 'error';
                      console.error("Authorization error accepting waiver:", response.status);
                 }
                  else if (response.status === 409) { // Conflict (e.g., outdated waiver)
                       acceptWaiverMessageDiv.textContent = responseData.error_message || 'Waiver version is outdated. Please refresh.';
                       acceptWaiverMessageDiv.className = 'error';
                       console.warn("Conflict accepting waiver:", response.status, responseData.error_message);
                        // Consider prompting user to refresh or automatically refreshing the waiver display
                        fetchLatestWaiver();
                  }
                 else {
                     // Other errors
                      const errorText = await response.text();
                      acceptWaiverMessageDiv.textContent = `Error accepting waiver: ${response.status} - ${errorText.substring(0, 100)}...`;
                      acceptWaiverMessageDiv.className = 'error';
                      console.error("Error accepting waiver:", response.status, errorText);
                 }

            } catch (error) {
                 // Network errors etc.
                 acceptWaiverMessageDiv.textContent = 'Network error submitting waiver acceptance.';
                 acceptWaiverMessageDiv.className = 'error';
                 console.error("Fetch error for waiver acceptance:", error);
            } finally {
                 // Re-enable button regardless of success/failure, unless hidden
                 if (acceptWaiverButton.style.display !== 'none') {
                     acceptWaiverButton.disabled = false;
                 }
            }
        });


    
        let userPermissions = [0]; // This should be set when the user logs in or is fetched from the server

        // Get modal elements
        const createWaiverModal = document.getElementById('create-waiver-modal');
        const createWaiverButton = document.getElementById('create-waiver-button');
        const closeButton = createWaiverModal.querySelector('.close-button');
        const submitWaiverButton = document.getElementById('submit-new-waiver');
        const newWaiverContentTitle = document.getElementById('new-waiver-title');
        const newWaiverContentArea = document.getElementById('new-waiver-content');
        const createWaiverErrorDiv = document.getElementById('create-waiver-error');

        if (hasPermission(userPermissions, [Permissions.CreateWaiver])) {
            createWaiverButton.style.display = 'block'; // Show button if user has permission
        } else {
            createWaiverButton.style.display = 'none'; // Hide button if no permission
        }

        const usersNav = document.getElementById('users-nav');
        if (hasPermission(userPermissions, [Permissions.CreateSuperAdmin, Permissions.RemoveSuperAdmin, Permissions.ViewInstructor, Permissions.CreateInstructor, Permissions.ModifyInstructor, Permissions.RemoveInstructor, Permissions.ViewStudent, Permissions.AddStudent, Permissions.RemoveStudent, Permissions.ModifyStudent])) {
            usersNav.style.display = 'block'; // Show button if user has permission
        } else {
            usersNav.style.display = 'none'; // Hide button if no permission
        }

        // Open the modal
        createWaiverButton.onclick = function() {
            createWaiverModal.style.display = 'block';
             createWaiverErrorDiv.textContent = ''; // Clear previous errors
             newWaiverContentArea.value = ''; // Clear previous content
             newWaiverContentTitle.value = ''; // Clear previous title
        }

        // Close the modal using the close button
        closeButton.onclick = function() {
            createWaiverModal.style.display = 'none';
        }

        // Close the modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == createWaiverModal) {
                createWaiverModal.style.display = 'none';
            }
        }

        // Submit the new waiver
        submitWaiverButton.onclick = async function() {
            const waiverContent = newWaiverContentArea.value.trim(); // Trim whitespace
            const waiverTitle = newWaiverContentTitle.value.trim(); // Trim whitespace

            if (!waiverContent) {
                createWaiverErrorDiv.textContent = 'Waiver content cannot be empty.';
                return;
            }

            if (!waiverTitle) {
                createWaiverErrorDiv.textContent = 'Waiver title cannot be empty.';
                return;
            }

             createWaiverErrorDiv.textContent = 'Submitting...'; // Show submitting state

             try {
                 const response = await fetch('/api/waiver/create', { // *** You'll need to implement this backend endpoint ***
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                        //  'Authorization': `Bearer ${token}`
                     },
                     body: JSON.stringify({ content: waiverContent, title: waiverTitle }) 
                 });

                 const responseData = await response.json(); // Assuming the response is JSON

                 if (response.ok) { // Status 200-299
                     console.log("Waiver created successfully:", responseData);
                     createWaiverModal.style.display = 'none'; // Hide modal on success
                     newWaiverContentArea.value = ''; // Clear the text area
                     fetchLatestWaiver(); // Refresh the displayed waiver
                 } else if (responseData && responseData.error_message) {
                      // Server returned a specific error message in the JSON body
                      createWaiverErrorDiv.textContent = `Error: ${responseData.error_message}`;
                      console.error("Server error creating waiver:", response.status, responseData.error_message);
                 }
                  else if (response.status === 401 || response.status === 403) {
                     // Authentication/Authorization error
                      createWaiverErrorDiv.textContent = 'Error: You are not authorized to create waivers.';
                      console.error("Authorization error creating waiver:", response.status);
                 }
                 else {
                     // Other errors
                      const errorText = await response.text(); // Try to get any response text
                      createWaiverErrorDiv.textContent = `Error creating waiver: ${response.status} - ${errorText.substring(0, 100)}...`;
                      console.error("Error creating waiver:", response.status, errorText);
                 }

             } catch (error) {
                 // Network errors etc.
                 createWaiverErrorDiv.textContent = 'Network error submitting waiver.';
                 console.error("Fetch error for waiver creation:", error);
             }
        }





        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            const sections = document.querySelectorAll('.portal-section');
            const navLinks = document.querySelectorAll('nav ul li a[data-section]');
            const logoutLink = document.getElementById('logoutLink');

            // Get form elements and message divs
            const profileUpdateForm = document.getElementById('profileUpdateForm');
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            const profileStatusMessageDiv = document.getElementById('profileStatusMessage');
            const passwordStatusMessageDiv = document.getElementById('passwordStatusMessage');

            // Get profile input fields by ID
            const profileFields = {
                email: document.getElementById('email'),
                first_name: document.getElementById('first_name'),
                surname: document.getElementById('surname'),
                gender: document.getElementById('gender'), // This is now a select
                phone: document.getElementById('phone'),
                dob: document.getElementById('dob'), // This is now type="date"
                address: document.getElementById('address'),
                suburb: document.getElementById('suburb'),
                emergency_name: document.getElementById('emergency_name'),
                emergency_relationship: document.getElementById('emergency_relationship'),
                emergency_phone: document.getElementById('emergency_phone'),
                emergency_medical: document.getElementById('emergency_medical'), // Textarea
                belt_size: document.getElementById('belt_size'), // This is now type="number"
                uniform_size: document.getElementById('uniform_size'), // This is now type="number"

                 // Read-only display spans (add user_id)
                user_id_display: document.getElementById('user_id_display'),
                member_number_display: document.getElementById('member_number_display'),
                created_ts_display: document.getElementById('created_ts_display'),
                contracted_until_display: document.getElementById('contracted_until_display'),
                email_verified_display: document.getElementById('email_verified_display'),
                waiver_id_display: document.getElementById('waiver_id_display'),
                photo_id_display: document.getElementById('photo_id_display'),
                stripe_payment_method_id_display: document.getElementById('stripe_payment_method_id_display'),
            };

            // Get password change fields
            const currentPasswordField = document.getElementById('currentPassword');
            const newPasswordField = document.getElementById('newPassword');
            const confirmNewPasswordField = document.getElementById('confirmNewPassword');


            // --- Section Switching Logic (Remains the same) ---
            function showSection(sectionId) {
                sections.forEach(section => {
                    if (section.id === sectionId + 'Section') {
                        section.style.display = 'block'; // Or 'flex'
                    } else {
                        section.style.display = 'none';
                    }
                });

                navLinks.forEach(link => {
                    if (link.getAttribute('data-section') === sectionId) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                history.pushState(null, '', `#${sectionId}`);

                if (sectionId === 'classes') {
                    fetchAndDisplayClasses(); // Fetch and display classes when this section is shown
                }
                if (sectionId === 'venues') {
                    fetchAndDisplayVenues(); // Fetch and display venues when this section is shown
                }
                if (sectionId === 'styles') {
                    fetchAndDisplayStyles();
                }
                if (sectionId === 'pos') {
                    fetchAndDisplayPOS();
                }
                 // --- Load profile data when Account section is shown ---
                 if (sectionId === 'account') {
                     loadUserProfile();
                 } else {
                     // Optional: Clear forms when leaving the section
                     profileUpdateForm.reset();
                     passwordChangeForm.reset();
                     profileStatusMessageDiv.textContent = '';
                     passwordStatusMessageDiv.textContent = '';
                 }

                 if (sectionId === 'waivers') {
                     fetchLatestWaiver(); // Load the latest waiver when this section is shown
                 }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const sectionId = link.getAttribute('data-section');
                    showSection(sectionId);
                });
            });


            // --- Load User Profile Data ---
            async function loadUserProfile() {
                displayMessage(profileStatusMessageDiv, 'Loading profile...', false);
                try {
                     const response = await fetch('/api/user/profile_data', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    // Check if response is OK (status 2xx)
                    if (!response.ok) {
                        // If not OK, it might be 401 Unauthorized if session expired
                        if (response.status === 401) {
                            console.warn('Session expired while loading profile.');
                            alert('Your session has expired. Please log in again.');
                            window.location.href = '/#login'; // Redirect to login
                            return; // Stop further processing
                        }
                         // Handle other non-OK statuses
                        const errorResult = await response.json(); // Try to parse JSON error
                        console.error('Failed to load profile (HTTP error):', response.status, errorResult);
                        displayMessage(profileStatusMessageDiv, errorResult.error_message || `HTTP error ${response.status}`, false);
                        return; // Stop further processing
                    }


                    const result = await response.json();

                    if (result.success && result.user_profile) {
                        const profile = result.user_profile;

                        // Populate form fields
                        profileFields.email.value = profile.email; // Email (read-only)
                        profileFields.first_name.value = profile.first_name || '';
                        profileFields.surname.value = profile.surname || '';
                        profileFields.gender.value = profile.gender || ''; // Set select value
                        profileFields.phone.value = profile.phone || '';
                        profileFields.dob.value = profile.dob || ''; // YYYY-MM-DD format from backend expected by input[type="date"]
                        profileFields.address.value = profile.address || '';
                        profileFields.suburb.value = profile.suburb || '';
                        profileFields.emergency_name.value = profile.emergency_name || '';
                        profileFields.emergency_relationship.value = profile.emergency_relationship || '';
                        profileFields.emergency_phone.value = profile.emergency_phone || '';
                        profileFields.emergency_medical.value = profile.emergency_medical || ''; // Textarea
                         // Handle number inputs - ensure they are numbers or empty strings
                        profileFields.belt_size.value = profile.belt_size !== null && profile.belt_size !== undefined ? profile.belt_size : '';
                        profileFields.uniform_size.value = profile.uniform_size !== null && profile.uniform_size !== undefined ? profile.uniform_size : '';


                         // Populate read-only display spans
                         profileFields.user_id_display.textContent = profile.user_id || 'N/A'; // Display User ID
                         profileFields.member_number_display.textContent = profile.member_number || 'N/A';
                         // Format timestamp for display (simple example)
                         profileFields.created_ts_display.textContent = profile.created_ts ? new Date(profile.created_ts * 1000).toLocaleDateString() : 'N/A';
                         profileFields.contracted_until_display.textContent = profile.contracted_until ? new Date(profile.contracted_until * 1000).toLocaleDateString() : 'N/A';
                         profileFields.email_verified_display.textContent = profile.email_verified ? 'Yes' : 'No';
                         profileFields.waiver_id_display.textContent = profile.waiver_id || 'N/A';
                         profileFields.photo_id_display.textContent = profile.photo_id || 'N/A';
                         profileFields.stripe_payment_method_id_display.textContent = profile.stripe_payment_method_id || 'N/A';


                        displayMessage(profileStatusMessageDiv, 'Profile loaded.', true);
                    } else {
                         console.error('Failed to load profile:', result.error_message);
                         displayMessage(profileStatusMessageDiv, result.error_message || 'Failed to load profile.', false);
                    }

                } catch (error) {
                    console.error('Fetch error loading profile:', error);
                    displayMessage(profileStatusMessageDiv, 'Failed to connect to the server to load profile.', false);
                }
            }


            // --- Handle Profile Update Submission ---
            profileUpdateForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                displayMessage(profileStatusMessageDiv, 'Saving profile...', false);
                profileStatusMessageDiv.style.color = 'gray';

                // --- Client-side Validation ---
                if (profileFields.first_name.value.length === 0 || profileFields.surname.value.length === 0) {
                     displayMessage(profileStatusMessageDiv, 'First name and Surname are required.', false);
                     return;
                }
                 // Check max lengths (already handled by HTML maxlength, but double-checking here for consistency)
                 if (profileFields.first_name.value.length > 64 || profileFields.surname.value.length > 64 || profileFields.gender.value.length > 64 ||
                     profileFields.phone.value.length > 64 || profileFields.suburb.value.length > 64 || profileFields.emergency_name.value.length > 64 ||
                     profileFields.emergency_relationship.value.length > 64 || profileFields.emergency_phone.value.length > 64 || profileFields.belt_size.value.length > 64 ||
                     profileFields.uniform_size.value.length > 64)
                 {
                      displayMessage(profileStatusMessageDiv, 'Maximum length for most fields is 64 characters.', false);
                      return;
                 }
                 if (profileFields.address.value.length > 512) {
                     displayMessage(profileStatusMessageDiv, 'Maximum length for Address is 512 characters.', false);
                     return;
                 }
                // Basic format validation
                 if (profileFields.phone.value && !isValidPhoneNumber(profileFields.phone.value)) {
                     displayMessage(profileStatusMessageDiv, 'Please enter a valid phone number format.', false);
                     return;
                 }
                // Add more format validation for names, etc. if desired, but be cautious with international characters.

                 // Validate number inputs (type="number" helps, but value might be empty or invalid)
                 var beltSizeValue = profileFields.belt_size.value;
                 if (beltSizeValue !== '') { // Only validate if not empty
                    const numBeltSize = parseInt(beltSizeValue, 10);
                     if (isNaN(numBeltSize) || numBeltSize < 0 || numBeltSize > 100 || beltSizeValue.includes('.')) { // Also check for decimals
                         displayMessage(profileStatusMessageDiv, 'Belt Size must be an integer between 0 and 100.', false);
                         return;
                    }
                    beltSizeValue = beltSizeValue.toString(); // Convert to string for consistency
                 }
                 const uniformSizeValue = profileFields.uniform_size.value;
                 if (uniformSizeValue !== '') { // Only validate if not empty
                     const numUniformSize = parseInt(uniformSizeValue, 10);
                     if (isNaN(numUniformSize) || numUniformSize < 0 || numUniformSize > 100 || uniformSizeValue.includes('.')) { // Also check for decimals
                         displayMessage(profileStatusMessageDiv, 'Uniform Size must be an integer between 0 and 100.', false);
                         return;
                     }
                 }
                // End Client-side Validation ---


                // Collect data from the form fields matching UpdateUserProfileRequest
                const updateData = {
                     first_name: profileFields.first_name.value,
                     surname: profileFields.surname.value,
                     gender: profileFields.gender.value || null,
                     phone: profileFields.phone.value || null,
                     dob: profileFields.dob.value || null, // type="date" gives YYYY-MM-DD string or "" if empty
                     address: profileFields.address.value || null,
                     suburb: profileFields.suburb.value || null,
                     emergency_name: profileFields.emergency_name.value || null,
                     emergency_relationship: profileFields.emergency_relationship.value || null,
                     emergency_phone: profileFields.emergency_phone.value || null,
                     emergency_medical: profileFields.emergency_medical.value || null, // Send "" if empty, convert to null if needed backend
                     belt_size: profileFields.belt_size.value || null, // Send number string or null if empty
                     uniform_size: profileFields.uniform_size.value || null, // Send number string or null if empty
                };
                 // Convert number strings to numbers if they are not empty strings or null
                //  if (updateData.belt_size !== null) updateData.belt_size = parseInt(updateData.belt_size, 10);
                //  if (updateData.uniform_size !== null) updateData.uniform_size = parseInt(updateData.uniform_size, 10);


                try {
                     const response = await fetch('/api/user/update_profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });

                    // Check if response is OK
                     if (!response.ok) {
                         if (response.status === 401) {
                            console.warn('Session expired while updating profile.');
                            alert('Your session has expired. Please log in again.');
                            window.location.href = '/#login';
                            return;
                        }
                         const errorResult = await response.json();
                         console.error('Profile update failed (HTTP error):', response.status, errorResult);
                         displayMessage(profileStatusMessageDiv, errorResult.error_message || `HTTP error ${response.status}`, false);
                         return;
                     }

                    const result = await response.json();

                    if (result.success) {
                        console.log('Profile updated successfully.');
                        displayMessage(profileStatusMessageDiv, 'Profile updated successfully!', true);
                    } else {
                         console.error('Profile update failed:', result.error_message);
                         displayMessage(profileStatusMessageDiv, result.error_message || 'Failed to update profile.', false);
                    }

                } catch (error) {
                    console.error('Fetch error updating profile:', error);
                    displayMessage(profileStatusMessageDiv, 'Failed to connect to the server to update profile.', false);
                }
            });

            // --- Handle Password Change Submission ---
             passwordChangeForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                displayMessage(passwordStatusMessageDiv, 'Changing password...', false);
                passwordStatusMessageDiv.style.color = 'gray';

                const currentPassword = currentPasswordField.value;
                const newPassword = newPasswordField.value;
                const confirmNewPassword = confirmNewPasswordField.value;

                 // --- Client-side Validation ---
                 if (!currentPassword || !newPassword || !confirmNewPassword) {
                      displayMessage(passwordStatusMessageDiv, 'All password fields are required.', false);
                      return;
                 }
                 if (newPassword !== confirmNewPassword) {
                     displayMessage(passwordStatusMessageDiv, 'New Password and Confirm New Password must match.', false);
                     // Clear both new password fields
                     newPasswordField.value = '';
                     confirmNewPasswordField.value = '';
                     return;
                 }
                 if (currentPassword === newPassword) {
                     displayMessage(passwordStatusMessageDiv, 'New password cannot be the same as the current password.', false);
                     // Clear new password fields
                     newPasswordField.value = '';
                     confirmNewPasswordField.value = '';
                     return;
                 }
                 // Add more validation (e.g., minimum password length, complexity)
                 if (newPassword.length < 8) { // Example minimum length
                      displayMessage(passwordStatusMessageDiv, 'New password must be at least 8 characters long.', false);
                      // Clear new password fields
                       newPasswordField.value = '';
                       confirmNewPasswordField.value = '';
                      return;
                 }
                 // End Client-side Validation ---


                const passwordData = {
                    current_password: currentPassword,
                    new_password: newPassword
                };

                try {
                    const response = await fetch('/api/user/change_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(passwordData)
                    });

                    // Check if response is OK
                     if (!response.ok) {
                         if (response.status === 401) {
                            // This could be session expired OR incorrect current password (if backend sends 401 for both)
                            const errorResult = await response.json(); // Try to parse JSON error
                             console.error('Password change failed (HTTP 401):', errorResult);
                             // Check if the error message indicates incorrect password (based on your backend)
                             if (errorResult.error_message && errorResult.error_message.includes('Incorrect current password')) {
                                  displayMessage(passwordStatusMessageDiv, 'Incorrect current password.', false);
                             } else {
                                  // Assume session expired or other auth issue
                                  console.warn('Session expired during password change or other authentication issue.');
                                  alert('Your session has expired or there was an authentication issue. Please log in again.');
                                  window.location.href = '/#login';
                             }
                            currentPasswordField.value = ''; // Always clear current password on 401
                             newPasswordField.value = '';
                             confirmNewPasswordField.value = '';
                             return;
                         }
                         // Handle other non-OK statuses
                         const errorResult = await response.json(); // Try to parse JSON error
                         console.error('Password change failed (HTTP error):', response.status, errorResult);
                         displayMessage(passwordStatusMessageDiv, errorResult.error_message || `HTTP error ${response.status}`, false);
                         // Optionally clear password fields on other failures
                         currentPasswordField.value = '';
                         newPasswordField.value = '';
                         confirmNewPasswordField.value = '';
                         return;
                     }


                    const result = await response.json();

                    if (result.success) {
                        console.log('Password changed successfully.');
                        displayMessage(passwordStatusMessageDiv, 'Password changed successfully!', true);
                        // Clear password fields on success
                        currentPasswordField.value = '';
                        newPasswordField.value = '';
                        confirmNewPasswordField.value = '';
                    } else {
                        console.error('Password change failed:', result.error_message);
                         displayMessage(passwordStatusMessageDiv, result.error_message || 'Failed to change password.', false);
                         // Optionally clear current password field on failure for security
                         currentPasswordField.value = '';
                    }

                } catch (error) {
                     console.error('Fetch error changing password:', error);
                     displayMessage(passwordStatusMessageDiv, 'Failed to connect to the server to change password.', false);
                }
            });

            // --- Handle Logout Link Click (Existing Logic) ---
            logoutLink.addEventListener('click', async (event) => {
                event.preventDefault();

                try {
                    const response = await fetch('/api/user/logout', { method: 'POST' });

                    // Check if response is OK
                    if (!response.ok) {
                         // Even logout might return non-OK (e.g., if session was already invalid)
                         console.warn('Logout response not OK:', response.status);
                         // We can still proceed to login page in most cases
                    }

                    console.log('Logout attempt finished, redirecting...');
                    window.location.href = '/#login'; // Always redirect to login after logout attempt

                } catch (error) {
                    console.error('Fetch error during logout:', error);
                     alert('Failed to connect to the server for logout. Attempting redirect.');
                     window.location.href = '/#login'; // Redirect even on fetch error
                }
            });




            // handleClassSection();


            // --- Venue Section Logic ---
            const addVenueButton = document.getElementById('add-venue-button');
            const addVenueModal = document.getElementById('add-venue-modal');
            const addVenueForm = document.getElementById('add-venue-form');
            const submitCreateVenueButton = document.getElementById('submit-create-venue');
            const createVenueMessageDiv = document.getElementById('create-venue-message');
            const venueListDiv = document.getElementById('venue-list'); // Assuming this exists in your HTML

            // Filter and Sort Elements for Venues
            const venueSearchInput = document.getElementById('venue-search');
            const venueSortBySelect = document.getElementById('venue-sort-by');
            const applyVenueFiltersButton = document.getElementById('apply-venue-filters-button');

            // Edit Venue Modal Elements
            const editVenueModal = document.getElementById('edit-venue-modal');
            const editVenueForm = document.getElementById('edit-venue-form');
            const submitEditVenueButton = document.getElementById('submit-edit-venue');
            const editVenueIdInput = document.getElementById('edit-venue-id');
            const editVenueTitleInput = document.getElementById('edit-venue-title');
            const editVenueDescriptionInput = document.getElementById('edit-venue-description');
            const editVenueAddressInput = document.getElementById('edit-venue-address');
            const editVenueSuburbInput = document.getElementById('edit-venue-suburb');
            const editVenueStateInput = document.getElementById('edit-venue-state');
            const editVenuePostcodeInput = document.getElementById('edit-venue-postcode');
            const editVenueCountryInput = document.getElementById('edit-venue-country');
            const editVenueLatitudeInput = document.getElementById('edit-venue-latitude');
            const editVenueLongitudeInput = document.getElementById('edit-venue-longitude');
            const editVenueContactPhoneInput = document.getElementById('edit-venue-contact-phone');
            const editVenueMessageDiv = document.getElementById('edit-venue-message');


            // Open Add Venue Modal
            addVenueButton.addEventListener('click', () => {
                addVenueModal.style.display = 'block';
                createVenueMessageDiv.textContent = '';
                createVenueMessageDiv.className = 'message text-center';
                createVenueMessageDiv.style.display = 'none';
                addVenueForm.reset();
            });


            // Close the Add Venue modal using close buttons (X and Cancel)
            // addVenueModalCloseButtons.forEach(button => {
            //     button.onclick = function() {
            //         addVenueModal.style.display = 'none';
            //     }
            // });

            // Close modals when clicking outside of them (Updated to handle multiple modals)
            // This function should already exist and handle multiple modals,
            // just ensure 'addVenueModal' is included in its checks.
            // window.onclick = function(event) { ... }


            // Submit Create Venue Form
            submitCreateVenueButton.addEventListener('click', async () => {
                 createVenueMessageDiv.style.display = 'none';
                 createVenueMessageDiv.textContent = '';
                 createVenueMessageDiv.className = 'message text-center';
                 submitCreateVenueButton.disabled = true;

                 const title = document.getElementById('venue-title').value.trim();
                 const description = document.getElementById('venue-description').value.trim();
                 const address = document.getElementById('venue-address').value.trim();
                 const suburb = document.getElementById('venue-suburb').value.trim();
                 const state = document.getElementById('venue-state').value.trim();
                 const postcode = document.getElementById('venue-postcode').value.trim();
                 const country = document.getElementById('venue-country').value.trim();
                 const latitudeString = document.getElementById('venue-latitude').value.trim();
                 const longitudeString = document.getElementById('venue-longitude').value.trim();
                 const contactPhone = document.getElementById('venue-contact-phone').value.trim();

                 if (!title) {
                     displayMessage(createVenueMessageDiv, 'Title is required.', 'error');
                     submitCreateVenueButton.disabled = false;
                     return;
                 }

                 const formattedDescription = description === '' ? null : description;
                 const formattedAddress = address === '' ? null : address;
                 const formattedSuburb = suburb === '' ? null : suburb;
                 const formattedState = state === '' ? null : state;
                 const formattedPostcode = postcode === '' ? null : postcode;
                 const formattedCountry = country === '' ? null : country;
                 const formattedContactPhone = contactPhone === '' ? null : contactPhone;

                 const latitude = latitudeString === '' ? null : latitudeString;
                 const longitude = longitudeString === '' ? null : longitudeString;

                 if (latitude !== null && isNaN(parseFloat(latitude))) {
                     displayMessage(createVenueMessageDiv, 'Invalid Latitude format. Must be a number.', 'error');
                     submitCreateVenueButton.disabled = false;
                     return;
                 }
                 if (longitude !== null && isNaN(parseFloat(longitude))) {
                     displayMessage(createVenueMessageDiv, 'Invalid Longitude format. Must be a number.', 'error');
                     submitCreateVenueButton.disabled = false;
                     return;
                 }


                 const requestBody = {
                     title: title,
                     description: formattedDescription,
                     address: formattedAddress,
                     suburb: formattedSuburb,
                     state: formattedState,
                     postcode: formattedPostcode,
                     country: formattedCountry,
                     latitude: latitude ? parseFloat(latitude) : null,
                     longitude: longitude ? parseFloat(longitude) : null,
                     contact_phone: formattedContactPhone,
                 };

                 console.log("Sending venue creation request:", requestBody);

                 try {
                     const response = await fetch('/api/venue/create', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Venue created successfully:", responseData);
                         displayMessage(createVenueMessageDiv, responseData.message || `Venue created successfully! ID: ${responseData.venue_id}`, 'success');

                         setTimeout(() => {
                             closeModal(addVenueModal);
                             fetchAndDisplayVenues(); // Refresh the venue list
                         }, 2000);


                     } else if (responseData && responseData.error_message) {
                         displayMessage(createVenueMessageDiv, `Creation failed: ${responseData.error_message}`, 'error');
                         console.error("Server error creating venue:", response.status, responseData.error_message);
                     }
                     else if (response.status === 400) {
                         const errorText = await response.text();
                          displayMessage(createVenueMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                         console.error("Bad request creating venue:", response.status, errorText);

                     }
                     else if (response.status === 401 || response.status === 403) {
                         displayMessage(createVenueMessageDiv, 'Error: You are not authorized to create venues.', 'error');
                         console.error("Authorization error creating venue:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                          displayMessage(createVenueMessageDiv, `Error creating venue: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error creating venue:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(createVenueMessageDiv, 'Network error submitting venue creation.', 'error');
                     console.error("Fetch error for venue creation:", error);
                 } finally {
                     submitCreateVenueButton.disabled = false;
                 }
            });


            // Function to fetch and display the list of venues as cards
            async function fetchAndDisplayVenues() {
                 venueListDiv.innerHTML = '<p class="text-gray-600 italic">Loading venues...</p>';

                 // Get filter and sort parameters for venues
                 const searchTerm = venueSearchInput.value.trim();
                 const sortBy = venueSortBySelect.value;

                 // Construct query parameters
                 const queryParams = new URLSearchParams();
                 if (searchTerm) queryParams.append('search', searchTerm);
                 if (sortBy) queryParams.append('sort_by', sortBy);

                 const url = `/api/venue/get_list${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
                 console.log("Fetching venues from:", url);

                 try {
                     const response = await fetch(url, { method: 'GET' });

                     if (response.ok) {
                         const result = await response.json(); // Assuming backend returns { success: true, venues: [...] }

                         if (result.success && result.venues) {
                            const venues = result.venues;
                             if (venues.length > 0) {
                                 let html = '';
                                 venues.forEach(venue => {
                                     add_cached_value("venue", venue.venue_id, venue); // Cache the venue data
                                     html += `
                                         <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                                             <h3 class="text-xl font-semibold text-gray-900 mb-2">${venue.title}</h3>
                                             <p class="text-gray-700 mb-4">${venue.description || 'No description'}</p>

                                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                                                 <div>
                                                     <p><strong class="font-medium">Address:</strong> ${venue.address || 'N/A'}, ${venue.suburb || ''}, ${venue.state || ''} ${venue.postcode || ''}, ${venue.country || ''}</p>
                                                      <p><strong class="font-medium">Contact Phone:</strong> ${venue.contact_phone || 'N/A'}</p>
                                                 </div>
                                                  <div>
                                                      ${venue.latitude && venue.longitude ?
                                                         `<p><strong class="font-medium">Location:</strong> ${parseFloat(venue.latitude).toFixed(4)}, ${parseFloat(venue.longitude).toFixed(4)}</p>`
                                                         : '<p><strong class="font-medium">Location:</strong> N/A</p>'}
                                                       <p><strong class="font-medium">Distance:</strong> ${venue.distance || 'N/A'}</p> <!-- Assuming backend provides distance -->
                                                  </div>
                                             </div>

                                              <div class="flex flex-wrap gap-3">
                                                  <!-- Add buttons like View Details (opens venue info modal) or Edit -->
                                                   <button class="view-venue-button py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 text-sm" data-venue-id="${venue.venue_id}">View Details</button>
                                                  <button class="edit-venue-button py-2 px-4 bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition duration-200 text-sm" data-venue-id="${venue.venue_id}">Edit</button>
                                                   <!-- Add Delete button if needed -->
                                              </div>
                                         </div>
                                     `;
                                 });
                                 venueListDiv.innerHTML = html;

                                // Attach event listeners after rendering
                                attachVenueButtonListeners(); // Attach listeners to Edit button
                                attachViewVenueButtonListeners(); // Attach listeners to View Details button

                             } else {
                                 venueListDiv.innerHTML = '<p class="text-gray-600 italic">No venues found matching your criteria.</p>';
                             }
                         } else {
                              // Handle cases where response is OK but success is false (backend level error)
                              venueListDiv.innerHTML = `<p class="text-red-600">Error loading venues: ${result.error_message || 'Unknown error'}</p>`;
                              console.error('Backend success: false for venues:', result.error_message);
                         }

                     } else if (response.status === 401 || response.status === 403) {
                          venueListDiv.innerHTML = '<p class="text-red-600">Error: You are not authorized to view venues.</p>';
                         console.error("Authorization error fetching venues:", response.status);
                     }
                     else {
                          // Handle other HTTP errors
                          const errorText = await response.text();
                           venueListDiv.innerHTML = `<p class="text-red-600">Error loading venues: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                          console.error("Error fetching venues:", response.status, errorText);
                     }
                 } catch (error) {
                     // Handle network errors
                     venueListDiv.innerHTML = `<p class="text-red-600">Network error loading venues.</p>`;
                     console.error("Fetch error for venue list:", error);
                 }
             }

            // Function to attach event listeners to dynamically created venue buttons
            function attachVenueButtonListeners() {
                 // Edit Button Listener
                 venueListDiv.querySelectorAll('.edit-venue-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const venueId = button.getAttribute('data-venue-id');
                         console.log('Attempting to edit venue:', venueId);
                         // Fetch venue data and open edit modal
                         fetchVenueForEdit(venueId);
                     });
                 });
                 // Add Delete button listener here if needed
            }

             // Function to attach event listeners to View Details buttons
             function attachViewVenueButtonListeners() {
                  venueListDiv.querySelectorAll('.view-venue-button').forEach(button => {
                      button.addEventListener('click', async () => {
                          const venueId = button.getAttribute('data-venue-id');
                          console.log('Attempting to view venue details for:', venueId);
                          fetchAndDisplayVenueInfo(venueId); // Reuse the venue info modal logic
                      });
                  });
             }


             // Function to fetch venue data for editing and populate the modal
            async function fetchVenueForEdit(venueId) {
                 editVenueMessageDiv.textContent = '';
                 editVenueMessageDiv.className = 'message text-center';
                 editVenueMessageDiv.style.display = 'none';

                 try {
                     // Use POST request body for venue ID
                     const response = await fetch('/api/venue/get', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ venue_id: venueId })
                     });

                     if (response.ok) {
                         const result = await response.json(); // Assuming backend returns { success: true, venue: {...} } OR just the venue data

                         if (!result.success) {
                                console.error('Backend success: false fetching venue for editing:', result.error_message || 'Invalid data received');
                                alert('Error fetching venue for editing: ' + (result.error_message || 'Invalid data received'));
                                return;
                         }
                        const venue = result.venue; // Adjust based on actual API response structure

                         if (venue && venue.venue_id) {
                             // Populate the edit modal form
                             editVenueIdInput.value = venue.venue_id;
                             editVenueTitleInput.value = venue.title || '';
                             editVenueDescriptionInput.value = venue.description || '';
                             editVenueAddressInput.value = venue.address || '';
                             editVenueSuburbInput.value = venue.suburb || '';
                             editVenueStateInput.value = venue.state || '';
                             editVenuePostcodeInput.value = venue.postcode || '';
                             editVenueCountryInput.value = venue.country || '';
                             editVenueLatitudeInput.value = venue.latitude !== null ? parseFloat(venue.latitude) : '';
                             editVenueLongitudeInput.value = venue.longitude !== null ? parseFloat(venue.longitude) : '';
                             editVenueContactPhoneInput.value = venue.contact_phone || '';

                             // Show the edit modal
                             editVenueModal.style.display = 'block';
                             add_cached_value("venue", venue.venue_id, venue); // Cache the venue data

                         } else {
                              alert('Error fetching venue for editing: ' + (result.error_message || 'Invalid data received'));
                              console.error('Backend success: false fetching venue for editing:', result.error_message || 'Invalid data received');
                         }

                     } else if (response.status === 404) {
                         alert('Venue not found.');
                         console.warn('Venue not found for editing:', venueId);
                     }
                     else if (response.status === 401 || response.status === 403) {
                         alert('You are not authorized to edit this venue.');
                          console.error("Authorization error fetching venue for editing:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                         alert(`Error fetching venue for editing: ${response.status}`);
                         console.error("Error fetching venue for editing:", response.status, errorText);
                     }
                 } catch (error) {
                     console.error('Fetch error fetching venue for editing:', error);
                     alert('Network error fetching venue for editing.');
                 }
            }


            // Submit Edit Venue Form
            submitEditVenueButton.addEventListener('click', async () => {
                 editVenueMessageDiv.style.display = 'none';
                 editVenueMessageDiv.textContent = '';
                 editVenueMessageDiv.className = 'message text-center';
                 submitEditVenueButton.disabled = true;

                const venueId = editVenueIdInput.value;
                const title = editVenueTitleInput.value.trim();
                const description = editVenueDescriptionInput.value.trim();
                const address = editVenueAddressInput.value.trim();
                const suburb = editVenueSuburbInput.value.trim();
                const state = editVenueStateInput.value.trim();
                const postcode = editVenuePostcodeInput.value.trim();
                const country = editVenueCountryInput.value.trim();
                const latitudeString = editVenueLatitudeInput.value.trim();
                const longitudeString = editVenueLongitudeInput.value.trim();
                const contactPhone = editVenueContactPhoneInput.value.trim();

                 if (!title) {
                     displayMessage(editVenueMessageDiv, 'Title is required.', 'error');
                     submitEditVenueButton.disabled = false;
                     return;
                 }

                 const formattedDescription = description === '' ? null : description;
                 const formattedAddress = address === '' ? null : address;
                 const formattedSuburb = suburb === '' ? null : suburb;
                 const formattedState = state === '' ? null : state;
                 const formattedPostcode = postcode === '' ? null : postcode;
                 const formattedCountry = country === '' ? null : country;
                 const formattedContactPhone = contactPhone === '' ? null : contactPhone;

                 const latitude = latitudeString === '' ? null : latitudeString;
                 const longitude = longitudeString === '' ? null : longitudeString;

                 if (latitude !== null && isNaN(parseFloat(latitude))) {
                     displayMessage(editVenueMessageDiv, 'Invalid Latitude format. Must be a number.', 'error');
                     submitEditVenueButton.disabled = false;
                     return;
                 }
                 if (longitude !== null && isNaN(parseFloat(longitude))) {
                     displayMessage(editVenueMessageDiv, 'Invalid Longitude format. Must be a number.', 'error');
                     submitEditVenueButton.disabled = false;
                     return;
                 }


                 const requestBody = {
                     venue_id: venueId, // Include the venue ID for update
                     title: title,
                     description: formattedDescription,
                     address: formattedAddress,
                     suburb: formattedSuburb,
                     state: formattedState,
                     postcode: formattedPostcode,
                     country: formattedCountry,
                     latitude: latitude ? parseFloat(latitude) : null,
                     longitude: longitude ? parseFloat(longitude) : null,
                     contact_phone: formattedContactPhone,
                 };

                console.log("Sending venue update request:", requestBody);

                 try {
                     const response = await fetch(`/api/venue/update`, { // Adjust endpoint
                         method: 'PUT', // Or 'PATCH'
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Venue updated successfully:", responseData);
                         displayMessage(editVenueMessageDiv, responseData.message || 'Venue updated successfully!', 'success');

                         setTimeout(() => {
                             closeModal(editVenueModal);
                             fetchAndDisplayVenues(); // Refresh the venue list
                         }, 2000);
                     } else if (responseData && responseData.error_message) {
                         displayMessage(editVenueMessageDiv, `Update failed: ${responseData.error_message}`, 'error');
                         console.error("Server error updating venue:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                          const errorText = await response.text();
                          displayMessage(editVenueMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                          console.error("Bad request updating venue:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                          displayMessage(editVenueMessageDiv, 'Error: You are not authorized to update venues.', 'error');
                           console.error("Authorization error updating venue:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(editVenueMessageDiv, `Error updating venue: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error updating venue:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(editVenueMessageDiv, 'Network error submitting venue update.', 'error');
                     console.error("Fetch error for venue update:", error);
                 } finally {
                     submitEditVenueButton.disabled = false;
                 }
            });


            // Attach event listener for applying venue filters
            applyVenueFiltersButton.addEventListener('click', () => {
                fetchAndDisplayVenues(); // Refetch venues with current filters
            });

            // --- Styles Management JavaScript ---

            // --- Styles Section Logic ---
            const addStyleButton = document.getElementById('add-style-button');
             const addStyleModal = document.getElementById('add-style-modal');
             const addStyleForm = document.getElementById('add-style-form');
             const submitCreateStyleButton = document.getElementById('submit-create-style');
             const createStyleMessageDiv = document.getElementById('create-style-message');
             const styleListDiv = document.getElementById('style-list');

             // Filter and Sort Elements for Styles
             const styleSearchInput = document.getElementById('style-search'); // Add this
             const styleSortBySelect = document.getElementById('style-sort-by'); // Add this
             const applyStyleFiltersButton = document.getElementById('apply-style-filters-button'); // Add this

             // Edit Style Modal Elements
             const editStyleModal = document.getElementById('edit-style-modal'); // Add this
             const editStyleForm = document.getElementById('edit-style-form'); // Add this
             const submitEditStyleButton = document.getElementById('submit-edit-style'); // Add this
             const editStyleIdInput = document.getElementById('edit-style-id'); // Add this
             const editStyleTitleInput = document.getElementById('edit-style-title'); // Add this
             const editStyleDescriptionInput = document.getElementById('edit-style-description'); // Add this
             const editStyleMessageDiv = document.getElementById('edit-style-message'); // Add this


             // Open Add Style Modal
             addStyleButton.addEventListener('click', () => {
                  addStyleModal.style.display = 'block';
                  createStyleMessageDiv.textContent = '';
                  createStyleMessageDiv.className = 'message text-center';
                  createStyleMessageDiv.style.display = 'none';
                  addStyleForm.reset();
             });


            // Submit Create Style Form
            submitCreateStyleButton.addEventListener('click', async () => {
                 createStyleMessageDiv.style.display = 'none';
                 createStyleMessageDiv.textContent = '';
                 createStyleMessageDiv.className = 'message text-center';
                 submitCreateStyleButton.disabled = true;

                 const title = document.getElementById('style-title').value.trim();
                 const description = document.getElementById('style-description').value.trim();

                  if (!title) {
                     displayMessage(createStyleMessageDiv, 'Title is required.', 'error');
                     submitCreateStyleButton.disabled = false;
                     return;
                 }

                  const styleData = {
                     title: title,
                     description: description || null,
                 };

                 console.log("Sending Style Data:", styleData);

                  try {
                     const response = await fetch('/api/style/create', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(styleData)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Style created successfully:", responseData);
                         displayMessage(createStyleMessageDiv, responseData.message || 'Style created successfully!', 'success');

                         setTimeout(() => {
                             closeModal(addStyleModal);
                             fetchAndDisplayStyles();
                            //  fetchStylesForSelect(classStyleSelect);
                            //  fetchStylesForSelect(editClassStyleSelect);
                         }, 2000);

                     } else if (responseData && responseData.error_message) {
                         displayMessage(createStyleMessageDiv, `Creation failed: ${responseData.error_message}`, 'error');
                         console.error("Server error creating style:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                           const errorText = await response.text();
                           displayMessage(createStyleMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                           console.error("Bad request creating style:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                           displayMessage(createStyleMessageDiv, 'Error: You are not authorized to create styles.', 'error');
                            console.error("Authorization error creating style:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(createStyleMessageDiv, `Error creating style: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error creating style:", response.status, errorText);
                     }

                  } catch (error) {
                      console.error('Error creating style:', error);
                     displayMessage(createStyleMessageDiv, 'Failed to connect to the server.', 'error');
                  } finally {
                      submitCreateStyleButton.disabled = false;
                  }
             });


            async function fetchAndDisplayPOS() {
                await fetchAndDisplayClasses();

            }



            // Function to fetch and display the list of styles as cards
            async function fetchAndDisplayStyles() {
                 styleListDiv.innerHTML = '<p class="text-gray-600 italic">Loading styles...</p>';

                 // Get filter and sort parameters for styles
                 const searchTerm = styleSearchInput.value.trim();
                 const sortBy = styleSortBySelect.value;

                 // Construct query parameters
                 const queryParams = new URLSearchParams();
                 if (searchTerm) queryParams.append('search', searchTerm);
                 if (sortBy) queryParams.append('sort_by', sortBy);

                 const url = `/api/style/get_list${queryParams.toString() ? '?' + queryParams.toString() : ''}`;

                 try {
                     const response = await fetch(url, { method: 'GET' });

                     if (response.ok) {
                         const result = await response.json();

                         if (result.success && result.styles) {
                             const styles = result.styles;
                             if (styles.length > 0) {
                                 let html = '';
                                 styles.forEach(style => {
                                     html += `
                                         <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                                             <h3 class="text-xl font-semibold text-gray-900 mb-2">${style.title}</h3>
                                             <p class="text-gray-700">${style.description || 'No description'}</p>

                                             <div class="flex flex-wrap gap-3 mt-4">
                                                  <button class="edit-style-button py-2 px-4 bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition duration-200 text-sm" data-style-id="${style.style_id}">Edit</button>
                                                  <!-- Add Delete button if needed -->
                                              </div>
                                         </div>
                                     `;
                                 });
                                 styleListDiv.innerHTML = html;

                                 attachStyleButtonListeners(); // Attach listeners to Edit button

                             } else {
                                 styleListDiv.innerHTML = '<p class="text-gray-600 italic">No styles found matching your criteria.</p>';
                             }
                         } else {
                             displayMessage(styleListDiv, `Error loading styles: ${result.error_message || 'Unknown error'}`, 'error');
                              console.error('Backend success: false for styles:', result.error_message);
                         }
                     } else if (response.status === 401 || response.status === 403) {
                          displayMessage(styleListDiv, 'Error: You are not authorized to view styles.', 'error');
                          console.error("Authorization error fetching styles:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                         displayMessage(styleListDiv, `Error loading styles: ${response.status} - ${errorText.substring(0, 100) + '...'}`, 'error');
                         console.error("Error fetching styles:", response.status, errorText);
                     }
                 } catch (error) {
                      console.error('Error fetching styles:', error);
                     displayMessage(styleListDiv, 'Network error loading styles.', 'error');
                 }
             }

             // Function to attach event listeners to dynamically created style buttons
            function attachStyleButtonListeners() {
                 // Edit Button Listener
                 styleListDiv.querySelectorAll('.edit-style-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const styleId = button.getAttribute('data-style-id');
                         console.log('Attempting to edit style:', styleId);
                         // Fetch style data and open edit modal
                         fetchStyleForEdit(styleId);
                     });
                 });
                 // Add Delete button listener here if needed
            }


             // Function to fetch style data for editing and populate the modal
            async function fetchStyleForEdit(styleId) {
                 editStyleMessageDiv.textContent = '';
                 editStyleMessageDiv.className = 'message text-center';
                 editStyleMessageDiv.style.display = 'none';

                 try {
                    console.log('Fetching style for editing:', styleId);

   
                    const requestBody = {
                        style_id: styleId, // Include the style ID for update
                    };

                     // Assuming you have a GET /api/style/{id} endpoint
                     const response = await fetch(`/api/style/get`, {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                    //  const response = await fetch(`/api/style/${styleId}`, { method: 'GET' });
                     const result = await response.json(); // Assuming backend returns { success: true, style: {...} }

                     if (response.ok && result.success && result.style) {
                         const style = result.style;
                         // Populate the edit modal form
                         editStyleIdInput.value = style.style_id;
                         editStyleTitleInput.value = style.title || '';
                         editStyleDescriptionInput.value = style.description || '';

                         // Show the edit modal
                         editStyleModal.style.display = 'block';

                     } else if (response.ok && result.error_message) {
                          alert('Error fetching style for editing: ' + (result.error_message || 'Unknown error'));
                          console.error('Backend success: false fetching style for editing:', result.error_message);
                     } else if (response.status === 404) {
                         alert('Style not found.');
                         console.warn('Style not found for editing:', styleId);
                     }
                     else if (response.status === 401 || response.status === 403) {
                         alert('You are not authorized to edit this style.');
                          console.error("Authorization error fetching style for editing:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                         alert(`Error fetching style for editing: ${response.status}`);
                         console.error("Error fetching style for editing:", response.status, errorText);
                     }
                 } catch (error) {
                     console.error('Fetch error fetching style for editing:', error);
                     alert('Network error fetching style for editing.');
                 }
            }


            // Submit Edit Style Form
            submitEditStyleButton.addEventListener('click', async () => {
                 editStyleMessageDiv.style.display = 'none';
                 editStyleMessageDiv.textContent = '';
                 editStyleMessageDiv.className = 'message text-center';
                 submitEditStyleButton.disabled = true;

                const styleId = editStyleIdInput.value;
                const title = editStyleTitleInput.value.trim();
                const description = editStyleDescriptionInput.value.trim();

                 if (!title) {
                     displayMessage(editStyleMessageDiv, 'Title is required.', 'error');
                     submitEditStyleButton.disabled = false;
                     return;
                 }

                 const formattedDescription = description === '' ? null : description;

                 const requestBody = {
                     style_id: styleId, // Include the style ID for update
                     title: title,
                     description: formattedDescription,
                 };

                console.log("Sending style update request:", requestBody);

                 try {
                     // Assuming you have a PUT /api/style/update/{id} endpoint
                     const response = await fetch(`/api/style/update`, {
                         method: 'PUT',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Style updated successfully:", responseData);
                         displayMessage(editStyleMessageDiv, responseData.message || 'Style updated successfully!', 'success');

                         setTimeout(() => {
                             closeModal(editStyleModal);
                             fetchAndDisplayStyles();
                              // Also refresh style selects in other modals if open
                             fetchStylesForSelect(classStyleSelect);
                             fetchStylesForSelect(editClassStyleSelect);
                         }, 2000);
                     } else if (responseData && responseData.error_message) {
                         displayMessage(editStyleMessageDiv, `Update failed: ${responseData.error_message}`, 'error');
                         console.error("Server error updating style:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                          const errorText = await response.text();
                          displayMessage(editStyleMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                          console.error("Bad request updating style:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                          displayMessage(editStyleMessageDiv, 'Error: You are not authorized to update styles.', 'error');
                           console.error("Authorization error updating style:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(editStyleMessageDiv, `Error updating style: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error updating style:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(editStyleMessageDiv, 'Network error submitting style update.', 'error');
                     console.error("Fetch error for style update:", error);
                 } finally {
                     submitEditStyleButton.disabled = false;
                 }
            });

             // Attach event listener for applying style filters
             applyStyleFiltersButton.addEventListener('click', () => {
                 fetchAndDisplayStyles();
             });



            // Handle initial section display
            const initialSection = window.location.hash ? window.location.hash.substring(1) : 'frontpage';
            const validSections = Array.from(navLinks).map(link => link.getAttribute('data-section'));
            if (validSections.includes(initialSection)) {
                showSection(initialSection);
            } else {
                showSection('frontpage');
            }
        });

        // Function to handle the class section display logic
        // function handleClassSection() {
   
            // --- Portal Navigation Logic (Keep your existing navigation logic here) ---
            // ... (Your showPortalSection, navLinks event listeners, popstate, initial section logic) ...

             // --- Global Modal Closing (Keep your existing global modal closing logic here) ---
             // ... (Your closeModal function, closeButtons event listeners, window click listener) ...

            // Add references to the new modals here so closeModal can find them
            const editClassModal = document.getElementById('edit-class-modal');
            const venueInfoModal = document.getElementById('venue-info-modal');


            // --- Classes Section Logic ---
            const classListDiv = document.getElementById('class-list');
            const addClassButton = document.getElementById('add-class-button');
            const addClassModal = document.getElementById('add-class-modal');
            const addClassForm = document.getElementById('add-class-form');
            const submitCreateClassButton = document.getElementById('submit-create-class');
            const classMessageDiv = document.getElementById('create-class-message');
            const frequencyContainer = document.getElementById('frequency-container');
            const addFrequencyButton = document.getElementById('add-frequency-button');
            const classVenueSelect = document.getElementById('class-venue-id');
            const classStyleSelect = document.getElementById('class-style-ids');

            // Filter and Sort Elements
            const classFilterStyle = document.getElementById('class-filter-style');
            const classFilterVenue = document.getElementById('class-filter-venue');
            const classSortBy = document.getElementById('class-sort-by');
            const classSearchInput = document.getElementById('class-search');
            const applyFiltersButton = document.getElementById('apply-filters-button');

            // Join by Code Elements
            const classCodeInput = document.getElementById('class-code-input');
            const joinByCodeButton = document.getElementById('join-by-code-button');
            const joinByCodeMessageDiv = document.getElementById('join-by-code-message');

             // Edit Class Modal Elements
             const editClassForm = document.getElementById('edit-class-form');
             const submitEditClassButton = document.getElementById('submit-edit-class');
             const editClassIdInput = document.getElementById('edit-class-id');
             const editClassTitleInput = document.getElementById('edit-class-title');
             const editClassDescriptionInput = document.getElementById('edit-class-description');
             const editClassVenueSelect = document.getElementById('edit-class-venue-id');
             const editClassStyleSelect = document.getElementById('edit-class-style-ids');
             const editClassGradingIdsInput = document.getElementById('edit-class-grading-ids');
             const editClassPriceInput = document.getElementById('edit-class-price');
             const editClassPublishModeInput = document.getElementById('edit-class-publish-mode');
             const editClassCapacityInput = document.getElementById('edit-class-capacity');
             const editFrequencyContainer = document.getElementById('edit-frequency-container');
             const addEditFrequencyButton = document.getElementById('add-edit-frequency-button');
             const editClassNotifyBookingCheckbox = document.getElementById('edit-class-notify-booking');
             const editClassWaiverIdInput = document.getElementById('edit-class-waiver-id');
             const editClassMessageDiv = document.getElementById('edit-class-message');
             const editClassFreeLessonsInput = document.getElementById('edit-class-free_lessons');
             

            // Venue Info Modal Elements
            const venueInfoContentDiv = document.getElementById('venue-info-content');
            const closeButtons = document.querySelectorAll('.modal .close-button'); // Select all close buttons for modals  .cancel-button

            // Close Modals (Reusable function)
            function closeModal(modalElement) {
                 modalElement.style.display = 'none';
                 // Clear specific form and message
                 if (modalElement.id === 'add-class-modal') {
                     addClassForm.reset();
                     frequencyContainer.innerHTML = ''; // Clear frequency entries
                     classMessageDiv.textContent = '';
                     classMessageDiv.style.display = 'none';
                 } else if (modalElement.id === 'add-venue-modal') {
                     addVenueForm.reset();
                     createVenueMessageDiv.textContent = '';
                     createVenueMessageDiv.style.display = 'none';
                 } else if (modalElement.id === 'add-style-modal') {
                     addStyleForm.reset();
                     createStyleMessageDiv.textContent = '';
                     createStyleMessageDiv.style.display = 'none';
                 } else if (modalElement.id === 'create-waiver-modal') {
                     createWaiverModal.style.display = 'none'; // Specific closing logic for waiver modal
                     newWaiverTitleInput.value = '';
                     newWaiverContentInput.value = '';
                     createWaiverErrorDiv.textContent = '';
                     createWaiverErrorDiv.className = 'message'; // Reset classes
                 }
                 // Add more modals here
             }


             // Attach close listeners to all close buttons
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Find the parent modal and close it
                    const modal = button.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                });
            });

            const cancelButtons = document.querySelectorAll('.modal .cancel-button'); // Select all close buttons for modals  .cancel-button
            // Attach close listeners to all close buttons
            cancelButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Find the parent modal and close it
                    const modal = button.closest('.modal');
                    if (modal) {
                        closeModal(modal);
                    }
                });
            });


             // --- Helper Functions ---

             // Template for a single frequency entry (using a function to generate HTML with Tailwind classes)
             function createFrequencyEntryHTML(frequency = {}, isEdit = false) {
                // Generate a unique ID for the HTML inputs even if frequency has an ID
                const htmlId = Date.now() + Math.random().toString(36).substr(2, 9);
                const prefix = isEdit ? 'edit-freq' : 'freq';

                const frequencyId = frequency.class_frequency_id || ''; // Get the class_frequency_id if it exists
                const frequencyValue = frequency.frequency || '';
                const startDateValue = frequency.start_date || '';
                const endDateValue = frequency.end_date || '';
                const startTimeValue = frequency.start_time || '';
                const endTimeValue = frequency.end_time || '';

                return `
                    <div class="frequency-entry relative border border-dashed border-gray-300 p-4 rounded-md mb-4" data-id="${htmlId}" data-frequency-id="${frequencyId}">
                        <button type="button" class="remove-frequency-button absolute top-2 right-2 bg-red-500 text-white rounded px-2 py-1 text-xs font-medium hover:bg-red-600">Remove</button>
                        ${isEdit && frequencyId ? `<input type="hidden" name="${prefix}-${htmlId}-id" value="${frequencyId}">` : ''} <!-- Hidden input for frequency ID -->
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-frequency" class="block text-sm font-medium text-gray-700 mb-1">Frequency (int):</label>
                            <input type="number" id="${prefix}-${htmlId}-frequency" value="${frequencyValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date:</label>
                            <input type="date" id="${prefix}-${htmlId}-start-date" value="${startDateValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date:</label>
                            <input type="date" id="${prefix}-${htmlId}-end-date" value="${endDateValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time:</label>
                            <input type="time" id="${prefix}-${htmlId}-start-time" value="${startTimeValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="form-group">
                            <label for="${prefix}-${htmlId}-end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time:</label>
                            <input type="time" id="${prefix}-${htmlId}-end-time" value="${endTimeValue}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                `;
            }

             // Function to get user ID (Implement based on how you store it after login)
             function getUserIdFromCookieOrStorage() {
                 // Example: Reading from a cookie named 'user_id'
                 const name = 'user_id=';
                 const decodedCookie = decodeURIComponent(document.cookie);
                 const ca = decodedCookie.split(';');
                 for(let i = 0; i <ca.length; i++) {
                     let c = ca[i];
                     while (c.charAt(0) === ' ') {
                         c = c.substring(1);
                     }
                     if (c.indexOf(name) === 0) {
                         return c.substring(name.length, c.length);
                     }
                 }
                 return null; // Return null if not found
             }


            // Function to check if a frequency should run today
            function shouldFrequencyRunToday(frequency, startDate, endDate) {
                let today = new Date(); // local
                today.setHours(0, 0, 0, 0);
                // let today = new Date(today + today.getTimezoneOffset() * 60000); // Normalize to UTC date
                // const todayDateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format // UTC
                // const todayDate = new Date(todayDateStr); // Normalize to date only // UTC
                
                let startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0); // Normalize to date only
                
                // Check if today is within the date bounds
                if (today < startDateObj) {
                    return false;
                }
                
                if (endDate) {
                    const endDateObj = new Date(endDate);
                    if (today > endDateObj) {
                        return false;
                    }
                }
                
                const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
                
                switch (frequency) {
                    case 1: // Every Monday
                        return dayOfWeek === 1;
                    case 2: // Every Tuesday
                        return dayOfWeek === 2;
                    case 3: // Every Wednesday
                        return dayOfWeek === 3;
                    case 4: // Every Thursday
                        return dayOfWeek === 4;
                    case 5: // Every Friday
                        return dayOfWeek === 5;
                    case 6: // Every Saturday
                        return dayOfWeek === 6;
                    case 7: // Every Sunday
                        return dayOfWeek === 0;
                    case 8: // Every Weekday
                        return dayOfWeek >= 1 && dayOfWeek <= 5;
                    case 9: // Every Weekend
                        return dayOfWeek === 0 || dayOfWeek === 6;
                    case 10: // Every Day
                        return true;
                    case 11: // Public Holidays
                        // Would need holiday calendar integration
                        return false;
                    case 12: // One off
                    case 16: // One off
                        // For one-off, check if today matches the start date exactly
                        return today.toDateString() === startDateObj.toDateString();
                    case 13: // Every week (same as every day within bounds)
                        return true;
                    case 14: // Every fortnight
                        const daysDiff = Math.floor((today - startDateObj) / (1000 * 60 * 60 * 24));
                        const weeksDiff = Math.floor(daysDiff / 7);
                        return weeksDiff >= 0 && weeksDiff % 2 === 0;
                    case 15: // Every month
                        return today.getDate() === startDateObj.getDate();
                    default:
                        console.warn(`Unknown frequency code: ${frequency}`);
                        return false;
                }
            }


            // --- API Fetch Functions ---

            // Function to fetch and display classes as cards
             async function fetchAndDisplayClasses() {
                 classListDiv.innerHTML = '<p class="text-gray-600 italic">Loading classes...</p>';

                 // Get filter and sort parameters
                 const styleFilter = classFilterStyle.value;
                 const venueFilter = classFilterVenue.value;
                 const sortBy = classSortBy.value;
                 const searchTerm = classSearchInput.value.trim();

                 // Construct query parameters
                 const queryParams = new URLSearchParams();
                 if (styleFilter) queryParams.append('style_id', styleFilter);
                 if (venueFilter) queryParams.append('venue_id', venueFilter);
                 if (sortBy) queryParams.append('sort_by', sortBy);
                 if (searchTerm) queryParams.append('search', searchTerm);

                await fetchVenuesForSelect(classFilterVenue);
                    // fetchStylesForSelect(classFilterStyle);

                 const url = `/api/class/get_list`;
                 console.log("Fetching classes from:", url);

                 try {
                     const response = await fetch(url, {
                         method: 'GET',
                         headers: {
                            'Content-Type': 'application/json' // Although GET, good practice for APIs
                         }
                     });

                     if (response.ok) {
                         const classes = await response.json(); // Assuming backend returns a JSON array
                         if (classes.length > 0) {
                             let html = '';
                             classes.forEach(cls => {
                                 // Assume your class object has properties like:
                                 // id, title, description, venue_id, style_ids, grading_ids, price,
                                 // publish_mode, capacity, frequencies, notify_booking, waiver_id,
                                 // next_run_time (formatted string), instructor_name, venue_name, venue_address,
                                 // venue_latitude, venue_longitude, style_names (array of strings), eligibility (string), distance (optional string)

                                 // Determine eligibility status
                                 let eligibilityStatus = cls.eligibility || 'Not specified';
                                 let eligibilityColor = 'text-gray-600';
                                 if (eligibilityStatus.toLowerCase().includes('eligible')) {
                                     eligibilityColor = 'text-green-600';
                                 } else if (eligibilityStatus.toLowerCase().includes('ineligible')) {
                                     eligibilityColor = 'text-red-600';
                                 }

                                 // Format price
                                const formattedPrice = cls.price !== undefined && cls.price !== null ? `$${parseFloat(cls.price).toFixed(2)}` : 'Free';
                                let venue_name = '';
                                let venue_data = get_cached_value('venue', cls.venue_id);

                                if (venue_data != null) {
                                    venue_name = venue_data.title;
                                } else {
                                    venue_name = 'N/A'; 
                                }
                                
                                // Updated calendar event addition code
                                const today = new Date();
                                const todayStr = today.toLocaleDateString(); //.split('T')[0]; // Get today's date in YYYY-MM-DD format
                                const year = todayStr.split('/')[2];
                                const month = todayStr.split('/')[1].padStart(2, '0'); // Ensure two digits
                                const day = todayStr.split('/')[0].padStart(2, '0'); // Ensure two digits
                                var all_event_ids = [];
                                cls.frequency.forEach(class_frequency => {
                                    // Check if this frequency should run today
                                    if (shouldFrequencyRunToday(
                                        class_frequency.frequency, 
                                        class_frequency.start_date, 
                                        class_frequency.end_date
                                    )) {
                                        // let starta = new Date(`${todayStr}T${class_frequency.start_time}`); // Adjust for timezone offset
                                        // let startb = today.getTimezoneOffset() * 1000; // Adjust for timezone offset
                                        
                                        let start = new Date( new Date(`${year}-${month}-${day}T${class_frequency.start_time}`)); // Adjust for timezone offset
                                        let end = new Date( new Date(`${year}-${month}-${day}T${class_frequency.end_time}`)); // Adjust for timezone offset
                                        // start.setMinutes(start.getMinutes() - start.getTimezoneOffset()); // Adjust for timezone offset
                                        // end.setMinutes(end.getMinutes() - end.getTimezoneOffset()); // Adjust for timezone offset
                                        console.log("Frequency start time:", class_frequency);
                                        // Add the calendar event only if it should run today
                                        calendar.addEvent(
                                            start,
                                            end,
                                            cls.title,
                                            cls.description,
                                            venue_name,
                                            cls.class_id,
                                            class_frequency.class_frequency_id
                                        );
                                        all_event_ids.push(class_frequency.class_frequency_id);
                                    }
                                });
                                calendar.removeNonPresentClassIdEvents(cls.class_id, all_event_ids);


                                 html += `
                                     <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                                         <h3 class="text-xl font-semibold text-gray-900 mb-2">${cls.title}</h3>
                                         <p class="text-gray-700 mb-4">${cls.description}</p>

                                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                                             <div>
                                                 <p><strong class="font-medium">Venue:</strong> <span class="venue-name cursor-pointer text-blue-600 hover:underline" data-venue-id="${cls.venue_id}">${venue_data.title || 'N/A'}</span></p>
                                                  <p><strong class="font-medium">Address:</strong> ${venue_data.address || 'N/A'}</p>
                                                  ${venue_data.latitude && venue_data.longitude ?
                                                     `<p>
                                                         <strong class="font-medium">Map:</strong>
                                                         <a href="https://www.openstreetmap.org/?mlat=${venue_data.latitude}&mlon=${venue_data.longitude}#map=15/${venue_data.latitude}/${venue_data.longitude}" target="_blank" class="text-blue-600 hover:underline">View on Map</a>
                                                      </p>`
                                                     : ''}
                                             </div>
                                             <div>
                                                 <p><strong class="font-medium">Instructor:</strong> ${cls.instructor_name || 'N/A'}</p>
                                                 <p><strong class="font-medium">Styles:</strong> ${cls.style_names && cls.style_names.length > 0 ? cls.style_names.join(', ') : 'N/A'}</p>
                                                  <p><strong class="font-medium">Eligibility:</strong> <span class="${eligibilityColor}">${eligibilityStatus}</span></p>
                                                  <p><strong class="font-medium">Distance:</strong> ${cls.distance || 'N/A'}</p>
                                             </div>
                                         </div>

                                         <div class="text-sm text-gray-600 mb-4">
                                              <p><strong class="font-medium">Next Run Time:</strong> ${cls.next_run_time || 'Not scheduled'}</p>
                                              <p><strong class="font-medium">Capacity:</strong> ${cls.capacity !== undefined ? cls.capacity : 'N/A'}</p>
                                              <p><strong class="font-medium">Price:</strong> ${formattedPrice}</p>
                                         </div>


                                         <div class="flex flex-wrap gap-3">
                                              <button class="join-class-button py-2 px-4 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 text-sm" data-class-id="${cls.class_id}">Join Class</button>
                                             <button class="checkin-class-button py-2 px-4 bg-yellow-500 text-gray-900 rounded-md hover:bg-yellow-600 transition duration-200 text-sm" data-class-id="${cls.class_id}">Check-in</button>
                                             <button class="edit-class-button py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 text-sm" data-class-id="${cls.class_id}">Edit</button>
                                             <!-- Add Delete button if needed -->
                                         </div>
                                     </div>
                                 `;
                             });
                             classListDiv.innerHTML = html;

                             // Attach event listeners after rendering
                             attachClassButtonListeners();
                             attachVenueNameListeners(); // Attach listeners to venue names

                         } else {
                             classListDiv.innerHTML = '<p class="text-gray-600 italic">No classes found matching your criteria.</p>';
                         }
                     } else if (response.status === 401 || response.status === 403) {
                          classListDiv.innerHTML = '<p class="text-red-600">Error: You are not authorized to view classes.</p>';
                         console.error("Authorization error fetching classes:", response.status);
                     }
                     else {
                         const errorText = await response.text();
                         classListDiv.innerHTML = `<p class="text-red-600">Error loading classes: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                         console.error("Error fetching classes:", response.status, errorText);
                     }
                 } catch (error) {
                     classListDiv.innerHTML = `<p class="text-red-600">Network error loading classes.</p>`;
                     console.error("Fetch error for class list:", error);
                 }
             }


            // Function to attach event listeners to dynamically created class buttons
            function attachClassButtonListeners() {
                 // Join Button Listener
                 classListDiv.querySelectorAll('.join-class-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const classId = button.getAttribute('data-class-id');
                         console.log('Attempting to join class:', classId);
                         // Implement API call to join class here
                         try {
                             const response = await fetch(`/api/class/join/${classId}`, { method: 'POST' }); // Adjust endpoint as needed
                             const result = await response.json();
                              if (result.success) {
                                   alert('Successfully joined class!'); // Or show a more integrated message
                                   // Optionally, refresh the class list to reflect the change
                                   fetchAndDisplayClasses();
                              } else {
                                   alert('Failed to join class: ' + (result.error_message || 'Unknown error'));
                              }
                         } catch (error) {
                              console.error('Fetch error joining class:', error);
                              alert('Network error joining class.');
                         }
                     });
                 });

                 // Check-in Button Listener
                 classListDiv.querySelectorAll('.checkin-class-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const classId = button.getAttribute('data-class-id');
                          console.log('Attempting to check-in for class:', classId);
                         // Implement API call to check in here (likely requires user ID)
                         try {
                              // You'll need to get the current user's ID to send with the check-in request
                              // This often comes from a cookie or local storage after login
                              const userId = getUserIdFromCookieOrStorage(); // Implement this function

                               if (!userId) {
                                    alert("Could not determine user ID for check-in.");
                                    return;
                               }

                             const response = await fetch(`/api/class/checkin`, {
                                  method: 'POST',
                                   headers: {
                                        'Content-Type': 'application/json',
                                        // Include authorization token if required
                                   },
                                   body: JSON.stringify({ user_id: userId, class_id: classId }) // Send user ID with the request
                               }); // Adjust endpoint as needed

                             const result = await response.json();
                              if (result.success) {
                                   alert('Successfully checked into class!'); // Or show a more integrated message
                                   // Optionally, update the class card to show check-in status
                              } else {
                                   alert('Failed to check in: ' + (result.error_message || 'Unknown error'));
                              }
                         } catch (error) {
                              console.error('Fetch error checking in:', error);
                              alert('Network error checking in.');
                         }
                     });
                 });

                 // Edit Button Listener
                 classListDiv.querySelectorAll('.edit-class-button').forEach(button => {
                     button.addEventListener('click', async () => {
                         const classId = button.getAttribute('data-class-id');
                         console.log('Attempting to edit class:', classId);
                         // Fetch class data and open edit modal
                         fetchClassForEdit(classId);
                     });
                 });
            }

            // Function to attach event listeners to venue names for showing venue info
            function attachVenueNameListeners() {
                 classListDiv.querySelectorAll('.venue-name').forEach(span => {
                     span.addEventListener('click', async () => {
                         const venueId = span.getAttribute('data-venue-id');
                         console.log('Attempting to fetch venue info for:', venueId);
                          fetchAndDisplayVenueInfo(venueId);
                     });
                 });
            }

            // Function to fetch venues for select dropdowns
            async function fetchVenuesForSelect(selectElement, selectedVenueId = null) {
                 console.log("Fetching venues for select element:", selectElement.id);
                 selectElement.innerHTML = '<option value="">Loading venues...</option>';
                 selectElement.disabled = true;
                 try {
                     const response = await fetch('/api/venue/get_list', { method: 'GET' });

                     if (response.ok) {
                         // Assuming backend returns { success: true, venues: [...] } on success
                         const result = await response.json();

                         if (result.success && result.venues) {
                            const venues = result.venues;
                            let optionsHtml = '<option value="">Select Venue</option>';
                            selectElement.disabled = false;
                            if (venues.length > 0) {
                                venues.forEach(venue => {
                                    const selected = selectedVenueId === venue.venue_id ? 'selected' : '';
                                    optionsHtml += `<option value="${venue.venue_id}" ${selected}>${venue.title}</option>`;
                                    add_cached_value("venue", venue.venue_id, venue); // Cache the venue ID and title

                                });
                                selectElement.innerHTML = optionsHtml;
                            } else {
                                selectElement.innerHTML = '<option value="">No venues found</option>';
                            }
                        } else {
                        // Handle cases where response is OK but success is false (backend level error)
                        selectElement.innerHTML = `<option value="">Error: ${result.error_message || 'Unknown error'}</option>`;
                            console.error('Backend success: false for venues:', result.error_message);
                        }

                     } else if (response.status === 401 || response.status === 403) {
                          selectElement.innerHTML = '<option value="">Error: Not authorized</option>';
                          console.error("Authorization error fetching venues:", response.status);
                     }
                     else {
                          // Handle other HTTP errors
                          const errorText = await response.text();
                           selectElement.innerHTML = `<option value="">Error: ${response.status} - ${errorText.substring(0, 50)}...</option>`;
                          console.error("Error fetching venues:", response.status, errorText);
                     }
                 } catch (error) {
                     // Handle network errors
                     console.error('Network error fetching venues:', error);
                     selectElement.innerHTML = '<option value="">Network Error</option>';
                 }
            }

            // Function to fetch styles for select dropdowns
             async function fetchStylesForSelect(selectElement, selectedStyleIds = []) {
                 selectElement.innerHTML = '<option value="">Loading styles...</option>';
                 selectElement.disabled = true;
                 try {
                     const response = await fetch('/api/style/get_list'); // Adjust endpoint
                     if (response.ok) {

                        const result = await response.json(); // Assuming the backend returns { success: true, styles: [...] } or { success: false, error_message: "" }

                        if (result.success && result.styles) {
                            const styles = result.styles;
                            let optionsHtml = '';
                            if (!selectElement.multiple) {
                                optionsHtml += '<option value="">Select Style</option>';
                            }
                            selectElement.disabled = false;
                            if (styles.length > 0) {
                                styles.forEach(style => {
                                    const selected = selectedStyleIds.includes(style.style_id) ? 'selected' : '';
                                    optionsHtml += `<option value="${style.style_id}" ${selected}>${style.title}</option>`;
                                    add_cached_value("style", style.style_id, style); // Cache the venue ID and title
                                });
                                selectElement.innerHTML = optionsHtml;
                            } else {
                                selectElement.innerHTML = '<option value="">No styles found</option>';
                            }
                        }
                    } else if (response.status === 401 || response.status === 403) {
                          selectElement.innerHTML = '<option value="">Error: Not authorized</option>';
                          console.error("Authorization error fetching venues:", response.status);
                     }
                     else {
                          // Handle other HTTP errors
                          const errorText = await response.text();
                           selectElement.innerHTML = `<option value="">Error: ${response.status} - ${errorText.substring(0, 50)}...</option>`;
                          console.error("Error fetching venues:", response.status, errorText);
                     }

                 } catch (error) {
                     console.error('Network error fetching styles:', error);
                     selectElement.innerHTML = '<option value="">Network Error</option>';
                 }
             }


             // --- Event Listeners ---

            // Open Add Class Modal
            addClassButton.addEventListener('click', () => {
                addClassModal.style.display = 'block';
                classMessageDiv.textContent = ''; // Clear previous messages
                classMessageDiv.className = 'message text-center'; // Reset classes
                classMessageDiv.style.display = 'none'; // Hide message div
                addClassForm.reset(); // Clear the form fields
                frequencyContainer.innerHTML = ''; // Clear previous frequency entries
                // Add an initial frequency entry when opening the modal
                frequencyContainer.innerHTML += createFrequencyEntryHTML();

                // Fetch venues and styles when modal opens
                fetchVenuesForSelect(classVenueSelect);
                fetchStylesForSelect(classStyleSelect);
            });


            // Add a frequency entry to the form
            function addFrequencyEntry(isEdit = false) {
                 const container = isEdit ? editFrequencyContainer : frequencyContainer;
                const entryHtml = createFrequencyEntryHTML({}, isEdit); // Pass isEdit to template
                container.insertAdjacentHTML('beforeend', entryHtml);

                // Add event listener to the new remove button using delegation
                // This is now handled by the delegated listener on the container itself
            }


            // Event listener for the "Add Frequency Slot" button
            addFrequencyButton.addEventListener('click', () => addFrequencyEntry(false));
            addEditFrequencyButton.addEventListener('click', () => addFrequencyEntry(true));


            // Handle Remove Frequency Button Click (using event delegation on containers)
             frequencyContainer.addEventListener('click', (event) => {
                 if (event.target.classList.contains('remove-frequency-button')) {
                     event.target.closest('.frequency-entry').remove();
                 }
             });

             editFrequencyContainer.addEventListener('click', (event) => {
                 if (event.target.classList.contains('remove-frequency-button')) {
                     event.target.closest('.frequency-entry').remove();
                 }
             });


            // Submit Create Class Form
            submitCreateClassButton.addEventListener('click', async () => {
                classMessageDiv.style.display = 'none';
                classMessageDiv.textContent = '';
                classMessageDiv.className = 'message text-center';
                submitCreateClassButton.disabled = true;

                // --- 1. Gather data from the form ---
                const title = document.getElementById('class-title').value.trim();
                const description = document.getElementById('class-description').value.trim();
                const venueIdString = document.getElementById('class-venue-id').value.trim();
                const styleIdsSelect = document.getElementById('class-style-ids');
                const style_ids = Array.from(styleIdsSelect.selectedOptions).map(option => option.value.trim()).filter(id => id.length > 0); // Get selected options
                const gradingIdsString = document.getElementById('class-grading-ids').value.trim();
                const priceString = document.getElementById('class-price').value.trim();
                const publishMode = parseInt(document.getElementById('class-publish-mode').value, 10);
                const capacity = parseInt(document.getElementById('class-capacity').value, 10);
                const notifyBooking = document.getElementById('class-notify-booking').checked;
                const waiverIdString = document.getElementById('class-waiver-id').value.trim();


                // --- 2. Validate and Format Complex Fields ---

                 if (!title || !description || !venueIdString || style_ids.length === 0 || isNaN(publishMode) || isNaN(capacity)) {
                     displayMessage(classMessageDiv, 'Please fill in all required fields (Title, Description, Venue, Styles, Publish Mode, Capacity).', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }
                // Basic format validation for UUIDs (optional, backend should validate definitively)
                if (venueIdString && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(venueIdString)) {
                    displayMessage(classMessageDiv, 'Invalid Venue ID format.', 'error');
                    submitCreateClassButton.disabled = false;
                    return;
                }
                if (style_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                     displayMessage(classMessageDiv, 'One or more Style IDs have an invalid UUID format.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }

                const grading_ids = gradingIdsString.split(',').map(id => id.trim()).filter(id => id.length > 0);
                 if (grading_ids.length > 0 && grading_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                     displayMessage(classMessageDiv, 'One or more Grading IDs have an invalid UUID format.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }

                const price = priceString === '' ? null : priceString;
                if (price !== null && isNaN(parseFloat(price))) {
                     displayMessage(classMessageDiv, 'Invalid Price format. Must be a number.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }

                const waiver_id = waiverIdString === '' ? null : waiverIdString;
                 if (waiver_id !== null && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(waiverIdString)) {
                     displayMessage(classMessageDiv, 'Invalid Waiver ID format. Expected UUID.', 'error');
                     submitCreateClassButton.disabled = false;
                     return;
                 }


                const frequencyEntries = frequencyContainer.querySelectorAll('.frequency-entry');
                const frequencies = [];
                for (const entry of frequencyEntries) {
                    const id = entry.dataset.id;

                    const freqNum = parseInt(entry.querySelector('[id$="-frequency"]').value, 10);
                    const startDate = entry.querySelector('[id$="-start-date"]').value;
                    const endDate = entry.querySelector('[id$="-end-date"]').value;
                    const startTime = entry.querySelector('[id$="-start-time"]').value;
                    const endTime = entry.querySelector('[id$="-end-time"]').value;


                     if (isNaN(freqNum) || freqNum <= 0) {
                         displayMessage(classMessageDiv, `Invalid frequency number for entry ID ${id}. Must be a positive integer.`, 'error');
                         submitCreateClassButton.disabled = false; return;
                     }
                     if (!startDate || !/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
                         displayMessage(classMessageDiv, `Invalid start date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                         submitCreateClassButton.disabled = false; return;
                     }
                     if (!endDate || !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) {
                         displayMessage(classMessageDiv, `Invalid end date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                            submitCreateClassButton.disabled = false; return;
                     }

                    const startTimeFormatted = startTime.includes(':') && startTime.split(':').length <= 2 ? startTime + ':00' : startTime;
                    const endTimeFormatted = endTime.includes(':') && endTime.split(':').length <= 2 ? endTime + ':00' : endTime;

                     if (!startTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(startTimeFormatted)) {
                         displayMessage(classMessageDiv, `Invalid start time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                            submitCreateClassButton.disabled = false; return;
                     }
                     if (!endTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(endTimeFormatted)) {
                         displayMessage(classMessageDiv, `Invalid end time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                            submitCreateClassButton.disabled = false; return;
                     }

                     frequencies.push({
                         frequency: freqNum,
                         start_date: startDate,
                         end_date: endDate,
                         start_time: startTimeFormatted,
                         end_time: endTimeFormatted
                     });
                 }

                 if (frequencies.length === 0) {
                    displayMessage(classMessageDiv, 'At least one frequency slot is required.', 'error');
                    submitCreateClassButton.disabled = false;
                    return;
                }


                // --- 3. Construct the JSON request body ---
                const requestBody = {
                    title: title,
                    description: description,
                    venue_id: venueIdString,
                    style_ids: style_ids,
                    grading_ids: grading_ids,
                    price: price ? parseFloat(price) : null, // Convert price to number if not null
                    publish_mode: publishMode,
                    capacity: capacity,
                    frequency: frequencies, // Use the corrected 'frequencies' variable name
                    notify_booking: notifyBooking,
                    waiver_id: waiver_id,
                };

                console.log("Sending class creation request:", requestBody);

                // --- 4. Send the POST request to the backend ---
                try {
                    const response = await fetch('/api/class/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const responseData = await response.json();

                    if (response.ok && responseData.success) {
                        console.log("Class created successfully:", responseData);
                        displayMessage(classMessageDiv, responseData.message || `Class created successfully! ID: ${responseData.class_id}`, 'success');

                        setTimeout(() => {
                            closeModal(addClassModal);
                            fetchAndDisplayClasses(); // Refresh the class list
                        }, 2000); // Hide after 2 seconds


                    } else if (responseData && responseData.error_message) {
                        displayMessage(classMessageDiv, `Creation failed: ${responseData.error_message}`, 'error');
                        console.error("Server error creating class:", response.status, responseData.error_message);
                    }
                    else if (response.status === 400) {
                        const errorText = await response.text();
                        displayMessage(classMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                        console.error("Bad request creating class:", response.status, errorText);

                    }
                    else if (response.status === 401 || response.status === 403) {
                        displayMessage(classMessageDiv, 'Error: You are not authorized to create classes.', 'error');
                        console.error("Authorization error creating class:", response.status);
                    }
                    else {
                        const errorText = await response.text();
                         displayMessage(classMessageDiv, `Error creating class: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                        console.error("Error creating class:", response.status, errorText);
                    }

                } catch (error) {
                    displayMessage(classMessageDiv, 'Network error submitting class creation.', 'error');
                    console.error("Fetch error for class creation:", error);
                } finally {
                    submitCreateClassButton.disabled = false;
                }
            });


             // Submit Edit Class Form
            submitEditClassButton.addEventListener('click', async () => {
                 editClassMessageDiv.style.display = 'none';
                 editClassMessageDiv.textContent = '';
                 editClassMessageDiv.className = 'message text-center';
                 submitEditClassButton.disabled = true;

                const classId = editClassIdInput.value;
                const title = editClassTitleInput.value.trim();
                const description = editClassDescriptionInput.value.trim();
                const venue_id = editClassVenueSelect.value.trim();
                const style_ids_select = editClassStyleSelect;
                const style_ids = Array.from(style_ids_select.selectedOptions).map(option => option.value.trim()).filter(id => id.length > 0);
                const grading_ids_string = editClassGradingIdsInput.value.trim();
                const priceString = editClassPriceInput.value.trim();
                const publish_mode = parseInt(editClassPublishModeInput.value, 10);
                const capacity = parseInt(editClassCapacityInput.value, 10);
                const free_lessons = parseInt(editClassFreeLessonsInput.value.trim());
                const notify_booking = editClassNotifyBookingCheckbox.checked;
                const waiver_id_string = editClassWaiverIdInput.value.trim();


                // --- 2. Validate and Format Complex Fields (Similar to create) ---
                console.log("Validating edit class data:", { title, description, venue_id, style_ids, publish_mode, capacity });

                if (!title || !description || !venue_id || style_ids.length === 0 || isNaN(publish_mode) || isNaN(capacity)) {
                    var missing_fields = [];
                    if (!title) missing_fields.push('Title');
                    if (!description) missing_fields.push('Description');
                    if (!venue_id) missing_fields.push('Venue');
                    if (style_ids.length === 0) missing_fields.push('Styles');
                    if (isNaN(publish_mode)) missing_fields.push('Publish Mode');
                    if (isNaN(capacity)) missing_fields.push('Capacity');
                    displayMessage(editClassMessageDiv, `Please fill in all required fields: ${missing_fields.join(', ')}.`, 'error');
                    submitEditClassButton.disabled = false;
                    return;
                }
                // Basic format validation for UUIDs
                 if (venue_id && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(venue_id)) {
                    displayMessage(editClassMessageDiv, 'Invalid Venue ID format.', 'error');
                    submitEditClassButton.disabled = false;
                    return;
                 }
                 if (style_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                      displayMessage(editClassMessageDiv, 'One or more Style IDs have an invalid UUID format.', 'error');
                      submitEditClassButton.disabled = false;
                      return;
                  }


                const grading_ids = grading_ids_string.split(',').map(id => id.trim()).filter(id => id.length > 0);
                if (grading_ids.length > 0 && grading_ids.some(id => !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(id))) {
                    displayMessage(editClassMessageDiv, 'One or more Grading IDs have an invalid UUID format.', 'error');
                    submitEditClassButton.disabled = false;
                    return;
                }

                const price = priceString === '' ? null : priceString;
                 if (price !== null && isNaN(parseFloat(price))) {
                     displayMessage(editClassMessageDiv, 'Invalid Price format. Must be a number.', 'error');
                     submitEditClassButton.disabled = false;
                     return;
                 }

                const waiver_id = waiver_id_string === '' ? null : waiver_id_string;
                 if (waiver_id !== null && !/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(waiver_id_string)) {
                     displayMessage(editClassMessageDiv, 'Invalid Waiver ID format. Expected UUID.', 'error');
                     submitEditClassButton.disabled = false;
                     return;
                 }


                const frequencyEntries = editFrequencyContainer.querySelectorAll('.frequency-entry');
                const frequencies = [];
                var id = 1;
                for (const entry of frequencyEntries) {
                    const class_frequency_id = entry.dataset.frequencyId || null;

                    const freqNum = parseInt(entry.querySelector('[id$="-frequency"]').value, 10);
                    // const class_frequency_id = entry.querySelector('[id$="-class_frequency_id"]').value;
                    const startDate = entry.querySelector('[id$="-start-date"]').value;
                    const endDate = entry.querySelector('[id$="-end-date"]').value;
                    const startTime = entry.querySelector('[id$="-start-time"]').value;
                    const endTime = entry.querySelector('[id$="-end-time"]').value;
                    // console.log("Class Frequency ID:", class_frequency_id);

                    // Basic frequency validation
                    if (isNaN(freqNum) || freqNum <= 0) {
                        displayMessage(editClassMessageDiv, `Invalid frequency number for entry ID ${id}. Must be a positive integer.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }
                    if (!startDate || !/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
                        displayMessage(editClassMessageDiv, `Invalid start date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }
                    if (!endDate || !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) {
                        displayMessage(editClassMessageDiv, `Invalid end date for frequency entry ID ${id}. Expected YYYY-MM-DD.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }

                    const startTimeFormatted = startTime.includes(':') && startTime.split(':').length <= 2 ? startTime + ':00' : startTime;
                    const endTimeFormatted = endTime.includes(':') && endTime.split(':').length <= 2 ? endTime + ':00' : endTime;

                    if (!startTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(startTimeFormatted)) {
                        displayMessage(editClassMessageDiv, `Invalid start time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }
                    if (!endTimeFormatted || !/^\d{2}:\d{2}:\d{2}$/.test(endTimeFormatted)) {
                        displayMessage(editClassMessageDiv, `Invalid end time format for frequency entry ID ${id}. Expected HH:MM or HH:MM:SS.`, 'error');
                        submitEditClassButton.disabled = false; return;
                    }

                    frequencies.push({
                        class_frequency_id: class_frequency_id, // Include ID for update
                        frequency: freqNum,
                        start_date: startDate,
                        end_date: endDate,
                        start_time: startTimeFormatted,
                        end_time: endTimeFormatted
                    });

                    id++;
                 }

                 if (frequencies.length === 0) {
                    displayMessage(editClassMessageDiv, 'At least one frequency slot is required.', 'error');
                    submitEditClassButton.disabled = false;
                    return;
                }


                // --- 3. Construct the JSON request body ---
                const requestBody = {
                    class_id: classId,
                    title: title,
                    description: description,
                    venue_id: venue_id,
                    style_ids: style_ids,
                    grading_ids: grading_ids,
                    price: price ? price : null,
                    publish_mode: publish_mode,
                    capacity: capacity,
                    frequency: frequencies, // Use the corrected 'frequencies' variable name
                    notify_booking: notify_booking,
                    waiver_id: waiver_id,
                    free_lessons: free_lessons // Convert to number if not null
                };

                // console.log("Sending class update request:", requestBody);

                // --- 4. Send the PUT/PATCH request to the backend ---
                 try {
                     const response = await fetch(`/api/class/update`, { // Adjust endpoint
                         method: 'PUT', // Or 'PATCH' depending on your API design
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify(requestBody)
                     });

                     const responseData = await response.json();

                     if (response.ok && responseData.success) {
                         console.log("Class updated successfully:", responseData);
                         displayMessage(editClassMessageDiv, responseData.message || 'Class updated successfully!', 'success');

                         setTimeout(() => {
                             closeModal(editClassModal);
                             fetchAndDisplayClasses(); // Refresh the class list
                         }, 2000); // Hide after 2 seconds


                     } else if (responseData && responseData.error_message) {
                         displayMessage(editClassMessageDiv, `Update failed: ${responseData.error_message}`, 'error');
                         console.error("Server error updating class:", response.status, responseData.error_message);
                     }
                      else if (response.status === 400) {
                          const errorText = await response.text();
                          displayMessage(editClassMessageDiv, `Invalid request data: ${responseData.error_message || errorText.substring(0, 100) + '...'}`, 'error');
                          console.error("Bad request updating class:", response.status, errorText);
                      }
                      else if (response.status === 401 || response.status === 403) {
                          displayMessage(editClassMessageDiv, 'Error: You are not authorized to update classes.', 'error');
                           console.error("Authorization error updating class:", response.status);
                      }
                     else {
                         const errorText = await response.text();
                         displayMessage(editClassMessageDiv, `Error updating class: ${response.status} - ${responseData.error_message || errorText.substring(0, 100) + '...'}` , 'error');
                         console.error("Error updating class:", response.status, errorText);
                     }

                 } catch (error) {
                     displayMessage(editClassMessageDiv, 'Network error submitting class update.', 'error');
                     console.error("Fetch error for class update:", error);
                 } finally {
                     submitEditClassButton.disabled = false;
                 }
            });


             // Function to fetch class data for editing and populate the modal
            async function fetchClassForEdit(classId) {
                 editClassMessageDiv.textContent = '';
                 editClassMessageDiv.className = 'message text-center';
                 editClassMessageDiv.style.display = 'none';

                 try {
                    const response = await fetch('/api/class/get', { // Adjust endpoint
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ class_id: classId })
                    });

                    //  const response = await fetch(`/api/class/${classId}`); // Adjust endpoint to get a single class by ID
                     const result = await response.json(); // Assuming backend returns { success: true, class: {...} }

                     if (result.success && result.class) {
                         const cls = result.class;
                         // Populate the edit modal form
                         editClassIdInput.value = cls.class_id;
                         editClassTitleInput.value = cls.title || '';
                         editClassDescriptionInput.value = cls.description || '';

                         // Populate venue and style selects - need to fetch available venues/styles first
                         await fetchVenuesForSelect(editClassVenueSelect, cls.venue_id);
                         await fetchStylesForSelect(editClassStyleSelect, cls.styles); // Pass array of selected style IDs

                         editClassGradingIdsInput.value = cls.grading_ids ? cls.grading_ids.join(', ') : '';
                         editClassPriceInput.value = cls.price !== undefined && cls.price !== null ? parseFloat(cls.price) : '';
                         editClassPublishModeInput.value = cls.publish_mode !== undefined ? cls.publish_mode : 0;
                         editClassCapacityInput.value = cls.capacity !== undefined ? cls.capacity : null;
                         editClassFreeLessonsInput.value = cls.free_lessons !== undefined ? cls.free_lessons : 0;

                         // Populate frequencies for edit
                         editFrequencyContainer.innerHTML = ''; // Clear existing frequencies
                        //  console.log("Frequencies for edit:", cls);
                         if (cls.frequency && cls.frequency.length > 0) {
                             cls.frequency.forEach(freq => {
                                 editFrequencyContainer.innerHTML += createFrequencyEntryHTML(freq, true); // Pass true for edit mode
                             });
                         } else {
                             // Add an initial empty frequency slot if none exist
                              editFrequencyContainer.innerHTML += createFrequencyEntryHTML({}, true);
                         }


                         editClassNotifyBookingCheckbox.checked = cls.notify_booking || false;
                         editClassWaiverIdInput.value = cls.waiver_id || '';

                         // Show the edit modal
                         editClassModal.style.display = 'block';

                     } else {
                         alert('Error fetching class for editing: ' + (result.error_message || 'Unknown error'));
                         console.error('Error fetching class for editing:', result);
                     }
                 } catch (error) {
                     console.error('Fetch error fetching class for editing:', error);
                     alert('Network error fetching class for editing.');
                 }
            }


             // Function to fetch and display venue info in the modal
            async function fetchAndDisplayVenueInfo(venueId) {
                venueInfoContentDiv.innerHTML = '<p class="text-gray-600 italic">Loading venue information...</p>';
                venueInfoModal.style.display = 'block';

                var venue = get_cached_value("venue", venueId);
                if (venue == null)
                {
                    try {
                        const response = await fetch('/api/venue/get', { // Adjust endpoint
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ venue_id: venueId })
                        });

                        const result = await response.json(); // Assuming backend returns { success: true, venue: {...} }

                        if (result.success && result.venue) {
                            add_cached_value("venue", result.venue.venue_id, result.venue); // Cache the venue ID and title
                        } else {
                            venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${result.error_message || 'Unknown error'}</p>`;
                        }
                    } catch (error) {
                        console.error('Error fetching venue info:', error);
                        venueInfoContentDiv.innerHTML = `<p class="text-red-600">Failed to connect to the server to load venue info.</p>`;
                    }
                }

                venue = get_cached_value("venue", venueId);
                if (venue == null)
                {
                    return;
                }

                venueInfoContentDiv.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">${venue.title}</h3>
                    <p class="text-gray-700 mb-2"><strong class="font-medium">Description:</strong> ${venue.description || 'N/A'}</p>
                    <p class="text-gray-700 mb-2"><strong class="font-medium">Address:</strong> ${venue.address || 'N/A'}, ${venue.suburb || ''}, ${venue.state || ''} ${venue.postcode || ''}, ${venue.country || ''}</p>
                    <p class="text-gray-700 mb-4"><strong class="font-medium">Contact Phone:</strong> ${venue.contact_phone || 'N/A'}</p>

                    ${venue.latitude && venue.longitude ?
                        `<div class="map-container rounded-lg overflow-hidden shadow-md mt-4">
                            <iframe
                                loading="lazy"
                                width="100%"
                                height="300"
                                frameborder="0"
                                scrolling="no"
                                marginheight="0"
                                marginwidth="0"
                                src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(venue.longitude) - 0.005},${parseFloat(venue.latitude) - 0.005},${parseFloat(venue.longitude) + 0.005},${parseFloat(venue.latitude) + 0.005}&amp;layer=mapnik&amp;marker=${venue.latitude},${venue.longitude}"
                                style="border: 1px solid black"
                            ></iframe>
                            <br/><small><a href="https://www.openstreetmap.org/?mlat=${venue.latitude}&amp;mlon=${venue.longitude}#map=15/${venue.latitude}/${venue.longitude}" target="_blank" class="text-blue-600 hover:underline">View Larger Map</a></small>
                        </div>
                        <p class="text-sm text-gray-600 italic mt-2 text-center">Map data  OpenStreetMap contributors.</p>
                        `
                        : '<p class="text-gray-600 italic">Map location not available.</p>'}

                `;
            }


            // Helper function to display messages with Tailwind classes
            function displayMessage(element, message, type) {
                 element.textContent = message;
                 element.className = `mt-4 text-center text-sm`; // Reset classes first
                 if (type === 'success') {
                     element.classList.add('text-green-600');
                 } else if (type === 'error') {
                     element.classList.add('text-red-600');
                 } else {
                      element.classList.add('text-gray-700'); // Default color
                 }
                 element.style.display = 'block'; // Ensure it's visible
            }


            // --- Initial Load / Event Attachments ---

            // Fetch filters (venues and styles) when the DOM is ready
            // fetchVenuesForSelect(classFilterVenue);
            fetchStylesForSelect(classFilterStyle);

            // Attach event listener for applying filters
             applyFiltersButton.addEventListener('click', () => {
                 fetchAndDisplayClasses(); // Refetch classes with current filters
             });

             // Handle Join by Code button click
            joinByCodeButton.addEventListener('click', async () => {
                const classCode = classCodeInput.value.trim();
                joinByCodeMessageDiv.textContent = ''; // Clear previous message
                joinByCodeMessageDiv.className = 'mt-2 text-center text-gray-700 text-sm';


                if (!classCode) {
                     displayMessage(joinByCodeMessageDiv, 'Please enter a class code.', 'error');
                     return;
                }

                 console.log('Attempting to join class with code:', classCode);

                 try {
                     const response = await fetch('/api/class/join_by_code', { // Adjust endpoint
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ code: classCode })
                     });

                     const result = await response.json();

                     if (result.success) {
                         displayMessage(joinByCodeMessageDiv, result.message || 'Successfully joined class!', 'success');
                          classCodeInput.value = ''; // Clear input

                         // Optionally, refresh the class list to reflect the change
                         fetchAndDisplayClasses();

                     } else {
                         displayMessage(joinByCodeMessageDiv, result.error_message || 'Error joining class by code.', 'error');
                     }

                 } catch (error) {
                     console.error('Fetch error joining class by code:', error);
                      displayMessage(joinByCodeMessageDiv, 'Failed to connect to the server.', 'error');
                 }
            });




        // }


        // Function to fetch and display venue info in the modal
        async function fetchAndDisplayVenueInfo(venueId) {
            venueInfoContentDiv.innerHTML = '<p class="text-gray-600 italic">Loading venue information...</p>';
            venueInfoModal.style.display = 'block';

            try {
                    // Use POST request body for venue ID
                    const response = await fetch('/api/venue/get', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ venue_id: venueId })
                    });

                    if (response.ok) {
                        const result = await response.json(); // Assuming backend returns { success: true, venue: {...} } OR just the venue data
                        if (!result.success) {
                            venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${result.error_message || 'Unknown error'}</p>`;
                            return;
                        }
                        // Check for 'success' field if your API uses it, or assume data is the venue if 200 OK
                        const venue = result.venue; // Adjust based on actual API response structure


                        if (venue && venue.venue_id) { // Basic check if we got venue data
                            add_cached_value("venue", venue.venue_id, venue); // Cache the venue ID and title
                            venueInfoContentDiv.innerHTML = `
                                <h3 class="text-xl font-semibold text-gray-800 mb-3">${venue.title}</h3>
                                <p class="text-gray-700 mb-2"><strong class="font-medium">Description:</strong> ${venue.description || 'N/A'}</p>
                                <p class="text-gray-700 mb-2"><strong class="font-medium">Address:</strong> ${venue.address || 'N/A'}, ${venue.suburb || ''}, ${venue.state || ''} ${venue.postcode || ''}, ${venue.country || ''}</p>
                                <p class="text-gray-700 mb-4"><strong class="font-medium">Contact Phone:</strong> ${venue.contact_phone || 'N/A'}</p>

                                ${venue.latitude && venue.longitude ?
                                    `<div class="map-container rounded-lg overflow-hidden shadow-md mt-4">
                                        <iframe
                                            width="100%"
                                            height="300"
                                            frameborder="0"
                                            scrolling="no"
                                            marginheight="0"
                                            marginwidth="0"
                                            src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(venue.longitude) - 0.005},${parseFloat(venue.latitude) - 0.005},${parseFloat(venue.longitude) + 0.005},${parseFloat(venue.latitude) + 0.005}&amp;layer=mapnik&amp;marker=${venue.latitude},${venue.longitude}"
                                            style="border: 1px solid black"
                                        ></iframe>
                                        <br/><small><a href="https://www.openstreetmap.org/?mlat=${venue.latitude}&amp;mlon=${venue.longitude}#map=15/${venue.latitude}/${venue.longitude}" target="_blank" class="text-blue-600 hover:underline">View Larger Map</a></small>
                                    </div>
                                    <p class="text-sm text-gray-600 italic mt-2 text-center">Map data  OpenStreetMap contributors.</p>
                                    `
                                    : '<p class="text-gray-600 italic">Map location not available.</p>'}

                            `;
                        } else {
                            venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${result.error_message || 'Invalid data received'}</p>`;
                        }

                    } else if (response.status === 404) {
                        venueInfoContentDiv.innerHTML = `<p class="text-red-600">Venue not found.</p>`;
                        console.warn('Venue not found:', venueId);
                    }
                    else if (response.status === 401 || response.status === 403) {
                        venueInfoContentDiv.innerHTML = '<p class="text-red-600">Error: You are not authorized to view venue details.</p>';
                        console.error("Authorization error fetching venue:", response.status);
                    }
                    else {
                        const errorText = await response.text();
                        venueInfoContentDiv.innerHTML = `<p class="text-red-600">Error loading venue information: ${response.status} - ${errorText.substring(0, 100)}...</p>`;
                        console.error("Error fetching venue:", response.status, errorText);
                    }
            } catch (error) {
                    console.error('Error fetching venue info:', error);
                    venueInfoContentDiv.innerHTML = `<p class="text-red-600">Failed to connect to the server to load venue info.</p>`;
            }
        }




        // Function to initiate session refresh
        async function refreshSession() {
            console.log('Attempting to refresh session...');
            try {
                const response = await fetch('/api/user/refresh_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // No body needed, authentication is handled by the session cookie
                });

                // Check if the response is OK (200-299)
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        if (result.new_session_token && result.new_expires_ts) {
                            console.log('Session successfully refreshed.');
                            // Cookies are already set by the server using Set-Cookie headers
                            // You might want to store the new expiry timestamp client-side
                            // if you are doing client-side expiry checks, but it's not strictly
                            // necessary if you rely on server validation and the refresh window.
                            // Example: localStorage.setItem('sessionExpiry', result.new_expires_ts);

                        } else {
                             console.log('Session refresh request successful, but no refresh was needed.');
                        }
                    } else {
                        // Server returned success: false (backend logic prevented refresh)
                        console.warn('Session refresh failed:', result.error_message || 'Unknown error');
                        // Handle specific errors if needed (e.g., user is now unauthorized)
                    }
                } else if (response.status === 401) {
                    // User is no longer authenticated (session cookie invalid or expired)
                    console.warn('Session refresh failed: User Unauthorized. Redirecting to login.');
                    window.location.href = '/login'; // Redirect to login page
                }
                 else {
                    // Handle other HTTP errors
                    console.error('Session refresh failed with HTTP status:', response.status);
                }
            } catch (error) {
                console.error('Network error during session refresh:', error);
                // Handle network errors (e.g., server down). User might need to log in again later.
            }
        }

        const sessionRefreshInterval = setInterval(refreshSession, 30 * 60 * 1000);

        // Calendar and events management

        class DailyCalendar {
            constructor() {
                this.events = [];
                this.highlightInterval = null;
                this.currentEvent = null;
                this.currentStudents = [];
                this.currentViewMode = 'list'; // 'list' or 'grid'
                this.SLOT_HEIGHT = 60;
                this.START_HOUR = 6;
                this.END_HOUR = 23;
                this.init();
            }

            init() {
                this.renderCalendar();
                this.startHighlightUpdater();
                this.setupModalEventListeners();
            }

            setupModalEventListeners() {
            // Close modal
            document.getElementById('closeModal').addEventListener('click', () => {
                this.closeModal();
            });

            // Close modal on backdrop click
            document.getElementById('attendanceModal').addEventListener('click', (e) => {
                if (e.target.id === 'attendanceModal') {
                this.closeModal();
                }
            });

            // Search functionality
            const searchInput = document.getElementById('student-search');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.searchStudents(e.target.value);
                }, 300);
            });

            // View toggle buttons
            document.getElementById('list-view-btn').addEventListener('click', () => {
                this.switchView('list');
            });

            document.getElementById('grid-view-btn').addEventListener('click', () => {
                this.switchView('grid');
            });
            }

            renderCalendar() {
                const today = new Date();
                const dateStr = today.toLocaleDateString("en-US", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
                document.getElementById("current-date").textContent = dateStr;

                const timeSlotsContainer = document.getElementById("time-slots");
                timeSlotsContainer.innerHTML = "";

                for (let hour = this.START_HOUR; hour <= this.END_HOUR; hour++) {
                    const timeSlot = document.createElement("div");
                    timeSlot.className = "time-slot";
                    timeSlot.dataset.hour = hour;

                    const timeLabel = document.createElement("div");
                    timeLabel.className = "time-label";
                    timeLabel.textContent = this.formatTime(hour);

                    const timeContent = document.createElement("div");
                    timeContent.className = "time-content";

                    timeSlot.appendChild(timeLabel);
                    timeSlot.appendChild(timeContent);
                    timeSlotsContainer.appendChild(timeSlot);
                }

                this.updateCurrentTimeIndicator();
            }

            formatTime(hour) {
                const period = hour >= 12 ? "PM" : "AM";
                const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
                return `${displayHour}:00 ${period}`;
            }

            addEvent(startTime, endTime, title, description = "", location = "", classId = null, eventId = null) {
                if (!eventId)
                {
                    throw new Error("Event ID is required to add an event.");
                }

            
                const event = {
                    id: eventId,
                    startTime: new Date(startTime),
                    endTime: new Date(endTime),
                    title,
                    description,
                    location,
                    classId,
                };
                // Check if event with event id already exists - if so override it
                const existingIndex = this.events.findIndex(e => e.id === eventId);
                if (existingIndex !== -1) {
                    this.events[existingIndex] = event; // Update existing event
                } else {
                    this.events.push(event); // Add new event
                }
                this.renderEvents();
                return event.id;
            }

            removeNonPresentClassIdEvents(classId, eventIds) {
                // If an event has the same class id as the parameter and the event id is not in the provided list, remove it
                this.events = this.events.filter((event) => {
                    return !(event.classId === classId && !eventIds.includes(event.id));
                });
                this.renderEvents();
            }

            removeEvent(eventId) {
                this.events = this.events.filter((event) => event.id !== eventId);
                this.renderEvents();
            }

            calculateEventPosition(startTime, endTime) {
                const startHour = startTime.getHours();
                const startMinutes = startTime.getMinutes();

                const hoursFromStart = startHour - this.START_HOUR;
                const minutesOffset = startMinutes / 60;
                const topPosition = (hoursFromStart + minutesOffset) * this.SLOT_HEIGHT;

                const durationMs = endTime.getTime() - startTime.getTime();
                const durationHours = durationMs / (1000 * 60 * 60);
                const height = Math.max(durationHours * this.SLOT_HEIGHT, 24);

                return { top: topPosition, height };
            }

                renderEvents() {
                    const eventsContainer = document.getElementById("events-container");
                    eventsContainer.innerHTML = "";

                    const sortedEvents = [...this.events].sort((a, b) => a.startTime - b.startTime);

                    sortedEvents.forEach((event) => {
                        if (
                        event.startTime.getHours() >= this.START_HOUR &&
                        event.startTime.getHours() <= this.END_HOUR
                        ) {
                        this.renderEvent(event);
                        }
                    });

                    this.updateHighlights();
                }

                renderEvent(event) {
                    const position = this.calculateEventPosition(event.startTime, event.endTime);

                    const eventElement = document.createElement("div");
                    eventElement.className = "event";
                    eventElement.id = `event-${event.id}`;
                    eventElement.style.top = `${position.top}px`;
                    eventElement.style.height = `${position.height}px`;

                    // Add click handler for modal
                    eventElement.addEventListener('click', () => {
                        this.openModal(event);
                    });

                    const startTimeStr = event.startTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    });
                    const endTimeStr = event.endTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    });

                    eventElement.innerHTML = `
                        <div class="event-title">${event.title}</div>
                        <div class="event-time">${startTimeStr} - ${endTimeStr}</div>
                        ${event.description ? `<div class="event-description">${event.description}</div>` : ""}
                        ${event.location ? `<div class="event-description"> ${event.location}</div>` : ""}
                    `;

                    const eventsContainer = document.getElementById("events-container");
                    eventsContainer.appendChild(eventElement);
                }

                // Modal functionality
                async openModal(event) {
                    this.currentEvent = event;
                    
                    // Populate modal header
                    document.getElementById('modal-event-title').textContent = event.title;
                    document.getElementById('modal-event-description').textContent = event.description || '';
                    document.getElementById('modal-event-location').textContent = event.location ? ` ${event.location}` : '';
                    
                    const timeStr = `${event.startTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    })} - ${event.endTime.toLocaleTimeString("en-US", {
                        hour: "numeric",
                        minute: "2-digit",
                        hour12: true,
                    })}`;
                    document.getElementById('modal-event-time').textContent = ` ${timeStr}`;

                    // Show modal
                    document.getElementById('attendanceModal').classList.remove('hidden');
                    
                    // Load current students
                    await this.loadCurrentStudents();
                }

            closeModal() {
                document.getElementById('attendanceModal').classList.add('hidden');
                document.getElementById('student-search').value = '';
                document.getElementById('search-results').classList.add('hidden');
                this.currentEvent = null;
                this.currentStudents = [];
            }

            async loadCurrentStudents() {
                try {
                    document.getElementById('loading-indicator').classList.remove('hidden');
                    console.log('Loading students for class:', this.currentEvent.classId);
                    const timeSegment = this.getTimeSegment(this.currentEvent.startTime);
                    const response = await fetch('/api/class/get_students', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_id: this.currentEvent.classId,
                            class_start_ts: timeSegment
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentStudents = data.students || [];
                        this.renderStudents();
                    } else {
                        console.error('Failed to load students');
                        this.currentStudents = [];
                        this.renderStudents();
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                    this.currentStudents = [];
                    this.renderStudents();
                } finally {
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            }

            async searchStudents(query) {
                if (!query.trim()) {
                    document.getElementById('search-results').classList.add('hidden');
                    return;
                }

                const timeSegment = this.getTimeSegment(this.currentEvent.startTime);
                try {
                    document.getElementById('loading-indicator').classList.remove('hidden');
                    const response = await fetch('/api/class/get_students', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_id: this.currentEvent.classId,
                            class_start_ts: timeSegment,
                            q: query.trim()
                        })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const students = data.students || [];
                        this.renderSearchResults(students);
                    } else {
                        console.error('Failed to search students');
                        this.renderSearchResults([]);
                    }

                } catch (error) {
                    console.error('Error showing loading indicator:', error);
                }
                document.getElementById('loading-indicator').classList.add('hidden');
            }

            renderSearchResults(students) {
                const resultsContainer = document.getElementById('search-results');
                
                if (students.length === 0) {
                    resultsContainer.innerHTML = '<div class="p-4 text-gray-500 text-center">No students found</div>';
                } else {
                    resultsContainer.innerHTML = students.map(student => `
                    <div class="student-search-item" data-student-id="${student.user_id}">
                        <img src="${student.photo_url || '/default-avatar.png'}" alt="${student.first_name}" class="student-avatar">
                        <div>
                        <div class="font-medium text-gray-900">${student.first_name} ${student.last_name}</div>
                        <div class="text-sm text-gray-500">ID: ${student.user_id}</div>
                        </div>
                    </div>
                    `).join('');

                    // Add click handlers
                    resultsContainer.querySelectorAll('.student-search-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.dataset.studentId;
                        const attended = this.currentStudents.find(s => s.user_id === studentId).attended;
                        this.toggleStudentAttendance(studentId, !attended);
                    });
                    });
                }

                resultsContainer.classList.remove('hidden');
            }

            switchView(mode) {
                this.currentViewMode = mode;
                
                // Update button states
                if (mode === 'list') {
                    document.getElementById('list-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
                    document.getElementById('grid-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                    document.getElementById('students-list-view').classList.remove('hidden');
                    document.getElementById('students-grid-view').classList.add('hidden');
                } else {
                    document.getElementById('grid-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
                    document.getElementById('list-view-btn').className = 'px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                    document.getElementById('students-list-view').classList.add('hidden');
                    document.getElementById('students-grid-view').classList.remove('hidden');
                }
            }

            renderStudents() {
                this.renderStudentsList();
                this.renderStudentsGrid();
            }

            renderStudentsList() {
                const container = document.getElementById('students-list-view');
                
                if (this.currentStudents.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No students in this class</div>';
                    return;
                }

                container.innerHTML = this.currentStudents.map(student => `
                    <div class="student-list-item ${student.attended ? 'attended' : ''}" data-student-id="${student.user_id}">
                    <div class="flex items-center space-x-3">
                        <img src="${student.photo_url || '/default-avatar.png'}" alt="${student.first_name}" class="student-avatar">
                        <div>
                        <div class="font-medium text-gray-900">${student.first_name} ${student.last_name}</div>
                        <div class="text-sm text-gray-500">ID: ${student.user_id}</div>
                        </div>
                    </div>
                    <div class="text-sm font-medium ${student.attended ? 'text-blue-600' : 'text-gray-400'}">
                        ${student.attended ? ' Present' : 'Absent'}
                    </div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.student-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.dataset.studentId;
                        const attended = this.currentStudents.find(s => s.user_id === studentId).attended;
                        this.toggleStudentAttendance(studentId, !attended);
                    });
                });
            }

            renderStudentsGrid() {
                const container = document.getElementById('students-grid-view');
                
                if (this.currentStudents.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">No students in this class</div>';
                    return;
                }

                container.innerHTML = this.currentStudents.map(student => `
                    <div class="student-grid-item ${student.attended ? 'attended' : ''}" data-student-id="${student.user_id}">
                    <img src="${student.photo_url || '/default-avatar.png'}" alt="${student.first_name}" class="student-grid-avatar">
                    <div class="font-medium text-gray-900">${student.first_name}</div>
                    <div class="font-medium text-gray-900">${student.last_name}</div>
                    <div class="text-sm font-medium mt-2 ${student.attended ? 'text-blue-600' : 'text-gray-400'}">
                        ${student.attended ? ' Present' : 'Absent'}
                    </div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.student-grid-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.dataset.studentId;
                        const attended = this.currentStudents.find(s => s.user_id === studentId).attended;
                        this.toggleStudentAttendance(studentId, !attended);
                    });
                });
            }

            async toggleStudentAttendance(studentId, attended) {
                try {
                    const timeSegment = this.getTimeSegment(this.currentEvent.startTime);
                    
                    const response = await fetch('/api/class/set_student_attendance', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_ids: [studentId],
                            present: [attended],
                            class_id: this.currentEvent.classId,
                            class_start_ts: timeSegment
                        })
                    });

                    if (response.ok) {
                        console.log(`Attendance for student ${studentId} toggled to ${attended ? 'present' : 'absent'}`);
                        // Reload students to get updated attendance
                        await this.loadCurrentStudents();
                        // Hide search results
                        document.getElementById('search-results').classList.add('hidden');
                        document.getElementById('student-search').value = '';
                    } else {
                        // Show error message - show a popup
                        const errorData = await response.json();
                        const errorMessage = errorData.error_message || 'Failed to toggle attendance';
                        // Show error in a modal error box
                        const errorModal = document.createElement('div');
                        errorModal.style.position = 'fixed';
                        errorModal.style.top = '0';
                        errorModal.style.left = '0';
                        errorModal.style.width = '100vw';
                        errorModal.style.height = '100vh';
                        errorModal.style.background = 'rgba(0,0,0,0.4)';
                        errorModal.style.zIndex = '9999';
                        errorModal.innerHTML = `
                            <div style="
                                background: white;
                                max-width: 400px;
                                margin: 10vh auto;
                                padding: 24px 32px;
                                border-radius: 8px;
                                box-shadow: 0 4px 24px rgba(0,0,0,0.2);
                                text-align: center;
                                position: relative;
                            ">
                                <div style="color: #dc2626; font-size: 1.2rem; font-weight: bold; margin-bottom: 12px;">
                                    Error
                                </div>
                                <div style="color: #991b1b; margin-bottom: 20px;">
                                    ${errorMessage}
                                </div>
                                <button id="close-error-modal" style="
                                    background: #ef4444;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    padding: 8px 20px;
                                    font-size: 1rem;
                                    cursor: pointer;
                                ">Close</button>
                            </div>
                        `;
                        document.body.appendChild(errorModal);
                        document.getElementById('close-error-modal').onclick = () => {
                            document.body.removeChild(errorModal);
                        };

                        console.error('Failed to toggle attendance');
                    }
                } catch (error) {
                    console.error('Error toggling attendance:', error);
                }
            }

            getTimeSegment(date) {
                // return the date timestamp
                return Math.floor(date.getTime()); // Convert to seconds since epoch

                // Convert date to time segment format
                // return date.toLocaleTimeString("en-US", {
                //     hour: "2-digit",
                //     minute: "2-digit",
                //     hour12: false
                // });
            }

            // Keep existing methods for time indicator and highlighting...
            updateCurrentTimeIndicator() {
                const existingIndicator = document.getElementById("current-time-indicator");
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();

                if (currentHour >= this.START_HOUR && currentHour <= this.END_HOUR) {
                    const indicator = document.createElement("div");
                    indicator.className = "current-time-indicator";
                    indicator.id = "current-time-indicator";

                    const timeLabel = document.createElement("div");
                    timeLabel.className = "current-time-label";
                    timeLabel.textContent = now.toLocaleTimeString("en-US", {
                    hour: "numeric",
                    minute: "2-digit",
                    hour12: true,
                    });
                    indicator.appendChild(timeLabel);

                    const hoursFromStart = currentHour - this.START_HOUR;
                    const minutesOffset = currentMinutes / 60;
                    const topPosition = (hoursFromStart + minutesOffset) * this.SLOT_HEIGHT;

                    indicator.style.top = `${topPosition}px`;

                    const eventsContainer = document.getElementById("events-container");
                    eventsContainer.appendChild(indicator);
                }
            }

            updateHighlights() {
                document.querySelectorAll(".event-highlight").forEach((el) => {
                    el.classList.remove("event-highlight");
                });

                const now = new Date();
                let currentEvent = null;
                let nextEvent = null;

                this.events.forEach((event) => {
                    if (now >= event.startTime && now <= event.endTime) {
                    currentEvent = event;
                    }
                });

                if (!currentEvent) {
                    const thirtyMinutesFromNow = new Date(now.getTime() + 30 * 60 * 1000);

                    this.events.forEach((event) => {
                    if (event.startTime > now && event.startTime <= thirtyMinutesFromNow) {
                        if (!nextEvent || event.startTime < nextEvent.startTime) {
                        nextEvent = event;
                        }
                    }
                    });
                }

                const eventToHighlight = currentEvent || nextEvent;
                if (eventToHighlight) {
                    const eventElement = document.getElementById(`event-${eventToHighlight.id}`);
                    if (eventElement) {
                    eventElement.classList.add("event-highlight");
                    }
                }
            }

            startHighlightUpdater() {
                this.highlightInterval = setInterval(() => {
                    this.updateHighlights();
                    this.updateCurrentTimeIndicator();
                }, 30000);
            }

            destroy() {
                if (this.highlightInterval) {
                    clearInterval(this.highlightInterval);
                }
            }
        }

        // Initialize calendar
        const calendar = new DailyCalendar();

        // Stripe - START
        
        // Initialize Stripe
        const stripe = Stripe('pk_test_51RW5mIP9izC6CZUZ9SqPTU177jhpSRM7NLdGRTjhUmAqILMy5YYP7vbuMxVGEh4XUj9spa9MdbeoAeAxqX5bNVBc00iDtJHDgv'); // Replace with your public key
        const elements = stripe.elements();

        // Create card element
        const cardElement = elements.create('card', {
            hidePostalCode: true,
            style: {
                base: {
                    fontSize: '16px',
                    color: '#424770',
                    '::placeholder': {
                        color: '#aab7c4',
                    },
                },
            },
        });

        cardElement.mount('#card-element');

        // Handle real-time validation errors from the card Element
        cardElement.on('change', ({error}) => {
            const displayError = document.getElementById('card-errors');
            if (error) {
                displayError.textContent = error.message;
            } else {
                displayError.textContent = '';
            }
        });

        // Get form elements
        const stripeForm = document.getElementById('stripe-card-form');
        const stripeSubmitBtn = document.getElementById('stripe-submit-btn');
        const stripeLoading = document.getElementById('stripe-loading');
        const stripeResult = document.getElementById('stripe-result');
        const stripeEmail = document.getElementById('email');
        const stripeCardholderName = document.getElementById('stripe-cardholder-name');

        // Pre-populate email from profile form
        // function syncEmailFromProfile() {
        //     const profileEmail = document.getElementById('email');
        //     if (profileEmail && profileEmail.value) {
        //         stripeEmail.value = profileEmail.value;
        //     }
        // }

        // Pre-populate cardholder name from profile form
        function syncNameFromProfile() {
            const firstName = document.getElementById('first_name');
            const surname = document.getElementById('surname');
            if (firstName && surname && firstName.value && surname.value) {
                stripeCardholderName.value = `${firstName.value} ${surname.value}`;
            }
        }

        // Sync data when account section is shown
        function syncStripeFormData() {
            // syncEmailFromProfile();
            syncNameFromProfile();
        }

        // Call sync when the page loads and when profile is updated
        syncStripeFormData();

        // Listen for profile updates to sync the Stripe form
        const profileForm = document.getElementById('profileUpdateForm');
        if (profileForm) {
            profileForm.addEventListener('submit', function() {
                // Sync after a short delay to allow profile update to complete
                setTimeout(syncStripeFormData, 1000);
            });
        }

        // Handle Stripe form submission
        stripeForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            event.stopPropagation(); // Prevent bubbling to other forms

            stripeSubmitBtn.disabled = true;
            stripeLoading.classList.remove('hidden');
            stripeResult.innerHTML = '';

            const cardholderName = stripeCardholderName.value;
            const email = stripeEmail.value;

            if (!cardholderName.trim()) {
                showStripeMessage('Please enter the cardholder name.', 'error');
                stripeSubmitBtn.disabled = false;
                stripeLoading.classList.add('hidden');
                return;
            }

            if (!email.trim()) {
                showStripeMessage('Email is required.', 'error');
                stripeSubmitBtn.disabled = false;
                stripeLoading.classList.add('hidden');
                return;
            }

            try {
                // Create setup intent on your backend
                const setupIntentResponse = await fetch('/api/user/create_setup_intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_email: email,
                        cardholder_name: cardholderName
                    }),
                });

                if (!setupIntentResponse.ok) {
                    throw new Error(`HTTP ${setupIntentResponse.status}: Failed to create setup intent`);
                }

                const { client_secret, customer_id } = await setupIntentResponse.json();

                // Confirm setup intent with card
                const {error, setupIntent} = await stripe.confirmCardSetup(
                    client_secret,
                    {
                        payment_method: {
                            card: cardElement,
                            billing_details: {
                                name: cardholderName,
                                email: email,
                            },
                        }
                    }
                );

                if (error) {
                    throw new Error(error.message);
                }

                // Success
                showStripeMessage('Success! Your payment method has been saved securely.', 'success');

                // Clear form
                stripeCardholderName.value = '';
                cardElement.clear();

                // Refresh saved cards list
                loadSavedCards();

            } catch (error) {
                console.error('Stripe error:', error);
                showStripeMessage(`Error: ${error.message}`, 'error');
            } finally {
                stripeSubmitBtn.disabled = false;
                stripeLoading.classList.add('hidden');
            }
        });

        // Helper function to show messages
        function showStripeMessage(message, type) {
            const className = type === 'success' 
                ? 'p-4 bg-green-100 border border-green-400 text-green-700 rounded-md'
                : 'p-4 bg-red-100 border border-red-400 text-red-700 rounded-md';
            
            stripeResult.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Clear message after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    stripeResult.innerHTML = '';
                }, 5000);
            }
        }

        // Load saved cards
        async function loadSavedCards() {
            const savedCardsList = document.getElementById('saved-cards-list');
            
            try {
                const response = await fetch('/api/user/get_stripe_saved_payment_methods', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to load payment methods`);
                }

                const { payment_methods } = await response.json();

                if (payment_methods && payment_methods.length > 0) {
                    savedCardsList.innerHTML = payment_methods.map(pm => `
                        <div class="flex justify-between items-center p-3 border border-gray-200 rounded-md bg-white" data-pm-id="${pm.id}">
                            <div>
                                <div class="font-medium capitalize">${pm.card.brand}  ${pm.card.last4}</div>
                                <div class="text-sm text-gray-500">Expires ${pm.card.exp_month}/${pm.card.exp_year}</div>
                            </div>
                            <button class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700" 
                                    onclick="deletePaymentMethod('${pm.id}')">
                                Delete
                            </button>
                        </div>
                    `).join('');
                } else {
                    savedCardsList.innerHTML = '<p class="text-gray-500">No saved payment methods found.</p>';
                }
            } catch (error) {
                console.error('Error loading saved cards:', error);
                savedCardsList.innerHTML = `<p class="text-red-600">Error loading saved cards: ${error.message}</p>`;
            }
        }

        // Delete payment method (global function)
        window.deletePaymentMethod = async function(paymentMethodId) {
            if (!confirm('Are you sure you want to delete this payment method?')) {
                return;
            }

            try {
                const response = await fetch('/api/user/delete_payment_method', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        payment_method_id: paymentMethodId
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to delete payment method`);
                }

                // Remove from UI
                const cardItem = document.querySelector(`[data-pm-id="${paymentMethodId}"]`);
                if (cardItem) {
                    cardItem.remove();
                }
                
                showStripeMessage('Payment method deleted successfully.', 'success');
                
            } catch (error) {
                console.error('Error deleting payment method:', error);
                showStripeMessage(`Error: ${error.message}`, 'error');
            }
        };

        // Refresh cards button
        document.getElementById('refresh-cards').addEventListener('click', loadSavedCards);

        // Load saved cards on initialization
        loadSavedCards();

        // Stripe - end







    </script>
</body>
</html>
